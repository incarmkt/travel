<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISC ê´€ë¦¬ì ì‹œìŠ¤í…œ</title>

  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">
</head>
<body>

<!-- ëª¨ë°”ì¼ ìŠ¤í”Œë˜ì‹œ -->
<div id="mobileSplash" class="mobile-splash" style="display:none;">
  <img src="assets/images/iscposter.jpg">
</div>

<!-- HEADER -->
<header class="header compact" id="topHeader" style="display:none;">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì ì‹œìŠ¤í…œ</h1>
      <p class="sub">ì¶œë°œ Â· ì¤‘ì‹ë¹„ Â· ê³ ê°ê´€ë¦¬</p>
    </div>
  </div>
</header>

<!-- ë¡œê·¸ì¸ -->
<section id="loginSection" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
      <input type="password" id="adminPw" placeholder="ê´€ë¦¬ì ë²ˆí˜¸">
      <button class="primary-btn" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      <p id="loginError" class="error"></p>
    </div>
  </div>
</section>

<!-- MAIN -->
<main id="mainSection" class="main-bg" style="display:none;">
  <div class="layout">

    <!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
    <aside class="side-menu">
      <button onclick="openPage('travel')">ğŸ§­ ì—¬í–‰ ê´€ë¦¬</button>
      <button onclick="openPage('meal')">ğŸœ ì¤‘ì‹ë¹„ ê´€ë¦¬</button>
      <button onclick="openPage('lookup')">ğŸ‘¤ ê³ ê° ì¡°íšŒ</button>
    </aside>

    <!-- ì½˜í…ì¸  -->
    <section class="content-area">
      <div class="main-panel">

        <!-- í™ˆ -->
        <div id="homeArea" class="home-view">
          <img src="assets/images/home.jpg">
        </div>

        <!-- ìƒì„¸ -->
        <section id="detailPage" class="detail" style="display:none;">
          <h2 id="detailTitle"></h2>
          <div id="detailContent"></div>

          <div class="nav-buttons">
            <button class="ghost-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
            <button class="ghost-btn" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
          </div>
        </section>

      </div>
    </section>
  </div>
</main>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= ê³µí†µ ================= */
const ADMIN_PASSWORD = "0000";
let pageHistory = [];
let qrScanner = null;

/* ================= ë¡œê·¸ì¸ ================= */
function adminLogin() {
  const pw = adminPw.value.trim();
  if (pw !== ADMIN_PASSWORD) {
    loginError.textContent = "ê´€ë¦¬ì ë²ˆí˜¸ ì˜¤ë¥˜";
    return;
  }

  loginSection.style.display = "none";

  if (innerWidth <= 767) {
    mobileSplash.style.display = "flex";
    setTimeout(showMain, 2000);
  } else {
    showMain();
  }
}

function showMain() {
  mobileSplash.style.display = "none";
  topHeader.style.display = "flex";
  mainSection.style.display = "block";
  document.body.classList.add("logged-in");
}

/* ================= í˜ì´ì§€ ì´ë™ ================= */
function openPage(type, fromHistory=false) {
  if (!fromHistory) pageHistory.push(type);

  homeArea.style.display = "none";
  detailPage.style.display = "block";

  if (type === "travel") renderTravelAdmin();
  if (type === "meal") renderMealAdmin();
  if (type === "lookup") renderLookup();
}

/* ================= ì—¬í–‰ ê´€ë¦¬ ================= */
function renderTravelAdmin() {
  detailTitle.textContent = "ğŸ§­ ì—¬í–‰ ê´€ë¦¬";
  detailContent.innerHTML = `
    <div class="card">
      <button class="primary-btn" onclick="startScan('departure_all')">ì „ì²´ ì¼ì • ì¶œë°œ ì²´í¬</button>
      <button class="primary-btn" onclick="startScan('departure_tour')">ì„ íƒ ê´€ê´‘ ì¶œë°œ ì²´í¬</button>
    </div>
    <div id="scanArea"></div>
  `;
}

/* ================= ì¤‘ì‹ë¹„ ê´€ë¦¬ ================= */
function renderMealAdmin() {
  detailTitle.textContent = "ğŸœ ì¤‘ì‹ë¹„ ê´€ë¦¬";
  detailContent.innerHTML = `
    <div class="card">
      <button class="primary-btn" onclick="startScan('meal_danshui')">ë‹¨ìˆ˜ì´ ì¤‘ì‹ë¹„ ì§€ê¸‰</button>
    </div>
    <div id="scanArea"></div>
  `;
}

/* ================= QR ìŠ¤ìº” ================= */
function startScan(mode) {
  const area = document.getElementById("scanArea");
  area.innerHTML = `
    <div class="card">
      <h3>QR ìŠ¤ìº” ì¤‘â€¦</h3>
      <div id="qrReader" style="height:300px;background:#000"></div>
      <p class="hint">ì—°ì† ìŠ¤ìº” ê°€ëŠ¥</p>
    </div>
  `;

  qrScanner = new Html5Qrcode("qrReader");

  Html5Qrcode.getCameras().then(devices => {
    const cam = devices.find(d => d.label.includes("back")) || devices[0];
    qrScanner.start(
      cam.id,
      { fps: 10, qrbox: 250 },
      text => handleScan(text, mode)
    );
  });
}

/* ================= ìŠ¤ìº” ì²˜ë¦¬ ================= */
function handleScan(text, mode) {
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (!id) return;

    sendToSheet(mode, id);
  } catch {}
}

/* ================= ì‹œíŠ¸ ì „ì†¡ ================= */
function sendToSheet(mode, id) {
  fetch("YOUR_GAS_URL", {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: mode,
      id,
      time: new Date().toISOString()
    })
  });
}

/* ================= ë„¤ë¹„ ================= */
function goHome() {
  pageHistory = [];
  detailPage.style.display = "none";
  homeArea.style.display = "block";
}

function goBack() {
  pageHistory.pop();
  if (pageHistory.length === 0) return goHome();
  openPage(pageHistory[pageHistory.length-1], true);
}
</script>
</body>
</html>
