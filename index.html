<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2025 ISC ëŒ€ë§Œ ì—¬í–‰</title>

  <!-- âœ… [1] í°íŠ¸ CDN ì¶”ê°€ (Pretendard) -->
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <!-- âœ… [ì¶”ê°€] ì´ë¯¸ì§€ ë¹ ë¥¸ ë¡œë”©ì„ ìœ„í•œ Preload (ë¸Œë¼ìš°ì €ê°€ ê°€ì¥ ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ë„ë¡ ì§€ì‹œ) -->
  <link rel="preload" as="image" href="assets/images/taiwan.jpg">
  <link rel="preload" as="image" href="assets/images/home2.jpg">

  <!-- í”„ë¦¬ë¯¸ì—„ í…Œë§ˆ CSS -->
  <style>
    /* =========================================================
       [1] CSS ë³€ìˆ˜ & ì´ˆê¸°í™” (Premium Palette)
    ========================================================= */
    :root {
      --primary-color: #1a233a; 
      --accent-color: #c5a059;  
      --bg-main: #f5f7fa;        
      --card-bg: #ffffff;
      --text-main: #2d3748;
      --text-sub: #718096;
      --border-light: #edf2f7;
      --sheet-radius: 24px;
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent; 
      /* âœ… í°íŠ¸ ì ìš© */
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      background-color: var(--primary-color);
      color: var(--text-main);
      overscroll-behavior: none; 
      /* âœ… ëª¨ë°”ì¼ ê½‰ ì±„ìš°ê¸° í•µì‹¬ ì„¤ì • */
      width: 100%;
      height: 100%;
      overflow: hidden; /* ì´ì¤‘ ìŠ¤í¬ë¡¤ ë°©ì§€ */
    }

    /* =========================================================
       [2] ìŠ¤í”Œë˜ì‹œ & ë¡œê·¸ì¸
    ========================================================= */
    /* ìŠ¤í”Œë˜ì‹œ ìŠ¤íƒ€ì¼ì€ ìœ ì§€í•˜ë˜ ë¡œì§ì—ì„œë§Œ ì œê±° */
    .mobile-splash {
      position: fixed; inset: 0; z-index: 9999;
      background: var(--primary-color);
      display: flex; align-items: center; justify-content: center;
    }
    .mobile-splash img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }

    .login-hero {
      width: 100%;
      /* âœ… ëª¨ë°”ì¼ ì£¼ì†Œì°½ ëŒ€ì‘ ë†’ì´ ì„¤ì • */
      height: 100vh;
      height: 100dvh; 
      background: url('assets/images/taiwan.jpg') center/cover no-repeat;
      /* âœ… ë°°ê²½ ê³ ì • (ìŠ¤í¬ë¡¤ ì‹œ í”ë“¤ë¦¼ ë°©ì§€) */
      position: fixed;
      top: 0; left: 0;
      z-index: 2000;
    }
    .hero-overlay {
      position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(26,35,58,0.85) 0%, rgba(0,0,0,0.6) 100%);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
    }
    .login-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 40px 24px;
      border-radius: 20px;
      width: 100%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    
    /* ğŸ”¥ [ìˆ˜ì •] ë¡œê·¸ì¸ í™”ë©´ ë¡œê³  ìŠ¤íƒ€ì¼: ë¹„ìœ¨ ìœ ì§€ */
    .hero-logo { 
        width: 140px;       /* ì ì ˆí•œ ê°€ë¡œ í¬ê¸° ì„¤ì • */
        height: auto;       /* ë†’ì´ëŠ” ìë™ */
        object-fit: contain;/* ë¹„ìœ¨ ìœ ì§€í•˜ë©° í‘œì‹œ */
        margin-bottom: 12px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    .login-box h2 { color: var(--primary-color); margin: 0 0 5px; font-weight: 800; }
    .hero-desc { color: var(--text-sub); margin-bottom: 24px; font-size: 14px; }
    .login-box input {
      width: 100%; padding: 14px; border: 1px solid var(--border-light);
      border-radius: 12px; font-size: 16px; margin-bottom: 16px;
      text-align: center; transition: border 0.3s;
    }
    .login-box input:focus { border-color: var(--accent-color); outline: none; }
    .primary-btn {
      width: 100%; padding: 15px; border: none; border-radius: 12px;
      background: var(--primary-color); color: #fff; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: background 0.3s, transform 0.1s;
    }
    .primary-btn:active { transform: scale(0.98); }
    .error { color: #e53e3e; font-size: 13px; margin-top: 12px; min-height: 18px; }

    /* =========================================================
       [3] í™ˆ í™”ë©´ (ë‹¨ì¼ í’€ìŠ¤í¬ë¦° ëŒ€ì‹œë³´ë“œ êµ¬ì¡°)
    ========================================================= */
    .main-bg { 
        width: 100%; 
        height: 100%; 
        overflow: hidden; 
    }
    
    .home-view {
      width: 100%;
      /* âœ… ëª¨ë°”ì¼ ì£¼ì†Œì°½ ëŒ€ì‘ */
      height: 100vh;
      height: 100dvh;
      background: url('assets/images/home2.jpg') center/cover no-repeat;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .home-overlay {
      position: absolute; inset: 0;
      /* âœ… ì–´ë‘¡ê²Œ ê¹”ë¦° ë°°ê²½ í•„í„° ì œê±° (íˆ¬ëª…í•˜ê²Œ ì²˜ë¦¬) */
      background: transparent;
      z-index: 1;
    }

    /* ìƒë‹¨ í—¤ë” */
    .home-header {
      position: relative; z-index: 100;
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px;
      /* âœ… ì•„ì´í° ë…¸ì¹˜ ì˜ì—­ ëŒ€ì‘ */
      padding-top: max(20px, env(safe-area-inset-top));
    }
    
    /* ğŸ”¥ [ìˆ˜ì •] ìƒë‹¨ í—¤ë” ë¡œê³  ìŠ¤íƒ€ì¼: ë¹„ìœ¨ ìœ ì§€ ë° ì›ë³¸ ìƒ‰ìƒ ì¶œë ¥ */
    .header-logo { 
        height: 36px;       /* í—¤ë” ë†’ì´ì— ë§ì¶¤ */
        width: auto;        /* ê°€ë¡œëŠ” ë¹„ìœ¨ëŒ€ë¡œ */
        object-fit: contain;/* ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
    }
    
    /* =========================================================
       [4] ìš°ì¸¡ ìƒë‹¨ ì¹´í…Œê³ ë¦¬ (íŒì—… ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼)
    ========================================================= */
    .menu-wrapper { 
        position: relative; 
        /* âœ… ë¡œê³  ìœ ë¬´ì™€ ìƒê´€ì—†ì´ ë©”ë‰´ë¥¼ ìš°ì¸¡ ëìœ¼ë¡œ ê³ ì • */
        margin-left: auto;
    }

    .menu-btn {
      background: rgba(255,255,255,0.15); 
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3); 
      color: #fff;
      padding: 8px 16px; 
      border-radius: 20px; 
      font-weight: 600; 
      font-size: 14px;
      cursor: pointer;
      display: flex; align-items: center; gap: 6px;
      /* âœ… ë©”ë‰´ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ íš¨ê³¼ (transition ì¶”ê°€) */
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.1s;
      position: relative; z-index: 101; 
    }
    /* âœ… ë©”ë‰´ ë²„íŠ¼ í´ë¦­ ì‹œ íš¨ê³¼ */
    .menu-btn:active { 
      background: rgba(255,255,255,0.3); 
      transform: scale(0.94);
    }

    /* ë©”ë‰´ ì—´ë¦´ ë•Œ í™”ë©´ ì–´ë‘¡ê²Œ í•´ì£¼ëŠ” ë ˆì´ì–´ */
    .menu-dim {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90;
      backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
      opacity: 0; visibility: hidden; transition: opacity 0.3s;
    }
    body.menu-open .menu-dim { opacity: 1; visibility: visible; }

    /* ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´ ë°•ìŠ¤ */
    .category-dropdown {
      position: absolute; top: calc(100% + 12px); right: 0;
      width: 250px; background: #fff; border-radius: 20px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      padding: 8px; z-index: 100;
      opacity: 0; visibility: hidden; transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      transform-origin: top right;
    }
    body.menu-open .category-dropdown {
      opacity: 1; visibility: visible; transform: translateY(0);
    }

    .dropdown-header {
      font-size: 13px; font-weight: 700; color: var(--text-sub);
      padding: 12px 14px 8px; border-bottom: 1px solid var(--border-light);
      margin-bottom: 4px;
    }

    .drop-nav button {
      width: 100%; text-align: left; background: none; border: none;
      padding: 14px; font-size: 15px; font-weight: 600; color: var(--text-main);
      border-radius: 12px; cursor: pointer; 
      display: flex; align-items: center; gap: 12px;
      /* âœ… ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ íš¨ê³¼ (transition ì¶”ê°€) */
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.1s;
    }
    .drop-nav button span { flex: 1; }
    /* âœ… ì¹´í…Œê³ ë¦¬ í•­ëª© í´ë¦­ ì‹œ ì«€ë“í•œ íš¨ê³¼ */
    .drop-nav button:active { 
      background: #f1f5f9; 
      transform: scale(0.95); 
    }

    /* =========================================================
       [5] ë©”ì¸ ì½˜í…ì¸  (í™˜ì˜ë¬¸êµ¬ & DAY ë²„íŠ¼ë“¤)
    ========================================================= */
    .home-main-content {
      position: relative; z-index: 10;
      flex: 1; 
      display: flex; flex-direction: column; justify-content: flex-end;
      padding: 0 24px 60px; 
      /* âœ… í•˜ë‹¨ ì•ˆì „ì˜ì—­ ëŒ€ì‘ */
      padding-bottom: max(60px, env(safe-area-inset-bottom));
      color: #fff;
    }
    
    .welcome-text { 
      margin-bottom: 30px; 
    }
    .welcome-text p { font-size: 18px; margin: 0; opacity: 0.95; font-weight: 500; letter-spacing: -0.5px; }
    /* âœ… ì´ë¦„ ê¸€ì”¨ ìƒ‰ìƒì„ ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ìƒ´í˜ì¸ ê³¨ë“œ(#e6c27a)ë¡œ ë³€ê²½í•˜ê³  ì‚´ì§ì˜ ê·¸ë¦¼ìë¡œ ê°€ë…ì„±ì„ ë†’ì„ */
    .welcome-text strong { color: #e6c27a; font-weight: 900; font-size: 20px; letter-spacing: -0.5px; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }
    .welcome-text h2 { font-size: 36px; font-weight: 900; margin: 6px 0 12px; line-height: 1.2; letter-spacing: -1px; }
    
    /* ğŸ”¥ [ë‚ ì”¨ ìœ„ì ¯ ë°°ì¹˜] ë‚ ì§œì™€ ë‚ ì”¨ë¥¼ ë‚˜ë€íˆ ë¬¶ëŠ” ë˜í¼ */
    .meta-badges {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .welcome-text .sub-date { 
      display: inline-block; padding: 6px 14px; background: rgba(0,0,0,0.4); border-radius: 20px; font-size: 13px; border: 1px solid rgba(255,255,255,0.1); font-weight: 600;
    }

    /* ğŸ”¥ [ë‚ ì”¨ ìœ„ì ¯ ìŠ¤íƒ€ì¼] ê¸°ì¡´ í…Œë§ˆì™€ ì–´ìš¸ë¦¬ëŠ” ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ë²„íŠ¼ */
    .weather-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s, background 0.1s;
    }
    .weather-badge:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.6);
    }
    .weather-badge strong {
      color: #e6c27a; /* ìƒ´í˜ì¸ ê³¨ë“œ */
      font-size: 14px;
      font-weight: 800;
      letter-spacing: -0.3px;
    }

    /* =========================================================
       ğŸ”¥ğŸ”¥ğŸ”¥ [NEW] ëŒ€ë§Œí’ DAY 1~4 ë²„íŠ¼ ë””ìì¸ ì ìš©
    ========================================================= */
    .day-buttons {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }

    .day-btn {
      /* ëŒ€ë§Œì˜ ë°¤ê±°ë¦¬(í™ë“±) ëŠë‚Œì„ ì‚´ë¦° ë”¥ ë¸Œë¼ìš´/ë ˆë“œí†¤ ê·¸ë¼ë°ì´ì…˜ ì˜¤ë²„ë ˆì´ + ì „í†µ ì°½ì‚´ ë¬´ëŠ¬ íŒ¨í„´ SVG */
      background: linear-gradient(135deg, rgba(40, 15, 15, 0.45) 0%, rgba(10, 10, 15, 0.6) 100%),
                  url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 0L24 12 12 24 0 12 12 0zm0 3.5L3.5 12 12 20.5 20.5 12 12 3.5z' fill='%23c5a059' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");
      background-size: cover, 24px 24px;
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      
      /* í…Œë‘ë¦¬ë¥¼ ì€ì€í•œ ìƒ´í˜ì¸ ê³¨ë“œë¡œ ì£¼ì–´ ê³ ê¸‰ìŠ¤ëŸ¬ì›€ ê·¹ëŒ€í™” */
      border: 1px solid rgba(197, 160, 89, 0.25);
      padding: 16px 16px; 
      border-radius: 16px;
      color: #fff; text-align: left;
      
      /* âœ… DAY ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ íš¨ê³¼ë¥¼ ìœ„í•œ transition ì„¤ì • */
      transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.1s, border-color 0.1s;
      cursor: pointer;
      display: flex; flex-direction: column; justify-content: space-between;
      min-height: 100px;
      position: relative;
      overflow: hidden;
    }

    /* ëŒ€ë§Œ ì „í†µ ë“±ë¶ˆì˜ ë¶‰ì€ë¹›ì´ ë²ˆì§€ëŠ” ë“¯í•œ íš¨ê³¼ (ìƒë‹¨ ìš°ì¸¡) */
    .day-btn::before {
      content: '';
      position: absolute;
      top: -30px;
      right: -30px;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(229, 62, 62, 0.18) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }

    /* ê¸ˆë¹› ë¹› ë²ˆì§ íš¨ê³¼ (í•˜ë‹¨ ì¢Œì¸¡) */
    .day-btn::after {
      content: '';
      position: absolute;
      bottom: -20px;
      left: -20px;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(197, 160, 89, 0.15) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
    }
    
    /* ë‚´ë¶€ í…ìŠ¤íŠ¸ ê²¹ì¹¨ ë°©ì§€ (ë¹›ë²ˆì§ íš¨ê³¼ë³´ë‹¤ ìœ„ë¡œ) */
    .day-btn-header, .day-btn .day-title { 
      position: relative; 
      z-index: 1; 
    }

    /* ë‚ ì§œ ë° ê¸€ì”¨ì²´ ê°€ë…ì„± ê°œì„  ìŠ¤íƒ€ì¼ */
    .day-btn-header { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: 18px; font-weight: 800; }
    
    /* í¬ì¸íŠ¸ ë‚ ì§œ ë°°ì§€ë„ ê³¨ë“œí†¤ í…Œë§ˆì— ì–´ìš¸ë¦¬ê²Œ ë¯¸ì„¸ ì¡°ì • */
    .btn-date { font-size: 12px; font-weight: 700; color: #fef08a; background: rgba(197, 160, 89, 0.2); padding: 2px 8px; border-radius: 10px; letter-spacing: 0; border: 1px solid rgba(197, 160, 89, 0.2); }
    
    .day-btn .day-title { font-size: 13.5px; font-weight: 600; color: #f1f5f9; margin-top: 12px; line-height: 1.4; word-break: keep-all; opacity: 1; }
    
    /* âœ… DAY ë²„íŠ¼ í´ë¦­ ì‹œ ì«€ë“í•œ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
    .day-btn:active { 
      background: linear-gradient(135deg, rgba(50, 20, 20, 0.55) 0%, rgba(20, 20, 25, 0.7) 100%),
                  url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 0L24 12 12 24 0 12 12 0zm0 3.5L3.5 12 12 20.5 20.5 12 12 3.5z' fill='%23c5a059' fill-opacity='0.12' fill-rule='evenodd'/%3E%3C/svg%3E");
      transform: scale(0.94); 
      border-color: rgba(197, 160, 89, 0.5);
    }
    /* ========================================================= */


    /* =========================================================
       [6] Bottom Sheet (Detail Page) - ğŸ”¥ í™”ë©´ ê½‰ ì±„ì›€ ìœ ì§€
    ========================================================= */
    #detailPage {
      position: fixed; inset: 0; z-index: 3000;
      display: none; 
    }
    
    /* pointer-events: none ì¶”ê°€í•˜ì—¬ íˆ¬ëª…í• ë•Œ í´ë¦­ ë°©í•´ ë°©ì§€ */
    .detail-dim {
      position: absolute; inset: 0;
      background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
      opacity: 0; transition: opacity 0.3s ease;
      pointer-events: none; 
    }
    
    .detail-sheet__inner {
      position: absolute; bottom: 0; left: 0; right: 0;
      
      /* âœ… ìˆ˜ì •: ë†’ì´ë¥¼ 100%ë¡œ ë³€ê²½í•˜ì—¬ í™”ë©´ ê½‰ ì±„ì›€ */
      height: 100%; 
      height: 100dvh;
      background: var(--bg-main);
      
      /* âœ… ìˆ˜ì •: ê½‰ ì°¬ í™”ë©´ì´ë¯€ë¡œ ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
      border-radius: 0;
      
      display: flex; flex-direction: column;
      transform: translateY(100%); 
      transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
    }

    body.detail-open .detail-dim { opacity: 1; pointer-events: auto; }
    body.detail-open .detail-sheet__inner { transform: translateY(0); }

    .detail-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px; background: #fff;
      
      /* âœ… ìˆ˜ì •: ë…¸ì¹˜ ì˜ì—­ ëŒ€ì‘ ë° ëª¨ì„œë¦¬ ì œê±° */
      padding-top: max(20px, env(safe-area-inset-top));
      border-radius: 0; 
      
      border-bottom: 1px solid var(--border-light); flex-shrink: 0; 
    }
    .detail-title { font-size: 18px; font-weight: 700; color: var(--primary-color); }
    .detail-actions button {
      background: none; border: none; font-size: 14px; color: var(--text-sub);
      margin-left: 12px; cursor: pointer; font-weight: 600;
    }
    #detailContent {
      flex: 1; overflow-y: auto; padding: 20px 20px calc(20px + var(--safe-bottom));
      -webkit-overflow-scrolling: touch;
    }

    /* =========================================================
       [7] ìƒì„¸ ì»¨í…ì¸  ìŠ¤íƒ€ì¼ (ì¼ì •, í™˜ìœ¨ ë“±)
    ========================================================= */
    .day-card {
      background: var(--card-bg); border-radius: 16px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    }
    .day-card h3 {
      margin: 0 0 10px; font-size: 18px; color: var(--primary-color);
      display: flex; align-items: baseline; gap: 8px; font-weight: 800;
    }
    .day-card h3 span { font-size: 13px; color: var(--text-sub); font-weight: 500; }
    .day-title { margin: 0 0 20px; font-weight: 600; color: var(--accent-color); font-size: 15px; }

    .timeline { border-left: 2px solid var(--border-light); margin-left: 10px; padding-left: 20px; }
    .schedule-item { position: relative; margin-bottom: 24px; }
    .schedule-item:last-child { margin-bottom: 0; }
    .timeline-dot {
      position: absolute; left: -26px; top: 0;
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent-color); border: 2px solid #fff;
    }
    .schedule-card { display: flex; flex-direction: column; gap: 4px; }
    .schedule-time { font-size: 13px; font-weight: 700; color: var(--text-sub); }
    .schedule-title { font-size: 15px; font-weight: 600; color: var(--text-main); }
    .schedule-desc { font-size: 13px; color: var(--text-sub); margin-top: 4px; line-height: 1.4; }

    /* í™˜ìœ¨, ëŒ€ë§Œì˜ ëª¨ë“  ê²ƒ, ë‚ ì”¨ */
    .country-compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .country-card { background: var(--card-bg); padding: 18px 12px; border-radius: 16px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    .country-header { display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 12px; }
    .flag-img { width: 28px; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .country-card h3 { margin: 0; font-size: 15px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary-color); }
    .time-box { background: var(--bg-main); padding: 12px 8px; border-radius: 12px; margin: 12px 0; }
    .time-box .time-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); }
    .time-box strong { display: block; font-size: 17px; color: var(--primary-color); margin-top: 4px; font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: 0; }
    .country-list { list-style: none; padding: 0; margin: 0; text-align: left; font-size: 13px; }
    .country-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 2px; border-bottom: 1px solid var(--border-light); }
    .country-list li:last-child { border: none; padding-bottom: 0; }
    .country-list li span { color: var(--text-sub); font-weight: 600; font-size: 12px; white-space: nowrap; }
    .country-list li strong { font-weight: 700; color: var(--text-main); font-size: 13px; white-space: nowrap; text-align: right; letter-spacing: -0.3px; }

    /* ğŸ”¥ [ì¶”ê°€] ëŒ€ë§Œ ìƒì„¸ ë‚ ì”¨ ë° ì¼ê¸°ì˜ˆë³´ CSS */
    .weather-detail-wrapper { margin-bottom: 20px; }
    .weather-current-row {
      display: flex; justify-content: space-around; align-items: center;
      background: var(--card-bg); border-radius: 16px; padding: 16px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.04); margin-bottom: 12px;
    }
    .w-city { text-align: center; flex: 1; }
    .w-city span { font-size: 12px; color: var(--text-sub); font-weight: 600; display:block; margin-bottom: 4px; }
    .w-city strong { font-size: 20px; font-weight: 800; color: var(--primary-color); display:flex; align-items:center; gap:4px; justify-content:center; }
    .w-vs { color: var(--border-light); font-weight: 300; font-size: 24px; padding: 0 10px; }
    
    .forecast-container { background: var(--card-bg); border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); }
    .forecast-header { font-size: 15px; font-weight: 800; margin-bottom: 14px; color: var(--primary-color); display:flex; justify-content:space-between; align-items:center; }
    .forecast-update { font-size: 11px; color: var(--text-sub); font-weight: 500; }
    .forecast-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
    .forecast-list::-webkit-scrollbar { display: none; }
    .forecast-item { flex: 0 0 auto; width: 72px; background: var(--bg-main); border-radius: 12px; padding: 12px 4px; text-align: center; border: 1px solid var(--border-light); }
    .f-date { font-size: 12px; color: var(--text-sub); font-weight: 700; display:block; margin-bottom: 6px; letter-spacing:-0.5px;}
    .f-icon { font-size: 22px; margin-bottom: 4px; display:block; }
    .f-temp { font-size: 13px; font-weight: 800; color: #e53e3e; display:block; }
    .f-temp-min { font-size: 12px; color: #3182ce; font-weight: 700; display:block; margin-top:2px; }

    .exchange-row {
      background: var(--primary-color); color: #fff; padding: 18px 20px;
      border-radius: 16px; text-align: center; margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(26,35,58,0.15);
    }
    .exchange-row strong { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
    .fx-grid { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-top: 16px;}
    .fx-box input {
      width: 100%; padding: 12px; border: 1px solid var(--border-light);
      border-radius: 10px; text-align: right; font-weight: 600; font-size: 16px;
    }
    .fx-eq { font-size: 20px; color: var(--text-sub); }

    /* ğŸ”¥ [ìˆ˜ì •] 2. ì„ íƒê´€ê´‘ ì‚¬ì§„í˜• ì¹´ë“œ CSS ê°œì„  */
    .tour-card-photo {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      background-color: #000;
      height: 240px; /* ì¹´ë“œê°€ ë„‰ë„‰í•´ ë³´ì´ë„ë¡ ë†’ì´ ì•½ê°„ ì¦ê°€ */
      color: #fff;
    }
    
    .tour-card-bg {
      position: absolute; inset: 0;
      background-size: cover; background-position: center;
      transition: transform 0.4s;
    }
    .tour-card-photo:active .tour-card-bg { transform: scale(1.05); }

    .tour-card-overlay {
      position: absolute; inset: 0;
      /* âœ… ìœ„ìª½(ê¸€ì”¨)ê³¼ ì•„ë˜ìª½(ë°•ìŠ¤) ì–‘ëì„ ì–´ë‘¡ê²Œ ì²˜ë¦¬í•˜ì—¬ ê°€ë…ì„± í™•ë³´ */
      background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.1) 40%, rgba(0,0,0,0.5) 100%);
    }

    /* âœ… .tour-infoê°€ ì „ì²´ ë†’ì´ë¥¼ ì°¨ì§€í•˜ê²Œ í•˜ì—¬ ìœ„/ì•„ë˜ ìš”ì†Œ ë°°ì¹˜ë¥¼ ì»¨íŠ¸ë¡¤ */
    .tour-info {
      position: absolute; inset: 0; z-index: 2;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .tour-badge {
      display: inline-block;
      background: var(--accent-color); color: #fff;
      font-size: 11px; font-weight: 700;
      padding: 4px 10px; border-radius: 100px;
      margin-bottom: 8px; text-transform: uppercase;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .tour-badge.red { background: #e53e3e; } /* ììœ ì¼ì • */

    .tour-info h3 { margin: 0 0 6px; font-size: 22px; font-weight: 800; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .tour-desc { font-size: 13px; opacity: 0.9; margin: 0; line-height: 1.4; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }

    /* âœ… í¬í•¨/ë¶ˆí¬í•¨ ë°•ìŠ¤ (margin-top: autoë¥¼ ì¤˜ì„œ ì¹´ë“œ ë§¨ ì•„ë˜ë¡œ ë°€ì–´ëƒ…ë‹ˆë‹¤) */
    .tour-meta-box {
      margin-top: auto; 
      width: 100%;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border-radius: 12px;
      padding: 10px 14px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px;
    }
    .tour-meta-items { display: flex; gap: 8px; font-size: 12px; }
    .tour-meta-items span { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }

    /* âœ… ì¤‘ì‹ë¹„ ìƒíƒœ ìƒ‰ìƒ CSS ì¶”ê°€ */
    .status.pending { color: #ff4d4f; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .status.done { color: #22c55e; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

    .meal-status-btn {
      background: #fff; color: #1a233a; border: none;
      font-size: 12px; font-weight: 700; padding: 6px 12px; border-radius: 8px;
    }
    .meal-status-btn.done { background: #38a169; color: #fff; }

    #requestInput {
      width: 100%; height: 120px; padding: 16px; border: 1px solid var(--border-light);
      border-radius: 12px; resize: none; font-size: 15px; margin-bottom: 12px;
    }

    /* =========================================================
       [8] ë°ìŠ¤í¬íƒ‘ (PC) ëŒ€ì‘ - ğŸ”¥ ì˜¤ë²„ë¼ì´ë“œ (ì—¬ê¸°ì„œ ëª¨ë“  ë¸Œë¼ìš°ì € í˜¸í™˜ ë° ë””ìì¸ ì™„ì„±)
    ========================================================= */
    @media (min-width: 768px) {
      /* 1. ë©”ì¸ ë ˆì´ì•„ì›ƒ ë° í¬ê¸° ì¡°ì • */
      .home-main-content { 
        max-width: 1000px; 
        margin: 0 auto; 
        width: 100%; 
        padding-bottom: 80px; /* PCëŠ” í•˜ë‹¨ ì—¬ë°±ì„ ì‹œì›í•˜ê²Œ */
      }
      .home-header { 
        max-width: 1000px; 
        margin: 0 auto; 
        width: 100%; 
        padding-top: 30px; /* PCì—ì„œëŠ” ë…¸ì¹˜(env) ì—¬ë°± ë¬´ì‹œí•˜ê³  ê³ ì • ì—¬ë°± */
      }
      
      /* 2. í™˜ì˜ ë¬¸êµ¬ í°íŠ¸ í™•ëŒ€ */
      .welcome-text h2 { font-size: 48px; }
      .welcome-text p { font-size: 20px; }

      /* 3. DAY ë²„íŠ¼ 4ì—´ ìœ ì§€ ë° í¼ì§í•˜ê²Œ ë³€ê²½ */
      .day-buttons { 
        grid-template-columns: repeat(4, 1fr); 
        gap: 16px; 
      }
      .day-btn {
        min-height: 120px;
        padding: 20px;
      }
      .day-btn-header { font-size: 20px; }
      .day-btn .day-title { font-size: 15px; margin-top: 16px; }

      /* 4. ì¹´í…Œê³ ë¦¬ ë©”ë‰´ íŒì—… ì‚¬ì´ì¦ˆ ìµœì í™” */
      .category-dropdown {
        width: 280px; /* PCëŠ” ë§ˆìš°ìŠ¤ ì¡°ì‘ì´ í¸í•˜ê²Œ ì¡°ê¸ˆ ë„“ê²Œ */
        padding: 12px;
      }
      .drop-nav button { font-size: 16px; padding: 16px; }

      /* 5. ë°”í…€ ì‹œíŠ¸ -> ì¤‘ì•™ íŒì—… ëª¨ë‹¬(Modal)ë¡œ ì™„ë²½í•˜ê²Œ ë³€í™˜ */
      .detail-sheet__inner {
        top: 50%; left: 50%;
        bottom: auto; right: auto;
        /* í™”ë©´ ì¤‘ì•™ì—ì„œ ì‚´ì§ ìœ„ì—ì„œ ì•„ë˜ë¡œ ë‚´ë ¤ì˜¤ë©° ë‚˜íƒ€ë‚˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        transform: translate(-50%, -48%) scale(0.95); 
        width: 100%; 
        max-width: 600px; /* PCì—ì„œ ë„ˆë¬´ í¼ì§€ì§€ ì•Šê²Œ íŒì—… ì°½ ê°€ë¡œ ê³ ì • */
        height: 85vh;     /* ë†’ì´ë„ í™”ë©´ì˜ 85% ì •ë„ë¡œ ì œí•œ */
        max-height: 800px; 
        border-radius: 24px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ë³µêµ¬ */
        opacity: 0;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); /* ì…ì²´ê° ë¶€ì—¬ */
        transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.4s;
      }
      body.detail-open .detail-sheet__inner {
        transform: translate(-50%, -50%) scale(1); 
        opacity: 1;
      }

      /* 6. ëª¨ë‹¬ ë‚´ë¶€ í—¤ë” ë° ì—¬ë°± ë³µêµ¬ (PC ë§ì¶¤) */
      .detail-header {
        padding: 24px;
        padding-top: 24px; /* ë…¸ì¹˜ ë¬´ì‹œ */
        border-radius: 24px 24px 0 0; /* ìœ„ìª½ë§Œ ë‘¥ê¸€ê²Œ ë³µêµ¬ */
      }
      #detailContent {
        padding: 24px 24px 40px; /* ìŠ¤í¬ë¡¤ ì—¬ë°± ë„‰ë„‰í•˜ê²Œ */
      }

      /* 7. ìƒì„¸ ì»¨í…ì¸  ë‚´ë¶€ ìš”ì†Œ PC ì‚¬ì´ì¦ˆ ë§ì¶¤ */
      .country-compare-grid { gap: 20px; }
      .tour-card-photo { height: 320px; } /* ì‚¬ì§„ ì¹´ë“œ ë†’ì´ ì¦ê°€ */
      .fx-box input { padding: 16px; font-size: 18px; } /* í™˜ìœ¨ ê³„ì‚°ê¸° ì…ë ¥ì¹¸ í™•ëŒ€ */
    }
  </style>
</head>

<body>
  
<!-- âœ… 1. ìŠ¤í”Œë˜ì‹œ HTML íƒœê·¸ëŠ” ë‚¨ê²¨ë‘ë˜ ì£¼ì„ì²˜ë¦¬í•˜ê±°ë‚˜, JSì—ì„œ ì œì–´í•˜ì§€ ì•ŠìŒ -->
<!-- <div id="mobileSplash" class="mobile-splash" style="display:none;">...</div> -->

<!-- ================= LOGIN ================= -->
<section id="loginSection" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <!-- ğŸ”¥ [ìˆ˜ì •] ë‚´ì¥ ë°ì´í„° ì œê±°í•˜ê³  ë¡œì»¬ ê²½ë¡œ ë³µì› -->
      <img src="assets/images/logo.png" class="hero-logo" onerror="this.style.display='none'">
      <h2>2025 ISC Taiwan</h2>
      <p class="hero-desc">ì‚¬ë²ˆìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>

      <input type="text" id="employeeId" placeholder="ì‚¬ë²ˆ ì…ë ¥">
      <button class="primary-btn" onclick="login()">ë¡œê·¸ì¸</button>
      <p id="loginError" class="error"></p>
    </div>
  </div>
</section>

<!-- ================= MAIN ================= -->
<main id="mainSection" class="main-bg" style="display:none;">

  <!-- ================= HOME VIEW ================= -->
  <section id="homeView" class="home-view">
    <div class="home-overlay"></div>
    
    <!-- ë©”ë‰´ ì—´ë¦´ ë•Œ ì „ì²´ í™”ë©´ì„ ì‚´ì§ ì–´ë‘¡ê²Œ í•´ì£¼ëŠ” ë”¤ -->
    <div id="menuDim" class="menu-dim" onclick="toggleMenu()"></div>
    
    <!-- 1ï¸âƒ£ ìƒë‹¨ í—¤ë” & ë©”ë‰´ ë²„íŠ¼ -->
    <header class="home-header">
      <!-- ğŸ”¥ [ìˆ˜ì •] ì›ë³¸ ë¡œê³ ê°€ ë¬´ì¡°ê±´ 100% ë³´ì´ë„ë¡ ìˆ˜ì • (ì—ëŸ¬ ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬ ë° í•„í„°ë§ ì œê±°) -->
      <img src="assets/images/logo.png" class="header-logo" alt="INCAR Logo">
      
      <!-- ìš°ì¸¡ ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ë¬¶ìŒ -->
      <div class="menu-wrapper">
        <button class="menu-btn" onclick="toggleMenu()">â˜° ì¹´í…Œê³ ë¦¬</button>
        
        <!-- ë²„íŠ¼ ëˆ„ë¥´ë©´ ì•„ë˜ë¡œ ë–¨ì–´ì§€ëŠ” ë“œë¡­ë‹¤ìš´ íŒì—… ë©”ë‰´ -->
        <div id="categoryDropdown" class="category-dropdown">
          <div class="dropdown-header">ì¹´í…Œê³ ë¦¬ ë©”ë‰´</div>
          <nav class="drop-nav">
            <button onclick="openPage('taiwan')">ğŸ‡¹ğŸ‡¼ <span>ëŒ€ë§Œì˜ ëª¨ë“  ê²ƒ</span></button>
            <button onclick="openPage('exchange')">ğŸ’± <span>í™˜ìœ¨ ê³„ì‚°ê¸°</span></button>  
            <button onclick="openPage('flight')">âœˆï¸ <span>í•­ê³µí¸ ì •ë³´</span></button>
            <button onclick="openPage('myTour')">ğŸ’ <span>ë‚˜ì˜ ì„ íƒ ê´€ê´‘</span></button>
            <button onclick="openPage('dinner')">ğŸ½ <span>ë§Œì°¬ ì•ˆë‚´</span></button>
            <button onclick="openPage('contact')">ğŸ“ <span>ê¸´ê¸‰ ì—°ë½ë§</span></button>
            <!-- âœ… [ìˆ˜ì •] 2. ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì¶”ê°€ -->
            <button onclick="logout()" style="border-top:1px solid #eee; margin-top:4px; color:#e53e3e;">ğŸšª <span>ë¡œê·¸ì•„ì›ƒ</span></button>
          </nav>
        </div>
      </div>
    </header>

    <!-- 2ï¸âƒ£ ë©”ì¸ ì¤‘ì•™ ì˜ì—­ (í™˜ì˜ ë¬¸êµ¬ + DAY ë²„íŠ¼) -->
    <div class="home-main-content">
      <div class="welcome-text">
        <p><strong id="employeeName"></strong> ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤</p>
        <h2>ISC Taiwan<br>ì—¬ì •ì˜ ì‹œì‘</h2>
        
        <!-- ğŸ”¥ [ë‚ ì”¨ ìœ„ì ¯ ì¶”ê°€] ì—¬í–‰ ë‚ ì§œ ì˜†ì— ë°°ì¹˜í•˜ì—¬ ë ˆì´ì•„ì›ƒ ìœ ì§€ -->
        <div class="meta-badges">
          <span class="sub-date">2026.03.11 ~ 03.14</span>
          <!-- í´ë¦­ ì‹œ ëŒ€ë§Œì˜ ëª¨ë“  ê²ƒ(taiwan) í˜ì´ì§€ë¡œ ì´ë™ -->
          <button class="weather-badge" onclick="openPage('taiwan')" id="homeWeather">
            â³ ë‚ ì”¨ ì—°ë™ì¤‘...
          </button>
        </div>
      </div>

      <div class="day-buttons">
        <button class="day-btn" onclick="openPage('day_0')">
          <div class="day-btn-header">DAY 1 <span class="btn-date">03.11</span></div>
          <span class="day-title">ì¸ì²œ ì¶œë°œ &<br>ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸</span>
        </button>
        <button class="day-btn" onclick="openPage('day_1')">
          <div class="day-btn-header">DAY 2 <span class="btn-date">03.12</span></div>
          <span class="day-title">ì„ íƒ ê´€ê´‘ &<br>ISC ê³µì‹ ë§Œì°¬</span>
        </button>
        <button class="day-btn" onclick="openPage('day_2')">
          <div class="day-btn-header">DAY 3 <span class="btn-date">03.13</span></div>
          <span class="day-title">ê·¼êµ ê´€ê´‘ &<br>ììœ  ì¼ì •</span>
        </button>
        <button class="day-btn" onclick="openPage('day_3')">
          <div class="day-btn-header">DAY 4 <span class="btn-date">03.14</span></div>
          <span class="day-title">íƒ€ì´ë² ì´ ì¶œë°œ &<br>ì¸ì²œ ê·€êµ­</span>
        </button>
      </div>
    </div>
  </section>

<!-- ================= DETAIL OVERLAY ================= -->
<section id="detailPage" class="detail-sheet">
  <!-- ğŸ”¹ dim ì˜ì—­ (ì—¬ê¸°ë§Œ í™ˆìœ¼ë¡œ) -->
  <div class="detail-dim" onclick="goHome()"></div>

  <!-- ğŸ”¹ ì‹¤ì œ ì‹œíŠ¸ -->
  <div class="detail-sheet__inner" onclick="event.stopPropagation()">
      <!-- âœ… ìƒë‹¨ í—¤ë” -->
      <div class="detail-header">
        <div class="detail-title" id="detailTitle"></div>
        <div class="detail-actions">
          <button class="btn-home" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
          <button class="btn-back" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
        </div>
      </div>
    <div id="detailContent"></div>
  </div>
</section>

</main>

<script>
/* ================= ê³µí†µ ================= */
let pageHistory = [];
let employees = [];
let currentUser = null;
const ADMIN_PASSWORD = "0000";
    
/* ================= ì¹´í…Œê³ ë¦¬ ë©”ë‰´ í† ê¸€ ================= */
function toggleMenu() {
  document.body.classList.toggle('menu-open');
}

/* ================= ì„ íƒê´€ê´‘ í…œí”Œë¦¿ (ğŸ”¥ ìˆ˜ì • 2. ì‚¬ì§„ ì¹´ë“œ ë””ìì¸ ì ìš©) ================= */
/* ì´ë¯¸ì§€ ê²½ë¡œëŠ” assets/images/ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡ì•˜ìœ¼ë©°, ì—†ì„ ê²½ìš° Unsplash ì´ë¯¸ì§€ê°€ ëœ¨ë„ë¡ onerrorë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤. */
const myTourTemplates = [
  { 
    keyword: "í‹°ì—”ë¼ì´", 
    html: `
      <div class="tour-card-photo">
        <div class="tour-card-bg" style="background-image: url('assets/images/tour_tienlai.jpg');" onerror="this.style.backgroundImage='url(https://images.unsplash.com/photo-1596483582098-9642e12e84d4?auto=format&fit=crop&w=800&q=80)'"></div>
        <div class="tour-card-overlay"></div>
        <div class="tour-info">
          <span class="tour-badge">ì„ íƒ 1ì•ˆ</span>
          <h3>í‹°ì—”ë¼ì´ ì˜¨ì²œ íë§</h3>
          <p class="tour-desc">í‹°ì—”ë¼ì´ ì˜¨ì²œìš• & ì–‘ëª…ì‚° êµ­ë¦½ê³µì› ìë½ì˜ ìµœê³ ê¸‰ ìœ í™© ì˜¨ì²œ</p>
          <div class="tour-meta-box">
            <div class="tour-meta-items">
              <span>ğŸ« ì…ì¥ê¶Œ</span>
              <span>ğŸšŒ ì „ìš©ì°¨ëŸ‰</span>
              <span>ğŸ½ ì¤‘ì‹(ì˜¤ë¦¬)</span>
            </div>
          </div>
        </div>
      </div>` 
  },
  { 
    keyword: "ê³ ê¶ë°•ë¬¼ê´€", 
    html: `
      <div class="tour-card-photo">
        <div class="tour-card-bg" style="background-image: url('assets/images/tour_museum.jpg');" onerror="this.style.backgroundImage='url(https://images.unsplash.com/photo-1590059390231-fb264f3d47fb?auto=format&fit=crop&w=800&q=80)'"></div>
        <div class="tour-card-overlay"></div>
        <div class="tour-info">
          <span class="tour-badge">ì„ íƒ 2ì•ˆ</span>
          <h3>ê³ ê¶ë°•ë¬¼ê´€ ì—­ì‚¬ ê¸°í–‰</h3>
          <p class="tour-desc">ì¤‘êµ­ ì—­ì‚¬ì˜ ì •ìˆ˜, ëŒ€ë§Œ ê³ ê¶ë°•ë¬¼ê´€ ê´€ëŒ</p>
          <div class="tour-meta-box">
            <div class="tour-meta-items">
              <span>ğŸ« ì…ì¥ê¶Œ</span>
              <span>ğŸšŒ ì „ìš©ì°¨ëŸ‰</span>
              <span>ğŸ½ ì¤‘ì‹(ì˜¤ë¦¬)</span>
            </div>
          </div>
        </div>
      </div>` 
  },
  { 
    keyword: "ììœ ì¼ì •", 
    html: `
      <div class="tour-card-photo">
        <div class="tour-card-bg" style="background-image: url('assets/images/tour_free.jpg');" onerror="this.style.backgroundImage='url(https://images.unsplash.com/photo-1470004914212-05527e49370b?auto=format&fit=crop&w=800&q=80)'"></div>
        <div class="tour-card-overlay"></div>
        <div class="tour-info">
          <span class="tour-badge red">ì„ íƒ 3ì•ˆ</span>
          <h3>ììœ ë¡œìš´ ëŒ€ë§Œ ì—¬í–‰</h3>
          <p class="tour-desc">ììœ ì¼ì • ëŒ€ë§Œ (ì¤‘ì‹ë¹„ ì§€ê¸‰)</p>
          <div class="tour-meta-box">
             <div class="meal-check" data-tour="ììœ ì¼ì •" style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                <!-- âœ… ê³ ì •ëœ í°ìƒ‰ ê¸€ì”¨ë¥¼ ì§€ìš°ê³  CSS í´ë˜ìŠ¤ë¥¼ í†µí•´ ìƒ‰ìƒ ì œì–´ -->
                <span class="status pending">ì¤‘ì‹ë¹„ ë¯¸ì§€ê¸‰</span>
                <button class="meal-status-btn" onclick="handleMealClick(this)">ì§€ê¸‰ í™•ì¸</button>
             </div>
          </div>
        </div>
      </div>` 
  }
];

/* ================= ì„ íƒê´€ê´‘ ë Œë”ë§ í•¨ìˆ˜ ================= */
function renderMyTour() {
  const selected = currentUser.myTour || [];
  const matchedCards = myTourTemplates.filter(t => selected.some(input => input.includes(t.keyword)));
  if (matchedCards.length === 0) return `<div class="card">ì„ íƒëœ ê´€ê´‘ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  return matchedCards.map(t => t.html).join("");
}

// ë¡œì»¬ íŒŒì¼ ì‹œë„ í›„ ì‹¤íŒ¨í•˜ë©´ ìœ„ ë°ì´í„° ì‚¬ìš©
fetch("people/employees.json?ts=" + Date.now())
  .then(res => res.json())
  .then(data => {
    employees = data;
    tryAutoLogin(); 
  })
  .catch(err => {
    console.warn("ë¡œì»¬ JSON ë¡œë“œ ì‹¤íŒ¨, ë‚´ì¥ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
    employees = EMBEDDED_EMPLOYEES;
    tryAutoLogin();
  });

/* ================= ì¤‘ì‹ë¹„ ì§€ê¸‰ ë¡œì§ ================= */
function handleMealClick(btn) {
  const wrap = btn.closest(".meal-check");
  const tour = wrap.dataset.tour;
  const isDone = wrap.classList.contains("done");
  if (isDone) showMealDetail(wrap);
  else approveMeal(wrap, tour);
}

function approveMeal(wrap, tour) {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if (pw !== ADMIN_PASSWORD) { alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
  const time = nowKSTString();
  setMealUI(wrap, "DONE", time);
  saveMealPaid(currentUser.id, tour, time);
  logMealPaymentToSheet({ action: "APPROVE", tour, time });
}

function setMealUI(wrap, mode, time = "") {
  const status = wrap.querySelector(".status");
  const btn = wrap.querySelector("button");
  if (mode === "DONE") {
    wrap.classList.add("done");
    status.textContent = "ì§€ê¸‰ ì™„ë£Œ";
    status.classList.remove("pending"); status.classList.add("done");
    wrap.dataset.time = time; btn.textContent = "ì§€ê¸‰ í™•ì¸";
  } else {
    wrap.classList.remove("done");
    status.textContent = "ì¤‘ì‹ë¹„ ë¯¸ì§€ê¸‰";
    status.classList.add("pending"); status.classList.remove("done");
    wrap.dataset.time = ""; btn.textContent = "ì§€ê¸‰ í™•ì¸";
  }
}
    
function mealKey(userId, tour) { return `mealPaid_${userId}_${tour}`; }
function saveMealPaid(userId, tour, time) { localStorage.setItem(mealKey(userId, tour), JSON.stringify({ time })); }
function loadMealPaid(userId, tour) { const raw = localStorage.getItem(mealKey(userId, tour)); return raw ? JSON.parse(raw) : null; }
function removeMealPaid(userId, tour) { localStorage.removeItem(mealKey(userId, tour)); }

function showMealDetail(wrap) {
  const time = wrap.dataset.time;
  const pw = prompt(`ì§€ê¸‰ ì™„ë£Œ ì‹œê°\n${time}\n\nì·¨ì†Œí•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥\n(í™•ì¸ë§Œ ë³´ë ¤ë©´ ì·¨ì†Œ)`);
  if (!pw) return;
  if (pw !== ADMIN_PASSWORD) { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); return; }
  if (confirm("ì§€ê¸‰ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    const tour = wrap.dataset.tour;
    const cancelTime = nowKSTString();
    setMealUI(wrap, "PENDING");
    removeMealPaid(currentUser.id, tour);
    logMealPaymentToSheet({ action: "CANCEL", tour, time: cancelTime });
  }
}

function nowKSTString() {
  return new Intl.DateTimeFormat("ko-KR", { timeZone: "Asia/Seoul", year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit" }).format(new Date());
}

const MEAL_SHEET_URL = "https://script.google.com/macros/s/AKfycbx2tVkT00Z8uXQWl6EeTIUUhZ3_NJHx3JDqSCHC5oJWkUCm0OtcTmaV6g20cNKoh0no9w/exec";

function logMealPaymentToSheet(payload) {
  if (!currentUser) return;
  fetch(MEAL_SHEET_URL, {
    method: "POST", mode: "no-cors",
    body: JSON.stringify({ type: "meal", id: currentUser.id, name: currentUser.name, action: payload.action, tour: payload.tour, time: payload.time })
  }).catch(console.error);
}

/* ================= WMO ë‚ ì”¨ ì½”ë“œ -> ì´ëª¨ì§€ ë³€í™˜ í•¨ìˆ˜ ================= */
function getWeatherEmoji(code) {
  if (code === 0) return "â˜€ï¸"; 
  if (code >= 1 && code <= 3) return "â›…"; 
  if (code >= 45 && code <= 48) return "ğŸŒ«ï¸"; 
  if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) return "ğŸŒ§ï¸"; 
  if (code >= 71 && code <= 77) return "â„ï¸"; 
  if (code >= 85 && code <= 86) return "â„ï¸"; /* ì¶”ê°€ëœ ëˆˆë³´ë¼ ì²˜ë¦¬ */
  if (code >= 95 && code <= 99) return "â›ˆï¸"; /* 96, 99 í­í’ìš° ì²˜ë¦¬ ë³´ê°• */
  return "â˜ï¸";
}

/* ================= ğŸ”¥ ì‹¤ì‹œê°„ ë‚ ì”¨ ì—°ë™ (ìºì‹œ ì™„ë²½ ì œê±°) ================= */
async function fetchTaipeiWeather() {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=25.0330&longitude=121.5654&current=temperature_2m,weather_code&timezone=Asia%2FTaipei&_t=${Date.now()}`;
    // ìºì‹œë¥¼ ì ˆëŒ€ íƒ€ì§€ ì•Šë„ë¡ ê°•ì œ ì„¤ì •
    const res = await fetch(url, { cache: "no-store" });
    const data = await res.json();
    const temp = Math.round(data.current.temperature_2m);
    const code = data.current.weather_code;
    const icon = getWeatherEmoji(code);

    const badge = document.getElementById("homeWeather");
    if (badge) badge.innerHTML = `${icon} íƒ€ì´ë² ì´ <strong>${temp}Â°C</strong>`;
  } catch(e) {
    console.error("ë‚ ì”¨ ì •ë³´ ì—°ë™ ì‹¤íŒ¨", e);
    const badge = document.getElementById("homeWeather");
    if (badge) badge.innerHTML = `â˜ï¸ ë‚ ì”¨ ì •ë³´ ì—†ìŒ`;
  }
}

async function renderDetailedWeather() {
  try {
    // ì„œìš¸ ì‹¤ì‹œê°„ (ìºì‹œ ë°©ì§€ ë° íƒ€ì„ì¡´ ê³ ì •)
    const resSeoul = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current=temperature_2m,weather_code&timezone=Asia%2FSeoul&_t=${Date.now()}`, { cache: "no-store" });
    const dataSeoul = await resSeoul.json();
    const seoulTemp = Math.round(dataSeoul.current.temperature_2m);
    const seoulIcon = getWeatherEmoji(dataSeoul.current.weather_code);
    
    // íƒ€ì´ë² ì´ ì‹¤ì‹œê°„ + ì£¼ê°„ (ìºì‹œ ë°©ì§€ ë° íƒ€ì„ì¡´ ê³ ì •)
    const resTaipei = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=25.0330&longitude=121.5654&current=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTaipei&forecast_days=5&_t=${Date.now()}`, { cache: "no-store" });
    const dataTaipei = await resTaipei.json();
    const taipeiTemp = Math.round(dataTaipei.current.temperature_2m);
    const taipeiIcon = getWeatherEmoji(dataTaipei.current.weather_code);

    const elSeoul = document.getElementById("seoulTempDetail");
    const elTaipei = document.getElementById("taipeiTempDetail");
    const elUpdate = document.getElementById("weatherUpdateTime");
    
    if(elSeoul) elSeoul.innerHTML = `${seoulIcon} ${seoulTemp}Â°C`;
    if(elTaipei) elTaipei.innerHTML = `${taipeiIcon} ${taipeiTemp}Â°C`;
    
    // ìƒˆë¡œê³ ì¹¨ í–ˆë‹¤ëŠ” ê²ƒì„ ëˆˆìœ¼ë¡œ ì¦‰ì‹œ ë³¼ ìˆ˜ ìˆê²Œ "ì´ˆ ë‹¨ìœ„"ê¹Œì§€ í‘œì‹œ
    const now = new Date();
    const timeStr = new Intl.DateTimeFormat("ko-KR", { hour: "2-digit", minute: "2-digit", second: "2-digit" }).format(now);
    if(elUpdate) elUpdate.textContent = `ì˜¤ëŠ˜ ${timeStr} ê¸°ì¤€`;

    const daily = dataTaipei.daily;
    const forecastHtml = daily.time.slice(0, 5).map((dateStr, idx) => {
      // Date ê°ì²´ ìƒì„± ì‹œ ë¬¸ìì—´ì„ ì˜ë¼ì„œ ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ê°•ì œ ìƒì„± (í•˜ë£¨ ë°€ë¦¼ í˜„ìƒ ë°©ì§€)
      const parts = dateStr.split("-");
      const d = new Date(parts[0], parts[1] - 1, parts[2]);
      
      const days = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      const isToday = (idx === 0);
      
      const dateTxt = isToday ? "ì˜¤ëŠ˜" : `${d.getMonth()+1}.${d.getDate()} (${days[d.getDay()]})`;
      
      const max = Math.round(daily.temperature_2m_max[idx]);
      const min = Math.round(daily.temperature_2m_min[idx]);
      const icon = getWeatherEmoji(daily.weather_code[idx]);
      
      return `
        <div class="forecast-item" style="${isToday ? 'border:1px solid var(--accent-color); background:rgba(197, 160, 89, 0.05);' : ''}">
          <span class="f-date" style="${isToday ? 'color:var(--accent-color); font-weight:800;' : ''}">${dateTxt}</span>
          <span class="f-icon">${icon}</span>
          <span class="f-temp">${max}Â°</span>
          <span class="f-temp-min">${min}Â°</span>
        </div>
      `;
    }).join("");

    const fList = document.getElementById("forecastList");
    if(fList) fList.innerHTML = forecastHtml;

  } catch(e) {
    console.error("Detailed weather fetch failed", e);
    const fList = document.getElementById("forecastList");
    if(fList) fList.innerHTML = `<div style="padding:10px; font-size:12px; color:var(--text-sub);">ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
  }
}

// ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œ í™ˆí™”ë©´ ë‚ ì”¨ ë°”ë¡œ í˜¸ì¶œ
fetchTaipeiWeather();
    
/* ================= ë¡œê·¸ì¸ (ìŠ¤í”Œë˜ì‹œ ì‚­ì œ) ================= */
function login() {
  const id = document.getElementById("employeeId").value.trim();
  const user = employees.find(e => e.id === id);

  if (!user) {
    document.getElementById("loginError").textContent = "ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.";
    return;
  }

  currentUser = user;

  // ë¡œê·¸ì¸ í™”ë©´ ì œê±°
  document.getElementById("loginSection").style.display = "none";

  // ğŸ“± ëª¨ë°”ì¼: ìŠ¤í”Œë˜ì‹œ ì—†ì´ ì¦‰ì‹œ ë©”ì¸ìœ¼ë¡œ ì§„ì…í•˜ë„ë¡ ìˆ˜ì •
  document.getElementById("mainSection").style.display = "block";

  document.getElementById("employeeName").textContent = user.name;
  document.body.classList.add("logged-in");
}

/* ================= ë¡œê·¸ì•„ì›ƒ ================= */
function logout() {
  if(!confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  
  currentUser = null;
  document.body.classList.remove("logged-in");
  document.body.classList.remove("menu-open");
  
  // ë©”ì¸ ìˆ¨ê¸°ê³  ë¡œê·¸ì¸ í™”ë©´ ë³´ì´ê¸°
  document.getElementById("mainSection").style.display = "none";
  document.getElementById("loginSection").style.display = "block";
  document.getElementById("employeeId").value = "";
  
  // ì—´ë ¤ìˆëŠ” ìƒì„¸í˜ì´ì§€ ë‹«ê¸°
  goHome(); 
}

function tryAutoLogin() {
  const params = new URLSearchParams(window.location.search);
  const eid = params.get("eid");

  if (!eid) return;

  // inputì— ì‚¬ë²ˆ ì£¼ì…
  const input = document.getElementById("employeeId");
  if (input) input.value = eid;

  const user = employees.find(e => String(e.id) === String(eid));
  if (!user) {
    document.getElementById("loginError").textContent = "QR ì‚¬ë²ˆì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }

  // ğŸ”¥ ì—¬ê¸°ì„œ ë
  login();
}

/* ================= ì—¬í–‰ ì¼ì • ë°ì´í„° ================= */
const travelSchedule = [
  {
    day: "DAY 1", date: "2026.03.11 (ìˆ˜)", title: "ì¸ì²œ â†’ íƒ€ì´ë² ì´ / ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸",
    items: [
      { time:"08:00/9:00", icon:"âœˆï¸", title:"ì¸ì²œ êµ­ì œê³µí•­ ì¶œë°œ", desc:"OZ 711 / KE 2021" },
      { time:"12:30/13:30", icon:"ğŸœ", title:"ì¤‘ì‹ | ìš°ìœ¡ë©´", desc:"í˜„ì§€ ì¸ê¸° ì¤‘ì‹ë‹¹" },
      { time:"13:30/14:30", icon:"ğŸ›ï¸", title:"ë‹¨ìˆ˜ì´ ì˜›ê±°ë¦¬/í™ë§ˆì˜¤ì²­/ì§„ë¦¬ëŒ€í•™", desc:"í™ë§ˆì˜¤ì²­Â·ì˜›ê±°ë¦¬ ê´€ê´‘" },
      { time:"16:30/17:30", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì¸", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"18:00/18:30", icon:"ğŸ½ï¸", title:"ì„ì‹ | íƒ€ì¹´ì˜¤ ìƒ¤ë¸Œìƒ¤ë¸Œ", desc:"ë¬´ì œí•œ ìƒ¤ë¸Œìƒ¤ë¸Œ" },
      { time:"19:30/20:00", icon:"ğŸŒƒ", title:"íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€", desc:"ì•¼ê²½ ê´€ëŒ" },
      { time:"21:00/21:30", icon:"ğŸ¨", title:"í˜¸í…”ë³µê·€", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" }
    ]
  },
  {
    day: "DAY 2", date: "2026.03.12 (ëª©)", title: "ì„ íƒ ê´€ê´‘ / ë§Œì°¬",
    items: [
      { time:"08:30/9:00", icon:"ğŸšŒ", title:"ì„ íƒ ê´€ê´‘", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"08:30", icon:"ğŸšŒ", title:"í‹°ì—”ë¼ì´ ì˜¨ì²œ", desc:"ì„ íƒ 1ì•ˆ" },
      { time:"9:00", icon:"ğŸ›ï¸", title:"ê³ ê¶ë°•ë¬¼ê´€", desc:"ì„ íƒ 2ì•ˆ" },
      { time:"13:00", icon:"ğŸ½ï¸", title:"ì¤‘ì‹", desc:"ë² ì´ì§•ë•" },
      { time:"14:30", icon:"ğŸ›ï¸", title:"ì„œë¬¸ì •", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"08:30/9:00", icon:"ğŸ§­", title:"ììœ ì‹œê°„", desc:"ì¤‘ì‹ë¹„ ì§€ê¸‰" },
      { time:"18:00", icon:"ğŸ‰", title:"ISC ë§Œì°¬", desc:"í•„ìˆ˜ ì°¸ì„" }
    ]
  },
  {
    day: "DAY 3", date: "2026.03.13 (ê¸ˆ)", title: "ê·¼êµ ê´€ê´‘",
    items: [
      { time:"10:00", icon:"ğŸ¨ğŸ½ï¸", title:"í˜¸í…” ì¡°ì‹ í›„ ì¶œë°œ", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"11:00", icon:"ğŸŒŠ", title:"ì•¼ë¥˜ í•´ìƒê³µì›", desc:"ê¸°ì•”ê´´ì„ ê´€ê´‘" },
      { time:"12:30", icon:"ğŸ¦", title:"ì¤‘ì‹ : ì”¨í‘¸ë“œ", desc:"í˜„ì§€ í•´ì‚°ë¬¼ íŠ¹ì‹" },
      { time:"14:30", icon:"ğŸ®", title:"ìŠ¤í€ ì²œë“±ë‚ ë¦¬ê¸°", desc:"ì†Œì›ì²œë“± ë‚ ë¦¬ê¸°" },
      { time:"17:00", icon:"ğŸ®", title:"ì§€ìš°í€ ì•¼ê²½", desc:"í™ë“±ë§ˆì„" },
      { time:"20:00", icon:"ğŸŒŠ", title:"ì•¼ì‹œì¥ ë° ì„ì‹", desc:"ì•¼ì‹œì¥ ììœ ì‹ ë° ì‡¼í•‘" },
      { time:"21:30", icon:"ğŸ¨", title:"í˜¸í…”ë³µê·€", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"ì „ì¼", icon:"ğŸ§­", title:"ììœ ì¼ì • ì„ íƒì‹œ", desc:"ì „ì²´ ê°œì¸ë¶€ë‹´(ì¤‘ì‹ë¹„ ì§€ê¸‰ X)" }
    ]
  },
  {
    day: "DAY 4", date: "2026.03.14 (í† )", title: "ê·€êµ­",
    items: [
      { time:"08:00/9:00", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì•„ì›ƒ", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"11:40/12:25", icon:"âœˆï¸", title:"íƒ€ì´ë² ì´ ì¶œë°œ", desc:"OZ 712 / KE 2022" },
      { time:"15:25/15:50", icon:"ğŸ‡°ğŸ‡·", title:"ì¸ì²œ ë„ì°©", desc:"ISC in Taiwan" }
    ]
  }
];
    
function normalizeTime(t) {
  const s = String(t).trim();
  const m = s.match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return s;
  return `${String(m[1]).padStart(2, "0")}:${m[2]}`;
}

function pickTimeByAirline(timeStr, airline) {
  const parts = String(timeStr).split("/").map(s => normalizeTime(s));
  if (parts.length === 1) return parts[0];
  const isKoreanAir = String(airline || "").includes("ëŒ€í•œí•­ê³µ");
  return isKoreanAir ? parts[parts.length - 1] : parts[0];
}

function buildDay2ItemsForUser(user, userAirline) {
  const tours = user?.myTour || [];
  const hasTienlai = tours.some(v => String(v).includes("í‹°ì—”ë¼ì´"));
  const hasGugung  = tours.some(v => String(v).includes("ê³ ê¶ë°•ë¬¼ê´€"));
  const hasFree    = tours.some(v => String(v).includes("ììœ ì¼ì •"));

  const day2 = travelSchedule.find(d => d.day === "DAY 2");
  const items = day2?.items || [];
  const byTitle = (title) => items.find(x => x.title === title);

  const itemSelect = byTitle("ì„ íƒ ê´€ê´‘");
  const itemTienlai = byTitle("í‹°ì—”ë¼ì´ ì˜¨ì²œ");
  const itemGugung  = byTitle("ê³ ê¶ë°•ë¬¼ê´€");
  const itemLunch   = byTitle("ì¤‘ì‹");
  const itemXimen   = byTitle("ì„œë¬¸ì •");
  const itemFree    = byTitle("ììœ ì‹œê°„");
  const itemDinner  = byTitle("ISC ë§Œì°¬");

  if (hasTienlai && hasGugung && hasFree) return [...(itemSelect ? [itemSelect] : []), ...(itemLunch ? [itemLunch] : []), ...(itemXimen ? [itemXimen] : []), ...(itemDinner ? [itemDinner] : [])];
  if (hasFree && !hasTienlai && !hasGugung) return [...(itemFree ? [itemFree] : []), ...(itemDinner ? [itemDinner] : [])];
  if (hasTienlai) return [...(itemTienlai ? [itemTienlai] : []), ...(itemLunch ? [itemLunch] : []), ...(itemXimen ? [itemXimen] : []), ...(itemDinner ? [itemDinner] : [])];
  if (hasGugung) return [...(itemGugung ? [itemGugung] : []), ...(itemLunch ? [itemLunch] : []), ...(itemXimen ? [itemXimen] : []), ...(itemDinner ? [itemDinner] : [])];
  
  return [...(itemSelect ? [itemSelect] : []), ...(itemDinner ? [itemDinner] : [])];
}

function pickFlightDescByAirline(desc, airline) {
  const s = String(desc || "");
  if (!s.includes("/")) return s;
  const isKoreanAir = String(airline || "").includes("ëŒ€í•œí•­ê³µ");
  const parts = s.split("/").map(v => v.trim()); 
  return isKoreanAir ? (parts[1] || s) : (parts[0] || s);
}

/* ================= í˜ì´ì§€ ì˜¤í”ˆ ë¡œì§ (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì¶”ê°€ ë°˜ì˜) ================= */
function openPage(type, fromHistory = false) {
  document.body.classList.remove('menu-open'); // ë©”ë‰´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°

  const userAirline = currentUser?.flight?.departure?.airline || ""; 
  
  // í° ìì²´ ë’¤ë¡œê°€ê¸°ë¥¼ ìœ„í•œ History pushState ì¶”ê°€
  if (!fromHistory) {
    pageHistory.push(type);
    history.pushState({ page: type }, "", "");
  }

  const detail = document.getElementById("detailPage");
  detail.style.display = "block";
  requestAnimationFrame(() => { document.body.classList.add("detail-open"); });

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  // âœ… DAY 1 ~ 4 ë²„íŠ¼ ì²˜ë¦¬ (í”„ë¦¬ë¯¸ì—„ ë””ìì¸ ì ìš©ë¶€)
  if (type.startsWith("day_")) {
    const idx = parseInt(type.split("_")[1]);
    const day = travelSchedule[idx];
    t.textContent = `ğŸ—“ ${day.day} ì¼ì •`;

    const items = (day.day === "DAY 2") ? buildDay2ItemsForUser(currentUser, userAirline) : day.items;

    c.innerHTML = `
      <div class="detail-content-wrap">
        <div class="day-card">
          <h3>${day.day} <span>${day.date}</span></h3>
          <p class="day-title">${day.title}</p>
          <div class="timeline">
            ${items.map(i => `
              <div class="schedule-item">
                <div class="timeline-dot"></div>
                <div class="schedule-card">
                  <div class="schedule-time">${pickTimeByAirline(i.time, userAirline)}</div>
                  <div class="schedule-body">
                    <div class="schedule-title">${i.icon} ${i.title}</div>
                    ${i.desc ? `<div class="schedule-desc">${pickFlightDescByAirline(i.desc, userAirline)}</div>` : ""}
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      </div>
    `;
    return;
  }

  // ë©”ë‰´ ì²˜ë¦¬
  if (type === "flight") {
    const dep = currentUser.flight.departure;
    const ret = currentUser.flight.return;
    t.textContent = "âœˆï¸ í•­ê³µí¸ ì •ë³´";
    c.innerHTML = `
      <div class="detail-content-wrap">
        <div class="day-card"><h3>ì¶œêµ­í¸</h3><div class="schedule-item"><div class="schedule-card"><div class="schedule-time">${dep.time}</div><div class="schedule-body"><div class="schedule-title">âœˆï¸ ${dep.from} â†’ ${dep.to}</div><div class="schedule-desc">${dep.airline} ${dep.flightNo}</div><div class="schedule-desc">${dep.date}</div></div></div></div></div>
        <div class="day-card"><h3>ê·€êµ­í¸</h3><div class="schedule-item"><div class="schedule-card"><div class="schedule-time">${ret.time}</div><div class="schedule-body"><div class="schedule-title">ğŸ  ${ret.from} â†’ ${ret.to}</div><div class="schedule-desc">${ret.airline} ${ret.flightNo}</div><div class="schedule-desc">${ret.date}</div></div></div></div></div>
      </div>`;
  }

  if (type === "myTour") {
    t.textContent = "ğŸ’ ë‚˜ì˜ ì„ íƒ ê´€ê´‘";
    c.innerHTML = `<div class="detail-content-wrap"><div class="mytour-wrap">${renderMyTour()}</div></div>`;
    setTimeout(() => {
      const wrap = document.querySelector('.meal-check[data-tour="ììœ ì¼ì •"]');
      if (!wrap) return;
      syncMealStatusFromServer(currentUser.id, "ììœ ì¼ì •", wrap);
      const saved = loadMealPaid(currentUser.id, "ììœ ì¼ì •");
      if (!wrap.classList.contains("done") && saved?.time) setMealUI(wrap, "DONE", saved.time);
    }, 0);
  }

  if (type === "taiwan") {
    t.textContent = "ğŸ‡¹ğŸ‡¼ ëŒ€ë§Œì˜ ëª¨ë“  ê²ƒ";
    c.innerHTML = `
      <div class="detail-content-wrap">
        <div class="country-compare-grid">
          <!-- ëŒ€í•œë¯¼êµ­ -->
          <div class="country-card">
            <div class="country-header">
              <img src="assets/images/flag-kr.jpg" class="flag-img" onerror="this.style.display='none'">
              <h3>ëŒ€í•œë¯¼êµ­</h3>
            </div>
            <div class="time-box">
              <span class="time-label">í˜„ì¬ ì‹œê°</span>
              <strong id="timeKR">--:--:--</strong>
            </div>
            <ul class="country-list">
              <li><span>ì‹œì°¨</span><strong>ê¸°ì¤€ êµ­ê°€</strong></li>
              <li><span>ì¸êµ¬</span><strong>ì•½ 5,100ë§Œ ëª…</strong></li>
              <li><span>ë©´ì </span><strong>ì•½ 100,210ã¢</strong></li>
              <li><span>GDP</span><strong>ì•½ 1.7ì¡° ë‹¬ëŸ¬</strong></li>
            </ul>
          </div>

          <!-- ëŒ€ë§Œ -->
          <div class="country-card">
            <div class="country-header">
              <img src="assets/images/flag-tw.jpg" class="flag-img" onerror="this.style.display='none'">
              <h3>ëŒ€ë§Œ</h3>
            </div>
            <div class="time-box">
              <span class="time-label">í˜„ì¬ ì‹œê°</span>
              <strong id="timeTW">--:--:--</strong>
            </div>
            <ul class="country-list">
              <li><span>ì‹œì°¨</span><strong>í•œêµ­ë³´ë‹¤ 1ì‹œê°„ ëŠë¦¼</strong></li>
              <li><span>ì¸êµ¬</span><strong>ì•½ 2,300ë§Œ ëª…</strong></li>
              <li><span>ë©´ì </span><strong>ì•½ 36,197ã¢</strong></li>
              <li><span>GDP</span><strong>ì•½ 0.8ì¡° ë‹¬ëŸ¬</strong></li>
            </ul>
          </div>
        </div>

        <!-- ğŸ”¥ [ì¶”ê°€] ì‹¤ì‹œê°„ ë‚ ì”¨ ë° ì£¼ê°„ ì¼ê¸°ì˜ˆë³´ -->
        <div class="weather-detail-wrapper">
          <div class="weather-current-row">
            <div class="w-city">
              <span>ğŸ‡°ğŸ‡· ì„œìš¸ (í˜„ì¬)</span>
              <strong id="seoulTempDetail">--Â°C</strong>
            </div>
            <div class="w-vs">|</div>
            <div class="w-city">
              <span>ğŸ‡¹ğŸ‡¼ íƒ€ì´ë² ì´ (í˜„ì¬)</span>
              <strong id="taipeiTempDetail">--Â°C</strong>
            </div>
          </div>
          
          <div class="forecast-container">
            <div class="forecast-header">
              <span>ğŸ“… íƒ€ì´ë² ì´ ì£¼ê°„ ì˜ˆë³´</span>
              <span class="forecast-update" id="weatherUpdateTime">ì—…ë°ì´íŠ¸ ì¤‘...</span>
            </div>
            <div class="forecast-list" id="forecastList">
              <div style="font-size:12px; color:var(--text-sub); padding:10px; text-align:center; width:100%;">ì˜ˆë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
          </div>
        </div>

        <!-- ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ í‘œì‹œ -->
        <div class="exchange-row">
            ì‹¤ì‹œê°„ í™˜ìœ¨: <strong>1 TWD â‰ˆ <span id="twFxRate">ë¡œë”©ì¤‘..</span>ì›</strong>
            <br><span style="font-size:12px; opacity:0.8;">(ì—…ë°ì´íŠ¸: <span id="twFxTime">-</span>)</span>
        </div>
        <p class="exchange-note" style="text-align:center; font-size:13px; font-weight:600; color:var(--text-sub);">â€» í™˜ìœ¨ì€ ì‹¤ì‹œê°„ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        
        <!-- ëŒ€ë§Œ ê¸°ë³¸ ì •ë³´ -->
        <div class="day-card" style="margin-top:20px;">
          <h3 style="margin: 0 0 16px; font-size: 18px; color: var(--primary-color); font-weight: 800; display:flex; align-items:center; gap:6px;">
            <span style="font-size:20px;">ğŸ’¡</span> ëŒ€ë§Œ ì—¬í–‰ í•„ìˆ˜ ì •ë³´
          </h3>
          
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
            <div style="background:var(--bg-main); padding:16px; border-radius:12px; border:1px solid var(--border-light);">
               <h4 style="margin:0 0 8px; font-size:13px; color:var(--text-sub); font-weight:700;">ğŸ”Œ ì „ì•• ë° ì½˜ì„¼íŠ¸</h4>
               <p style="margin:0; font-size:15px; font-weight:800; color:var(--primary-color); letter-spacing:-0.5px;">110V / 60Hz</p>
               <span style="font-size:12px; color:#e53e3e; font-weight:700; margin-top:4px; display:block; letter-spacing:-0.5px;">â€» 11ìí˜•(ë¼ì§€ì½”) í•„ìˆ˜</span>
            </div>
            
            <div style="background:var(--bg-main); padding:16px; border-radius:12px; border:1px solid var(--border-light);">
               <h4 style="margin:0 0 8px; font-size:13px; color:var(--text-sub); font-weight:700;">ğŸ›‚ ë¹„ì (Visa)</h4>
               <p style="margin:0; font-size:15px; font-weight:800; color:var(--primary-color); letter-spacing:-0.5px;">90ì¼ ë¬´ë¹„ì</p>
               <span style="font-size:12px; color:var(--text-sub); font-weight:600; margin-top:4px; display:block; letter-spacing:-0.5px;">í•œêµ­ ì—¬ê¶Œ ì†Œì§€ì ê¸°ì¤€</span>
            </div>
            
            <div style="background:var(--bg-main); padding:16px; border-radius:12px; border:1px solid var(--border-light);">
               <h4 style="margin:0 0 8px; font-size:13px; color:var(--text-sub); font-weight:700;">ğŸª™ íŒ ë¬¸í™”</h4>
               <p style="margin:0; font-size:15px; font-weight:800; color:var(--primary-color); letter-spacing:-0.5px;">íŒ ë¬¸í™” ì—†ìŒ</p>
               <span style="font-size:12px; color:var(--text-sub); font-weight:600; margin-top:4px; display:block; letter-spacing:-0.5px;">ëŒ€ë¶€ë¶„ 10% ë´‰ì‚¬ë£Œ í¬í•¨</span>
            </div>
            
            <div style="background:var(--bg-main); padding:16px; border-radius:12px; border:1px solid var(--border-light);">
               <h4 style="margin:0 0 8px; font-size:13px; color:var(--text-sub); font-weight:700;">ğŸ—£ï¸ ì‚¬ìš© ì–¸ì–´</h4>
               <p style="margin:0; font-size:15px; font-weight:800; color:var(--primary-color); letter-spacing:-0.5px;">ì¤‘êµ­ì–´(ë²ˆì²´)</p>
               <span style="font-size:12px; color:var(--text-sub); font-weight:600; margin-top:4px; display:block; letter-spacing:-0.5px;">ì£¼ìš” ê´€ê´‘ì§€ ì˜/í•œ í†µìš©</span>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding:18px; border-radius:12px; position:relative; overflow:hidden; border:1px solid var(--border-light);">
            <div style="position:relative; z-index:2;">
               <h4 style="margin:0 0 8px; font-size:15px; font-weight:800; color:var(--primary-color); display:flex; align-items:center; gap:6px;">â›… 3ì›”ì˜ ëŒ€ë§Œ, ë‚ ì”¨ì™€ ì˜·ì°¨ë¦¼</h4>
               <p style="margin:0 0 6px; font-size:13px; line-height:1.6; color:var(--text-main); word-break:keep-all;">
                 <strong>í‰ê·  ê¸°ì˜¨ 18~25â„ƒ</strong>ë¡œ í•œêµ­ì˜ ì´ˆì—¬ë¦„~ë´„ ë‚ ì”¨ì™€ ë¹„ìŠ·í•©ë‹ˆë‹¤. ë‚®ì—ëŠ” ê°€ë²¼ìš´ ì˜·ì°¨ë¦¼ì´ ì¢‹ì§€ë§Œ, ì•„ì¹¨ì €ë…ì´ë‚˜ ì—ì–´ì»¨ì´ ê°•í•œ ì‹¤ë‚´ì—ì„œëŠ” ìŒ€ìŒ€í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ <strong style="color:#2b6cb0;">ì–‡ì€ ê²‰ì˜·(ê°€ë””ê±´, ë°”ëŒë§‰ì´)</strong>ì„ ê¼­ ì±™ê²¨ì£¼ì„¸ìš”!
               </p>
            </div>
            <span style="font-size:70px; position:absolute; right:-10px; bottom:-15px; opacity:0.1; z-index:1;">ğŸ§¥</span>
          </div>
        </div>
      </div>`;
      
    // ê¸°ëŠ¥ 1: ì‹œê³„ ë™ì‘
    startWorldClock();
    
    // ê¸°ëŠ¥ 2: ëŒ€ë§Œ ìƒì„¸ ë‚ ì”¨ ê°€ì ¸ì˜¤ê¸°
    renderDetailedWeather();

    // ê¸°ëŠ¥ 3: í™˜ìœ¨ API í˜¸ì¶œ
    getFxRate().then(data => {
        const r = document.getElementById("twFxRate");
        const t = document.getElementById("twFxTime");
        if(r) r.textContent = fxFmt(data.rate);
        if(t) t.textContent = data.updatedUtc || "ë°©ê¸ˆ";
    });
  }

  if (type === "exchange") {
    t.textContent = "ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°";
    c.innerHTML = `
      <div class="detail-content-wrap">
        <div class="exchange-row">í™˜ìœ¨: <strong>1 TWD â‰ˆ <span id="fxRateText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>ì›</strong><br><span style="font-size:12px; color:#6b7280;">ì—…ë°ì´íŠ¸: <span id="fxUpdatedText">-</span></span><div style="margin-top:10px;"><button class="primary-btn" id="fxRefreshBtn" style="max-width:220px;">í™˜ìœ¨ ìƒˆë¡œê³ ì¹¨</button></div></div>
        <div class="day-card"><h3 class="section-title">TWD â†” KRW ê³„ì‚°</h3><div class="fx-grid"><div class="fx-box"><label>ëŒ€ë§Œë‹¬ëŸ¬ (TWD)</label><input id="inputTWD" type="text" inputmode="decimal" placeholder="ì˜ˆ: 1000"></div><div class="fx-eq">â‡„</div><div class="fx-box"><label>ì›í™” (KRW)</label><input id="inputKRW" type="text" inputmode="decimal" placeholder="ì˜ˆ: 42000"></div></div><p class="fx-note" style="margin-top:10px; font-size:13px; color:#6b7280; text-align:center;">â€» ìˆ«ì ì…ë ¥ ì‹œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p></div>
      </div>`;
    initExchangeCalculatorAuto();
  }

  if (type === "dinner") {
    t.textContent = "ğŸ½ ë§Œì°¬ ì•ˆë‚´";
    c.innerHTML = `
      <div class="detail-content-wrap">
        <div class="day-card">
          <h3>ISC ê³µì‹ ë§Œì°¬</h3>
          <p style="margin-top:10px; font-size:14px; color:var(--text-sub);">ISC ê³µì‹ ë§Œì°¬ì¥ ë°°ì¹˜ë„ ë° ìƒì„¸ ì•ˆë‚´ì…ë‹ˆë‹¤.</p>
          
          <!-- âœ… ë§Œì°¬ì¥ ë°°ì¹˜ë„ ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°€ëŠ” ìë¦¬ì…ë‹ˆë‹¤ -->
          <div style="margin-top:16px; border-radius:12px; overflow:hidden; border:1px solid var(--border-light); background:#f8fafc;">
            <img src="assets/images/dinner_map.jpg" alt="ë§Œì°¬ì¥ ë°°ì¹˜ë„" style="width:100%; height:auto; display:block;" onerror="this.style.display='none'">
          </div>
        </div>
      </div>`;
  }
   
  if (type === "request") {
    t.textContent = "ğŸ“ ìš”ì²­ì‚¬í•­";
    c.innerHTML = `<div class="detail-content-wrap"><div class="day-card"><textarea id="requestInput" placeholder="ìš”ì²­ì‚¬í•­ì„ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea><button class="primary-btn" onclick="submitRequest()">ì œì¶œí•˜ê¸°</button></div></div>`;
  }
   
  if (type === "contact") {
    t.textContent = "ğŸ“ ê¸´ê¸‰ ì—°ë½ë§";
    c.innerHTML = `
      <div class="detail-content-wrap"><div class="day-card"><h3>ë¹„ìƒ ì—°ë½ë§</h3><div class="timeline">
      <div class="schedule-item"><div class="timeline-dot"></div><div class="schedule-card"><div class="schedule-body"><div class="schedule-title">ğŸ“ ì¸ì¹´ë¸”ë£¨íˆ¬ì–´</div><div class="schedule-desc">ë‹´ë‹¹ì í™ê¸¸ë™ | 010-0000-0000</div></div></div></div>
      <div class="schedule-item"><div class="timeline-dot"></div><div class="schedule-card"><div class="schedule-body"><div class="schedule-title">ğŸ“ ì¸ì¹´ ë§ˆì¼€íŒ…ë¶€</div><div class="schedule-desc">ë‹´ë‹¹ì í˜„ë³´ë¼ê³¼ì¥ | 02-6214-0000</div></div></div></div>
      <div class="schedule-item"><div class="timeline-dot"></div><div class="schedule-card"><div class="schedule-body"><div class="schedule-title">ğŸ“ í˜„ì§€ ê°€ì´ë“œ</div><div class="schedule-desc">ë‹´ë‹¹ì Jason | +886-900-222-222</div></div></div></div>
      </div></div></div>`;
  }
}

async function syncMealStatusFromServer(userId, tour, wrap) {
  const url = `${MEAL_SHEET_URL}?mode=customerAdmin&id=${userId}`;
  const res = await fetch(url);
  const data = await res.json();
  const status = data.mealMap?.[tour];
  if (status === "APPROVE") setMealUI(wrap, "DONE", "ì„œë²„ ê¸°ì¤€");
  else setMealUI(wrap, "PENDING");
}

/* ================= í™ˆìœ¼ë¡œ (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ì¶”ê°€) ================= */
function goHome() {
  const steps = pageHistory.length;
  pageHistory = [];

  // ìŒ“ì—¬ìˆëŠ” ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ê¸°ë¡ì„ í•œ ë²ˆì— ë‚ ë ¤ì¤Œ (í° ìì²´ ë’¤ë¡œê°€ê¸° ìµœì í™”)
  if (steps > 0) {
    history.go(-steps);
  }

  document.body.classList.remove("detail-open");
  document.body.classList.remove("menu-open");

  // ì• ë‹ˆë©”ì´ì…˜(0.4ì´ˆ)ì´ ëë‚œ í›„ ì™„ì „íˆ ìˆ¨ê²¨ì„œ í„°ì¹˜ ë°©í•´ ë°©ì§€
  setTimeout(() => {
    document.getElementById("detailPage").style.display = "none";
  }, 400); 
}

/* ================= ë’¤ë¡œê°€ê¸° (ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ë¡œì§ ì—°ë™) ================= */
function goBack() {
  if (pageHistory.length > 0) {
    // ì•± ë‚´ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ë„ ìŠ¤ë§ˆíŠ¸í° ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°ì™€ ë™ì¼í•œ ë¡œì§(popstate)ì„ íƒ€ê²Œ ë§Œë“¦
    history.back(); 
  } else {
    goHome();
  }
}

/* ================= í° ìì²´ ë’¤ë¡œê°€ê¸°(í•˜ë“œì›¨ì–´ ë²„íŠ¼) ê°ì§€ ë° ì—°ë™ ================= */
window.addEventListener("popstate", (event) => {
  // 1. ë©”ë‰´ê°€ ì—´ë ¤ìˆì„ ë•Œ ë’¤ë¡œê°€ê¸° ëˆ„ë¥´ë©´ ë©”ë‰´ë§Œ ë‹«ìŒ
  if (document.body.classList.contains("menu-open")) {
    document.body.classList.remove("menu-open");
  }

  // 2. íˆìŠ¤í† ë¦¬ê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì´ì „ í˜ì´ì§€ ë˜ëŠ” í™ˆìœ¼ë¡œ ì´ë™
  if (pageHistory.length > 0) {
    pageHistory.pop(); // ë‚´ë¶€ ë°°ì—´ ìµœì‹ í™”
    
    if (pageHistory.length === 0) {
      // ë”ì´ìƒ ë’¤ë¡œê°ˆ í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ í™ˆ í™”ë©´ìœ¼ë¡œ ë‹«ê¸°
      document.body.classList.remove("detail-open");
      setTimeout(() => { document.getElementById("detailPage").style.display = "none"; }, 400); 
    } else {
      // ì´ì „ ìƒì„¸ í˜ì´ì§€ ë‹¤ì‹œ ì—´ê¸° (íˆìŠ¤í† ë¦¬ì— ë‹¤ì‹œ ìŒ“ì§€ ì•Šë„ë¡ true íŒŒë¼ë¯¸í„° ì „ë‹¬)
      const prevType = pageHistory[pageHistory.length - 1];
      openPage(prevType, true);
    }
  }
});

/* ================= ìš”ì²­ì‚¬í•­ ì „ì†¡ ================= */
function submitRequest() {
  const requestText = document.getElementById("requestInput").value.trim();
  if (!requestText) { alert("ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
  if (!currentUser) { alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
   
  fetch(MEAL_SHEET_URL, {
    method: "POST", mode: "no-cors",
    body: JSON.stringify({ type: "request", id: currentUser.id, name: currentUser.name, request: requestText, time: nowKSTString() })
  }).then(() => { alert("ìš”ì²­ì‚¬í•­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById("requestInput").value = ""; }).catch(err => { console.error(err); alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); });
}

function startWorldClock() {
  function updateTime() {
    const now = new Date();
    const kr = new Intl.DateTimeFormat("ko-KR", { timeZone: "Asia/Seoul", hour: "2-digit", minute: "2-digit", second: "2-digit" }).format(now);
    const tw = new Intl.DateTimeFormat("zh-TW", { timeZone: "Asia/Taipei", hour: "2-digit", minute: "2-digit", second: "2-digit" }).format(now);
    const krEl = document.getElementById("timeKR");
    const twEl = document.getElementById("timeTW");
    if (krEl && twEl) { krEl.textContent = kr; twEl.textContent = tw; }
  }
  updateTime();
  setInterval(updateTime, 1000);
}

const FX_CACHE_KEY = "fx_twd_krw_cache_v1";
const FX_CACHE_MS = 6 * 60 * 60 * 1000; 

function fxParse(v) {
  if (v == null) return NaN;
  const x = String(v).replace(/,/g, "").trim();
  if (x === "") return NaN;
  return Number(x);
}

function fxFmt(n) {
  if (!isFinite(n)) return "";
  const isInt = Math.abs(n - Math.round(n)) < 1e-10;
  return (isInt ? Math.round(n) : n).toLocaleString("ko-KR", { maximumFractionDigits: 2 });
}

/* ================= ğŸ”¥ í™˜ìœ¨ ì‹¤ì‹œê°„ ê°±ì‹  ì™„ë²½ ì ìš© ================= */
async function fetchTwdToKrwRate() {
  // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ URLì— ë¶™ì—¬ì„œ ë¸Œë¼ìš°ì € ìºì‹œ ë¬´ë ¥í™”
  const url = `https://open.er-api.com/v6/latest/USD?_t=${Date.now()}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("í™˜ìœ¨ API ì‹¤íŒ¨: " + res.status);
  
  const data = await res.json();
  const krwPerUsd = data?.rates?.KRW;
  const twdPerUsd = data?.rates?.TWD;
  
  if (!isFinite(krwPerUsd) || !isFinite(twdPerUsd)) throw new Error("KRW/TWD í™˜ìœ¨ ë°ì´í„° ì—†ìŒ");
  
  // APIì˜ êµ¬í˜• ì—…ë°ì´íŠ¸ ì‹œê°„ì´ ì•„ë‹ˆë¼, ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆ„ë¥¸ ì¦‰ì‹œ í˜„ì¬ í•œêµ­ ì‹œê°„ì„ ìƒì„±
  const nowKST = new Intl.DateTimeFormat("ko-KR", { 
    timeZone: "Asia/Seoul", 
    month: "2-digit", 
    day: "2-digit", 
    hour: "2-digit", 
    minute: "2-digit", 
    second: "2-digit" 
  }).format(new Date());

  return { rate: krwPerUsd / twdPerUsd, updatedUtc: `ì˜¤ëŠ˜ ${nowKST}` };
}

function loadFxCache() {
  const raw = localStorage.getItem(FX_CACHE_KEY);
  if (!raw) return null;
  try {
    const v = JSON.parse(raw);
    if (!v.rate || !v.savedAt) return null;
    if (Date.now() - v.savedAt > FX_CACHE_MS) return null; 
    return v;
  } catch { return null; }
}

function saveFxCache(payload) {
  localStorage.setItem(FX_CACHE_KEY, JSON.stringify({ rate: payload.rate, updatedUtc: payload.updatedUtc, savedAt: Date.now() }));
}

async function getFxRate({ force = false } = {}) {
  // force(ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼) ì¼ ê²½ìš° ë¬´ì¡°ê±´ ì„œë²„ì—ì„œ ìƒˆë¡œ ê°€ì ¸ì˜´
  if (!force) { 
    const cached = loadFxCache(); 
    if (cached) return cached; 
  }
  const fresh = await fetchTwdToKrwRate();
  saveFxCache(fresh); 
  return fresh;
}

function initExchangeCalculatorAuto() {
  const twdEl = document.getElementById("inputTWD");
  const krwEl = document.getElementById("inputKRW");
  const rateText = document.getElementById("fxRateText");
  const updatedText = document.getElementById("fxUpdatedText");
  const refreshBtn = document.getElementById("fxRefreshBtn");
  if (!twdEl || !krwEl || !rateText || !updatedText) return;

  let syncing = false; let rate = NaN; 

  function updateFromTWD() {
    if (syncing) return; syncing = true;
    const twd = fxParse(twdEl.value);
    if (!isFinite(twd) || !isFinite(rate)) { krwEl.value = ""; syncing = false; return; }
    krwEl.value = fxFmt(twd * rate); syncing = false;
  }
  function updateFromKRW() {
    if (syncing) return; syncing = true;
    const krw = fxParse(krwEl.value);
    if (!isFinite(krw) || !isFinite(rate) || rate === 0) { twdEl.value = ""; syncing = false; return; }
    twdEl.value = fxFmt(krw / rate); syncing = false;
  }

  twdEl.addEventListener("input", updateFromTWD);
  krwEl.addEventListener("input", updateFromKRW);

  async function renderRate(force = false) {
    rateText.textContent = "ê°€ì ¸ì˜¤ëŠ” ì¤‘â€¦";
    try {
      const fx = await getFxRate({ force });
      rate = Number(fx.rate);
      rateText.textContent = fxFmt(rate);
      updatedText.textContent = fx.updatedUtc || "-";
      const hasT = String(twdEl.value).trim() !== "";
      const hasK = String(krwEl.value).trim() !== "";
      if (hasT) updateFromTWD(); else if (hasK) updateFromKRW();
    } catch (e) {
      console.error(e); rateText.textContent = "ì‹¤íŒ¨"; updatedText.textContent = "-"; alert("í™˜ìœ¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  }
  
  if (refreshBtn) refreshBtn.addEventListener("click", () => renderRate(true));
  renderRate(false);
}
</script>

</body>
</html>
