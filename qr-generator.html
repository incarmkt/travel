<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ISC ì§ì› QR ë° ëª…ì°° ìƒì„±ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- QR ìƒì„± -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- ZIP ë‹¤ìš´ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body{
      font-family: system-ui, -apple-system, sans-serif;
      background:#f6f7fb;
      padding:20px;
      margin:0;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    h1{margin:0;}
    .muted{color:#667085;font-size:13px;margin:6px 0 0;}
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      background:#111827;
      color:#fff;
      transition: all 0.2s ease;
    }
    .btn:hover { background: #1f2937; }
    
    .btn.secondary{
      background:#fff;
      color:#111827;
      border:1px solid #e5e7eb;
    }
    .btn.secondary:hover { background: #f9fafb; }
    
    .btn.primary {
      background: #3b82f6;
      color: #fff;
    }
    .btn.primary:hover { background: #2563eb; }

    /* ğŸ”¥ ëª…ì°° ì–‘ì‹ ì—…ë¡œë“œ ë° ì„¤ì • ì˜ì—­ CSS */
    .template-card {
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid #eef2f7;
      box-shadow: 0 4px 10px rgba(0,0,0,.02);
    }
    .template-card h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }
    .file-input-wrapper {
      margin-bottom: 16px;
    }
    .editor-container {
      position: relative;
      display: none; /* íŒŒì¼ ì—…ë¡œë“œ ì „ì—ëŠ” ìˆ¨ê¹€ */
      max-width: 400px;
      margin: 0 auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      touch-action: none; /* ëª¨ë°”ì¼ ë“œë˜ê·¸ íŠ ë°©ì§€ */
    }
    .editor-container img {
      width: 100%;
      display: block;
      pointer-events: none; /* ì´ë¯¸ì§€ ê¸°ë³¸ ë“œë˜ê·¸ ë°©ì§€ */
    }
    /* í•©ì„±ë  ì˜ì—­ì„ ë‚˜íƒ€ë‚´ëŠ” ë°•ìŠ¤ */
    .print-area-box {
      position: absolute;
      border: 2px dashed #ef4444;
      background: rgba(255, 255, 255, 0.6);
      cursor: grab;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .print-area-box:active {
      cursor: grabbing;
    }
    .print-area-box span {
      font-weight: 800;
      color: #b91c1c;
      font-size: 14px;
      text-align: center;
      pointer-events: none;
    }
    /* ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬ (ìš°ì¸¡ í•˜ë‹¨) */
    .resize-handle {
      position: absolute;
      right: -1px;
      bottom: -1px;
      width: 24px;
      height: 24px;
      background: #ef4444;
      cursor: se-resize;
      border-radius: 4px 0 0 0;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:14px;
    }
    .card{
      background:#fff;
      border-radius:14px;
      padding:16px 12px;
      text-align:center;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
      border:1px solid #eef2f7;
    }
    .name{font-weight:800;margin-top:12px; font-size: 16px;}
    .id{font-size:12px;color:#6b7280;margin-top:4px;}
    .mini-actions{
      margin-top:14px;
      display:flex;
      gap:6px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .mini-actions button{
      font-size:11px;
      padding:8px;
      border-radius:8px;
      flex: 1;
    }
    .status{
      margin-top:10px;
      margin-bottom:20px;
      font-size:13px;
      color:#111827;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:10px 12px;
    }
    .status.good{border-color:#bbf7d0; background:#f0fdf4; color:#166534;}
    .status.bad{border-color:#fecaca; background:#fef2f2; color:#991b1b;}
    .hidden{display:none;}
  </style>
</head>
<body>

  <div class="topbar">
    <div style="flex:1; min-width:220px;">
      <h1>ISC ì§ì› QR & ëª…ì°° ìë™í™” ë„êµ¬</h1>
      <div class="muted">
        QR ë‚´ìš©ì€ <b>https://incarmkt.github.io/travel/?eid=ì‚¬ë²ˆ</b> í˜•ì‹ì…ë‹ˆë‹¤.
      </div>
    </div>

    <button id="btnReload" class="btn secondary">ìƒˆë¡œê³ ì¹¨(ëª©ë¡ ì¬ë¡œë“œ)</button>
    <button id="btnZip" class="btn">QRë§Œ ì „ì²´ ZIP</button>
    <button id="btnNameTagZip" class="btn primary">ì „ì²´ ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div id="statusBox" class="status hidden"></div>

  <!-- ğŸ”¥ ëª…ì°° ì–‘ì‹ ì„¸íŒ… ì˜ì—­ (ì‹ ê·œ) -->
  <div class="template-card">
    <h2>1. ë””ìì´ë„ˆ ëª…ì°° ì–‘ì‹ ì—…ë¡œë“œ ë° ì˜ì—­ ì„¤ì •</h2>
    <div class="muted" style="margin-bottom: 12px;">
      ë””ìì´ë„ˆê°€ ë§Œë“  ë¹ˆ ëª…ì°° ì´ë¯¸ì§€(PNG, JPG)ë¥¼ ì—…ë¡œë“œí•˜ê³ , ì •ë³´(ì´ë¦„/QR ë“±)ê°€ ë“¤ì–´ê°ˆ ì˜ì—­ì„ ë“œë˜ê·¸í•´ì„œ ë§ì¶°ì£¼ì„¸ìš”.<br>
      <span style="color:#ef4444; font-weight:600;">â€» ëª…ì°° ì–‘ì‹ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì•¼ ëª…ì°° ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
    </div>
    
    <div class="file-input-wrapper">
      <input type="file" id="templateInput" accept="image/png, image/jpeg" class="btn secondary" style="width:100%; max-width: 400px; padding: 10px;">
    </div>

    <div class="editor-container" id="editorContainer">
      <img id="templatePreview" alt="ëª…ì°° ë°°ê²½ ë¯¸ë¦¬ë³´ê¸°">
      
      <!-- ì›€ì§ì´ê³  ë¦¬ì‚¬ì´ì¦ˆ í•  ìˆ˜ ìˆëŠ” ë°•ìŠ¤ -->
      <div class="print-area-box" id="printArea" style="left: 10%; top: 40%; width: 80%; height: 50%;">
        <span>ì •ë³´ ì‚½ì… ì˜ì—­<br>(ì†Œì†/ì´ë¦„/QR)</span>
        <div class="resize-handle" id="resizeHandle"></div>
      </div>
    </div>
  </div>

  <div id="qrGrid" class="grid"></div>

<script>
/* ==============================
   ì„¤ì • ë° ìƒíƒœ
============================== */
const EMP_URL  = "people/employees.json?ts=" + Date.now();
const BASE_URL = "https://incarmkt.github.io/travel/?eid=";

let employees = [];

// ëª…ì°° í…œí”Œë¦¿ ê´€ë ¨ ìƒíƒœ
let customTemplateImg = null; 
// ë°•ìŠ¤ì˜ ìœ„ì¹˜ ë° í¬ê¸° ë¹„ìœ¨ (0~1 ì‚¬ì´ì˜ ê°’)
let boxBounds = { x: 0.1, y: 0.4, w: 0.8, h: 0.5 };

/* ==============================
   ìœ í‹¸
============================== */
function setStatus(msg, kind=""){
  const box = document.getElementById("statusBox");
  box.classList.remove("hidden","good","bad");
  if(kind==="good") box.classList.add("good");
  if(kind==="bad") box.classList.add("bad");
  box.textContent = msg;
}

function clearStatus(){
  const box = document.getElementById("statusBox");
  box.classList.add("hidden");
  box.textContent = "";
}

function safeName(str){
  return String(str || "").replace(/[\\/:*?"<>|]/g, "_").trim();
}

function dataURLtoBase64(dataUrl){
  return dataUrl.split(",")[1];
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* ==============================
   ğŸ”¥ ë“œë˜ê·¸ & ë¦¬ì‚¬ì´ì¦ˆ ì—ë””í„° ë¡œì§
============================== */
const editorContainer = document.getElementById("editorContainer");
const printArea = document.getElementById("printArea");
const resizeHandle = document.getElementById("resizeHandle");
const templateInput = document.getElementById("templateInput");
const templatePreview = document.getElementById("templatePreview");

let isDragging = false;
let isResizing = false;
let startX, startY, startLeft, startTop, startW, startH;

// í†µí•© ë§ˆìš°ìŠ¤/í„°ì¹˜ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
function getPointerPos(e) {
  if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  return { x: e.clientX, y: e.clientY };
}

// 1. ë“œë˜ê·¸ ì‹œì‘ (ë°•ìŠ¤ ì´ë™)
printArea.addEventListener('mousedown', startDrag);
printArea.addEventListener('touchstart', startDrag, {passive: false});

function startDrag(e) {
  if (e.target === resizeHandle) return; // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ í´ë¦­ì‹œ ë¬´ì‹œ
  isDragging = true;
  const pos = getPointerPos(e);
  startX = pos.x; startY = pos.y;
  startLeft = printArea.offsetLeft; 
  startTop = printArea.offsetTop;
}

// 2. ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘ (í¬ê¸° ì¡°ì ˆ)
resizeHandle.addEventListener('mousedown', startResize);
resizeHandle.addEventListener('touchstart', startResize, {passive: false});

function startResize(e) {
  isResizing = true;
  e.stopPropagation(); // ë“œë˜ê·¸ ì´ë²¤íŠ¸ë¡œ ì „íŒŒ ë°©ì§€
  const pos = getPointerPos(e);
  startX = pos.x; startY = pos.y;
  startW = printArea.offsetWidth;
  startH = printArea.offsetHeight;
}

// 3. ì›€ì§ì„ ì²˜ë¦¬
window.addEventListener('mousemove', handleMove);
window.addEventListener('touchmove', handleMove, {passive: false});

function handleMove(e) {
  if (!isDragging && !isResizing) return;
  e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
  
  const pos = getPointerPos(e);
  const dx = pos.x - startX;
  const dy = pos.y - startY;

  const editorRect = editorContainer.getBoundingClientRect();

  if (isDragging) {
    let newL = startLeft + dx;
    let newT = startTop + dy;
    
    // ì—ë””í„° ì˜ì—­ ë²—ì–´ë‚˜ì§€ ì•Šê²Œ ì œí•œ
    newL = Math.max(0, Math.min(newL, editorRect.width - printArea.offsetWidth));
    newT = Math.max(0, Math.min(newT, editorRect.height - printArea.offsetHeight));
    
    printArea.style.left = newL + 'px';
    printArea.style.top = newT + 'px';
  } else if (isResizing) {
    let newW = startW + dx;
    let newH = startH + dy;
    
    // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ
    newW = Math.max(50, Math.min(newW, editorRect.width - printArea.offsetLeft));
    newH = Math.max(50, Math.min(newH, editorRect.height - printArea.offsetTop));

    printArea.style.width = newW + 'px';
    printArea.style.height = newH + 'px';
  }
}

// 4. ì¢…ë£Œ ì²˜ë¦¬ ë° ë¹„ìœ¨ ì €ì¥
window.addEventListener('mouseup', endAction);
window.addEventListener('touchend', endAction);

function endAction() {
  if (isDragging || isResizing) {
    isDragging = false;
    isResizing = false;
    updateBoxBounds(); // í™”ë©´ í¬ê¸°ê°€ ë³€í•´ë„ ìœ„ì¹˜ë¥¼ ê¸°ì–µí•˜ë„ë¡ í¼ì„¼íŠ¸(%) ì €ì¥
  }
}

function updateBoxBounds() {
  const ew = editorContainer.offsetWidth;
  const eh = editorContainer.offsetHeight;
  // í¼ì„¼íŠ¸ë¡œ ì €ì¥ (0 ~ 1)
  boxBounds = {
    x: printArea.offsetLeft / ew,
    y: printArea.offsetTop / eh,
    w: printArea.offsetWidth / ew,
    h: printArea.offsetHeight / eh
  };
}

// ëª…ì°° ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì²˜ë¦¬
templateInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    customTemplateImg = new Image();
    customTemplateImg.onload = function() {
      // ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì—ë””í„° í‘œì‹œ
      templatePreview.src = event.target.result;
      editorContainer.style.display = "block";
      
      // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸° ë°•ìŠ¤ ë°”ìš´ë“œ ê³„ì‚°
      setTimeout(() => {
        // ê¸°ë³¸ ì…‹íŒ…ëœ pxì„ í¼ì„¼íŠ¸ë¡œ ë³€í™˜ ì €ì¥
        updateBoxBounds(); 
        setStatus("ëª…ì°° ì–‘ì‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ëª©ë¡ì—ì„œ [ëª…ì°°ë‹¤ìš´]ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "good");
      }, 100);
    };
    customTemplateImg.src = event.target.result;
  };
  reader.readAsDataURL(file);
});


/* ==============================
   ğŸ”¥ ììœ ì˜ì—­ ê¸°ë°˜ ëª…ì°° í•©ì„± ìº”ë²„ìŠ¤ ë¡œì§
============================== */
async function createCustomNameTag(emp, qrDataUrl) {
  if (!customTemplateImg) {
    throw new Error("ëª…ì°° ì–‘ì‹ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
  }

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  // 1. ìº”ë²„ìŠ¤ í•´ìƒë„ë¥¼ ì—…ë¡œë“œí•œ ì›ë³¸ ëª…ì°° í•´ìƒë„ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
  const baseW = customTemplateImg.naturalWidth;
  const baseH = customTemplateImg.naturalHeight;
  canvas.width = baseW;
  canvas.height = baseH;

  // 2. ë°°ê²½(ì—…ë¡œë“œí•œ ëª…ì°° ë””ìì¸) ê·¸ë¦¬ê¸°
  ctx.drawImage(customTemplateImg, 0, 0, baseW, baseH);

  // 3. ì‚¬ìš©ìê°€ ì§€ì •í•œ 'ì •ë³´ ì‚½ì… ì˜ì—­(ë°•ìŠ¤)'ì˜ ì‹¤ì œ í”½ì…€ ì¢Œí‘œ ê³„ì‚°
  const areaX = baseW * boxBounds.x;
  const areaY = baseH * boxBounds.y;
  const areaW = baseW * boxBounds.w;
  const areaH = baseH * boxBounds.h;

  const centerX = areaX + (areaW / 2); // ë°•ìŠ¤ì˜ ê°€ë¡œ ì¤‘ì•™

  // --- ë°•ìŠ¤ ë‚´ë¶€ ë¹„ìœ¨ì— ë§ì¶° í…ìŠ¤íŠ¸ì™€ QR ë°°ì¹˜ ---
  // (ë°•ìŠ¤ ì•ˆì—ì„œ ìœ„ì—ì„œë¶€í„° ì†Œì†(15%), ì´ë¦„(35%), ì‚¬ë²ˆ(45%), QR(50%~) ìœ„ì¹˜ë¡œ ë¶„ë°°)
  
  const dept = emp.department || emp.team || "ISC ì„ì§ì›";
  
  // ì†Œì† (ê¸€ìí¬ê¸°ëŠ” ë°•ìŠ¤ ë†’ì´ì˜ 7%)
  const fontSizeDept = Math.max(areaH * 0.07, 16); 
  ctx.fillStyle = "#3b82f6"; // ê¸°ë³¸ íŒŒë€ìƒ‰ (í•„ìš”ì‹œ ë³€ê²½)
  ctx.font = `bold ${fontSizeDept}px system-ui, sans-serif`;
  ctx.textAlign = "center";
  ctx.fillText(dept, centerX, areaY + (areaH * 0.15));

  // ì´ë¦„ (ê¸€ìí¬ê¸°ëŠ” ë°•ìŠ¤ ë†’ì´ì˜ 14%)
  const fontSizeName = Math.max(areaH * 0.14, 24);
  ctx.fillStyle = "#111827"; 
  ctx.font = `bold ${fontSizeName}px system-ui, sans-serif`;
  ctx.fillText(emp.name, centerX, areaY + (areaH * 0.35));

  // ì‚¬ë²ˆ (ê¸€ìí¬ê¸°ëŠ” ë°•ìŠ¤ ë†’ì´ì˜ 5%)
  const fontSizeId = Math.max(areaH * 0.05, 12);
  ctx.fillStyle = "#6b7280";
  ctx.font = `${fontSizeId}px system-ui, sans-serif`;
  ctx.fillText(`ID : ${emp.id}`, centerX, areaY + (areaH * 0.45));

  // QR ì½”ë“œ
  // QR í¬ê¸°ëŠ” ë°•ìŠ¤ ê°€ë¡œì˜ 70% ë˜ëŠ” ë°•ìŠ¤ í•˜ë‹¨ ë‚¨ì€ ë†’ì´ì˜ 90% ì¤‘ ì‘ì€ ê°’
  const maxQrSize = Math.min(areaW * 0.7, areaH * 0.5); 
  const qrY = areaY + (areaH * 0.5); // ë°•ìŠ¤ ì¤‘ê°„ë¶€í„° ì•„ë˜ë¡œ ê·¸ë¦¼

  const qrImg = new Image();
  qrImg.src = qrDataUrl;
  await new Promise(r => qrImg.onload = r);

  // QR ì´ë¯¸ì§€ë¥¼ ê³„ì‚°ëœ ì¤‘ì•™ í•˜ë‹¨ ìœ„ì¹˜ì— ë°°ì¹˜
  ctx.drawImage(qrImg, centerX - (maxQrSize/2), qrY, maxQrSize, maxQrSize);

  return canvas;
}

/* ==============================
   ë Œë”
============================== */
function renderGrid(list){
  const grid = document.getElementById("qrGrid");
  grid.innerHTML = "";

  list.forEach(emp => {
    const card = document.createElement("div");
    card.className = "card";

    const qrBox = document.createElement("div");
    qrBox.style.display = "inline-block";
    qrBox.style.padding = "6px";
    qrBox.style.background = "#fff";
    qrBox.style.borderRadius = "12px";
    qrBox.style.border = "1px solid #eef2f7";

    card.appendChild(qrBox);

    const qrText = BASE_URL + String(emp.id).trim();

    new QRCode(qrBox, {
      text: qrText,
      width: 140,
      height: 140
    });

    const nameEl = document.createElement("div");
    nameEl.className = "name";
    nameEl.textContent = emp.name;

    const idEl = document.createElement("div");
    idEl.className = "id";
    idEl.textContent = emp.id;

    const actions = document.createElement("div");
    actions.className = "mini-actions";

    const btnCopy = document.createElement("button");
    btnCopy.className = "btn secondary";
    btnCopy.textContent = "ë§í¬ë³µì‚¬";
    btnCopy.onclick = async () => {
      try{
        await navigator.clipboard.writeText(qrText);
        setStatus(`${emp.name} ë§í¬ ë³µì‚¬ ì™„ë£Œ`, "good");
      }catch{
        setStatus("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨", "bad");
      }
    };

    const btnPng = document.createElement("button");
    btnPng.className = "btn secondary";
    btnPng.textContent = "QRë‹¤ìš´";
    btnPng.onclick = async () => {
      try{
        await sleep(30);
        const img = qrBox.querySelector("img");
        const canvas = qrBox.querySelector("canvas");
        let dataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");

        if(!dataUrl) throw new Error("QR ë Œë” ìš”ì†Œ ì—†ìŒ");

        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `${safeName(emp.id)}_${safeName(emp.name)}_QR.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setStatus(`${emp.name} QR ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, "good");
      }catch(e){
        setStatus("PNG ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨", "bad");
      }
    };

    // ğŸ”¥ ëª…ì°° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ì»¤ìŠ¤í…€ í•©ì„±)
    const btnNameTag = document.createElement("button");
    btnNameTag.className = "btn primary";
    btnNameTag.textContent = "ëª…ì°°ë‹¤ìš´";
    btnNameTag.onclick = async () => {
      if(!customTemplateImg) {
        alert("ìƒë‹¨ì—ì„œ ëª…ì°° ì–‘ì‹(ë””ìì¸)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
        return;
      }
      try{
        await sleep(30);
        const img = qrBox.querySelector("img");
        const canvas = qrBox.querySelector("canvas");
        let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
        
        if(!qrDataUrl) throw new Error("QR ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨");

        // âœ… ì—…ë¡œë“œëœ ì–‘ì‹ ìœ„ì— í•©ì„±í•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ
        const nameTagCanvas = await createCustomNameTag(emp, qrDataUrl);
        
        const a = document.createElement("a");
        a.href = nameTagCanvas.toDataURL("image/png");
        a.download = `${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setStatus(`${emp.name} ëª…ì°° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, "good");
      }catch(e){
        console.error(e);
        setStatus(e.message || "ëª…ì°° ìƒì„± ì‹¤íŒ¨", "bad");
      }
    };

    actions.appendChild(btnCopy);
    actions.appendChild(btnPng);
    actions.appendChild(btnNameTag);

    card.appendChild(nameEl);
    card.appendChild(idEl);
    card.appendChild(actions);

    grid.appendChild(card);
  });

  clearStatus();
}

/* ==============================
   ì§ì› ë°ì´í„° ë¡œë“œ
============================== */
async function loadEmployees(){
  setStatus("ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "");
  try{
    const res = await fetch(EMP_URL, { cache:"no-store" });
    employees = await res.json();
    employees.sort((a,b) => String(a.id).localeCompare(String(b.id), "ko"));
    renderGrid(employees);
    setStatus(`ì§ì› ${employees.length}ëª… ë¡œë“œ ì™„ë£Œ`, "good");
  }catch(e){
    console.error(e);
    setStatus("employees.json ë¡œë“œ ì‹¤íŒ¨", "bad");
  }
}

/* ==============================
   ì „ì²´ QR ZIP ë‹¤ìš´ë¡œë“œ
============================== */
async function downloadZipAll(){
  if(!employees.length) return setStatus("ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", "bad");
  setStatus("QR ZIP ìƒì„± ì¤‘...", "");
  try{
    const zip = new JSZip();
    const folder = zip.folder("ISC_QR");

    for(let i=0; i<employees.length; i++){
      const emp = employees[i];
      const temp = document.createElement("div");
      temp.style.position = "fixed"; temp.style.left = "-9999px";
      document.body.appendChild(temp);

      new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 320, height: 320 });
      await sleep(60);

      const img = temp.querySelector("img");
      const canvas = temp.querySelector("canvas");
      let dataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");

      const base64 = dataURLtoBase64(dataUrl);
      folder.file(`${safeName(emp.id)}_${safeName(emp.name)}.png`, base64, { base64:true });
      temp.remove();
    }
    const blob = await zip.generateAsync({ type:"blob" });
    saveAs(blob, "ISC_ì§ì›_QRì „ì²´.zip");
    setStatus("QR ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ…", "good");
  }catch(e){
    setStatus("ZIP ìƒì„± ì‹¤íŒ¨", "bad");
  }
}

/* ==============================
   ğŸ”¥ ì „ì²´ ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ
============================== */
async function downloadNameTagZipAll(){
  if(!employees.length) return setStatus("ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", "bad");
  if(!customTemplateImg) {
    alert("ìƒë‹¨ì—ì„œ ëª…ì°° ì–‘ì‹(ë””ìì¸)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
    return;
  }

  setStatus("ëª…ì°° ZIP ìƒì„± ì¤‘... (í•´ìƒë„ê°€ ë†’ì•„ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "");
  
  try{
    const zip = new JSZip();
    const folder = zip.folder("ISC_ëª…ì°°_ì¶œë ¥ìš©");

    for(let i=0; i<employees.length; i++){
      const emp = employees[i];
      setStatus(`ëª…ì°° ZIP ìƒì„± ì¤‘... ${i+1}/${employees.length} (${emp.name})`, "");

      const temp = document.createElement("div");
      temp.style.position = "fixed"; temp.style.left = "-9999px";
      document.body.appendChild(temp);

      // QR í•´ìƒë„ ë„‰ë„‰í•˜ê²Œ ìƒì„±
      new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 400, height: 400 });
      await sleep(60); 

      const img = temp.querySelector("img");
      const canvas = temp.querySelector("canvas");
      let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
      temp.remove();

      // ì»¤ìŠ¤í…€ í•©ì„± ìº”ë²„ìŠ¤ í˜¸ì¶œ
      const nameTagCanvas = await createCustomNameTag(emp, qrDataUrl);
      const base64 = dataURLtoBase64(nameTagCanvas.toDataURL("image/png"));
      
      folder.file(`${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`, base64, { base64:true });
    }

    const blob = await zip.generateAsync({ type:"blob" });
    saveAs(blob, "ISC_ëª…ì°°_ì¶œë ¥ìš©_ì „ì²´.zip");
    setStatus("ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ… (ë””ìì¸íŒ€/ì¸ì‡„ì†Œ ì „ë‹¬ìš©)", "good");
  }catch(e){
    console.error(e);
    setStatus("ëª…ì°° ZIP ìƒì„± ì‹¤íŒ¨", "bad");
  }
}

/* ==============================
   ì´ë²¤íŠ¸ ë°”ì¸ë”©
============================== */
document.getElementById("btnReload").addEventListener("click", loadEmployees);
document.getElementById("btnZip").addEventListener("click", downloadZipAll);
document.getElementById("btnNameTagZip").addEventListener("click", downloadNameTagZipAll);

/* ìµœì´ˆ ë¡œë“œ */
loadEmployees();
</script>

</body>
</html>
