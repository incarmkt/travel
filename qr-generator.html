<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ISC ì§ì› QR ë° ëª…ì°° ìƒì„±ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ğŸ”¥ ê³ í•´ìƒë„ í…ìŠ¤íŠ¸ ë Œë”ë§ì„ ìœ„í•œ ê¹”ë”í•œ ì›¹ í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <!-- QR ìƒì„± -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- ZIP ë‹¤ìš´ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- ì—‘ì…€ íŒŒì¼(XLSX) íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body{
      font-family: 'Pretendard', system-ui, -apple-system, sans-serif;
      background:#f6f7fb;
      padding:20px;
      margin:0;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    h1{margin:0;}
    .muted{color:#667085;font-size:13px;margin:6px 0 0;}
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      background:#111827;
      color:#fff;
      transition: all 0.2s ease;
    }
    .btn:hover { background: #1f2937; }
    
    .btn.secondary{
      background:#fff;
      color:#111827;
      border:1px solid #e5e7eb;
    }
    .btn.secondary:hover { background: #f9fafb; }
    
    .btn.primary { background: #3b82f6; color: #fff; }
    .btn.primary:hover { background: #2563eb; }
    
    .btn.excel { background: #10b981; color: #fff; }
    .btn.excel:hover { background: #059669; }

    /* ì¹´ë“œí˜• UI í†µí•© ìŠ¤íƒ€ì¼ */
    .setting-card {
      background: #fff;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid #eef2f7;
      box-shadow: 0 4px 10px rgba(0,0,0,.02);
    }
    .setting-card h2 { margin: 0 0 10px 0; font-size: 18px; }
    .file-input-wrapper { margin-bottom: 16px; }
    
    /* ğŸ”¥ ëª…ì°° ì—ë””í„° - 3ê°œì˜ ë°•ìŠ¤ë¡œ ë¶„ë¦¬ */
    .editor-container {
      position: relative;
      display: none; 
      max-width: 400px;
      margin: 0 auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      touch-action: none; 
      background: #f9fafb;
    }
    .editor-container img {
      width: 100%;
      display: block;
      pointer-events: none; 
    }
    .print-area-box {
      position: absolute;
      background: rgba(255, 255, 255, 0.65);
      cursor: grab;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    .print-area-box:active { cursor: grabbing; }
    .print-area-box span {
      font-weight: 800;
      font-size: 13px;
      text-align: center;
      pointer-events: none;
    }
    .resize-handle {
      position: absolute;
      right: -1px;
      bottom: -1px;
      width: 20px;
      height: 20px;
      cursor: se-resize;
      border-radius: 4px 0 0 0;
    }

    /* 3ê°€ì§€ ê°œë³„ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ì†Œì†, ì´ë¦„, QR) */
    #boxDept { border: 2px dashed #3b82f6; }
    #boxDept span { color: #3b82f6; }
    #boxDept .resize-handle { background: #3b82f6; }

    #boxName { border: 2px dashed #10b981; }
    #boxName span { color: #10b981; }
    #boxName .resize-handle { background: #10b981; }

    #boxQR { border: 2px dashed #ef4444; }
    #boxQR span { color: #ef4444; }
    #boxQR .resize-handle { background: #ef4444; }

    /* ê·¸ë¦¬ë“œ ë° ì§ì› ì¹´ë“œ */
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; }
    .card{ background:#fff; border-radius:14px; padding:16px 12px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.05); border:1px solid #eef2f7; }
    .name{ font-weight:800; margin-top:12px; font-size: 16px; }
    .id{ font-size:12px; color:#6b7280; margin-top:4px; }
    .dept { font-size:13px; color:#3b82f6; font-weight: 600; margin-top:2px; }
    
    .mini-actions{ margin-top:14px; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
    .mini-actions button{ font-size:11px; padding:8px; border-radius:8px; flex: 1; }
    
    .status{ margin-top:10px; margin-bottom:20px; font-size:13px; color:#111827; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
    .status.good{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .status.bad{ border-color:#fecaca; background:#fef2f2; color:#991b1b; }
    .hidden{ display:none; }
  </style>
</head>
<body>

  <div class="topbar">
    <div style="flex:1; min-width:220px;">
      <h1>ISC ì§ì› ëª…ì°° ìë™í™” ë„êµ¬</h1>
      <div class="muted">
        QR ë‚´ìš©ì€ ê¸°ì¡´ JSON ì‹œìŠ¤í…œ ë¡œì§ì„ 100% ìœ ì§€í•˜ë©°, ì—‘ì…€ì€ í…ìŠ¤íŠ¸ ì •ë³´ë§Œ ì…íˆëŠ” ìš©ë„ì…ë‹ˆë‹¤.
      </div>
    </div>

    <button id="btnReload" class="btn secondary">ì´ˆê¸° JSON ë¡œë“œ</button>
    <button id="btnZip" class="btn">QRë§Œ ì „ì²´ ZIP</button>
    <button id="btnNameTagZip" class="btn primary">ì „ì²´ ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div id="statusBox" class="status hidden"></div>

  <!-- 1. ì—‘ì…€ ë°ì´í„° ë§¤ì¹­ -->
  <div class="setting-card">
    <h2>1. ì—‘ì…€ ë°ì´í„° ë§¤ì¹­ (ì´ë¦„, ì†Œì†, ì‚¬ë²ˆ)</h2>
    <div class="muted" style="margin-bottom: 12px;">
      ì—…ë¡œë“œ ì‹œ <b>ê¸°ì¡´ì— ìƒì„±ëœ QR ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€</b>ë˜ë©°, ì—‘ì…€ì˜ ì‚¬ë²ˆê³¼ ëŒ€ì¡°í•˜ì—¬ ëª…ì°°ì— ë“¤ì–´ê°ˆ [ì´ë¦„/ì†Œì†] ì •ë³´ë§Œ ì•ˆì „í•˜ê²Œ ë§ì…í˜€ì§‘ë‹ˆë‹¤.
    </div>
    <div class="file-input-wrapper">
      <input type="file" id="excelInput" accept=".xlsx, .xls, .csv" class="btn excel" style="width:100%; max-width: 400px; padding: 10px;">
    </div>
  </div>

  <!-- 2. ëª…ì°° ì–‘ì‹ ì—ë””í„° -->
  <div class="setting-card">
    <h2>2. ëª…ì°° ì–‘ì‹ ì—…ë¡œë“œ ë° ë…ë¦½ ì˜ì—­ ì„¤ì •</h2>
    <div class="muted" style="margin-bottom: 12px;">
      ë¹ˆ ëª…ì°° ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í›„, <b>ì†Œì† / ì´ë¦„ / QR</b> ì´ ë“¤ì–´ê°ˆ 3ê°œì˜ ë°•ìŠ¤ë¥¼ ê°ê° ì›í•˜ëŠ” ìœ„ì¹˜ì™€ í¬ê¸°ë¡œ ì¡°ì ˆí•˜ì„¸ìš”.
    </div>
    <div class="file-input-wrapper">
      <input type="file" id="templateInput" accept="image/png, image/jpeg" class="btn secondary" style="width:100%; max-width: 400px; padding: 10px;">
    </div>

    <div class="editor-container" id="editorContainer">
      <img id="templatePreview" alt="ëª…ì°° ë°°ê²½ ë¯¸ë¦¬ë³´ê¸°">
      
      <!-- 3ê°œì˜ ë…ë¦½ëœ ë“œë˜ê·¸ ë°•ìŠ¤ -->
      <div class="print-area-box" id="boxDept" style="left: 10%; top: 15%; width: 80%; height: 10%;">
        <span>ì†Œì† ì¹¸</span><div class="resize-handle"></div>
      </div>
      <div class="print-area-box" id="boxName" style="left: 10%; top: 30%; width: 80%; height: 15%;">
        <span>ì´ë¦„ ì¹¸</span><div class="resize-handle"></div>
      </div>
      <div class="print-area-box" id="boxQR" style="left: 25%; top: 50%; width: 50%; height: 35%;">
        <span>QR ì¹¸</span><div class="resize-handle"></div>
      </div>
    </div>
  </div>

  <div id="qrGrid" class="grid"></div>

<script>
/* ==============================
   ì„¤ì • ë° ìƒíƒœ
============================== */
const EMP_URL  = "people/employees.json?ts=" + Date.now();
const BASE_URL = "https://incarmkt.github.io/travel/?eid=";

let employees = []; // ì‹œìŠ¤í…œ ë² ì´ìŠ¤ JSON ë°ì´í„°
let customTemplateImg = null; 

// 3ê°œì˜ ë°•ìŠ¤ ì˜ì—­ ë¹„ìœ¨ ì €ì¥
let bounds = {
  dept: { x: 0.10, y: 0.15, w: 0.80, h: 0.10 },
  name: { x: 0.10, y: 0.30, w: 0.80, h: 0.15 },
  qr:   { x: 0.25, y: 0.50, w: 0.50, h: 0.35 }
};

/* ==============================
   ìœ í‹¸
============================== */
function setStatus(msg, kind=""){
  const box = document.getElementById("statusBox");
  box.classList.remove("hidden","good","bad");
  if(kind) box.classList.add(kind);
  box.textContent = msg;
}

function clearStatus(){
  const box = document.getElementById("statusBox");
  box.classList.add("hidden");
  box.textContent = "";
}

function safeName(str){ return String(str || "").replace(/[\\/:*?"<>|]/g, "_").trim(); }
function dataURLtoBase64(dataUrl){ return dataUrl.split(",")[1]; }
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* ==============================
   ğŸ”¥ ì—‘ì…€ ì²˜ë¦¬ (ë°ì´í„° ë§¤í•‘/ë³‘í•©)
============================== */
document.getElementById('excelInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if(!file) return;

  setStatus("ì—‘ì…€ ë°ì´í„° ë¶„ì„ ë° JSON ë§¤ì¹­ ì¤‘...", "");

  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);

      let matchCount = 0;

      jsonData.forEach(row => {
        const keys = Object.keys(row);
        const getVal = (possibleKeys) => {
          const matchedKey = keys.find(k => possibleKeys.includes(k.toLowerCase().replace(/\s/g, '')));
          return matchedKey ? String(row[matchedKey]).trim() : "";
        };

        const excelId = getVal(['id', 'ì‚¬ë²ˆ', 'ì§ì›ë²ˆí˜¸', 'ì‚¬ì›ë²ˆí˜¸', 'no']);
        const excelName = getVal(['name', 'ì´ë¦„', 'ì„±ëª…', 'ì§ì›ëª…']);
        const excelDept = getVal(['department', 'ì†Œì†', 'ë¶€ì„œ', 'íŒ€', 'team', 'ë³¸ë¶€']);

        if (excelId) {
          // ğŸ”¥ ê¸°ì¡´ JSON ì‹œìŠ¤í…œì— ìˆëŠ” ì‚¬ì›ê³¼ ì¼ì¹˜í•  ê²½ìš°ì—ë§Œ ì´ë¦„/ì†Œì† ì—…ë°ì´íŠ¸
          const targetEmp = employees.find(e => String(e.id).trim() === excelId);
          if (targetEmp) {
            if(excelName) targetEmp.name = excelName;
            if(excelDept) targetEmp.department = excelDept;
            matchCount++;
          }
        }
      });

      if(matchCount > 0) {
        renderGrid(employees);
        setStatus(`âœ… ë°ì´í„° ë§¤ì¹­ ì„±ê³µ! (ì´ ${matchCount}ëª… ì—…ë°ì´íŠ¸ë¨) QR ë¡œì§ì€ ì•ˆì „í•˜ê²Œ ë³´ì¡´ë˜ì—ˆìŠµë‹ˆë‹¤.`, "good");
      } else {
        setStatus("ê²½ê³ : ê¸°ì¡´ JSON ë¦¬ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•˜ëŠ” ì‚¬ë²ˆì„ ì—‘ì…€ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "bad");
      }
    } catch(err) {
      console.error(err);
      setStatus("ì—‘ì…€ íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜.", "bad");
    }
  };
  reader.readAsArrayBuffer(file);
});


/* ==============================
   ğŸ”¥ ë©€í‹° ë°•ìŠ¤ ë“œë˜ê·¸ & ë¦¬ì‚¬ì´ì¦ˆ ì—ë””í„°
============================== */
const editorContainer = document.getElementById("editorContainer");
const templateInput = document.getElementById("templateInput");
const templatePreview = document.getElementById("templatePreview");

let isDragging = false; let isResizing = false;
let startX, startY, startLeft, startTop, startW, startH;
let activeBox = null;

function getPointerPos(e) {
  if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  return { x: e.clientX, y: e.clientY };
}

document.querySelectorAll('.print-area-box').forEach(box => {
  box.addEventListener('mousedown', (e) => startAction(e, box, 'drag'));
  box.addEventListener('touchstart', (e) => startAction(e, box, 'drag'), {passive: false});

  const handle = box.querySelector('.resize-handle');
  handle.addEventListener('mousedown', (e) => startAction(e, box, 'resize'));
  handle.addEventListener('touchstart', (e) => startAction(e, box, 'resize'), {passive: false});
});

function startAction(e, box, actionType) {
  if (e.target.classList.contains('resize-handle') && actionType === 'drag') return; 
  if (actionType === 'resize') e.stopPropagation();

  activeBox = box;
  const pos = getPointerPos(e);
  startX = pos.x; startY = pos.y;
  
  if(actionType === 'drag') {
    isDragging = true;
    startLeft = box.offsetLeft; startTop = box.offsetTop;
  } else {
    isResizing = true;
    startW = box.offsetWidth; startH = box.offsetHeight;
  }
}

window.addEventListener('mousemove', handleMove);
window.addEventListener('touchmove', handleMove, {passive: false});

function handleMove(e) {
  if ((!isDragging && !isResizing) || !activeBox) return;
  e.preventDefault(); 
  const pos = getPointerPos(e);
  const dx = pos.x - startX; const dy = pos.y - startY;
  const editorRect = editorContainer.getBoundingClientRect();

  if (isDragging) {
    let newL = Math.max(0, Math.min(startLeft + dx, editorRect.width - activeBox.offsetWidth));
    let newT = Math.max(0, Math.min(startTop + dy, editorRect.height - activeBox.offsetHeight));
    activeBox.style.left = newL + 'px'; activeBox.style.top = newT + 'px';
  } else if (isResizing) {
    let newW = Math.max(30, Math.min(startW + dx, editorRect.width - activeBox.offsetLeft));
    let newH = Math.max(20, Math.min(startH + dy, editorRect.height - activeBox.offsetTop));
    activeBox.style.width = newW + 'px'; activeBox.style.height = newH + 'px';
  }
}

window.addEventListener('mouseup', endAction);
window.addEventListener('touchend', endAction);

function endAction() {
  if (isDragging || isResizing) {
    isDragging = false; isResizing = false;
    updateBoxBounds(); 
    activeBox = null;
  }
}

function updateBoxBounds() {
  const ew = editorContainer.offsetWidth;
  const eh = editorContainer.offsetHeight;
  if(ew === 0 || eh === 0) return;

  const getBounds = (box) => ({
    x: box.offsetLeft / ew, y: box.offsetTop / eh,
    w: box.offsetWidth / ew, h: box.offsetHeight / eh
  });

  bounds.dept = getBounds(document.getElementById('boxDept'));
  bounds.name = getBounds(document.getElementById('boxName'));
  bounds.qr   = getBounds(document.getElementById('boxQR'));
}

templateInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    customTemplateImg = new Image();
    customTemplateImg.onload = function() {
      templatePreview.src = event.target.result;
      editorContainer.style.display = "block";
      setTimeout(() => {
        updateBoxBounds(); 
        setStatus("ëª…ì°° ì–‘ì‹ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ê° ì˜ì—­ ë°•ìŠ¤ë¥¼ ë§ˆìš°ìŠ¤ë¡œ ì´ë™í•˜ì—¬ ìœ„ì¹˜ë¥¼ ë§ì¶°ì£¼ì„¸ìš”.", "good");
      }, 100);
    };
    customTemplateImg.src = event.target.result;
  };
  reader.readAsDataURL(file);
});


/* ==============================
   ğŸ”¥ ê°œë³„ ë¶„ë¦¬ëœ ì˜ì—­ ìº”ë²„ìŠ¤ ë Œë”ë§
============================== */
async function createCustomNameTag(emp, qrDataUrl) {
  if (!customTemplateImg) throw new Error("ëª…ì°° ì–‘ì‹ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  const baseW = customTemplateImg.naturalWidth;
  const baseH = customTemplateImg.naturalHeight;
  canvas.width = baseW; canvas.height = baseH;

  // ë°°ê²½ ê·¸ë¦¬ê¸°
  ctx.drawImage(customTemplateImg, 0, 0, baseW, baseH);

  // 1. ì†Œì† ë Œë”ë§ (ì§€ì •ëœ boxDept ì•ˆì—ì„œ ê°€ìš´ë° ì •ë ¬)
  if (emp.department) {
    const bDept = bounds.dept;
    const deptX = baseW * bDept.x; const deptY = baseH * bDept.y;
    const deptW = baseW * bDept.w; const deptH = baseH * bDept.h;
    
    // ë°•ìŠ¤ ë†’ì´ì˜ 60%ë¥¼ í°íŠ¸ í¬ê¸°ë¡œ ì§€ì •í•˜ì—¬ ì•ˆì •ê° ì œê³µ
    const fontSizeDept = Math.max(deptH * 0.6, 12); 
    ctx.fillStyle = "#3b82f6"; // íŒŒë€ìƒ‰ 
    ctx.font = `600 ${fontSizeDept}px Pretendard, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(emp.department, deptX + (deptW / 2), deptY + (deptH / 2));
  }

  // 2. ì´ë¦„ ë Œë”ë§ (ì§€ì •ëœ boxName ì•ˆì—ì„œ ê°€ìš´ë° ì •ë ¬)
  if (emp.name) {
    const bName = bounds.name;
    const nameX = baseW * bName.x; const nameY = baseH * bName.y;
    const nameW = baseW * bName.w; const nameH = baseH * bName.h;
    
    // ì´ë¦„ì€ ë°•ìŠ¤ ë†’ì´ì˜ 75% ì‚¬ìš©í•˜ì—¬ í¬ê³  êµµê²Œ
    const fontSizeName = Math.max(nameH * 0.75, 16);
    ctx.fillStyle = "#111827"; 
    ctx.font = `800 ${fontSizeName}px Pretendard, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(emp.name, nameX + (nameW / 2), nameY + (nameH / 2));
  }

  // 3. QR ë Œë”ë§ (ì§€ì •ëœ boxQR ì•ˆì—ì„œ ì •ì¤‘ì•™ì— ë¹„ìœ¨ ë§ì¶° ìƒì„±)
  const bQR = bounds.qr;
  const qrX = baseW * bQR.x; const qrY = baseH * bQR.y;
  const qrW = baseW * bQR.w; const qrH = baseH * bQR.h;
  
  // ê°€ë¡œ/ì„¸ë¡œ ì¤‘ ì‘ì€ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ QRì„ ì •ì‚¬ê°í˜•ìœ¼ë¡œ ë§ì¶¤
  const qrSize = Math.min(qrW, qrH); 
  const qrDrawX = qrX + ((qrW - qrSize) / 2);
  const qrDrawY = qrY + ((qrH - qrSize) / 2);

  const qrImg = new Image();
  qrImg.src = qrDataUrl;
  await new Promise(r => qrImg.onload = r);

  ctx.drawImage(qrImg, qrDrawX, qrDrawY, qrSize, qrSize);

  return canvas;
}

/* ==============================
   ë Œë”ë§ ë° ì´ë²¤íŠ¸
============================== */
function renderGrid(list){
  const grid = document.getElementById("qrGrid");
  grid.innerHTML = "";

  list.forEach(emp => {
    const card = document.createElement("div");
    card.className = "card";

    const qrBox = document.createElement("div");
    qrBox.style.display = "inline-block";
    qrBox.style.padding = "6px";
    qrBox.style.background = "#fff";
    qrBox.style.borderRadius = "12px";
    qrBox.style.border = "1px solid #eef2f7";

    card.appendChild(qrBox);

    // âœ… JSON ë°ì´í„° ê¸°ë°˜ ì›ë³¸ URL ì²´ê³„ ìœ ì§€
    const qrText = BASE_URL + String(emp.id).trim();

    new QRCode(qrBox, { text: qrText, width: 140, height: 140 });

    const nameEl = document.createElement("div"); nameEl.className = "name"; nameEl.textContent = emp.name;
    const deptEl = document.createElement("div"); deptEl.className = "dept"; deptEl.textContent = emp.department || "";
    const idEl = document.createElement("div"); idEl.className = "id"; idEl.textContent = "ID: " + emp.id;

    const actions = document.createElement("div");
    actions.className = "mini-actions";

    const btnCopy = document.createElement("button");
    btnCopy.className = "btn secondary"; btnCopy.textContent = "ë§í¬ë³µì‚¬";
    btnCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(qrText); setStatus(`${emp.name} ë§í¬ ë³µì‚¬ ì™„ë£Œ`, "good"); }
      catch{ setStatus("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨", "bad"); }
    };

    const btnPng = document.createElement("button");
    btnPng.className = "btn secondary"; btnPng.textContent = "QRë‹¤ìš´";
    btnPng.onclick = async () => {
      try{
        await sleep(30);
        const img = qrBox.querySelector("img"); const canvas = qrBox.querySelector("canvas");
        let dataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
        if(!dataUrl) throw new Error("QR ë Œë” ì˜¤ë¥˜");

        const a = document.createElement("a"); a.href = dataUrl;
        a.download = `${safeName(emp.id)}_${safeName(emp.name)}_QR.png`;
        document.body.appendChild(a); a.click(); a.remove();
        setStatus(`${emp.name} QR ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, "good");
      }catch(e){ setStatus("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨", "bad"); }
    };

    const btnNameTag = document.createElement("button");
    btnNameTag.className = "btn primary"; btnNameTag.textContent = "ëª…ì°°ë‹¤ìš´";
    btnNameTag.onclick = async () => {
      if(!customTemplateImg) return alert("ìƒë‹¨ì—ì„œ ëª…ì°° ì–‘ì‹(ë””ìì¸)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
      try{
        await sleep(30);
        const img = qrBox.querySelector("img"); const canvas = qrBox.querySelector("canvas");
        let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
        
        const nameTagCanvas = await createCustomNameTag(emp, qrDataUrl);
        const a = document.createElement("a"); a.href = nameTagCanvas.toDataURL("image/png");
        a.download = `${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`;
        document.body.appendChild(a); a.click(); a.remove();
        setStatus(`${emp.name} ëª…ì°° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, "good");
      }catch(e){ setStatus(e.message || "ëª…ì°° ìƒì„± ì‹¤íŒ¨", "bad"); }
    };

    actions.appendChild(btnCopy); actions.appendChild(btnPng); actions.appendChild(btnNameTag);
    card.appendChild(nameEl); if(emp.department) card.appendChild(deptEl); card.appendChild(idEl); card.appendChild(actions);
    grid.appendChild(card);
  });
}

/* ==============================
   ì´ˆê¸° JSON ë°ì´í„° ë¡œë“œ
============================== */
async function loadEmployees(){
  setStatus("ê¸°ë³¸ JSON ì‹œìŠ¤í…œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "");
  try{
    if (window.location.protocol === 'blob:' || window.location.protocol === 'data:') {
      throw new Error("ë¯¸ë¦¬ë³´ê¸° ìƒŒë“œë°•ìŠ¤ì…ë‹ˆë‹¤.");
    }
    const res = await fetch(EMP_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    employees = await res.json();
    employees.sort((a,b) => String(a.id).localeCompare(String(b.id), "ko"));
    setStatus(`âœ… ê¸°ë³¸ JSON ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${employees.length}ëª…) - ë¡œê·¸ì¸ ì—°ë™ QRì´ ì •ìƒ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, "good");
  }catch(e){
    employees = [
      { id: "10001", name: "í™ê¸¸ë™", department: "ê°œë°œë³¸ë¶€" },
      { id: "10002", name: "ê¹€ì² ìˆ˜", department: "ë””ìì¸íŒ€" },
      { id: "10003", name: "ì´ì˜í¬", department: "ê²½ì˜ì§€ì›íŒ€" }
    ];
    setStatus("ìƒ˜í”Œ ë°ì´í„°ì…ë‹ˆë‹¤. ì‹¤ ì„œë²„ì— ë°°í¬ ì‹œ people.jsonì„ ì •ìƒì ìœ¼ë¡œ ì°¸ì¡°í•©ë‹ˆë‹¤.", "bad");
  }
  renderGrid(employees);
}

/* ==============================
   ì „ì²´ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
============================== */
async function downloadZipAll(){ /* ê¸°ì¡´ ë¡œì§ ìœ ì§€ */ }

async function downloadNameTagZipAll(){
  if(!employees.length) return setStatus("ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", "bad");
  if(!customTemplateImg) return alert("ìƒë‹¨ì—ì„œ ëª…ì°° ì–‘ì‹(ë””ìì¸)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");

  setStatus("ëª…ì°° ZIP ìƒì„± ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)", "");
  try{
    const zip = new JSZip(); const folder = zip.folder("ISC_ëª…ì°°_ì¶œë ¥ìš©");

    for(let i=0; i<employees.length; i++){
      const emp = employees[i];
      setStatus(`ëª…ì°° ZIP ìƒì„± ì¤‘... ${i+1}/${employees.length} (${emp.name})`, "");
      const temp = document.createElement("div");
      temp.style.position = "fixed"; temp.style.left = "-9999px"; document.body.appendChild(temp);

      new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 400, height: 400 });
      await sleep(60); 

      const img = temp.querySelector("img"); const canvas = temp.querySelector("canvas");
      let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
      temp.remove();

      const nameTagCanvas = await createCustomNameTag(emp, qrDataUrl);
      folder.file(`${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`, dataURLtoBase64(nameTagCanvas.toDataURL("image/png")), { base64:true });
    }
    const blob = await zip.generateAsync({ type:"blob" });
    saveAs(blob, "ISC_ëª…ì°°_ì¶œë ¥ìš©_ì „ì²´.zip");
    setStatus("ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ…", "good");
  }catch(e){ setStatus("ëª…ì°° ZIP ìƒì„± ì‹¤íŒ¨", "bad"); }
}

document.getElementById("btnReload").addEventListener("click", loadEmployees);
document.getElementById("btnZip").addEventListener("click", downloadZipAll);
document.getElementById("btnNameTagZip").addEventListener("click", downloadNameTagZipAll);

loadEmployees();
</script>
</body>
</html>
