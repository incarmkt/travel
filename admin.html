<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISC ê´€ë¦¬ì</title>

  <!-- âœ… ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ ê³µìœ  -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">

  <style>
    /* ê´€ë¦¬ì í˜ì´ì§€ ì „ìš©: ê¸°ì¡´ CSS í›¼ì† ì—†ì´ ìµœì†Œ ì¶”ê°€ */

    /* QR í™”ë©´ì—ì„œë§Œ body ìŠ¤í¬ë¡¤ ì ê¸ˆ */
    body.qr-lock {
      overflow: hidden !important;
      overscroll-behavior: none;
    }

    /* ê´€ë¦¬ì ì—¬í–‰ê´€ë¦¬ ì„œë¸Œ ë²„íŠ¼ */
    .admin-sub-buttons{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
      margin: 12px 0 0;
    }

    /* ì¼ì • í´ë¦­ ì˜ì—­ì„ ë” â€œë²„íŠ¼ì²˜ëŸ¼â€ */
    .admin-clickable { cursor:pointer; user-select:none; }

    /* QR ì˜ì—­: ì–´ë–¤ í°ì´ë“  detail íŒ¨ë„ ì•ˆì— ë§ì¶”ê¸° */
    #qrReader{
      width: 100%;
      max-width: 420px;
      border-radius: 12px;
      background: #000;
      overflow: hidden;
    }

    /* html5-qrcode ë‚´ë¶€ ë¹„ë””ì˜¤ê°€ ì‚ì ¸ë‚˜ì˜¤ëŠ” ì¼€ì´ìŠ¤ ë°©ì§€ */
    #qrReader video, #qrReader canvas{
      width: 100% !important;
      height: auto !important;
      border-radius: 12px;
    }

    .qr-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      width:100%;
    }

    .qr-panel .manual-row{
      width: 100%;
      max-width: 420px;
      display:flex;
      gap:10px;
    }
    .qr-panel .manual-row input{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #d0d5dd;
      background:#fff;
    }

    .qr-result{
      width: 100%;
      max-width: 420px;
      padding:10px 12px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      font-size:14px;
      line-height:1.4;
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      box-sizing:border-box;
    }
    .qr-result.success{ color:#16a34a; font-weight:700; }
    .qr-result.fail{ color:#dc2626; font-weight:700; }

    /* ===============================
       QR í™”ë©´ : í•œ í™”ë©´ ê³ ì • (ìŠ¤í¬ë¡¤ ì œê±°)
       =============================== */

    /* QR ëª¨ë“œì¼ ë•Œ detailPage ì „ì²´ë¥¼ ê³ ì • ë ˆì´ì•„ì›ƒìœ¼ë¡œ */
    body.qr-lock #detailPage {
      height: calc(100vh - 56px); /* í—¤ë” ë†’ì´ ì œì™¸ */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ì œëª© ì œì™¸í•œ ë‚´ìš© ì˜ì—­ */
    body.qr-lock #detailContent {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: stretch;
      overflow: hidden;
      padding-bottom: 12px; /* í•˜ë‹¨ ì—¬ë°± ì‚´ì§ */
      box-sizing: border-box;
    }

    /* QR ì „ì²´ ë¬¶ìŒ */
    body.qr-lock .qr-panel {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 10px;
      padding: 0 12px;
      box-sizing: border-box;
    }

    /* QR ì¹´ë©”ë¼ ì˜ì—­ */
    body.qr-lock #qrReader {
      flex: 1;
      max-height: 45vh;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    /* ë‚´ë¶€ ì¹´ë©”ë¼ ì˜ìƒ ê°•ì œ ë§ì¶¤ */
    body.qr-lock #qrReader video,
    body.qr-lock #qrReader canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
    }

    /* ì‚¬ë²ˆ ì…ë ¥ / ê²°ê³¼ ì˜ì—­ì€ ì¤„ì–´ë“¤ì§€ ì•Šê²Œ */
    body.qr-lock .manual-row,
    body.qr-lock .qr-result {
      flex-shrink: 0;
    }

    /* ===============================
       QR í™”ë©´ ì „ìš©: í•˜ë‹¨ ë„¤ë¹„ ì œê±°
       =============================== */
    body.qr-lock #detailPage .nav-buttons {
      display: none !important;
    }

    /* iOS/ëª¨ë°”ì¼ ì£¼ì†Œì°½ ëŒ€ì‘ */
    body.qr-lock #detailPage {
      height: 100dvh;
    }

    /* ê³ ê° ìƒì„¸ ì¹´ë“œ(ê³ ê°ì •ë³´) */
    .info-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin: 10px 0;
    }
    .info-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    .info-row{
      font-size:14px;
      color:#111827;
    }
    .info-label{
      color:#6b7280;
      font-size:12px;
      margin-bottom:2px;
    }
    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:12px;
    }
  </style>
</head>

<body>

<!-- ================= LOGIN (ê´€ë¦¬ì) ================= -->
<section id="adminLoginSection" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>ISC ê´€ë¦¬ì</h2>
      <p class="hero-desc">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</p>

      <input type="password" id="adminPwInput" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
      <button class="primary-btn" onclick="adminDoLogin()">ë¡œê·¸ì¸</button>
      <p id="adminLoginError" class="error"></p>
    </div>
  </div>
</section>

<!-- ================= HEADER (ê³ ê°ìš© êµ¬ì¡° ê·¸ëŒ€ë¡œ) ================= -->
<header class="header compact" id="topHeader" style="display:none;">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì</h1>
      <p class="sub" id="adminHeaderSub">ê´€ë¦¬ì ëª¨ë“œ</p>
    </div>
  </div>

  <div class="header-right">
    <p class="welcome-text"><strong>ê´€ë¦¬ì</strong>ë‹˜</p>
  </div>
</header>

<!-- ================= MAIN (ê³ ê°ìš© êµ¬ì¡° ê·¸ëŒ€ë¡œ) ================= -->
<main id="mainSection" class="main-bg" style="display:none;">
  <div class="layout">

    <!-- âœ… ì¢Œì¸¡ ë©”ë‰´(ê³ ê°ìš©ê³¼ ë™ì¼ UX) -->
    <aside class="side-menu">
      <!-- âœ… í™ˆ ì‚­ì œ: ê´€ë¦¬ì í™ˆ ë²„íŠ¼ ì œê±° -->
      <button onclick="openPage('travelRoot')">ğŸ§­ ì—¬í–‰ ì¼ì • ê´€ë¦¬</button>
      <button onclick="openPage('mealRoot')">ğŸ’³ ì¤‘ì‹ë¹„ ê´€ë¦¬</button>
      <button onclick="openPage('customerRoot')">ğŸ‘¤ ê³ ê° ì •ë³´</button>
    </aside>

    <!-- âœ… ìš°ì¸¡ ì˜ì—­ -->
    <section class="content-area">
      <div class="main-panel">

        <!-- âœ… í™ˆ ì˜ì—­(ì‚­ì œ ìš”êµ¬ ë°˜ì˜): í™”ë©´ì—ì„œ ì“°ì§€ ì•ŠìŒ -->
        <div id="homeArea" class="home-view" style="display:none;"></div>

        <!-- ìƒì„¸ í˜ì´ì§€(ê³ ê°ìš©ê³¼ ë™ì¼) -->
        <section id="detailPage" class="detail" style="display:none;">
          <h2 id="detailTitle"></h2>
          <div id="detailContent"></div>

          <div class="nav-buttons">
            <button class="ghost-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
            <button class="ghost-btn" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
          </div>
        </section>

      </div>

      <!-- âœ… ìš°ì¸¡ ê³ ì • í¬ìŠ¤í„°(ê³ ê°ìš©ê³¼ ë™ì¼ êµ¬ì¡°) -->
      <aside class="fixed-poster">
        <img src="assets/images/iscposter.jpg" alt="Fixed Poster">
      </aside>

    </section>
  </div>
</main>

<!-- QR ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* =========================================================
   âœ… ì„¤ì • (ìš”êµ¬ì‚¬í•­ ê³ ì •)
========================================================= */
const ADMIN_PASSWORD = "0000";
const GAS_URL = "https://script.google.com/macros/s/AKfycbywujbffRaXimjgXIjZkeyLv0kea2tDe17jtBmMvLjs6gFB0dz16Xkfj4mJLMN2mof83w/exec";
const EMP_URL = "people/employees.json?ts=" + Date.now();

/* =========================================================
   âœ… ê³µí†µ ìƒíƒœ
========================================================= */
let pageHistory = [];
let employees = [];
let qrScanner = null;

/* í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ */
let currentCategory = "";     // "ì „ì²´ì¼ì •" | "ì„ íƒê´€ê´‘"
let currentCourse = "";       // ì¶œë°œì²´í¬ ì½”ìŠ¤ëª…
let currentMealGroup = "";    // "ë‹¨ìˆ˜ì´" | "ê¸°íƒ€"
let currentMealTour = "";     // ì¤‘ì‹ë¹„ ì§€ê¸‰ ëŒ€ìƒ(íˆ¬ì–´/ì‹ë‹¹ëª… ë“±)
let qrMode = "";              // "departure" | "meal" | "customer"
let lastScannedEmployee = null;

/* =========================================================
   âœ… ì§ì› ë°ì´í„° ë¡œë“œ
========================================================= */
fetch(EMP_URL)
  .then(res => res.json())
  .then(data => employees = data)
  .catch(console.error);

/* =========================================================
   âœ… ê´€ë¦¬ì ë¡œê·¸ì¸
========================================================= */
function adminDoLogin(){
  const pw = String(document.getElementById("adminPwInput").value || "").trim();
  if (pw !== ADMIN_PASSWORD) {
    document.getElementById("adminLoginError").textContent = "ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
    return;
  }

  document.getElementById("adminLoginSection").style.display = "none";
  document.getElementById("topHeader").style.display = "flex";
  document.getElementById("mainSection").style.display = "block";
  document.body.classList.add("logged-in");

  // âœ… í™ˆ ì‚­ì œ: ì²« í™”ë©´ì„ travelRootë¡œ
  pageHistory = [];
  openPage("travelRoot");
}

/* =========================================================
   âœ… í˜ì´ì§€ ì—´ê¸° (ì‚­ì œ/ì¬êµ¬ì„± ì—†ì´ ë¶„ê¸°ë§Œ ì¶”ê°€)
========================================================= */
function openPage(type, fromHistory = false){
  cleanupQR();

  if (!fromHistory) pageHistory.push(type);

  // í™ˆì€ ì•ˆ ì”€
  document.getElementById("homeArea").style.display = "none";
  document.getElementById("detailPage").style.display = "block";

  // ëª¨ë°”ì¼ì¼ ë•ŒëŠ” ì‚¬ì´ë“œ ë©”ë‰´ ìˆ¨ê¹€(ê³ ê°ìš©ê³¼ ë™ì¼)
  if (window.innerWidth <= 767) {
    document.querySelector(".side-menu").style.display = "none";
  }

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  /* ================= ì—¬í–‰ ì¼ì • ê´€ë¦¬ (ë£¨íŠ¸) ================= */
  if (type === "travelRoot") {
    t.textContent = "ğŸ§­ ì—¬í–‰ ì¼ì • ê´€ë¦¬";
    c.innerHTML = `
      <div class="card" style="text-align:center;">
        <p style="margin:0; font-weight:700;">ì¶œë°œ ì²´í¬ êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div class="admin-sub-buttons">
          <button class="primary-btn" onclick="openSchedule('ì „ì²´ì¼ì •')">ì „ì²´ ê´€ê´‘ ì¶œë°œ ì²´í¬</button>
          <button class="primary-btn" onclick="openSchedule('ì„ íƒê´€ê´‘')">ì„ íƒ ê´€ê´‘ ì¶œë°œ ì²´í¬</button>
        </div>
      </div>
    `;
    return;
  }

  /* ================= ì¤‘ì‹ë¹„ ê´€ë¦¬ ================= */
  if (type === "mealRoot") {
    t.textContent = "ğŸ’³ ì¤‘ì‹ë¹„ ê´€ë¦¬";
    c.innerHTML = `
      <div class="card" style="text-align:center;">
        <p style="margin:0; font-weight:700;">ì§€ê¸‰ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        <div class="admin-sub-buttons">
          <button class="primary-btn" onclick="openMealGroup('ë‹¨ìˆ˜ì´')">ë‹¨ìˆ˜ì´ ì¤‘ì‹ë¹„ ì§€ê¸‰</button>
          <button class="primary-btn" onclick="openMealGroup('ê¸°íƒ€')">ê¸°íƒ€ ì¤‘ì‹ë¹„ ì§€ê¸‰</button>
        </div>
        <p style="margin:10px 0 0; color:#667085; font-size:12px;">
          â€» QR ì°ìœ¼ë©´ GASì— <span class="pill">type: meal</span> ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.
        </p>
      </div>
    `;
    return;
  }

  /* ================= ê³ ê° ì •ë³´ ================= */
  if (type === "customerRoot") {
    t.textContent = "ğŸ‘¤ ê³ ê° ì •ë³´";
    c.innerHTML = `
      <div class="card" style="text-align:center;">
        <p style="margin:0; font-weight:700;">QRë¡œ ê³ ê°ì„ ì¡°íšŒí•˜ì„¸ìš”</p>
        <div style="margin-top:12px;">
          <button class="primary-btn" onclick="openCustomerScan()">ê³ ê° QR ì¡°íšŒ</button>
        </div>
      </div>
    `;
    return;
  }

  /* ê¸°ë³¸: ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…ì´ë©´ travelRootë¡œ */
  openPage("travelRoot", true);
}

/* =========================================================
   âœ… 2) ì—¬í–‰ ì¼ì •: ì „ì²´/ì„ íƒ ë¶„ê¸°
========================================================= */
function openSchedule(cat){
  currentCategory = cat;

  openPage("scheduleView");
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = (cat === "ì „ì²´ì¼ì •") ? "ğŸ—“ ì „ì²´ ê´€ê´‘ ì¶œë°œ ì²´í¬" : "ğŸ—“ ì„ íƒ ê´€ê´‘ ì¶œë°œ ì²´í¬";

  // âœ… í•µì‹¬: ì„ íƒê´€ê´‘ì´ë©´ 'ì „ì²´ì¼ì •'ì„ ë³´ì—¬ì£¼ì§€ ì•Šê²Œ ë¶„ë¦¬
  const source = (cat === "ì „ì²´ì¼ì •") ? travelSchedule : selectTourSchedule;

  c.innerHTML = source.map(day => `
    <div class="day-card">
      <h3>${day.day} <span>${day.date}</span></h3>
      <p class="day-title">${day.title}</p>

      <div class="timeline">
        ${day.items.map(item => `
          <div class="schedule-item">
            <div class="timeline-dot"></div>
            <div class="schedule-card admin-clickable"
                 onclick="openDepartureQR('${escapeQuotes(item.title)}')">
              <div class="schedule-time">${item.time}</div>
              <div class="schedule-title">${item.icon} ${item.title}</div>
              ${item.desc ? `<div class="schedule-desc">${item.desc}</div>` : ""}
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
}

/* =========================================================
   âœ… 3) ì¤‘ì‹ë¹„: ê·¸ë£¹ -> í•­ëª© ë¦¬ìŠ¤íŠ¸ -> QR
========================================================= */
function openMealGroup(group){
  currentMealGroup = group;

  openPage("mealListView");
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ’³ ì¤‘ì‹ë¹„ ì§€ê¸‰ - ${group}`;

  // âœ… ë„¤ê°€ ê¸°ì¡´ ê³ ê°ìš©ì— ë„£ì–´ë‘” â€œì¤‘ì‹ë¹„ ëŒ€ìƒ(ëŒ€ë¶€ë¶„ ì„ íƒê´€ê´‘)â€ì„ ì—¬ê¸°ë¡œ ê·¸ëŒ€ë¡œ ì˜®ê²¨ ë‹´ìœ¼ë©´ ë¨
  //    (ë‚´ê°€ ë©‹ëŒ€ë¡œ ì‚­ì œ/ë³€ê²½í•˜ì§€ ì•Šê¸° ìœ„í•´ 'ë°°ì—´'ë§Œ ë¶„ë¦¬í•´ë‘ )
  const list = (group === "ë‹¨ìˆ˜ì´") ? mealSchedule_Dansui : mealSchedule_Etc;

  c.innerHTML = list.map(day => `
    <div class="day-card">
      <h3>${day.day} <span>${day.date}</span></h3>
      <p class="day-title">${day.title}</p>

      <div class="timeline">
        ${day.items.map(item => `
          <div class="schedule-item">
            <div class="timeline-dot"></div>
            <div class="schedule-card admin-clickable"
                 onclick="openMealQR('${escapeQuotes(item.title)}')">
              <div class="schedule-time">${item.time}</div>
              <div class="schedule-title">${item.icon} ${item.title}</div>
              ${item.desc ? `<div class="schedule-desc">${item.desc}</div>` : ""}
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
}

function openMealQR(tourTitle){
  currentMealTour = tourTitle;
  qrMode = "meal";

  openPage("mealQRView");
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ“· ì¤‘ì‹ë¹„ ì§€ê¸‰ - ${currentMealGroup} / ${tourTitle}`;

  c.innerHTML = `
    <div class="qr-panel">
      <div id="qrReader"></div>

      <div class="manual-row">
        <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥">
        <button class="ghost-btn" onclick="manualCheck()">í™•ì¸</button>
      </div>

      <div id="qrResult" class="qr-result">QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”</div>

      <div style="width:100%; max-width:420px; display:flex; gap:10px;">
        <button class="primary-btn" style="flex:1;" onclick="approveMeal()">ì§€ê¸‰(ìŠ¹ì¸)</button>
        <button class="ghost-btn" style="flex:1;" onclick="cancelMeal()">ì·¨ì†Œ</button>
      </div>
    </div>
  `;

  document.body.classList.add("qr-lock");
  startQR();
}

function approveMeal(){
  if (!lastScannedEmployee) {
    setQRResult("ë¨¼ì € QR/ì‚¬ë²ˆìœ¼ë¡œ ê³ ê°ì„ í™•ì¸í•˜ì„¸ìš”.", false);
    return;
  }
  processMeal(lastScannedEmployee.id, "APPROVE");
}
function cancelMeal(){
  if (!lastScannedEmployee) {
    setQRResult("ë¨¼ì € QR/ì‚¬ë²ˆìœ¼ë¡œ ê³ ê°ì„ í™•ì¸í•˜ì„¸ìš”.", false);
    return;
  }
  processMeal(lastScannedEmployee.id, "CANCEL");
}

function processMeal(id, action){
  const emp = findEmp(id);
  if (!emp) {
    setQRResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
    return;
  }

  const time = nowKSTString();

  // âœ… GAS ê¸°ë¡ (ë„¤ê°€ ì˜ˆì „ì— ì“°ë˜ í˜•íƒœ: type:"meal")
  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "meal",
      id: emp.id,
      name: emp.name,
      tour: `${currentMealGroup} | ${currentMealTour}`,
      action: action,       // APPROVE / CANCEL
      time: time
    })
  }).catch(console.error);

  setQRResult(`âœ… ${emp.name} (${emp.id}) / ${currentMealGroup} / ${currentMealTour} / ${action} / ${time}`, true);
}

/* =========================================================
   âœ… 4) ê³ ê°ì •ë³´: QR ì¡°íšŒ -> ìƒì„¸
========================================================= */
function openCustomerScan(){
  qrMode = "customer";
  lastScannedEmployee = null;

  openPage("customerQRView");
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ“· ê³ ê° ì¡°íšŒ`;

  c.innerHTML = `
    <div class="qr-panel">
      <div id="qrReader"></div>

      <div class="manual-row">
        <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥">
        <button class="ghost-btn" onclick="manualCheck()">ì¡°íšŒ</button>
      </div>

      <div id="qrResult" class="qr-result">QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”</div>

      <div style="width:100%; max-width:420px;">
        <button class="primary-btn" style="width:100%;" onclick="openCustomerDetail()">ê³ ê° ìƒì„¸ ë³´ê¸°</button>
      </div>
    </div>
  `;

  document.body.classList.add("qr-lock");
  startQR();
}

function openCustomerDetail(){
  if (!lastScannedEmployee) {
    setQRResult("ë¨¼ì € QR/ì‚¬ë²ˆìœ¼ë¡œ ê³ ê°ì„ ì¡°íšŒí•˜ì„¸ìš”.", false);
    return;
  }

  cleanupQR(); // ìƒì„¸ëŠ” ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•´ì•¼ í•˜ë¯€ë¡œ QR ì¢…ë£Œ + ì ê¸ˆ í•´ì œ
  openPage("customerDetailView");

  const emp = lastScannedEmployee;
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ‘¤ ê³ ê° ìƒì„¸ - ${emp.name} (${emp.id})`;

  // employees.jsonì— ë“¤ì–´ìˆëŠ” â€œì •ë¦¬í•´ë‘” ëª¨ë“  ì •ë³´â€ëŠ” êµ¬ì¡°ë¥¼ ëª°ë¼ì„œ
  // ì¼ë‹¨ key/valueë¡œ ì•ˆì „í•˜ê²Œ ì „ë¶€ í¼ì³ì„œ ë³´ì—¬ì¤€ë‹¤ (ì‚­ì œ/ì¶”ì • ì—†ì´)
  const kv = Object.keys(emp).map(k => {
    const v = (typeof emp[k] === "object") ? JSON.stringify(emp[k]) : String(emp[k]);
    return `
      <div class="info-row">
        <div class="info-label">${escapeHtml(k)}</div>
        <div>${escapeHtml(v)}</div>
      </div>
    `;
  }).join("");

  c.innerHTML = `
    <div class="info-card">
      <div style="margin-bottom:8px;">
        <span class="pill">employees.json ê¸°ë°˜</span>
        <span class="pill">ì‚¬ë²ˆ:${escapeHtml(String(emp.id))}</span>
      </div>
      <div class="info-grid">
        ${kv}
      </div>
    </div>

    <div class="info-card">
      <div style="margin-bottom:8px;">
        <span class="pill">ì¶œë°œ/ì¤‘ì‹ë¹„ ê¸°ë¡</span>
        <span class="pill">GAS ì¡°íšŒ(ì˜µì…˜)</span>
      </div>
      <div id="customerLogs" style="color:#6b7280; font-size:13px;">
        ê¸°ë¡ ì¡°íšŒ ì¤‘...
      </div>
    </div>
  `;

  // âœ… (ì˜µì…˜) GASê°€ JSON ì‘ë‹µì„ ì§€ì›í•˜ë©´ í‘œì‹œ
  //    GAS ìª½ì—ì„œ ì•„ë˜ì²˜ëŸ¼ êµ¬í˜„ë˜ì–´ ìˆì–´ì•¼ í•¨:
  //    GET  ?type=customer_logs&id=ì‚¬ë²ˆ  => { departures:[...], meals:[...] }
  fetchCustomerLogs(emp.id);
}

async function fetchCustomerLogs(empId){
  const box = document.getElementById("customerLogs");
  if (!box) return;

  try {
    const url = `${GAS_URL}?type=customer_logs&id=${encodeURIComponent(empId)}&ts=${Date.now()}`;
    const res = await fetch(url, { method:"GET" });
    const data = await res.json();

    const dep = Array.isArray(data.departures) ? data.departures : [];
    const meals = Array.isArray(data.meals) ? data.meals : [];

    const depHtml = dep.length
      ? `<div style="margin-top:6px;"><b>ì¶œë°œ ê¸°ë¡</b><ul>${dep.map(x => `<li>${escapeHtml(JSON.stringify(x))}</li>`).join("")}</ul></div>`
      : `<div style="margin-top:6px;"><b>ì¶œë°œ ê¸°ë¡</b> ì—†ìŒ</div>`;

    const mealHtml = meals.length
      ? `<div style="margin-top:10px;"><b>ì¤‘ì‹ë¹„ ê¸°ë¡</b><ul>${meals.map(x => `<li>${escapeHtml(JSON.stringify(x))}</li>`).join("")}</ul></div>`
      : `<div style="margin-top:10px;"><b>ì¤‘ì‹ë¹„ ê¸°ë¡</b> ì—†ìŒ</div>`;

    box.innerHTML = depHtml + mealHtml;

  } catch (e) {
    box.innerHTML = `
      <div style="color:#6b7280; font-size:13px;">
        í˜„ì¬ GASê°€ JSON ì¡°íšŒë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
        (QR ê¸°ë¡ ì €ì¥ì€ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤)
      </div>
    `;
  }
}

/* =========================================================
   âœ… ê³µí†µ QR: ì¶œë°œì²´í¬ QR
========================================================= */
function openDepartureQR(course){
  currentCourse = course;
  qrMode = "departure";
  lastScannedEmployee = null;

  openPage("qrView");
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ“· ì¶œë°œ ì²´í¬ - ${course}`;

  c.innerHTML = `
    <div class="qr-panel">
      <div id="qrReader"></div>

      <div class="manual-row">
        <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥">
        <button class="ghost-btn" onclick="manualCheck()">ë“±ë¡</button>
      </div>

      <div id="qrResult" class="qr-result">QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”</div>
    </div>
  `;

  document.body.classList.add("qr-lock");
  startQR();
}

/* =========================================================
   âœ… QR ì‹œì‘/ì²˜ë¦¬ (ëª¨ë“œ ê³µìš©)
========================================================= */
async function startQR(){
  if (qrScanner) return;

  try {
    qrScanner = new Html5Qrcode("qrReader");
    const devices = await Html5Qrcode.getCameras();

    if (!devices || devices.length === 0) {
      setQRResult("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", false);
      return;
    }

    const backCam =
      devices.find(d => /back|rear|í›„ë©´/i.test(d.label)) ||
      devices[devices.length - 1];

    await qrScanner.start(
      backCam.id,
      {
        fps: 10,
        qrbox: (viewfinderWidth, viewfinderHeight) => {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          const size = Math.max(200, Math.min(260, Math.floor(minEdge * 0.7)));
          return { width: size, height: size };
        }
      },
      (decodedText) => handleQR(decodedText),
      () => {}
    );

  } catch (e) {
    console.error(e);
    setQRResult("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.", false);
  }
}

function handleQR(text){
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (id) {
      // âœ… ê³µí†µ: ë§ˆì§€ë§‰ ìŠ¤ìº” ê³ ê° ì €ì¥
      const emp = findEmp(id);
      if (emp) lastScannedEmployee = emp;

      // ëª¨ë“œë³„ ì²˜ë¦¬
      if (qrMode === "departure") processDeparture(id);
      else if (qrMode === "meal") {
        // meal ëª¨ë“œëŠ” ìŠ¤ìº” ì¦‰ì‹œ ì§€ê¸‰X, 'ìŠ¹ì¸' ë²„íŠ¼ì„ ëˆ„ë¥´ê²Œ í•¨
        if (emp) setQRResult(`âœ… ${emp.name} (${emp.id}) í™•ì¸ë¨. ì•„ë˜ì—ì„œ ì§€ê¸‰/ì·¨ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.`, true);
        else setQRResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
      }
      else if (qrMode === "customer") {
        if (emp) setQRResult(`âœ… ${emp.name} (${emp.id}) ì¡°íšŒ ì™„ë£Œ. 'ê³ ê° ìƒì„¸ ë³´ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”.`, true);
        else setQRResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
      }
    }
  } catch {
    // QR í˜•ì‹ ì•„ë‹ˆë©´ ë¬´ì‹œ
  }
}

function manualCheck(){
  const id = String(document.getElementById("manualId")?.value || "").trim();
  if (!id) return;

  const emp = findEmp(id);
  if (emp) lastScannedEmployee = emp;

  if (qrMode === "departure") processDeparture(id);
  else if (qrMode === "meal") {
    if (emp) setQRResult(`âœ… ${emp.name} (${emp.id}) í™•ì¸ë¨. ì•„ë˜ì—ì„œ ì§€ê¸‰/ì·¨ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”.`, true);
    else setQRResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
  }
  else if (qrMode === "customer") {
    if (emp) setQRResult(`âœ… ${emp.name} (${emp.id}) ì¡°íšŒ ì™„ë£Œ. 'ê³ ê° ìƒì„¸ ë³´ê¸°'ë¥¼ ëˆ„ë¥´ì„¸ìš”.`, true);
    else setQRResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
  }
}

/* =========================================================
   âœ… ì¶œë°œ ì²˜ë¦¬ + GAS ê¸°ë¡ (ê¸°ì¡´ ë™ì‘ ìœ ì§€)
========================================================= */
function processDeparture(id){
  const emp = findEmp(id);
  if (!emp) {
    setQRResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
    return;
  }

  const time = nowKSTString();

  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "departure",
      id: emp.id,
      name: emp.name,
      category: currentCategory,
      course: currentCourse,
      time: time
    })
  }).catch(console.error);

  setQRResult(`âœ… ${emp.name} (${emp.id}) / ${currentCourse} / ${time}`, true);

  const input = document.getElementById("manualId");
  if (input) input.value = "";
}

function setQRResult(msg, ok){
  const el = document.getElementById("qrResult");
  if (!el) return;
  el.textContent = msg;
  el.classList.remove("success","fail");
  el.classList.add(ok ? "success" : "fail");
}

/* =========================================================
   âœ… í™ˆ/ë’¤ë¡œê°€ê¸° (í™ˆ ì‚­ì œ ë°˜ì˜)
========================================================= */
function goHome(){
  cleanupQR();
  pageHistory = [];

  // âœ… í™ˆ ì‚­ì œ: travelRootë¡œ
  openPage("travelRoot", true);

  // ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œ ë©”ë‰´ ë‹¤ì‹œ ë³´ì´ê¸°
  if (window.innerWidth <= 767) {
    document.querySelector(".side-menu").style.display = "block";
  }
}

function goBack(){
  cleanupQR();
  pageHistory.pop();

  if (pageHistory.length === 0) {
    goHome();
    return;
  }

  const prev = pageHistory[pageHistory.length - 1];
  openPage(prev, true);
}

/* =========================================================
   âœ… QR ì •ë¦¬ (í˜ì´ì§€ ì´ë™/ë’¤ë¡œê°€ê¸°/í™ˆì—ì„œ í•­ìƒ í˜¸ì¶œ)
========================================================= */
function cleanupQR(){
  document.body.classList.remove("qr-lock");
  qrMode = "";

  if (qrScanner) {
    try {
      qrScanner.stop()
        .then(() => {
          qrScanner.clear();
          qrScanner = null;
        })
        .catch(() => {
          try { qrScanner.clear(); } catch {}
          qrScanner = null;
        });
    } catch {
      qrScanner = null;
    }
  }
}

/* =========================================================
   âœ… ìœ í‹¸
========================================================= */
function nowKSTString(){
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  }).format(new Date());
}

function escapeQuotes(str){
  return String(str).replace(/'/g, "\\'").replace(/"/g, '\\"');
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function findEmp(id){
  return employees.find(e => String(e.id).trim() === String(id).trim()) || null;
}

/* =========================================================
   âœ… ì—”í„°ë¡œ ë¡œê·¸ì¸
========================================================= */
document.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && document.getElementById("adminLoginSection").style.display !== "none") {
    adminDoLogin();
  }
});

/* =========================================================
   âœ… ì—¬í–‰ ì¼ì • (ë„¤ê°€ ì¤€ ì›ë³¸ ê·¸ëŒ€ë¡œ / ì‚­ì œ ê¸ˆì§€)
========================================================= */
const travelSchedule = [
  {
    day: "DAY 1",
    date: "2026.03.11 (ìˆ˜)",
    title: "ì¸ì²œ â†’ íƒ€ì´ë² ì´ / ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸",
    items: [
      { time:"08:00", icon:"âœˆï¸", title:"ì¸ì²œ êµ­ì œê³µí•­ ì¶œë°œ", desc:"OZ 711 / KE 2021" },
      { time:"12:30", icon:"ğŸœ", title:"ì¤‘ì‹ | ìš°ìœ¡ë©´", desc:"í˜„ì§€ ì¸ê¸° ì¤‘ì‹ë‹¹" },
      { time:"14:00", icon:"ğŸ›ï¸", title:"ì¤‘ì •ê¸°ë…ë‹¹", desc:"ì¥ê°œì„ ì´í†µ ê¸°ë…ê´€" },
      { time:"15:30", icon:"ğŸº", title:"êµ­ë¦½ê³ ê¶ë°•ë¬¼ê´€", desc:"ì„¸ê³„ 4ëŒ€ ë°•ë¬¼ê´€" },
      { time:"18:30", icon:"ğŸ½ï¸", title:"ì„ì‹ | íƒ€ì¹´ì˜¤ ìƒ¤ë¸Œìƒ¤ë¸Œ", desc:"í˜„ì§€ì‹" },
      { time:"20:00", icon:"ğŸŒƒ", title:"íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€", desc:"ì•¼ê²½ ê´€ëŒ" }
    ]
  },
  {
    day: "DAY 2",
    date: "2026.03.12 (ëª©)",
    title: "ì„ íƒ ê´€ê´‘ / ë§Œì°¬",
    items: [
      { time:"09:00", icon:"ğŸšŒ", title:"ì„ íƒ ê´€ê´‘", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"18:00", icon:"ğŸ‰", title:"ISC ë§Œì°¬", desc:"í•„ìˆ˜ ì°¸ì„" }
    ]
  },
  {
    day: "DAY 3",
    date: "2026.03.13 (ê¸ˆ)",
    title: "ê·¼êµ ê´€ê´‘",
    items: [
      { time:"10:00", icon:"ğŸŒŠ", title:"ì•¼ë¥˜ í•´ìƒê³µì›", desc:"ê¸°ì•”ê´´ì„ ê´€ê´‘" },
      { time:"14:00", icon:"ğŸ®", title:"ì§€ìš°í€", desc:"í™ë“± ë§ˆì„" }
    ]
  },
  {
    day: "DAY 4",
    date: "2026.03.14 (í† )",
    title: "ê·€êµ­",
    items: [
      { time:"07:00", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì•„ì›ƒ", desc:"" },
      { time:"11:40", icon:"âœˆï¸", title:"íƒ€ì´ë² ì´ ì¶œë°œ", desc:"OZ 712 / KE 2022" },
      { time:"15:25", icon:"ğŸ‡°ğŸ‡·", title:"ì¸ì²œ ë„ì°©", desc:"" }
    ]
  }
];

/* =========================================================
   âœ… ì„ íƒê´€ê´‘ 2ê°œ(ì›ë˜ í˜ì´ì§€ì— ìˆë˜ ë‘ í•­ëª©ë§Œ ë‚˜ì˜¤ê²Œ)
   - ì—¬ê¸°ë§Œ ë„¤ ì›ë³¸ 2ê°œë¡œ êµì²´í•˜ë©´ ë¨ (ë‚´ê°€ ë©‹ëŒ€ë¡œ í™•ì¥ ì•ˆ í•¨)
========================================================= */
const selectTourSchedule = [
  {
    day: "ì„ íƒê´€ê´‘",
    date: "",
    title: "ì„ íƒê´€ê´‘ (2ê°œ í•­ëª©)",
    items: [
      // âœ… ì—¬ê¸° 2ê°œë¥¼ ë„¤ ì›ë³¸ ê·¸ëŒ€ë¡œ ë„£ì–´
      { time:"", icon:"â­", title:"ì„ íƒê´€ê´‘ A", desc:"" },
      { time:"", icon:"â­", title:"ì„ íƒê´€ê´‘ B", desc:"" }
    ]
  }
];

/* =========================================================
   âœ… ì¤‘ì‹ë¹„ ìŠ¤ì¼€ì¤„ (ë‹¨ìˆ˜ì´/ê¸°íƒ€)
   - ë„¤ê°€ ì›ë˜ ê³ ê°ìš©ì— ë„£ì–´ë‘” ì¤‘ì‹ë¹„ ëŒ€ìƒë“¤ì„ ê·¸ëŒ€ë¡œ ì˜®ê²¨ ë„£ëŠ” ê³µê°„
========================================================= */
const mealSchedule_Dansui = [
  {
    day: "ë‹¨ìˆ˜ì´",
    date: "",
    title: "ë‹¨ìˆ˜ì´ ì¤‘ì‹ë¹„ ì§€ê¸‰ ëŒ€ìƒ",
    items: [
      // âœ… ë„¤ ì›ë³¸ ê·¸ëŒ€ë¡œ ì±„ì›Œ
      { time:"", icon:"ğŸ±", title:"ë‹¨ìˆ˜ì´ ì¤‘ì‹ë¹„ í•­ëª© 1", desc:"" }
    ]
  }
];

const mealSchedule_Etc = [
  {
    day: "ê¸°íƒ€",
    date: "",
    title: "ê¸°íƒ€ ì¤‘ì‹ë¹„ ì§€ê¸‰ ëŒ€ìƒ",
    items: [
      // âœ… ë„¤ ì›ë³¸ ê·¸ëŒ€ë¡œ ì±„ì›Œ
      { time:"", icon:"ğŸ±", title:"ê¸°íƒ€ ì¤‘ì‹ë¹„ í•­ëª© 1", desc:"" }
    ]
  }
];
</script>

</body>
</html>
