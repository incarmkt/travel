<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì</title>

  <!-- ê³ ê°ìš©ê³¼ ë™ì¼ CSS -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width:768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width:767px)">

  <style>
    body.qr-lock { overflow:hidden; }

    #qrReader {
      width:100%;
      max-width:420px;
      background:#000;
      border-radius:12px;
      overflow:hidden;
    }
    #qrReader video { width:100%!important; height:100%!important; object-fit:cover; }

    .qr-panel{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }

    .qr-result{
      width:100%;
      max-width:420px;
      padding:10px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      text-align:center;
      font-weight:700;
    }
    .qr-result.success{color:#16a34a;}
    .qr-result.fail{color:#dc2626;}

    .info-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
    }
    .info-row{font-size:14px;margin-bottom:6px;}
    .info-label{color:#6b7280;font-size:12px;}
  </style>
</head>

<body>

<!-- ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= -->
<section id="adminLoginSection" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>ISC ê´€ë¦¬ì</h2>
      <input type="password" id="adminPw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
      <button class="primary-btn" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      <p id="loginError" class="error"></p>
    </div>
  </div>
</section>

<header class="header compact" id="topHeader" style="display:none;">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì</h1>
      <p class="sub">ê´€ë¦¬ì ëª¨ë“œ</p>
    </div>
  </div>
</header>

<main id="mainSection" class="main-bg" style="display:none;">
  <div class="layout">

    <aside class="side-menu">
      <button onclick="openPage('travelRoot')">ğŸ§­ ì—¬í–‰ì¼ì •ê´€ë¦¬</button>
      <button onclick="openPage('mealRoot')">ğŸ’³ ì¤‘ì‹ë¹„ì§€ê¸‰ê´€ë¦¬</button>
      <button onclick="openPage('customerRoot')">ğŸ‘¤ ê³ ê°ê´€ë¦¬</button>
    </aside>

    <section class="content-area">
      <div class="main-panel">

        <section id="detailPage" class="detail" style="display:none;">
          <h2 id="detailTitle"></h2>
          <div id="detailContent"></div>

          <div class="nav-buttons">
            <button class="ghost-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
            <button class="ghost-btn" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
          </div>
        </section>

      </div>

      <aside class="fixed-poster">
        <img src="assets/images/iscposter.jpg">
      </aside>
    </section>
  </div>
</main>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ================= ì„¤ì • ================= */
const ADMIN_PASSWORD = "0000";
const GAS_URL = "https://script.google.com/macros/s/AKfycbywujbffRaXimjgXIjZkeyLv0kea2tDe17jtBmMvLjs6gFB0dz16Xkfj4mJLMN2mof83w/exec";
const EMP_URL = "people/employees.json?ts=" + Date.now();

/* ================= ìƒíƒœ ================= */
let employees = [];
let pageHistory = [];
let qrScanner = null;

let qrMode = "";       // departure | meal | customer
let currentPayload = {}; // GASì— ë³´ë‚¼ ë°ì´í„°

fetch(EMP_URL).then(r=>r.json()).then(d=>employees=d);

/* ================= ë¡œê·¸ì¸ ================= */
function adminLogin(){
  const pw = document.getElementById("adminPw").value.trim();
  if(pw !== ADMIN_PASSWORD){
    document.getElementById("loginError").textContent="ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
    return;
  }
  document.getElementById("adminLoginSection").style.display="none";
  document.getElementById("topHeader").style.display="flex";
  document.getElementById("mainSection").style.display="block";
  openPage("travelRoot");
}

/* ================= í˜ì´ì§€ ================= */
function openPage(type, fromHistory=false){
  stopQR();
  if(!fromHistory) pageHistory.push(type);

  document.getElementById("detailPage").style.display="block";
  const t = detailTitle;
  const c = detailContent;

  /* ì—¬í–‰ì¼ì •ê´€ë¦¬ */
  if(type==="travelRoot"){
    t.textContent="ğŸ§­ ì—¬í–‰ì¼ì •ê´€ë¦¬";
    c.innerHTML=`
      <button class="primary-btn" onclick="openDeparture('ì „ì²´ì¼ì •')">ì „ì²´ì¼ì •ê´€ë¦¬</button>
      <button class="primary-btn" onclick="openDeparture('ì„ íƒì¼ì •')">ì„ íƒì¼ì •ê´€ë¦¬</button>
    `;
    return;
  }

  /* ì¤‘ì‹ë¹„ */
  if(type==="mealRoot"){
    t.textContent="ğŸ’³ ì¤‘ì‹ë¹„ì§€ê¸‰ê´€ë¦¬";
    c.innerHTML=`
      <button class="primary-btn" onclick="openMealQR()">ì¤‘ì‹ë¹„ QR ìŠ¤ìº”</button>
    `;
    return;
  }

  /* ê³ ê°ê´€ë¦¬ */
  if(type==="customerRoot"){
    t.textContent="ğŸ‘¤ ê³ ê°ê´€ë¦¬";
    openCustomerQR();
    return;
  }
}

/* ================= QR ê³µí†µ ================= */
function startQR(){
  document.body.classList.add("qr-lock");
  qrScanner = new Html5Qrcode("qrReader");
  qrScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    text=>handleQR(text)
  );
}
function stopQR(){
  document.body.classList.remove("qr-lock");
  if(qrScanner){
    qrScanner.stop().then(()=>qrScanner.clear());
    qrScanner=null;
  }
}

/* ================= ì—¬í–‰ì¼ì • ================= */
function openDeparture(type){
  qrMode="departure";
  currentPayload={ category:type };
  detailTitle.textContent=`ğŸ“· ${type} ì¶œë°œ ì²´í¬`;
  detailContent.innerHTML=`
    <div class="qr-panel">
      <div id="qrReader"></div>
      <div id="qrResult" class="qr-result">QR ìŠ¤ìº” ëŒ€ê¸°ì¤‘</div>
    </div>`;
  startQR();
}

/* ================= ì¤‘ì‹ë¹„ ================= */
function openMealQR(){
  qrMode="meal";
  detailTitle.textContent="ğŸ“· ì¤‘ì‹ë¹„ ì§€ê¸‰";
  detailContent.innerHTML=`
    <div class="qr-panel">
      <div id="qrReader"></div>
      <div id="qrResult" class="qr-result">QR ìŠ¤ìº” ëŒ€ê¸°ì¤‘</div>
    </div>`;
  startQR();
}

/* ================= ê³ ê°ê´€ë¦¬ ================= */
function openCustomerQR(){
  qrMode="customer";
  detailContent.innerHTML=`
    <div class="qr-panel">
      <div id="qrReader"></div>
      <div id="qrResult" class="qr-result">QR ìŠ¤ìº” ëŒ€ê¸°ì¤‘</div>
    </div>`;
  startQR();
}

/* ================= QR ì²˜ë¦¬ ================= */
function handleQR(text){
  try{
    const id = new URL(text).searchParams.get("eid");
    const emp = employees.find(e=>String(e.id)===String(id));
    if(!emp){
      setQR("ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆ",false);
      return;
    }

    const time = now();

    if(qrMode==="departure"){
      sendGAS({type:"departure", id:emp.id, name:emp.name, category:currentPayload.category, time});
      setQR(`${emp.name} ì¶œë°œì²´í¬ ì™„ë£Œ`,true);
    }

    if(qrMode==="meal"){
      sendGAS({type:"meal", id:emp.id, name:emp.name, time});
      setQR(`${emp.name} ì¤‘ì‹ë¹„ ì§€ê¸‰`,true);
    }

    if(qrMode==="customer"){
      showCustomer(emp);
    }

  }catch{}
}

function sendGAS(payload){
  fetch(GAS_URL,{method:"POST",mode:"no-cors",body:JSON.stringify(payload)});
}

/* ================= ê³ ê°ì •ë³´ ================= */
function showCustomer(emp){
  stopQR();
  detailTitle.textContent=`ğŸ‘¤ ${emp.name} (${emp.id})`;
  detailContent.innerHTML=`
    <div class="info-card">
      ${Object.keys(emp).map(k=>`
        <div class="info-row">
          <div class="info-label">${k}</div>
          <div>${JSON.stringify(emp[k])}</div>
        </div>`).join("")}
    </div>`;
}

/* ================= ìœ í‹¸ ================= */
function setQR(msg,ok){
  qrResult.textContent=msg;
  qrResult.className="qr-result "+(ok?"success":"fail");
}
function now(){
  return new Intl.DateTimeFormat("ko-KR",{timeZone:"Asia/Seoul",
    year:"numeric",month:"2-digit",day:"2-digit",
    hour:"2-digit",minute:"2-digit",second:"2-digit"
  }).format(new Date());
}
function goHome(){ pageHistory=[]; openPage("travelRoot",true); }
function goBack(){ pageHistory.pop(); openPage(pageHistory.at(-1)||"travelRoot",true); }
</script>
</body>
</html>
