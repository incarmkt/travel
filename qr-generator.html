<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ISC ì§ì› QR ë° ëª…ì°° ìƒì„±ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ê³ í•´ìƒë„ ì›¹ í°íŠ¸ (Pretendard) -->
  <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ (QR, ZIP, ì—‘ì…€, PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- ğŸ”¥ PDF ìƒì„±ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{
      font-family: 'Pretendard', system-ui, -apple-system, sans-serif;
      background:#f6f7fb;
      margin:0;
      padding: 0;
    }
    
    /* ================= MAIN VIEW ================= */
    #mainView { padding: 20px; }
    
    .topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
    h1{ margin:0; }
    .muted{ color:#667085; font-size:13px; margin:6px 0 0; }
    
    .btn{ border:0; border-radius:10px; padding:12px 16px; cursor:pointer; font-weight:700; font-size: 14px; color:#fff; transition: all 0.2s; }
    .btn:hover { filter: brightness(0.9); }
    .btn.primary { background: #3b82f6; }
    .btn.secondary { background: #fff; color: #111827; border: 1px solid #e5e7eb; }
    .btn.excel { background: #10b981; }
    .btn.dark { background: #111827; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; margin-top: 20px;}
    .card{ background:#fff; border-radius:14px; padding:16px 12px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,.05); border:1px solid #eef2f7; }
    .name{ font-weight:800; margin-top:12px; font-size: 16px; }
    .id{ font-size:12px; color:#6b7280; margin-top:4px; }
    .dept { font-size:13px; color:#3b82f6; font-weight: 600; margin-top:2px; }
    
    .status{ margin-top:10px; margin-bottom:20px; font-size:13px; color:#111827; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; display: none; }
    .status.good{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; display: block; }
    .status.bad{ border-color:#fecaca; background:#fef2f2; color:#991b1b; display: block; }
    
    /* ================= STUDIO VIEW (ìƒˆ ì°½ ëŠë‚Œì˜ ì „ì²´í™”ë©´) ================= */
    #studioView {
      display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #eef2f7;
      z-index: 9999;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    
    /* ìŠ¤íŠœë””ì˜¤ ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
    .studio-header {
      background: #fff;
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 10;
    }
    .studio-title h2 { margin: 0; font-size: 20px; font-weight: 800; }
    .studio-title p { margin: 4px 0 0 0; font-size: 13px; color: #6b7280; }
    
    .studio-tools {
      display: flex;
      gap: 12px;
      padding: 16px 24px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .tool-group {
      background: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .tool-group span.step { font-weight: 800; color: #3b82f6; margin-right: 4px; }

    /* íŒŒì¼ ì¸í’‹ ë²„íŠ¼ ë””ìì¸í™” */
    .file-label {
      background: #fff; border: 1px solid #d1d5db; border-radius: 8px;
      padding: 8px 12px; font-size: 13px; font-weight: 600; cursor: pointer;
      display: inline-block; transition: all 0.2s;
    }
    .file-label:hover { background: #f3f4f6; }
    .file-label input { display: none; }
    
    /* ìŠ¤íŠœë””ì˜¤ ìº”ë²„ìŠ¤ (í¬ê²Œ ë³´ëŠ” ì˜ì—­) */
    .studio-workspace {
      flex: 1;
      overflow: auto;
      padding: 40px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    
    .editor-container {
      position: relative;
      background: #fff;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      /* ì›ë³¸ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©° í™”ë©´ì— ê½‰ ì°¨ê²Œ í¼ì§€ë§‰í•˜ê²Œ í‘œì‹œ */
      max-width: 90%; 
      margin: 0 auto;
      touch-action: none;
    }
    .editor-container img {
      width: 100%;
      height: auto;
      display: block;
      pointer-events: none; 
    }
    
    /* ğŸ”¥ ë“œë˜ê·¸ ë°•ìŠ¤ ê°œì„  (ì–‡ì€ ì ì„ , ìƒ‰ê¹” ì  ì œê±°, í…ìŠ¤íŠ¸ ì¶•ì†Œ) */
    .print-area-box {
      position: absolute;
      background: rgba(255, 255, 255, 0.15); /* ë°˜íˆ¬ëª… ë°°ê²½ì„ ë” ì˜…ê²Œ */
      border: 1px dashed #6b7280; /* ì–‡ê³  ì‹¬í”Œí•œ íšŒìƒ‰ ì ì„  */
      cursor: grab;
      box-sizing: border-box;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .print-area-box:active { cursor: grabbing; }
    
    /* ê¸€ì”¨ ì‘ê³  ê±°ìŠ¬ë¦¬ì§€ ì•Šê²Œ */
    .print-area-box span { 
      font-weight: 600; 
      font-size: 12px; 
      color: #374151;
      pointer-events: none; 
      text-shadow: 1px 1px 2px rgba(255,255,255,0.9); /* ê¸€ì”¨ ê°€ë…ì„±ë§Œ ì‚´ì§ ìœ ì§€ */
    }
    
    /* í™œì„±í™”(ì„ íƒ) ëœ ë°•ìŠ¤ (í‚¤ë³´ë“œ ì¡°ì‘ íƒ€ê²Ÿ) - ì–‡ì€ ë¹¨ê°„ ì ì„  */
    .print-area-box.active {
      background: rgba(59, 130, 246, 0.1);
      border: 1px dashed #ef4444 !important; 
      z-index: 10;
    }
    
    /* í¬ê¸° ì¡°ì ˆ ì˜ì—­ (ê¸°ëŠ¥ì€ ìœ ì§€í•˜ë˜ ëˆˆì—ëŠ” ì•ˆ ë³´ì´ê²Œ íˆ¬ëª… ì²˜ë¦¬) */
    .resize-handle {
      position: absolute; 
      right: 0; 
      bottom: 0; 
      width: 20px; 
      height: 20px;
      cursor: se-resize; 
      background: transparent; /* íˆ¬ëª… */
    }

  </style>
</head>
<body>

  <!-- ================= MAIN VIEW ================= -->
  <div id="mainView">
    <div class="topbar">
      <div style="flex:1; min-width:220px;">
        <h1>ISC ì§ì› QR ìë™ìƒì„±ê¸°</h1>
        <div class="muted">ê³ ìœ  QR í…ìŠ¤íŠ¸ ë°ì´í„° ë² ì´ìŠ¤ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
      
      <!-- ëª…ì°° ìŠ¤íŠœë””ì˜¤ ì—´ê¸° ë²„íŠ¼ -->
      <button id="btnOpenStudio" class="btn primary" style="padding: 14px 24px; font-size: 16px;">âœ¨ ëª…ì°° ì œì‘ ìŠ¤íŠœë””ì˜¤ ì—´ê¸°</button>
      <button id="btnZip" class="btn secondary">QRë§Œ ì „ì²´ ZIP</button>
    </div>

    <div id="statusBox" class="status"></div>
    <div id="qrGrid" class="grid"></div>
  </div>


  <!-- ================= STUDIO VIEW (ìƒˆ ì°½) ================= -->
  <div id="studioView">
    <div class="studio-header">
      <div class="studio-title">
        <h2>ğŸ¨ ëª…ì°° ì œì‘ ìŠ¤íŠœë””ì˜¤</h2>
        <p>ë°•ìŠ¤ë¥¼ í´ë¦­ í›„ <b>í‚¤ë³´ë“œ ë°©í–¥í‚¤(â†‘,â†“,â†,â†’)</b>ë¡œ ìœ„ì¹˜ë¥¼ ë¯¸ì„¸ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì†Œì†: <b>í°ìƒ‰</b> / ì´ë¦„: <b>ê²€ì •ìƒ‰</b> ë Œë”ë§)</p>
      </div>
      <button id="btnCloseStudio" class="btn dark">ëŒì•„ê°€ê¸° (ë‹«ê¸°)</button>
    </div>
    
    <div class="studio-tools">
      <div class="tool-group">
        <span class="step">1</span>
        <button id="btnDownloadTemplate" class="btn secondary" style="padding: 8px 12px; font-size: 13px;">ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
      </div>

      <div class="tool-group">
        <span class="step">2</span>
        <label class="file-label" style="color:#10b981; border-color:#10b981;">
          ì—‘ì…€ ë°ì´í„° ì—…ë¡œë“œ (.xlsx)
          <input type="file" id="excelInput" accept=".xlsx, .xls, .csv">
        </label>
        <span id="excelStatus" style="font-size: 13px; color: #6b7280;"></span>
      </div>

      <div class="tool-group">
        <span class="step">3</span>
        <label class="file-label" style="color:#3b82f6; border-color:#3b82f6;">
          ë¹ˆ ëª…ì°° ë””ìì¸ ì—…ë¡œë“œ (JPG, PNG)
          <input type="file" id="templateInput" accept="image/png, image/jpeg">
        </label>
      </div>
      
      <div style="flex: 1;"></div>
      
      <button id="btnNameTagZip" class="btn primary" style="font-size: 16px; padding: 12px 24px;">ğŸ“¥ ê°œë³„ ì´ë¯¸ì§€ + í†µí•© PDF ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <!-- ì—„ì²­ í¬ê²Œ ë³´ì´ëŠ” í¸ì§‘ ì˜ì—­ -->
    <div class="studio-workspace">
      <div class="editor-container" id="editorContainer">
        <img id="templatePreview" alt="ëª…ì°° ë°°ê²½ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”." style="min-height: 400px; background: #fff;">
        
        <!-- í…ìŠ¤íŠ¸ ë‚´ìš© ê°„ì†Œí™” ë° ì‹ë³„ ID ìœ ì§€ -->
        <div class="print-area-box" id="boxDept" style="left: 10%; top: 15%; width: 80%; height: 10%;" tabindex="0">
          <span>ì†Œì†</span><div class="resize-handle"></div>
        </div>
        <div class="print-area-box" id="boxName" style="left: 10%; top: 30%; width: 80%; height: 15%;" tabindex="0">
          <span>ì´ë¦„</span><div class="resize-handle"></div>
        </div>
        <div class="print-area-box" id="boxQR" style="left: 25%; top: 50%; width: 50%; height: 35%;" tabindex="0">
          <span>QRì˜ì—­</span><div class="resize-handle"></div>
        </div>
      </div>
    </div>
  </div>


<script>
/* ==============================
   1. ê¸°ë³¸ ì„¤ì • ë° ìƒíƒœ
============================== */
const EMP_URL  = "people/employees.json?ts=" + Date.now();
// ğŸ”¥ ì´ ì£¼ì†Œê°€ ë°”ë¡œ ì—¬í–‰ ì•ˆë‚´ ì‚¬ì´íŠ¸ì˜ ì£¼ì†Œì…ë‹ˆë‹¤!
// ì´ ì½”ë“œë¥¼ index.htmlì— ë®ì–´ì“°ì‹œë©´ qrì´ ìƒì„±ê¸° ìì‹ ì„ ë¶€ë¥´ê²Œ ë˜ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.
const BASE_URL = "https://incarmkt.github.io/travel/?eid=";

let employees = []; 
let customTemplateImg = null; 

// ë°•ìŠ¤ ë¹„ìœ¨ ì €ì¥ ë°ì´í„°
let bounds = {
  dept: { x: 0.10, y: 0.15, w: 0.80, h: 0.10 },
  name: { x: 0.10, y: 0.30, w: 0.80, h: 0.15 },
  qr:   { x: 0.25, y: 0.50, w: 0.50, h: 0.35 }
};

// ìœ í‹¸
function setStatus(msg, kind=""){
  const box = document.getElementById("statusBox");
  box.className = "status"; // ë¦¬ì…‹
  if(kind) box.classList.add(kind);
  box.textContent = msg;
}
function safeName(str){ return String(str || "").replace(/[\\/:*?"<>|]/g, "_").trim(); }
function dataURLtoBase64(dataUrl){ return dataUrl.split(",")[1]; }
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }


/* ==============================
   2. ë·° ì „í™˜ ì œì–´ (ìƒˆ ì°½ íš¨ê³¼)
============================== */
const mainView = document.getElementById("mainView");
const studioView = document.getElementById("studioView");

document.getElementById("btnOpenStudio").addEventListener("click", () => {
  mainView.style.display = "none";
  studioView.style.display = "flex";
  // í™”ë©´ì´ ë³´ì¸ í›„ ì‚¬ì´ì¦ˆ ë‹¤ì‹œ ì…‹íŒ…
  setTimeout(updateBoxBounds, 200);
});

document.getElementById("btnCloseStudio").addEventListener("click", () => {
  studioView.style.display = "none";
  mainView.style.display = "block";
});


/* ==============================
   3. ì—‘ì…€ ë°ì´í„° ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
============================== */
document.getElementById('btnDownloadTemplate').addEventListener('click', () => {
  const wsData = [ ["ì‚¬ë²ˆ", "ì´ë¦„", "ì†Œì†"] ];
  
  if(employees && employees.length > 0) {
    employees.forEach(emp => {
      wsData.push([String(emp.id).trim(), emp.name || "", emp.department || ""]);
    });
  } else {
    wsData.push(["10001", "í™ê¸¸ë™", "ê°œë°œë³¸ë¶€"]);
    wsData.push(["10002", "ê¹€ì² ìˆ˜", "ë””ìì¸íŒ€"]);
  }

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 20}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ëª…ì°°ë°ì´í„°");
  XLSX.writeFile(wb, "ëª…ì°°_ì •ë³´_ì—…ë¡œë“œì–‘ì‹.xlsx");
});


/* ==============================
   4. ğŸ”¥ ì—‘ì…€ ë°ì´í„° ì™„ì „ ë®ì–´ì“°ê¸° ë¡œì§
============================== */
document.getElementById('excelInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if(!file) return;

  const statusTxt = document.getElementById('excelStatus');
  statusTxt.textContent = "ë°ì´í„° ì™„ì „íˆ êµì²´í•˜ëŠ” ì¤‘...";

  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const worksheet = workbook.Sheets[workbook.SheetNames[0]];
      
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, defval: "" });

      const newEmployees = [];

      jsonData.forEach(row => {
        const keys = Object.keys(row);
        const getVal = (possibleKeys) => {
          const matchedKey = keys.find(k => possibleKeys.includes(k.toLowerCase().replace(/\s/g, '')));
          return matchedKey ? String(row[matchedKey]).trim() : "";
        };

        const excelId = getVal(['id', 'ì‚¬ë²ˆ', 'ì§ì›ë²ˆí˜¸']);
        const excelName = getVal(['name', 'ì´ë¦„', 'ì„±ëª…']);
        const excelDept = getVal(['department', 'ì†Œì†', 'ë¶€ì„œ', 'íŒ€']);

        // ì´ë¦„ì´ë‚˜ ì‚¬ë²ˆì´ ì¡´ì¬í•˜ë©´ ìƒˆë¡œìš´ ëª©ë¡ì— ê°•ì œë¡œ ì¶”ê°€
        if (excelName || excelId) {
          newEmployees.push({
            id: excelId || "0000",
            name: excelName || "",
            department: excelDept || ""
          });
        }
      });

      if(newEmployees.length > 0) {
        // ğŸ”¥ í•µì‹¬: ê¸°ì¡´ ë°ì´í„°ë¥¼ ë²„ë¦¬ê³  ë¬´ì¡°ê±´ ì—‘ì…€ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì—ì–´ë²„ë¦¼
        employees = newEmployees;
        renderGrid(employees); 
        statusTxt.textContent = `âœ… ì—‘ì…€ ê¸°ì¤€ ${employees.length}ëª…ìœ¼ë¡œ ëª©ë¡ êµì²´ ì™„ë£Œ!`;
        statusTxt.style.color = "#10b981";
      } else {
        statusTxt.textContent = `âŒ ì—‘ì…€ì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`;
        statusTxt.style.color = "#ef4444";
      }
    } catch(err) {
      statusTxt.textContent = `ì˜¤ë¥˜ ë°œìƒ: ${err.message}`;
    }
  };
  reader.readAsArrayBuffer(file);
});


/* ==============================
   5. ìŠ¤íŠœë””ì˜¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ì—ë””í„° ë¡œì§
============================== */
const editorContainer = document.getElementById("editorContainer");
const templateInput = document.getElementById("templateInput");
const templatePreview = document.getElementById("templatePreview");
const boxes = document.querySelectorAll('.print-area-box');

let selectedBox = null;
let isDragging = false; let isResizing = false;
let startX, startY, startLeft, startTop, startW, startH;
let activeBox = null;

function getPointerPos(e) {
  if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
  return { x: e.clientX, y: e.clientY };
}

function selectBox(box) {
  boxes.forEach(b => b.classList.remove('active'));
  if(box) {
    box.classList.add('active');
    selectedBox = box;
    box.focus();
  } else {
    selectedBox = null;
  }
}

editorContainer.addEventListener('mousedown', (e) => {
  if(e.target === editorContainer || e.target === templatePreview) {
    selectBox(null);
  }
});

boxes.forEach(box => {
  const startDragEvent = (e) => {
    selectBox(box);
    if (e.target.classList.contains('resize-handle')) return; 
    
    activeBox = box;
    isDragging = true;
    const pos = getPointerPos(e);
    startX = pos.x; startY = pos.y;
    startLeft = box.offsetLeft; startTop = box.offsetTop;
  };

  box.addEventListener('mousedown', startDragEvent);
  box.addEventListener('touchstart', startDragEvent, {passive: false});

  const handle = box.querySelector('.resize-handle');
  const startResizeEvent = (e) => {
    selectBox(box);
    e.stopPropagation();
    activeBox = box;
    isResizing = true;
    const pos = getPointerPos(e);
    startX = pos.x; startY = pos.y;
    startW = box.offsetWidth; startH = box.offsetHeight;
  };

  handle.addEventListener('mousedown', startResizeEvent);
  handle.addEventListener('touchstart', startResizeEvent, {passive: false});
});

window.addEventListener('mousemove', handleMove);
window.addEventListener('touchmove', handleMove, {passive: false});

function handleMove(e) {
  if ((!isDragging && !isResizing) || !activeBox) return;
  e.preventDefault(); 
  
  const pos = getPointerPos(e);
  const dx = pos.x - startX; const dy = pos.y - startY;
  const editorRect = editorContainer.getBoundingClientRect();

  if (isDragging) {
    let newL = Math.max(0, Math.min(startLeft + dx, editorRect.width - activeBox.offsetWidth));
    let newT = Math.max(0, Math.min(startTop + dy, editorRect.height - activeBox.offsetHeight));
    activeBox.style.left = newL + 'px'; activeBox.style.top = newT + 'px';
  } else if (isResizing) {
    let newW = Math.max(30, Math.min(startW + dx, editorRect.width - activeBox.offsetLeft));
    let newH = Math.max(20, Math.min(startH + dy, editorRect.height - activeBox.offsetTop));
    activeBox.style.width = newW + 'px'; activeBox.style.height = newH + 'px';
  }
}

window.addEventListener('mouseup', endAction);
window.addEventListener('touchend', endAction);

function endAction() {
  if (isDragging || isResizing) {
    isDragging = false; isResizing = false;
    updateBoxBounds(); 
    activeBox = null;
  }
}

window.addEventListener('keydown', (e) => {
  if (!selectedBox || studioView.style.display === 'none') return;
  
  if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
    e.preventDefault(); 
    const step = e.shiftKey ? 10 : 1;
    let currentLeft = selectedBox.offsetLeft;
    let currentTop = selectedBox.offsetTop;
    
    const editorRect = editorContainer.getBoundingClientRect();
    
    if (e.key === "ArrowUp") currentTop -= step;
    if (e.key === "ArrowDown") currentTop += step;
    if (e.key === "ArrowLeft") currentLeft -= step;
    if (e.key === "ArrowRight") currentLeft += step;

    currentLeft = Math.max(0, Math.min(currentLeft, editorRect.width - selectedBox.offsetWidth));
    currentTop = Math.max(0, Math.min(currentTop, editorRect.height - selectedBox.offsetHeight));

    selectedBox.style.left = currentLeft + 'px';
    selectedBox.style.top = currentTop + 'px';
    
    updateBoxBounds();
  }
});

function updateBoxBounds() {
  const ew = editorContainer.offsetWidth;
  const eh = editorContainer.offsetHeight;
  if(ew === 0 || eh === 0) return;

  const getBounds = (box) => ({
    x: box.offsetLeft / ew, y: box.offsetTop / eh,
    w: box.offsetWidth / ew, h: box.offsetHeight / eh
  });

  bounds.dept = getBounds(document.getElementById('boxDept'));
  bounds.name = getBounds(document.getElementById('boxName'));
  bounds.qr   = getBounds(document.getElementById('boxQR'));
}

templateInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(event) {
    customTemplateImg = new Image();
    customTemplateImg.onload = function() {
      templatePreview.src = event.target.result;
      setTimeout(updateBoxBounds, 100);
    };
    customTemplateImg.src = event.target.result;
  };
  reader.readAsDataURL(file);
});


/* ==============================
   6. ëª…ì°° ìµœì¢… í•©ì„± (Canvas)
============================== */
async function createCustomNameTag(emp, qrDataUrl) {
  if (!customTemplateImg) throw new Error("ëª…ì°° ë°°ê²½ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  const baseW = customTemplateImg.naturalWidth;
  const baseH = customTemplateImg.naturalHeight;
  canvas.width = baseW; canvas.height = baseH;

  ctx.drawImage(customTemplateImg, 0, 0, baseW, baseH);

  if (emp.department) {
    const bDept = bounds.dept;
    const deptX = baseW * bDept.x; const deptY = baseH * bDept.y;
    const deptW = baseW * bDept.w; const deptH = baseH * bDept.h;
    
    const fontSizeDept = Math.max(deptH * 0.6, 12); 
    ctx.fillStyle = "#ffffff"; 
    ctx.font = `600 ${fontSizeDept}px Pretendard, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(emp.department, deptX + (deptW / 2), deptY + (deptH / 2));
  }

  if (emp.name) {
    const bName = bounds.name;
    const nameX = baseW * bName.x; const nameY = baseH * bName.y;
    const nameW = baseW * bName.w; const nameH = baseH * bName.h;
    
    const fontSizeName = Math.max(nameH * 0.75, 16);
    ctx.fillStyle = "#111827"; 
    ctx.font = `800 ${fontSizeName}px Pretendard, sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(emp.name, nameX + (nameW / 2), nameY + (nameH / 2));
  }

  const bQR = bounds.qr;
  const qrX = baseW * bQR.x; const qrY = baseH * bQR.y;
  const qrW = baseW * bQR.w; const qrH = baseH * bQR.h;
  
  const qrSize = Math.min(qrW, qrH); 
  const qrDrawX = qrX + ((qrW - qrSize) / 2);
  const qrDrawY = qrY + ((qrH - qrSize) / 2);

  const qrImg = new Image();
  qrImg.src = qrDataUrl;
  await new Promise(r => qrImg.onload = r);

  ctx.drawImage(qrImg, qrDrawX, qrDrawY, qrSize, qrSize);

  return canvas;
}


/* ==============================
   7. ê·¸ë¦¬ë“œ ì¶œë ¥ (ë©”ì¸ í™”ë©´ìš©)
============================== */
function renderGrid(list){
  const grid = document.getElementById("qrGrid");
  grid.innerHTML = "";

  list.forEach(emp => {
    const card = document.createElement("div");
    card.className = "card";

    const qrBox = document.createElement("div");
    qrBox.style.display = "inline-block";
    qrBox.style.padding = "6px";
    qrBox.style.background = "#fff";
    qrBox.style.borderRadius = "12px";
    qrBox.style.border = "1px solid #eef2f7";

    card.appendChild(qrBox);

    const qrText = BASE_URL + String(emp.id).trim();
    new QRCode(qrBox, { text: qrText, width: 140, height: 140 });

    const nameEl = document.createElement("div"); nameEl.className = "name"; nameEl.textContent = emp.name;
    const deptEl = document.createElement("div"); deptEl.className = "dept"; deptEl.textContent = emp.department || "";
    const idEl = document.createElement("div"); idEl.className = "id"; idEl.textContent = "ID: " + emp.id;

    card.appendChild(nameEl); if(emp.department) card.appendChild(deptEl); card.appendChild(idEl);
    grid.appendChild(card);
  });
}

/* ==============================
   8. ì´ˆê¸° JSON ë¡œë“œ 
============================== */
async function loadEmployees(){
  setStatus("ë°ì´í„° ë¡œë“œ ì¤‘...", "");
  try{
    if (window.location.protocol === 'blob:' || window.location.protocol === 'data:') {
      throw new Error("Preview sandbox");
    }
    const res = await fetch(EMP_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("JSON not found");
    employees = await res.json();
    employees.sort((a,b) => String(a.id).localeCompare(String(b.id), "ko"));
    setStatus(`âœ… ê¸°ë³¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${employees.length}ëª…)`, "good");
  }catch(e){
    employees = [
      { id: "10001", name: "í™ê¸¸ë™", department: "ê°œë°œë³¸ë¶€" },
      { id: "10002", name: "ê¹€ì² ìˆ˜", department: "ë””ìì¸íŒ€" },
      { id: "10003", name: "ì´ì˜í¬", department: "ê²½ì˜ì§€ì›íŒ€" }
    ];
    setStatus("í…ŒìŠ¤íŠ¸ ìƒ˜í”Œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "bad");
  }
  renderGrid(employees);
}

// QR ë§Œ ì „ì²´ ì••ì¶•
document.getElementById("btnZip").addEventListener("click", async () => {
  if(!employees.length) return alert("ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
  const zip = new JSZip(); const folder = zip.folder("ISC_QR");
  
  for(let i=0; i<employees.length; i++){
    const emp = employees[i];
    const temp = document.createElement("div");
    temp.style.position = "fixed"; temp.style.left = "-9999px"; document.body.appendChild(temp);
    new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 320, height: 320 });
    await sleep(40);
    const img = temp.querySelector("img"); const canvas = temp.querySelector("canvas");
    let dataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
    folder.file(`${safeName(emp.id)}_${safeName(emp.name)}.png`, dataURLtoBase64(dataUrl), { base64:true });
    temp.remove();
  }
  const blob = await zip.generateAsync({ type:"blob" });
  saveAs(blob, "ISC_ì§ì›_QRì „ì²´.zip");
});

// ğŸ”¥ ìŠ¤íŠœë””ì˜¤ ë‚´: ëª…ì°° ê°œë³„ PNG + í†µí•© A4 PDFë¥¼ í•œ ë²ˆì— ìƒì„±
document.getElementById("btnNameTagZip").addEventListener("click", async () => {
  if(!employees.length) return alert("ì§ì› ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ì„ ì—…ë¡œë“œ í•´ì£¼ì„¸ìš”.");
  if(!customTemplateImg) return alert("ë””ìì¸ íŒŒì¼(JPG, PNG)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");

  const btn = document.getElementById("btnNameTagZip");
  btn.textContent = "ëª…ì°° ë° PDF ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!";
  btn.style.pointerEvents = "none";

  try{
    const zip = new JSZip(); 
    const imgFolder = zip.folder("ê°œë³„_ëª…ì°°_ì´ë¯¸ì§€"); // PNG ë‹´ì„ í´ë”
    
    // A4 ì‚¬ì´ì¦ˆ ê¸°ì¤€ PDF (ë‹¨ìœ„ mm, 210 x 297)
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    for(let i=0; i<employees.length; i++){
      const emp = employees[i];
      const temp = document.createElement("div");
      temp.style.position = "fixed"; temp.style.left = "-9999px"; document.body.appendChild(temp);

      // QR ì½”ë“œ ê³ í•´ìƒë„ ìƒì„±
      new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 400, height: 400 });
      await sleep(40); 

      const img = temp.querySelector("img"); const canvas = temp.querySelector("canvas");
      let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
      temp.remove();

      // ëª…ì°° ì´ë¯¸ì§€ ìƒì„±
      const nameTagCanvas = await createCustomNameTag(emp, qrDataUrl);
      const imgDataUrl = nameTagCanvas.toDataURL("image/png");
      
      // 1. ZIPì— ê°œë³„ PNG ì¶”ê°€
      imgFolder.file(`${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`, dataURLtoBase64(imgDataUrl), { base64:true });

      // 2. PDFì— 2ì¥ì”© ë°°ì¹˜ ì¶”ê°€ ë¡œì§
      // (ë¹„ìœ¨ ìœ ì§€í•˜ë˜ 1ì¥ë‹¹ ìµœëŒ€ ë†’ì´ 135mm, ë§ˆì§„ 10mmë¡œ ìƒ/í•˜ ë°°ì¹˜)
      const ratio = nameTagCanvas.height / nameTagCanvas.width;
      const targetH = 135; 
      const targetW = targetH / ratio;
      const startX = (210 - targetW) / 2; // ê°€ë¡œ ì¤‘ì•™ ì •ë ¬

      if (i > 0 && i % 2 === 0) {
        pdf.addPage(); // 2ì¥ ì±„ì›Œì¡Œìœ¼ë©´ ìƒˆ í˜ì´ì§€
      }
      
      // ì§ìˆ˜ ì¸ë±ìŠ¤(0, 2, 4...)ëŠ” ìƒë‹¨ ë°°ì¹˜, í™€ìˆ˜ ì¸ë±ìŠ¤ëŠ” í•˜ë‹¨ ë°°ì¹˜
      const startY = (i % 2 === 0) ? 10 : 10 + targetH + 10;
      pdf.addImage(imgDataUrl, 'PNG', startX, startY, targetW, targetH);
    }
    
    // PDF ë°ì´í„°ë¥¼ blobìœ¼ë¡œ ë½‘ì•„ì„œ zip ë°”ë¡œ ë°”ê¹¥ì— ì¶”ê°€
    const pdfBlob = pdf.output('blob');
    zip.file("ëª…ì°°_ì¶œë ¥ìš©_A4_í†µí•©ë³¸.pdf", pdfBlob);

    // ZIP ë‹¤ìš´ë¡œë“œ
    const blob = await zip.generateAsync({ type:"blob" });
    saveAs(blob, "ISC_ì „ì²´ëª…ì°°_ë°_PDF.zip");
    alert("ê°œë³„ ì´ë¯¸ì§€ì™€ PDF íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
  }catch(e){ 
    alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
  } finally {
    btn.textContent = "ğŸ“¥ ê°œë³„ ì´ë¯¸ì§€ + í†µí•© PDF ë‹¤ìš´ë¡œë“œ";
    btn.style.pointerEvents = "auto";
  }
});

loadEmployees();
</script>
</body>
</html>
