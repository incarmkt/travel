<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì ì¶œë°œ ì²´í¬</title>

  <!-- âœ… ê¸°ì¡´ ê°œì¸ í˜ì´ì§€ì™€ CSS 100% ê³µìœ  -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">
</head>

<body>

<!-- ================= ëª¨ë°”ì¼ ìŠ¤í”Œë˜ì‹œ (ê°œì¸ í˜ì´ì§€ì™€ ë™ì¼) ================= -->
<div id="mobileSplash" class="mobile-splash" style="display:none;">
  <img src="assets/images/iscposter.jpg" alt="ISC Poster">
</div>

<!-- ================= HEADER ================= -->
<header class="header compact" id="topHeader" style="display:none;">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì ì¶œë°œ ì²´í¬</h1>
      <p class="sub">ê´€ë¦¬ì ì „ìš©</p>
    </div>
  </div>
  <div class="header-right">
    <p class="welcome-text"><strong>ê´€ë¦¬ì ëª¨ë“œ</strong></p>
  </div>
</header>

<!-- ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= -->
<section id="adminLogin" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>ê´€ë¦¬ì í™•ì¸</h2>
      <p class="hero-desc">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</p>

      <input type="password" id="adminPw" placeholder="ê´€ë¦¬ì ë²ˆí˜¸">
      <button class="primary-btn" onclick="adminLogin()">í™•ì¸</button>
      <p id="adminError" class="error"></p>
    </div>
  </div>
</section>

<!-- ================= ê´€ë¦¬ì ë©”ì¸ ================= -->
<main id="mainSection" class="main-bg" style="display:none;">
  <div class="layout">
    <section class="content-area">
      <div class="main-panel">

        <!-- ================= QR ìŠ¤ìº” í™”ë©´ ================= -->
        <section id="scanSection">
          <div class="card">
            <h3>ğŸ“· QR ìŠ¤ìº”</h3>
            <div id="qrReader" style="width:100%; min-height:280px; border-radius:12px; background:#000;"></div>
            <p class="hint">ì§ì› ê°œì¸ QRì„ ìŠ¤ìº”í•˜ì„¸ìš”</p>
          </div>

          <div class="card">
            <h3>âŒ¨ï¸ ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥</h3>
            <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì…ë ¥">
            <button class="primary-btn" onclick="loadEmployeeById()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
        </section>

        <!-- ================= ì§ì› ì²˜ë¦¬ í™”ë©´ ================= -->
        <section id="employeeSection" style="display:none;">
          <div class="card">
            <h3 id="empTitle">ì§ì› ì •ë³´</h3>

            <div class="info-row"><strong>ì‚¬ë²ˆ</strong><span id="empId"></span></div>
            <div class="info-row"><strong>ì´ë¦„</strong><span id="empName"></span></div>
            <div class="info-row"><strong>ì„ íƒê´€ê´‘</strong><span id="empTour"></span></div>

            <div class="action-box">
              <button class="primary-btn" onclick="markDeparture()">ğŸš ì¶œë°œ ì²´í¬</button>
              <button class="ghost-btn" onclick="payMeal()">ğŸœ ì¤‘ì‹ë¹„ ì§€ê¸‰</button>
              <button class="ghost-btn" onclick="backToScan()">â† ëŒì•„ê°€ê¸°</button>
            </div>

            <p id="actionResult" class="hint"></p>
          </div>
        </section>

      </div>
    </section>
  </div>
</main>

<!-- ================= QR LIB ================= -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= CONFIG ================= */
const ADMIN_PASSWORD = "0000";   // ê°œì¸ í˜ì´ì§€ ì¤‘ì‹ë¹„ ê´€ë¦¬ì ë²ˆí˜¸ì™€ ë™ì¼
const EMP_URL = "people/employees.json";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxe8hQ9oGcL0z3N3y82dWaygu05sWI4CC6iLJYBb7vMm-9n8WURifONvPYb9ZUclr8M2A/exec";

let employees = [];
let currentEmployee = null;
let qrScanner;

/* ================= LOAD EMP DATA ================= */
fetch(EMP_URL + "?ts=" + Date.now())
  .then(r => r.json())
  .then(d => employees = d);

/* ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= */
function adminLogin() {
  const pw = document.getElementById("adminPw").value.trim();
  if (pw !== ADMIN_PASSWORD) {
    document.getElementById("adminError").textContent = "ê´€ë¦¬ì ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }

  document.getElementById("adminLogin").style.display = "none";

  if (window.innerWidth <= 767) {
    document.getElementById("mobileSplash").style.display = "flex";
    setTimeout(showMain, 2000);
  } else {
    showMain();
  }
}

function showMain() {
  document.getElementById("mobileSplash").style.display = "none";
  document.getElementById("topHeader").style.display = "flex";
  document.getElementById("mainSection").style.display = "block";
  document.body.classList.add("logged-in");
  startQR();
}

/* ================= QR START ================= */
function startQR() {
  qrScanner = new Html5Qrcode("qrReader");
  Html5Qrcode.getCameras().then(devices => {
    const back =
      devices.find(d => d.label.toLowerCase().includes("back")) ||
      devices[devices.length - 1];

    qrScanner.start(
      back.id,
      { fps: 10, qrbox: 250 },
      text => handleQR(text)
    );
  });
}

/* ================= QR RESULT ================= */
function handleQR(text) {
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (id) loadEmployee(id);
  } catch {}
}

/* ================= ì§ì› ë¶ˆëŸ¬ì˜¤ê¸° ================= */
function loadEmployeeById() {
  const id = document.getElementById("manualId").value.trim();
  loadEmployee(id);
}

function loadEmployee(id) {
  const emp = employees.find(e => e.id === id);
  if (!emp) {
    alert("ì‚¬ë²ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  currentEmployee = emp;
  document.getElementById("scanSection").style.display = "none";
  document.getElementById("employeeSection").style.display = "block";

  document.getElementById("empTitle").textContent = `${emp.name}ë‹˜ ì •ë³´`;
  document.getElementById("empId").textContent = emp.id;
  document.getElementById("empName").textContent = emp.name;
  document.getElementById("empTour").textContent =
    emp.myTour?.length ? emp.myTour.join(", ") : "ì„ íƒê´€ê´‘ ì—†ìŒ";
}

/* ================= ACTION ================= */
function markDeparture() {
  sendToSheet({
    type: "departure",
    id: currentEmployee.id,
    name: currentEmployee.name,
    tour: currentEmployee.myTour?.join(", ") || "-"
  });
  showResult("ì¶œë°œ ì²´í¬ ì™„ë£Œ");
}

function payMeal() {
  sendToSheet({
    type: "meal",
    id: currentEmployee.id,
    name: currentEmployee.name,
    tour: "ë‹¨ìˆ˜ì´",
    action: "APPROVE",
    time: nowKST()
  });
  showResult("ì¤‘ì‹ë¹„ ì§€ê¸‰ ì™„ë£Œ");
}

/* ================= BACK ================= */
function backToScan() {
  currentEmployee = null;
  document.getElementById("employeeSection").style.display = "none";
  document.getElementById("scanSection").style.display = "block";
  document.getElementById("manualId").value = "";
  document.getElementById("actionResult").textContent = "";
}

/* ================= SHEET ================= */
function sendToSheet(payload) {
  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  });
}

/* ================= UTIL ================= */
function showResult(msg) {
  const el = document.getElementById("actionResult");
  el.textContent = msg;
  el.style.color = "#1f5fbf";
}

function nowKST() {
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    dateStyle: "short",
    timeStyle: "medium"
  }).format(new Date());
}
</script>

</body>
</html>
