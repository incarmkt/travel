<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>INCARPASS PRO - í†µí•© ê´€ë¦¬ì</title>
    
    <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <!-- Firebase SDK (ì‹¤ì‹œê°„ ë™ê¸°í™”ìš©) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- ì´ë¯¸ì§€ ë° ì••ì¶• ê´€ë ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- í°íŠ¸ ë‹¤ì–‘í™” (20ì¢… ì¶”ê°€) -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Cute+Font&family=Do+Hyeon&family=Dongle&family=Gaegu&family=Gamja+Flower&family=Gowun+Batang&family=Gowun+Dodum&family=Gugi&family=Hi+Melody&family=Jua&family=Nanum+Brush+Script&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@100;300;400;500;700;900&family=Poor+Story&family=Single+Day&family=Song+Myung&family=Stylish&family=Sunflower:wght@300;500;700&family=Yeon+Sung&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        incar: '#27398C', 
                        'incar-dark': '#1a2b6d', 
                        'incar-light': '#eef2ff',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444'
                    },
                    boxShadow: { 'card': '0 4px 20px rgba(39, 57, 140, 0.08)' },
                    fontFamily: {
                        'sans': ['Noto Sans KR', 'sans-serif'],
                    },
                    cursor: {
                        'grab': 'grab',
                        'grabbing': 'grabbing',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #334155; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .scan-line { width: 100%; height: 2px; background: #ef4444; position: absolute; top: 0; left: 0; animation: scan 2s infinite linear; z-index: 20; box-shadow: 0 0 4px #ef4444; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        .mobile-only { display: block; }
        .pc-only { display: none; }
        @media (min-width: 768px) {
            .mobile-only { display: none; }
            .pc-only { display: block; }
        }
        
        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 500; color: #334155; }
        .data-table tr:hover td { background-color: #f8fafc; }

        /* ìŠ¤ìºë„ˆ UI ê°•ì œ ìŠ¤íƒ€ì¼ (ì •ì‚¬ê°í˜• ë° ê½‰ ì±„ìš°ê¸°) */
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 320px;
            aspect-ratio: 1 / 1;
            background: #000;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 4px solid rgba(255, 255, 255, 0.1);
        }

        #reader, #lookup-reader {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0;
            left: 0;
            border: none !important;
        }

        #reader video, #lookup-reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 1.2rem;
        }

        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            @page { size: auto; margin: 0; }
            
            html, body, #root, main, .overflow-y-auto {
                width: 100%;
                height: auto !important;
                min-height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                position: static !important;
            }

            body * { visibility: hidden; }

            .print-only-container, .print-only-container * { visibility: visible !important; }

            .print-only-container {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white;
                z-index: 9999;
                display: block !important;
                overflow: visible !important;
            }

            .print-reset-spacing {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
                padding: 0 !important;
            }

            .no-print { display: none !important; }

            .page-wrapper {
                width: 100%;
                height: 100vh;
                display: flex !important;
                justify-content: center;
                align-items: center;
                break-after: page;
                page-break-after: always;
                page-break-inside: avoid;
                margin: 0;
                padding: 0;
                position: relative !important;
            }
            
            .page-wrapper:last-child {
                break-after: auto;
                page-break-after: auto;
            }

            .badge-card {
                border: none !important;
                box-shadow: none !important;
                page-break-inside: avoid;
            }
        }
        .print-only { display: none; }
        
        /* ê°€ì´ë“œë¼ì¸ ìŠ¤íƒ€ì¼ */
        .smart-guide-x {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #ef4444;
            z-index: 200; /* Ensure it is above layers */
            pointer-events: none;
            border-left: 1px dashed #ef4444;
        }
        .smart-guide-y {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #ef4444;
            z-index: 200; /* Ensure it is above layers */
            pointer-events: none;
            border-top: 1px dashed #ef4444;
        }
        
        .layer-item:hover { background-color: #f1f5f9; }
        .layer-item.active { background-color: #eef2ff; border-color: #27398C; }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (í”„ë¦°íŠ¸ì‹œ) */
        @media print {
            ::-webkit-scrollbar { display: none; }
        }
        /* ë°ì´í„° í…Œì´ë¸” ì¸ì‡„ìš© */
        .no-print-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .no-print-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-[100dvh] w-screen flex flex-col md:flex-row bg-slate-50">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment, useCallback } = React;
        const CURRENCY = '$';

        // âœ… ì—°ë™ í•µì‹¬ URL ë° íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx2tVkT00Z8uXQWl6EeTIUUhZ3_NJHx3JDqSCHC5oJWkUCm0OtcTmaV6g20cNKoh0no9w/exec";
        const EMP_URL = "https://incarmkt.github.io/travel/people/employees.json?ts=" + Date.now();
        const BASE_URL = "https://incarmkt.github.io/travel/?eid=";
        const SYSTEM_APP_ID = 'inca-prod-v1';

        const firebaseConfig = {
            apiKey: "AIzaSyAh1dsSNobeF6Wz-0euP5AUggdqJANJ3dQ",
            authDomain: "incarpass.firebaseapp.com",
            projectId: "incarpass",
            storageBucket: "incarpass.firebasestorage.app",
            messagingSenderId: "955362361998",
            appId: "1:955362361998:web:166055dd392784f1827fdf",
            measurementId: "G-SNR3FPPQ7E"
        };

        // âœ… QR URL íŒŒì‹± ë¡œì§ (URLë¡œ ìŠ¤ìº”ë˜ì–´ë„ ì‚¬ë²ˆë§Œ ì •í™•í•˜ê²Œ ì¶”ì¶œ)
        const extractEid = (text) => {
            const m = String(text).match(/[?&]eid=([^&]+)/);
            return m ? m[1] : text;
        };

        // âœ… ìŠ¤ìº” ì‚¬ìš´ë“œ ë° ì§„ë™ í”¼ë“œë°±
        const beep = () => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = "square";
                osc.frequency.value = 1200;
                gain.gain.value = 0.1;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.08);
            } catch(e){}
        };
        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(40); };

        // âœ… êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë°±ê·¸ë¼ìš´ë“œ ì „ì†¡
        const sendToGAS = (payload) => {
            fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            }).catch(e => console.log("GAS ì „ì†¡ ì‹¤íŒ¨:", e));
        };

        // í°íŠ¸ ëª©ë¡ ì •ì˜
        const AVAILABLE_FONTS = [
            { name: 'Noto Sans KR (ê³ ë”•)', value: "'Noto Sans KR', sans-serif" },
            { name: 'Nanum Gothic (ë‚˜ëˆ”ê³ ë”•)', value: "'Nanum Gothic', sans-serif" },
            { name: 'Nanum Myeongjo (ë‚˜ëˆ”ëª…ì¡°)', value: "'Nanum Myeongjo', serif" },
            { name: 'Black Han Sans (ê²€ì€ê³ ë”•)', value: "'Black Han Sans', sans-serif" },
            { name: 'Do Hyeon (ë„í˜„)', value: "'Do Hyeon', sans-serif" },
            { name: 'Jua (ì£¼ì•„)', value: "'Jua', sans-serif" },
            { name: 'Yeon Sung (ì—°ì„±)', value: "'Yeon Sung', cursive" },
            { name: 'Gugi (êµ¬ê¸°)', value: "'Gugi', cursive" },
            { name: 'Gamja Flower (ê°ìê½ƒ)', value: "'Gamja Flower', cursive" },
            { name: 'Hi Melody (í•˜ì´ë©œë¡œë””)', value: "'Hi Melody', cursive" },
            { name: 'Sunflower (í•´ë°”ë¼ê¸°)', value: "'Sunflower', sans-serif" },
            { name: 'Gowun Dodum (ê³ ìš´ë‹ì›€)', value: "'Gowun Dodum', sans-serif" },
            { name: 'Gowun Batang (ê³ ìš´ë°”íƒ•)', value: "'Gowun Batang', serif" },
            { name: 'Dongle (ë™ê¸€)', value: "'Dongle', sans-serif" },
            { name: 'Poor Story (ê°€ë‚œí•œì´ì•¼ê¸°)', value: "'Poor Story', cursive" },
            { name: 'Single Day (ì‹±ê¸€ë°ì´)', value: "'Single Day', cursive" },
            { name: 'Cute Font (ííŠ¸)', value: "'Cute Font', cursive" },
            { name: 'Song Myung (ì†¡ëª…)', value: "'Song Myung', serif" },
            { name: 'Stylish (ìŠ¤íƒ€ì¼ë¦¬ì‹œ)', value: "'Stylish', serif" },
            { name: 'Gaegu (ê°œêµ¬ìŸì´)', value: "'Gaegu', cursive" }
        ];

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                menu: <path d="M3 12h18M3 6h18M3 18h18"/>,
                dashboard: <path d="M3 3h7v7H3V3m11 0h7v7h-7V3m0 11h7v7h-7v-7M3 14h7v7H3v-7"/>,
                qr: <path d="M3 7V3h4M3 17v4h4M17 3h4v4M21 17v-4h4m-4 4h-4M7 11h2v2H7v-2m4 0h2v2h-2v-2m4 0h2v2h-2v-2"/>,
                users: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                money: <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>,
                edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></g>,
                settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>,
                check: <polyline points="20 6 9 17 4 12"/>,
                x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
                alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/></g>,
                history: <g><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></g>,
                upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></g>,
                download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></g>,
                table: <g><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></g>,
                print: <g><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></g>,
                bus: <g><path d="M19 17h2l.64-2.54c.24-1.12.36-2.26.36-3.41V8.5a4.5 4.5 0 0 0-4.5-4.5h-11A4.5 4.5 0 0 0 2 8.5v2.55c0 1.15.12 2.29.36 3.41L3 17h2"/><path d="M15 17v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2"/><path d="M16 8.5h.01"/><path d="M8 8.5h.01"/></g>,
                trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
                layers: <g><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></g>,
                plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
                square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>,
                circle: <circle cx="12" cy="12" r="10"/>,
                type: <g><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></g>,
                up: <g><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></g>,
                down: <g><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></g>,
                chevronsUp: <g><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></g>,
                chevronsDown: <g><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></g>,
                image: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></g>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="2"/>}</svg>;
        };

        const Sidebar = ({ activeTab, setActiveTab }) => (
            <aside className="w-64 bg-white/95 backdrop-blur-md h-full border-r border-slate-200 flex flex-col shadow-lg z-30 no-print hidden md:flex relative">
                <div className="p-6 border-b border-slate-100 flex items-center gap-3">
                    <div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-black">P</div>
                    <h1 className="font-black text-slate-800 tracking-tight">INCARPASS <span className="text-incar text-[10px] px-1.5 py-0.5 bg-indigo-50 rounded-md align-top">PC</span></h1>
                </div>
                <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                    {[
                        {id:'dashboard', icon:'dashboard', label:'í˜„í™© (Status)'},
                        {id:'boarding', icon:'bus', label:'íƒ‘ìŠ¹ (Boarding)'},
                        {id:'payment', icon:'money', label:'ì§€ê¸‰ (Payment)'},
                        {id:'change', icon:'edit', label:'ê´€ë¦¬ (Management)'},
                        {id:'manage', icon:'settings', label:'ì„¤ì • (Settings)'}
                    ].map(menu => (
                        <button key={menu.id} onClick={()=>setActiveTab(menu.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl font-bold transition-all ${activeTab===menu.id ? 'bg-incar text-white shadow-md' : 'text-slate-400 hover:bg-slate-50'}`}>
                            <Icon name={menu.icon} /> {menu.label}
                        </button>
                    ))}
                </nav>
                <div className="p-6 border-t border-slate-100">
                    <div className="text-xs text-slate-400 font-bold mb-2">OPERATOR</div>
                    <div className="flex items-center gap-3"><div className="w-8 h-8 rounded-full bg-slate-200"></div><div className="text-sm font-bold text-slate-700">ê´€ë¦¬ìë‹˜</div></div>
                </div>
            </aside>
        );

        const MobileTab = ({ activeTab, setActiveTab }) => (
            <nav className="fixed bottom-0 w-full bg-white border-t border-slate-200 pb-safe pt-2 px-4 flex justify-around items-center z-30 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] no-print md:hidden">
                <button onClick={()=>setActiveTab('dashboard')} className={`flex flex-col items-center gap-1 p-2 w-14 ${activeTab==='dashboard'?'text-incar':'text-slate-300'}`}><Icon name="dashboard" size={20} className={activeTab==='dashboard'?'fill-current':''} /><span className="text-[9px] font-bold">í˜„í™©</span></button>
                <button onClick={()=>setActiveTab('boarding')} className={`flex flex-col items-center gap-1 p-2 w-14 relative ${activeTab==='boarding'?'text-incar':'text-slate-300'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${activeTab==='boarding'?'bg-incar text-white shadow-lg ring-2 ring-slate-100 mb-1':''}`}><Icon name="bus" size={20} /></div>{activeTab!=='boarding' && <span className="text-[9px] font-bold">íƒ‘ìŠ¹</span>}</button>
                <button onClick={()=>setActiveTab('payment')} className={`flex flex-col items-center gap-1 p-2 w-14 relative ${activeTab==='payment'?'text-emerald-500':'text-slate-300'}`}><div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${activeTab==='payment'?'bg-emerald-500 text-white shadow-lg ring-2 ring-slate-100 mb-1':''}`}><Icon name="money" size={20} /></div>{activeTab!=='payment' && <span className="text-[9px] font-bold">ì§€ê¸‰</span>}</button>
                <button onClick={()=>setActiveTab('change')} className={`flex flex-col items-center gap-1 p-2 w-14 ${activeTab==='change'?'text-incar':'text-slate-300'}`}><Icon name="edit" size={20} className={activeTab==='change'?'fill-current':''} /><span className="text-[9px] font-bold">ê´€ë¦¬</span></button>
            </nav>
        );

        const ResultModal = ({ result, onClose, onForceUpdate }) => {
            if (!result) return null;
            const { status, msg, subMsg, user, logs, relatedLogs, requiredChoice, session } = result;
            const isSuccess = status === 'success';
            const isTargetMismatch = status === 'error' && msg === 'ëŒ€ìƒì ì•„ë‹˜';
            const isBusMismatch = status === 'error' && msg === 'íƒ‘ìŠ¹ ë¶ˆê°€ (ì°¨ëŸ‰ ë¶ˆì¼ì¹˜)';
            
            useEffect(() => {
                if(isSuccess) {
                    // âœ… ì—°ì† ìŠ¤ìº”ì„ ìœ„í•´ íŒì—…ì„ 2ì´ˆ ë’¤ ìë™ ë‹«ìŒ
                    const timer = setTimeout(onClose, 2000);
                    return () => clearTimeout(timer);
                }
            }, [isSuccess, result, onClose]);

            // âœ… ì—°ì† ìŠ¤ìº” ì„±ê³µ ì‹œ, í™”ë©´ì„ ê°€ë¦¬ì§€ ì•ŠëŠ” í•˜ë‹¨ ì‘ì€ Toast íŒì—…
            if (isSuccess) {
                return (
                    <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[250] w-[90%] max-w-sm animate-slide-up no-print pointer-events-none">
                        <div className="bg-white rounded-3xl overflow-hidden shadow-[0_10px_40px_rgba(0,0,0,0.2)] border-2 border-emerald-400 pointer-events-auto flex items-center p-4 gap-4">
                            <div className="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0">
                                <Icon name="check" size={28} />
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="text-emerald-600 font-black text-lg truncate">{msg}</div>
                                <div className="font-bold text-slate-800 truncate text-sm mt-0.5">{user.name} <span className="text-xs text-slate-400 font-medium">({user.uid})</span></div>
                                {logs && logs.finalAmount !== undefined && logs.finalAmount > 0 && (
                                    <div className="text-xs font-bold text-emerald-500 mt-1">ì§€ê¸‰ì•¡: {CURRENCY}{logs.finalAmount}</div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // âœ… ì—ëŸ¬ ë˜ëŠ” ì¤‘ë³µ ìŠ¤ìº” ì‹œì—ëŠ” ì£¼ì˜ë¥¼ ì£¼ê¸° ìœ„í•´ ì „ì²´ í™”ë©´ ê²½ê³ 
            return (
                <div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm animate-slide-up no-print">
                    <div className="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl relative z-[301]">
                        <div className={`p-8 text-center flex flex-col items-center justify-center ${status==='duplicate'?'bg-amber-50':'bg-rose-50'}`}>
                            <div className={`w-20 h-20 rounded-full flex items-center justify-center mb-4 ${status==='duplicate'?'bg-amber-100 text-amber-600':'bg-rose-100 text-rose-600'}`}>
                                <Icon name={status==='duplicate'?'alert':'x'} size={40} />
                            </div>
                            <h2 className={`text-2xl font-bold mb-1 ${status==='duplicate'?'text-amber-800':'text-rose-800'}`}>{msg}</h2>
                            <p className="text-slate-500 font-medium">{subMsg}</p>
                        </div>
                        {user && (
                            <div className="p-6 bg-white space-y-4">
                                <div className="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100">
                                    <div className="w-12 h-12 rounded-full bg-incar text-white flex items-center justify-center font-bold text-lg">{user.name[0]}</div>
                                    <div>
                                        <div className="font-bold text-lg text-slate-900">{user.name}</div>
                                        <div className="text-xs text-slate-400 font-medium">{user.org} | {user.uid}</div>
                                        {user.bus && <div className="text-xs text-incar font-bold mt-1">ë°°ì •ì°¨ëŸ‰: {user.bus}</div>}
                                    </div>
                                </div>
                                
                                {isTargetMismatch && (
                                    <div className="p-4 bg-rose-50 border border-rose-100 rounded-xl text-center">
                                        <p className="text-sm font-bold text-rose-600 mb-2">í˜„ì¥ì—ì„œ ë°”ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                                        <p className="text-xs text-rose-400 mb-3">ì£¼ì˜: ì´ì „ ì˜µì…˜ì— ëŒ€í•œ ì™„ë£Œ ê¸°ë¡ì´ ìˆë‹¤ë©´ ì‚­ì œë©ë‹ˆë‹¤.</p>
                                        <button onClick={() => onForceUpdate(user, session, requiredChoice)} className="w-full py-3 bg-rose-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform text-sm">
                                            ë„¤, ì¼ì • ë³€ê²½ í›„ ìŠ¹ì¸
                                        </button>
                                    </div>
                                )}
                                
                                {isBusMismatch && (
                                    <div className="p-4 bg-rose-50 border border-rose-100 rounded-xl text-center">
                                        <p className="text-sm font-bold text-rose-600 mb-2">ì°¨ëŸ‰ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                                        <p className="text-xs text-slate-500 mb-1">í•´ë‹¹ ì¸ì›ì€ <strong>{user.bus}</strong> íƒ‘ìŠ¹ ëŒ€ìƒì…ë‹ˆë‹¤.</p>
                                        <p className="text-xs text-slate-400">ë‹¤ë¥¸ ì°¨ëŸ‰ìœ¼ë¡œ ì•ˆë‚´í•˜ê±°ë‚˜, ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>
                                    </div>
                                )}
                            </div>
                        )}
                        <button onClick={onClose} className="w-full py-5 bg-slate-900 text-white font-bold text-lg hover:bg-slate-800 transition-colors">ë‹«ê¸° (ìŠ¤ìº” ê³„ì†)</button>
                    </div>
                </div>
            );
        };

        const SessionDetailModal = ({ session, users, logs, onClose, onManualComplete }) => {
            const [tab, setTab] = useState('done');
            
            const targetUsers = useMemo(() => {
                if (!session) return [];
                if (session.targetKey === 'ALL') return users;
                return users.filter(u => u.options && u.options[session.targetKey] && u.options[session.targetKey].includes(session.targetVal));
            }, [session, users]);

            const { doneList, yetList } = useMemo(() => {
                const doneIds = new Set(logs.filter(l => l.sessionId === session.id).map(l => l.uid));
                const done = [];
                const yet = [];
                targetUsers.forEach(u => {
                    if (doneIds.has(u.uid)) {
                        const log = logs.find(l => l.sessionId === session.id && l.uid === u.uid);
                        done.push({ ...u, log });
                    } else {
                        yet.push(u);
                    }
                });
                return { doneList: done, yetList: yet };
            }, [targetUsers, logs, session]);

            const currentList = tab === 'done' ? doneList : yetList;

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm animate-fade-in no-print" onClick={onClose}>
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b border-slate-100 flex justify-between items-start bg-slate-50">
                            <div>
                                <span className={`inline-block px-2 py-1 rounded text-[10px] font-bold mb-1 ${session.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-indigo-100 text-incar'}`}>{session.type==='PAYMENT'?'ì§€ê¸‰':'íƒ‘ìŠ¹'}</span>
                                <h3 className="font-bold text-lg text-slate-800 leading-tight">{session.title}</h3>
                                <p className="text-xs text-slate-500 mt-1">{session.displayDate} | ëŒ€ìƒ {targetUsers.length}ëª…</p>
                            </div>
                            <button onClick={onClose} className="p-2 text-slate-400 hover:text-slate-600"><Icon name="x" size={24}/></button>
                        </div>
                        
                        <div className="flex border-b border-slate-100">
                            <button onClick={()=>setTab('done')} className={`flex-1 py-4 text-sm font-bold transition-colors ${tab==='done'?'text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50':'text-slate-400 hover:bg-slate-50'}`}>
                                ì™„ë£Œ ({doneList.length})
                            </button>
                            <button onClick={()=>setTab('yet')} className={`flex-1 py-4 text-sm font-bold transition-colors ${tab==='yet'?'text-rose-500 border-b-2 border-rose-500 bg-rose-50/50':'text-slate-400 hover:bg-slate-50'}`}>
                                ë¯¸ì™„ë£Œ ({yetList.length})
                            </button>
                        </div>

                        <div className="overflow-y-auto flex-1 p-4 space-y-2">
                            {currentList.length === 0 ? (
                                <div className="py-10 text-center text-slate-400 text-sm">í•´ë‹¹ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                            ) : (
                                currentList.map(u => (
                                    <div key={u.uid} className="flex justify-between items-center p-3 rounded-xl border border-slate-100 hover:border-slate-300 transition-colors">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white ${tab==='done'?'bg-emerald-500':'bg-slate-300'}`}>{u.name[0]}</div>
                                            <div>
                                                <div className="font-bold text-slate-800 text-sm">{u.name} <span className="text-xs font-normal text-slate-500">({u.options && (u.options['ì§ì±…'] || u.org)})</span></div>
                                                <div className="text-[10px] text-slate-400 font-mono">{u.uid}</div>
                                                {u.bus && <div className="text-[10px] text-incar font-bold">ë°°ì •: {u.bus}</div>}
                                            </div>
                                        </div>
                                        {tab === 'done' && u.log && (
                                            <div className="text-right">
                                                {session.type === 'PAYMENT' && (
                                                    <div className="font-bold text-emerald-600 text-sm">{CURRENCY}{u.log.finalAmount}</div>
                                                )}
                                                <div className="text-[10px] text-slate-400">{new Date(u.log.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                            </div>
                                        )}
                                        {tab === 'yet' && (
                                            <button onClick={() => onManualComplete(u, session)} className="px-3 py-1.5 bg-slate-800 text-white text-[10px] font-bold rounded-lg hover:bg-slate-700 transition-colors shadow-sm">
                                                ìˆ˜ë™ ì™„ë£Œ
                                            </button>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ users, logs, scheduleStats, groupedStats, changeLogs, onSessionClick }) => (
            <div className="space-y-6 animate-slide-up">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-incar">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Participants</div>
                        <div className="text-4xl font-bold text-slate-800">{users.length}</div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-emerald-500">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Payout</div>
                        <div className="text-4xl font-bold text-slate-800">{CURRENCY}{logs.reduce((sum, l) => sum + (l.finalAmount||0), 0).toLocaleString()}</div>
                        <div className="text-xs text-rose-500 font-bold mt-2">
                            (íŒ¨ë„í‹°/ë¯¸ë°˜í™˜: {CURRENCY}{(changeLogs.reduce((sum, c) => sum + (c.penalty || 0), 0) + logs.reduce((sum, l) => sum + (l.penaltyApplied || 0), 0)).toLocaleString()})
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-indigo-400 hidden md:block">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Completion Rate</div>
                        <div className="text-4xl font-bold text-slate-800">
                            {scheduleStats.length > 0 ? Math.round(scheduleStats.reduce((acc, s) => acc + s.percent, 0) / scheduleStats.length) : 0}%
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded-3xl shadow-card border-l-8 border-rose-400 hidden md:block">
                        <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Penalties</div>
                        <div className="text-4xl font-bold text-slate-800">{changeLogs.length}ê±´</div>
                    </div>
                </div>

                <div>
                    <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                        <Icon name="dashboard" className="text-incar"/> ì¼ì •ë³„ ì§„í–‰ë¥  (ìš”ì•½)
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {scheduleStats.map(stat => {
                             const sessionPenalties = logs.filter(l => l.sessionId === stat.id).reduce((sum, l) => sum + (l.penaltyApplied || 0), 0);
                             return (
                                <div key={stat.id} onClick={() => onSessionClick(stat)} className="cursor-pointer bg-white p-5 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition-shadow active:scale-[0.98] transition-transform">
                                    <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name={stat.type === 'PAYMENT' ? 'money' : 'bus'} size={60} /></div>
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${stat.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-indigo-50 text-incar'}`}>{stat.type==='PAYMENT'?'ì§€ê¸‰':'íƒ‘ìŠ¹'}</span>
                                            <span className="text-xs font-bold text-slate-400">{stat.displayDate}</span>
                                        </div>
                                        <h4 className="font-bold text-slate-800 mb-4 truncate pr-8">{stat.title}</h4>
                                        <div className="flex justify-between items-end mb-1">
                                            <span className="text-3xl font-bold text-slate-800">{stat.doneCount}<span className="text-sm text-slate-400 font-medium ml-1">/ {stat.targetCount}</span></span>
                                            <span className={`text-xl font-bold ${stat.percent === 100 ? 'text-emerald-500' : 'text-incar'}`}>{stat.percent}%</span>
                                        </div>
                                        <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                                            <div className={`h-full rounded-full transition-all duration-1000 ${stat.percent===100?'bg-emerald-500':'bg-incar'}`} style={{width: `${stat.percent}%`}}></div>
                                        </div>
                                        {stat.type === 'PAYMENT' && (
                                            <div className="pt-2 border-t border-slate-50 flex flex-col gap-1 text-xs">
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">ì§‘í–‰ì•¡</span>
                                                    <span className="font-bold text-slate-700">{CURRENCY}{stat.actualAmount.toLocaleString()}</span>
                                                </div>
                                                {sessionPenalties > 0 && (
                                                    <div className="flex justify-between text-[10px] text-rose-500 font-bold">
                                                        <span>(íŒ¨ë„í‹° ì°¨ê°ë¶„)</span>
                                                        <span>-{CURRENCY}{sessionPenalties.toLocaleString()}</span>
                                                    </div>
                                                )}
                                                <div className="flex justify-between mt-1 pt-1 border-t border-slate-100/50">
                                                    <span className="text-slate-400">ì˜ˆìƒ (ë³€ê²½ì „ í¬í•¨ì•ˆí•¨)</span>
                                                    <span>{CURRENCY}{stat.expectedAmount.toLocaleString()}</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                        {scheduleStats.length === 0 && <div className="col-span-full py-10 text-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                    </div>
                </div>
                
                <div className="pc-only bg-white rounded-3xl border border-slate-200 shadow-card overflow-hidden mt-8">
                    <div className="p-5 border-b border-slate-100 bg-slate-50/50">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="table" className="text-incar"/> ìƒì„¸ í˜„í™© ë¶„ì„í‘œ</h3>
                    </div>
                    {Object.entries(groupedStats).length === 0 ? <div className="p-10 text-center text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div> : (
                        <div className="p-6 space-y-8">
                            {Object.entries(groupedStats).sort().map(([date, stats]) => (
                                <div key={date}>
                                    <h4 className="text-xs font-bold text-incar bg-indigo-50 px-3 py-1.5 rounded-lg inline-block mb-3">{date}</h4>
                                    <div className="overflow-hidden rounded-xl border border-slate-200">
                                        <table className="w-full text-left data-table">
                                            <thead><tr><th className="w-1/3">ì¼ì •ëª…</th><th className="text-center">êµ¬ë¶„</th><th className="text-right">ëŒ€ìƒ(Target)</th><th className="text-right">ì™„ë£Œ(Done)</th><th className="text-center border-l border-slate-200">ë¯¸ì™„ë£Œ</th><th className="text-right">ì˜ˆìƒ ê¸ˆì•¡</th><th className="text-right">ì‹¤ì œ ì§‘í–‰</th><th className="text-center border-l border-slate-200">ì°¨ì•¡ (Diff)</th></tr></thead>
                                            <tbody>
                                                {stats.map(s => (
                                                    <tr key={s.id} onClick={() => onSessionClick(s)} className="cursor-pointer hover:bg-slate-50 transition-colors">
                                                        <td className="font-bold text-slate-700">{s.title}</td>
                                                        <td className="text-center"><span className={`px-2 py-0.5 rounded text-[10px] font-bold border ${s.type==='PAYMENT'?'bg-emerald-50 text-emerald-600 border-emerald-100':'bg-indigo-50 text-incar border-indigo-100'}`}>{s.type==='PAYMENT'?'ì§€ê¸‰':'íƒ‘ìŠ¹'}</span></td>
                                                        <td className="text-right text-slate-500">{s.targetCount}</td>
                                                        <td className="text-right font-bold text-slate-900">{s.doneCount}</td>
                                                        <td className="text-center border-l border-slate-50">{s.targetCount - s.doneCount === 0 ? <span className="text-emerald-500 font-bold text-xs">Complete</span> : <span className="text-rose-500 font-bold text-xs">{s.targetCount - s.doneCount}ëª… ë‚¨ìŒ</span>}</td>
                                                        <td className="text-right text-slate-400">{s.type==='PAYMENT'?`${CURRENCY}${s.expectedAmount.toLocaleString()}`:'-'}</td>
                                                        <td className="text-right font-bold text-emerald-600">{s.type==='PAYMENT'?`${CURRENCY}${s.actualAmount.toLocaleString()}`:'-'}</td>
                                                        <td className="text-center border-l border-slate-50">{s.type !== 'PAYMENT' ? '-' : (s.diffAmount === 0 ? <span className="text-emerald-500 font-bold text-xs">OK</span> : s.diffAmount < 0 ? <span className="text-rose-500 font-bold text-xs">{s.diffAmount}</span> : <span className="text-blue-500 font-bold text-xs">+{s.diffAmount}</span>)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        );

        const ScanView = ({ mode, schedules, targetSessionId, setTargetSessionId, targetBus, setTargetBus, manualBus, setManualBus, isScanning, setIsScanning, processScan, users, isMobile, busList, setBusList }) => {
            const scannerRef = useRef(null);
            const isRunningRef = useRef(false);
            const lastScanRef = useRef({ text: null, time: 0 }); // âœ… ì—°ì† ìŠ¤ìº”ì„ ìœ„í•œ ì¤‘ë³µë°©ì§€ ë”œë ˆì´ Ref
            const [isStrictBusMode, setIsStrictBusMode] = useState(false);
            
            const filteredSchedules = useMemo(() => {
                return schedules.filter(s => s.type === mode);
            }, [schedules, mode]);

            useEffect(() => {
                if (filteredSchedules.length > 0) {
                    const exists = filteredSchedules.find(s => s.id === targetSessionId);
                    if (!exists) setTargetSessionId(filteredSchedules[0].id);
                } else {
                    setTargetSessionId('');
                }
            }, [mode, filteredSchedules]);

            useEffect(() => {
                return () => {
                    stopScanner();
                };
            }, []);

            const handleAddBus = () => {
                let nextNum = 1;
                if (busList.length > 0) {
                    const nums = busList.map(b => {
                        const match = b.match(/(\d+)í˜¸ì°¨/);
                        return match ? parseInt(match[1]) : 0;
                    });
                    const maxNum = Math.max(...nums, 0);
                    nextNum = maxNum + 1;
                }
                const newBus = `${nextNum}í˜¸ì°¨`;
                const newList = [...busList, newBus];
                setBusList(newList);
                if(!manualBus) setTargetBus(newBus);
            };

            const handleRenameBus = (index) => {
                const oldName = busList[index];
                const newName = prompt(`'${oldName}'ì˜ ìƒˆë¡œìš´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`, oldName);
                if (newName && newName.trim()) {
                    const newList = [...busList];
                    newList[index] = newName.trim();
                    setBusList(newList);
                    if(targetBus === oldName) setTargetBus(newName.trim());
                }
            };

            const handleDeleteBus = (index, e) => {
                e.stopPropagation();
                if(confirm(`'${busList[index]}'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
                    const newList = busList.filter((_, i) => i !== index);
                    setBusList(newList);
                    if(targetBus === busList[index] && newList.length > 0) setTargetBus(newList[0]);
                }
            };

            const startScanner = () => {
                if (isRunningRef.current) return;
                setIsScanning(true);
                
                setTimeout(() => {
                    const element = document.getElementById("reader");
                    if (!element) return;

                    if (!scannerRef.current) {
                        scannerRef.current = new Html5Qrcode("reader");
                    }
                    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                    scannerRef.current.start({ facingMode: "environment" }, config, (decodedText) => {
                        const now = Date.now();
                        
                        // âœ… ë™ì¼í•œ QR ì½”ë“œëŠ” 3ì´ˆ ì´ë‚´ ì¤‘ë³µ ì¸ì‹ ë°©ì§€ (ì—°ì† ìŠ¤ìº”ì„ ìœ„í•¨)
                        if (lastScanRef.current.text === decodedText && (now - lastScanRef.current.time) < 3000) {
                            return;
                        }
                        lastScanRef.current = { text: decodedText, time: now };
                        
                        beep();
                        vibrate();
                        
                        // stopScanner(); // ğŸ”¥ ì‚­ì œë¨: ì„±ê³µí•´ë„ ì¹´ë©”ë¼ë¥¼ ë„ì§€ ì•Šê³  ìœ ì§€í•©ë‹ˆë‹¤.
                        processScan(decodedText, isStrictBusMode); 
                    }, () => {}).then(() => {
                        isRunningRef.current = true;
                    }).catch(err => {
                        console.error("Camera start failed", err);
                        setIsScanning(false);
                        alert("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    });
                }, 100);
            };

            const stopScanner = () => {
                if (scannerRef.current && isRunningRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        isRunningRef.current = false;
                        setIsScanning(false);
                    }).catch(err => {
                        console.log("Failed to stop scanner", err);
                        setIsScanning(false);
                        isRunningRef.current = false;
                    });
                } else {
                    setIsScanning(false);
                }
            };

            return (
                <div className="space-y-6 h-full flex flex-col animate-slide-up">
                    <div className="bg-white p-6 rounded-3xl shadow-card border border-slate-200">
                        <div className="flex items-center gap-2 mb-4">
                            <span className={`px-2 py-1 rounded-lg text-xs font-bold ${mode==='BOARDING'?'bg-incar text-white':'bg-emerald-500 text-white'}`}>{mode==='BOARDING' ? 'STEP 1' : 'ì§€ê¸‰'}</span>
                            <h3 className="text-lg font-bold text-slate-800">{mode==='BOARDING' ? 'íƒ‘ìŠ¹ ì¼ì • ì„ íƒ' : 'ì§€ê¸‰ í•­ëª© ì„ íƒ'}</h3>
                        </div>
                        <div className="mb-6">
                            <select value={targetSessionId} onChange={(e) => setTargetSessionId(e.target.value)} className={`w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-lg outline-none focus:ring-4 transition-all ${mode==='BOARDING'?'focus:ring-incar/20':'focus:ring-emerald-500/20'}`}>
                                {filteredSchedules.length === 0 && <option>í•´ë‹¹í•˜ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</option>}
                                {filteredSchedules.map(s => <option key={s.id} value={s.id}>[{s.displayDate}] {s.title}</option>)}
                            </select>
                        </div>
                        {mode === 'BOARDING' && (
                            <div className="animate-slide-up">
                                <div className="flex items-center gap-1.5 sm:gap-2 mb-3 w-full">
                                    <span className="px-2 py-1 rounded-lg text-[10px] sm:text-xs font-bold bg-slate-800 text-white shrink-0 whitespace-nowrap">STEP 2</span>
                                    <div className="flex justify-between items-center flex-1 min-w-0 gap-1 sm:gap-2">
                                        <h3 className="text-base sm:text-lg font-bold text-slate-800 shrink-0 whitespace-nowrap">ì°¨ëŸ‰ ì„ íƒ</h3>
                                        <div className="flex gap-1.5 sm:gap-2 items-center shrink-0">
                                            {/* ê²€ì¦ ëª¨ë“œ í† ê¸€ */}
                                            <div className="flex items-center bg-slate-100 rounded-lg px-1.5 sm:px-2 py-1 gap-1 sm:gap-2 cursor-pointer shrink-0 whitespace-nowrap" onClick={() => setIsStrictBusMode(!isStrictBusMode)}>
                                                <div className={`w-7 sm:w-8 h-4 rounded-full relative transition-colors shrink-0 ${isStrictBusMode ? 'bg-incar' : 'bg-slate-300'}`}>
                                                    <div className={`absolute top-0.5 left-0.5 w-3 h-3 bg-white rounded-full transition-transform ${isStrictBusMode ? 'translate-x-3 sm:translate-x-4' : 'translate-x-0'}`}></div>
                                                </div>
                                                <span className={`text-[9px] sm:text-[10px] font-bold ${isStrictBusMode ? 'text-incar' : 'text-slate-400'}`}>ë°°ì • ì°¨ëŸ‰ ê²€ì¦</span>
                                            </div>
                                            <button onClick={()=>setManualBus(!manualBus)} className={`text-[10px] sm:text-xs font-bold px-2 sm:px-3 py-1.5 rounded-lg transition-colors shrink-0 whitespace-nowrap ${manualBus ? 'bg-incar text-white shadow-md' : 'bg-slate-100 text-slate-500'}`}>
                                                {manualBus ? 'ê´€ë¦¬ ì™„ë£Œ' : 'ì°¨ëŸ‰ ê´€ë¦¬'}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-4 gap-2">
                                    {busList.map((bus, i) => (
                                        <div key={i} className="relative group">
                                            <button 
                                                onClick={() => manualBus ? handleRenameBus(i) : setTargetBus(bus)}
                                                className={`w-full py-3 rounded-xl text-sm font-bold transition-all relative ${
                                                    targetBus === bus && !manualBus
                                                    ? 'bg-incar text-white shadow-lg scale-105 z-10' 
                                                    : manualBus 
                                                        ? 'bg-white border-2 border-dashed border-indigo-200 text-indigo-400 hover:bg-indigo-50'
                                                        : 'bg-slate-100 text-slate-400 hover:bg-slate-200'
                                                }`}
                                            >
                                                {bus}
                                                {manualBus && <span className="absolute bottom-0.5 right-1 text-[8px] opacity-50">ìˆ˜ì •</span>}
                                            </button>
                                            {manualBus && (
                                                <button 
                                                    onClick={(e) => handleDeleteBus(i, e)}
                                                    className="absolute -top-2 -right-2 w-6 h-6 bg-rose-500 text-white rounded-full flex items-center justify-center shadow-md z-20 hover:scale-110 transition-transform"
                                                >
                                                    <Icon name="x" size={12} />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                    
                                    {/* í•­ìƒ ë³´ì´ëŠ” ì¶”ê°€ ë²„íŠ¼ (ê´€ë¦¬ ëª¨ë“œê°€ ì•„ë‹ ë•Œë„ ì¶”ê°€ ê°€ëŠ¥) */}
                                    <button onClick={handleAddBus} className="py-3 rounded-xl text-sm font-bold bg-slate-50 border-2 border-dashed border-slate-200 text-slate-400 hover:bg-slate-100 hover:text-slate-600 hover:border-slate-300 transition-all flex items-center justify-center">
                                        <Icon name="plus" size={20} />
                                    </button>
                                </div>
                                {manualBus && <div className="text-[10px] text-slate-400 mt-2 text-right">* ì°¨ëŸ‰ì„ ëˆŒëŸ¬ ì´ë¦„ì„ ìˆ˜ì •í•˜ê±°ë‚˜ Xë¥¼ ëˆŒëŸ¬ ì‚­ì œí•˜ì„¸ìš”.</div>}
                            </div>
                        )}
                    </div>

                    <div className="flex-1 flex flex-col justify-end">
                        <button onClick={startScanner} className={`w-full py-6 text-white rounded-3xl font-bold text-xl shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-transform ${mode==='BOARDING'?'bg-incar shadow-incar/30':'bg-emerald-500 shadow-emerald-500/30'}`}>
                            <Icon name="qr" size={28}/> {mode==='BOARDING' ? 'íƒ‘ìŠ¹ ìŠ¤ìº” ì‹œì‘' : 'ì§€ê¸‰ ìŠ¤ìº” ì‹œì‘'}
                        </button>
                    </div>

                    {isScanning && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-6 animate-fade-in" style={{ touchAction: 'none' }}>
                            <button onClick={stopScanner} className="absolute top-8 right-8 text-white p-3 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-[101]">
                                <Icon name="x" size={32} />
                            </button>
                            
                            {/* ì •ì‚¬ê°í˜• ìŠ¤ìºë„ˆ ë˜í¼ */}
                            <div className="scanner-container">
                                <div id="reader"></div>
                                
                                {/* ì¤‘ì•™ ê°€ì´ë“œë¼ì¸ (í™©ê¸ˆë¹„ìœ¨ ìŠ¤íƒ€ì¼) */}
                                <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                                    <div className="relative w-[70%] h-[70%]">
                                        <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-2xl"></div>
                                        <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-2xl"></div>
                                        <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-2xl"></div>
                                        <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-2xl"></div>
                                        <div className={`scan-line ${mode==='BOARDING'?'bg-incar':'bg-emerald-500'}`} style={{ width: '90%' }}></div>
                                    </div>
                                </div>
                            </div>
                            
                            <p className="text-white mt-10 font-bold text-xl animate-pulse text-center">
                                QRì½”ë“œë¥¼ ì‚¬ê°í˜• ì¤‘ì•™ì— ë§ì¶°ì£¼ì„¸ìš”
                            </p>
                            
                            <div className="mt-8 flex gap-4">
                                <button onClick={stopScanner} className="px-8 py-3 bg-white text-slate-900 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">ìŠ¤ìº” ì¢…ë£Œ (ë‹«ê¸°)</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ChangeView = ({ searchQuery, setSearchQuery, selectedUser, setSelectedUser, editForm, setEditForm, handleUserUpdate, users, schedules, changeLogs }) => {
            const [manualInput, setManualInput] = useState(false);
            const [showAllHistory, setShowAllHistory] = useState(false);
            const [isLookupScanning, setIsLookupScanning] = useState(false);
            const html5QrCodeRef = useRef(null);

            useEffect(() => {
                return () => {
                    if (html5QrCodeRef.current) {
                        if (html5QrCodeRef.current.isScanning) {
                            html5QrCodeRef.current.stop().catch(err => console.error(err));
                        }
                        html5QrCodeRef.current.clear();
                    }
                };
            }, []);

            const startLookupScanner = () => {
                setIsLookupScanning(true);
                
                setTimeout(() => {
                    const elementId = "lookup-reader";
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.error("Scanner element not found");
                        return;
                    }

                    if (html5QrCodeRef.current) {
                        if(html5QrCodeRef.current.isScanning) return; 
                        html5QrCodeRef.current.clear(); 
                    }

                    const html5QrCode = new Html5Qrcode(elementId);
                    html5QrCodeRef.current = html5QrCode;

                    const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
                    
                    html5QrCode.start(
                        { facingMode: "environment" }, 
                        config, 
                        async (decodedText) => {
                            beep();
                            vibrate();
                            try {
                                if (html5QrCode.isScanning) {
                                    await html5QrCode.stop();
                                }
                                html5QrCode.clear();
                            } catch (err) {
                                console.warn("Failed to stop scanner", err);
                            }

                            setIsLookupScanning(false);
                            html5QrCodeRef.current = null;

                            const eId = extractEid(decodedText);
                            const found = users.find(u => String(u.uid).trim() === String(eId).trim());
                            if (found) {
                                setSelectedUser(found);
                            } else {
                                alert(`ë¯¸ë“±ë¡ ì‚¬ìš©ìì…ë‹ˆë‹¤. (ID: ${eId})`);
                            }
                        }, 
                        (errorMessage) => {}
                    ).catch(err => {
                        console.error("Error starting scanner", err);
                        setIsLookupScanning(false);
                        alert("ì¹´ë©”ë¼ë¥¼ ì‹¤í–‰í•  ìˆ˜ ë¬´ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    });
                }, 300);
            };

            const stopLookupScanner = async () => {
                if (html5QrCodeRef.current) {
                    try {
                        if (html5QrCodeRef.current.isScanning) {
                            await html5QrCodeRef.current.stop();
                        }
                        html5QrCodeRef.current.clear();
                    } catch (err) {
                        console.warn("Error stopping scanner", err);
                    }
                    html5QrCodeRef.current = null;
                }
                setIsLookupScanning(false);
            };

            const userSchedules = useMemo(() => {
                if (!selectedUser || !schedules) return [];
                return schedules.filter(s => {
                    if (s.targetKey === 'ALL') return true;
                    const userOpt = selectedUser.options?.[s.targetKey];
                    if (!userOpt) return false;
                    return s.targetVal === 'ALL' || userOpt.includes(s.targetVal);
                }).sort((a,b) => a.date > b.date ? 1 : -1);
            }, [selectedUser, schedules]);

            const uniqueValues = useMemo(() => {
                if (!editForm.optKey) return [];
                const values = new Set();
                
                if (users) {
                    users.forEach(u => {
                        if (u.options && u.options[editForm.optKey]) {
                            values.add(u.options[editForm.optKey]);
                        }
                    });
                }

                if (schedules) {
                    schedules.forEach(s => {
                        if (s.targetKey === editForm.optKey && s.targetVal !== 'ALL') {
                            values.add(s.targetVal);
                        }
                    });
                }

                return Array.from(values).sort();
            }, [editForm.optKey, users, schedules]);

            useEffect(() => {
                if (!selectedUser || !editForm.optKey || !editForm.optVal || !schedules) return;

                const oldVal = selectedUser.options[editForm.optKey];
                const newVal = editForm.optVal;

                if (oldVal === newVal) return;

                const getPriceForOption = (val) => {
                    return schedules
                        .filter(s => s.targetKey === editForm.optKey && s.targetVal === val && s.type === 'PAYMENT')
                        .reduce((sum, s) => sum + (s.price || 0), 0);
                };

                const oldPrice = getPriceForOption(oldVal);
                const newPrice = getPriceForOption(newVal);
                const diff = oldPrice - newPrice;

                if (diff > 0) {
                    setEditForm(prev => ({
                        ...prev,
                        penalty: diff,
                        reason: `ì¼ì • ë³€ê²½ ì°¨ì•¡ (${oldVal}: ${CURRENCY}${oldPrice} -> ${newVal}: ${CURRENCY}${newPrice})`
                    }));
                }
            }, [editForm.optVal, editForm.optKey, selectedUser, schedules]);

            const userHistoryLogs = useMemo(() => {
                if(!selectedUser) return [];
                return changeLogs.filter(l => l.uid === selectedUser.uid).sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
            }, [changeLogs, selectedUser]);

            const visibleLogs = showAllHistory ? userHistoryLogs : userHistoryLogs.slice(0, 1);

            return (
                <div className="space-y-6 animate-slide-up">
                    <div className="bg-white p-6 rounded-3xl shadow-card">
                        <h3 className="font-bold text-lg mb-4 text-slate-800">ì°¸ê°€ì ì¼ì • ë³€ê²½ ë° íŒ¨ë„í‹° ê´€ë¦¬</h3>
                        <div className="flex flex-col gap-2 mb-6">
                            <input 
                                type="text" 
                                value={searchQuery} 
                                onChange={(e)=>setSearchQuery(e.target.value)} 
                                placeholder="ì‚¬ë²ˆ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰" 
                                className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl font-bold outline-none focus:border-incar" 
                            />
                            <div className="flex gap-2">
                                <button 
                                    onClick={startLookupScanner} 
                                    className="bg-slate-100 text-slate-600 px-4 py-4 rounded-2xl hover:bg-slate-200 transition-colors border border-slate-200 flex-none" 
                                    title="QR ìŠ¤ìº”ìœ¼ë¡œ ì°¾ê¸°"
                                >
                                    <Icon name="qr" size={24} />
                                </button>
                                <button 
                                    onClick={()=>{
                                        const found = users.find(u => String(u.uid).trim() === String(searchQuery).trim() || u.name.includes(searchQuery));
                                        if(found) setSelectedUser(found); else alert("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                                    }} 
                                    className="flex-1 bg-slate-800 text-white px-6 py-4 rounded-2xl font-bold"
                                >
                                    ê²€ìƒ‰
                                </button>
                            </div>
                        </div>

                        {/* ìŠ¤ìºë„ˆ ëª¨ë‹¬ */}
                        {isLookupScanning && (
                            <div className="fixed inset-0 z-[300] bg-black/95 flex flex-col items-center justify-center p-6 animate-fade-in" style={{ touchAction: 'none' }}>
                                <button onClick={stopLookupScanner} className="absolute top-8 right-8 text-white p-3 bg-white/10 rounded-full hover:bg-white/20 transition-colors z-[101]">
                                    <Icon name="x" size={32} />
                                </button>
                                <div className="scanner-container">
                                    <div id="lookup-reader"></div>
                                    <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                                        <div className="relative w-[70%] h-[70%]">
                                            <div className="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-white rounded-tl-2xl"></div>
                                            <div className="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-white rounded-tr-2xl"></div>
                                            <div className="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-white rounded-bl-2xl"></div>
                                            <div className="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-white rounded-br-2xl"></div>
                                            <div className="scan-line bg-incar"></div>
                                        </div>
                                    </div>
                                </div>
                                <p className="text-white mt-10 font-bold text-xl animate-pulse text-center">ì¡°íšŒí•  QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</p>
                                <div className="mt-8 flex gap-4">
                                    <button onClick={stopLookupScanner} className="px-8 py-3 bg-white text-slate-900 rounded-xl font-bold text-sm hover:bg-slate-200 transition-colors">ë‹«ê¸°</button>
                                </div>
                            </div>
                        )}

                        {selectedUser && (
                            <div className="border-t border-slate-100 pt-6 space-y-4">
                                <div className="flex flex-col md:flex-row gap-6 mb-6">
                                    <div className="flex-1 bg-slate-50 p-5 rounded-2xl border border-slate-100 flex flex-col justify-center">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <div className="font-black text-2xl text-slate-800">{selectedUser.name}</div>
                                                <div className="text-sm font-bold text-slate-500">{selectedUser.org}</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-[10px] font-bold text-slate-400 uppercase">ì‚¬ë²ˆ(ID)</div>
                                                <div className="font-mono font-bold text-incar">{selectedUser.uid}</div>
                                            </div>
                                        </div>
                                        <div className="mt-4 pt-4 border-t border-slate-200/50 flex justify-between items-center">
                                            <span className="text-xs font-bold text-slate-400">ëˆ„ì  íŒ¨ë„í‹°</span>
                                            <span className="font-black text-rose-500 text-lg">-{CURRENCY}{selectedUser.penaltyTotal || 0}</span>
                                        </div>
                                    </div>
                                    <div className="bg-white border-2 border-dashed border-slate-200 rounded-2xl p-4 flex flex-col items-center justify-center text-center w-full md:w-auto">
                                        <div className="mb-2 w-32 h-32 flex items-center justify-center bg-slate-50">
                                            <QRCodeCanvas text={BASE_URL + selectedUser.uid} />
                                        </div>
                                        <p className="text-[10px] font-bold text-slate-400">ì•ˆë‚´ URL í¬í•¨ë¨</p>
                                    </div>
                                </div>

                                <div className="bg-indigo-50 border border-indigo-100 rounded-2xl p-5 mb-4">
                                    <h4 className="font-bold text-incar mb-3 flex items-center gap-2"><Icon name="dashboard" size={16}/> {selectedUser.name}ë‹˜ì˜ ì „ì²´ ì—¬í–‰ ì¼ì •</h4>
                                    {userSchedules.length === 0 ? (
                                        <div className="text-center text-slate-400 text-xs py-4">ë°°ì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                    ) : (
                                        <div className="max-h-60 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                                            {userSchedules.map((s, idx) => (
                                                <div key={idx} className="bg-white p-3 rounded-xl border border-indigo-100 shadow-sm flex justify-between items-center">
                                                    <div>
                                                        <span className="text-[10px] font-bold text-slate-400 block">{s.displayDate}</span>
                                                        <span className="font-bold text-slate-800">{s.title}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-bold ${s.type==='PAYMENT'?'bg-emerald-100 text-emerald-600':'bg-slate-100 text-slate-500'}`}>
                                                            {s.type==='PAYMENT' ? `ì§€ê¸‰ ${CURRENCY}${s.price}` : 'íƒ‘ìŠ¹'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="mt-6 pt-6 border-t border-slate-100">
                                    <h4 className="font-bold text-sm text-slate-800 mb-3 flex items-center gap-2"><Icon name="history" size={16}/> ë³€ê²½ ë° íŒ¨ë„í‹° ì´ë ¥</h4>
                                    {userHistoryLogs.length === 0 ? (
                                        <p className="text-xs text-slate-400">ë³€ê²½ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                    ) : (
                                        <div className="space-y-3">
                                            {/* PC ë·° (í…Œì´ë¸”) */}
                                            <div className="hidden md:block overflow-x-auto">
                                                <table className="w-full text-xs text-left">
                                                    <thead className="bg-slate-50 text-slate-500 font-bold">
                                                        <tr><th className="p-2">ì¼ì‹œ</th><th className="p-2">í•­ëª©</th><th className="p-2">ë‚´ìš©</th><th className="p-2 text-right">íŒ¨ë„í‹°</th><th className="p-2">ì‚¬ìœ </th></tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {visibleLogs.map((log, i) => (
                                                            <tr key={i}>
                                                                <td className="p-2 text-slate-400">{log.timestamp.slice(5, 16)}</td>
                                                                <td className="p-2 font-bold">{log.targetOption}</td>
                                                                <td className="p-2">
                                                                    <span className="line-through text-slate-300">{log.oldVal}</span> 
                                                                    <span className="mx-1 text-slate-300">â†’</span> 
                                                                    <span className="text-incar font-bold">{log.newVal}</span>
                                                                </td>
                                                                <td className="p-2 text-right font-bold text-rose-500">{log.penalty > 0 ? `-${CURRENCY}${log.penalty}` : '-'}</td>
                                                                <td className="p-2 text-slate-500 truncate max-w-[100px]">{log.reason}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {/* ëª¨ë°”ì¼ ë·° (ì¹´ë“œ ë¦¬ìŠ¤íŠ¸) */}
                                            <div className="md:hidden space-y-2">
                                                {visibleLogs.map((log, i) => (
                                                    <div key={i} className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col gap-2">
                                                        <div className="flex justify-between items-center text-xs text-slate-400 font-medium border-b border-slate-200 pb-2 mb-1">
                                                            <span>{log.timestamp.slice(5, 16)}</span>
                                                            <span className="bg-white px-2 py-0.5 rounded border border-slate-200">{log.targetOption}</span>
                                                        </div>
                                                        <div className="flex items-center justify-center gap-2 text-sm">
                                                            <span className="line-through text-slate-400">{log.oldVal}</span>
                                                            <Icon name="chevronsDown" size={12} className="rotate-[-90deg] text-slate-300" />
                                                            <span className="font-bold text-incar">{log.newVal}</span>
                                                        </div>
                                                        <div className="flex justify-between items-end mt-1 pt-2 border-t border-slate-200/50">
                                                            <span className="text-xs text-slate-500 flex-1 truncate pr-2">{log.reason}</span>
                                                            <span className="text-sm font-bold text-rose-500">{log.penalty > 0 ? `-${CURRENCY}${log.penalty}` : '-'}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>

                                            {userHistoryLogs.length > 1 && (
                                                <button 
                                                    onClick={() => setShowAllHistory(!showAllHistory)} 
                                                    className="w-full py-2 text-xs font-bold text-slate-400 bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors flex items-center justify-center gap-1"
                                                >
                                                    {showAllHistory ? 'ì ‘ê¸°' : `ë”ë³´ê¸° (${userHistoryLogs.length - 1}ê±´ ë” ìˆìŒ)`} <Icon name={showAllHistory ? "up" : "down"} size={12} />
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-2 gap-4 mt-4">
                                    <div><label className="block text-xs font-bold text-slate-400 mb-1">ë³€ê²½ ì „ ì¼ì •</label><select value={editForm.optKey} onChange={e=>setEditForm({...editForm, optKey: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white"><option value="">ì„ íƒí•˜ì„¸ìš”</option>{Object.keys(selectedUser.options).map(key => <option key={key} value={key}>{key} (í˜„ì¬: {selectedUser.options[key]})</option>)}</select></div>
                                    
                                    <div>
                                        <div className="flex justify-between items-center mb-1">
                                            <label className="block text-xs font-bold text-slate-400">ë³€ê²½ í›„ ì¼ì •</label>
                                            <button onClick={()=>setManualInput(!manualInput)} className="text-[10px] text-incar underline font-bold">{manualInput ? 'ëª©ë¡ì—ì„œ ì„ íƒ' : 'ì§ì ‘ ì…ë ¥'}</button>
                                        </div>
                                        {manualInput ? (
                                            <input type="text" value={editForm.optVal} onChange={e=>setEditForm({...editForm, optVal: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white" placeholder="ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”" />
                                        ) : (
                                            <select value={editForm.optVal} onChange={e=>setEditForm({...editForm, optVal: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm bg-white">
                                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                                {uniqueValues.map(val => (
                                                    <option key={val} value={val}>{val}</option>
                                                ))}
                                                <option value="ì§ì ‘ì…ë ¥">[ëª©ë¡ì— ì—†ìŒ]</option>
                                            </select>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1">íŒ¨ë„í‹° ({CURRENCY})</label>
                                    <input type="number" value={editForm.penalty} onChange={e=>setEditForm({...editForm, penalty: e.target.value})} className="w-full p-3 border border-rose-200 bg-rose-50 rounded-xl font-bold text-rose-600" />
                                    <p className="text-[10px] text-slate-400 mt-1">* ê¸°ì¡´ ì¼ì •ë³´ë‹¤ ì €ë ´í•œ ì¼ì •ìœ¼ë¡œ ë³€ê²½ ì‹œ ì°¨ì•¡ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                                </div>
                                <div><label className="block text-xs font-bold text-slate-400 mb-1">ë³€ê²½ ì‚¬ìœ </label><input type="text" value={editForm.reason} onChange={e=>setEditForm({...editForm, reason: e.target.value})} className="w-full p-3 border rounded-xl font-bold text-sm" /></div>
                                <button onClick={handleUserUpdate} className="w-full py-4 bg-incar text-white font-bold rounded-2xl shadow-lg mt-4 hover:bg-incar-dark">ì €ì¥í•˜ê¸°</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ê°œë³„ QR ì¹´ë“œë¥¼ ìœ„í•œ ìƒˆë¡œìš´ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€
        const UserQRCard = ({ user, baseUrl }) => {
            const canvasRef = useRef(null);
            const qrText = baseUrl + user.uid;

            useEffect(() => {
                if (canvasRef.current && window.QRious) {
                    new QRious({
                        element: canvasRef.current,
                        value: qrText,
                        size: 140,
                        level: 'H',
                        background: 'white',
                        foreground: 'black'
                    });
                }
            }, [qrText]);

            const copyLink = async () => {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(qrText);
                        alert(`${user.name} ë‹˜ì˜ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    } else {
                        throw new Error("No clipboard API");
                    }
                } catch (e) {
                    const el = document.createElement('textarea');
                    el.value = qrText;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    alert(`${user.name} ë‹˜ì˜ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            };

            const downloadPng = () => {
                if (canvasRef.current) {
                    const dataUrl = canvasRef.current.toDataURL("image/png");
                    const a = document.createElement("a");
                    a.href = dataUrl;
                    a.download = `${user.uid}_${user.name}_QR.png`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            };

            return (
                <div className="bg-white rounded-2xl p-4 text-center shadow-sm border border-slate-200 flex flex-col items-center">
                    <div className="p-2 bg-white rounded-xl border border-slate-100 mb-3 inline-flex justify-center items-center">
                        <canvas ref={canvasRef}></canvas>
                    </div>
                    <div className="font-bold text-slate-800 text-sm">{user.name}</div>
                    <div className="text-[9px] text-slate-500 mb-1">{user.uid}</div>
                    {/* âœ… ì¶”ê°€: QRì— ì‹¬ì–´ì§„ ì‹¤ì œ ì£¼ì†Œë¥¼ ëˆˆìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ í•¨ */}
                    <div className="text-[7px] text-blue-500 mb-3 break-all bg-blue-50 p-1.5 rounded w-full">
                        {qrText}
                    </div>
                    <div className="flex gap-2 w-full justify-center">
                        <button onClick={copyLink} className="flex-1 py-2 bg-slate-100 text-slate-700 text-[10px] font-bold rounded-lg hover:bg-slate-200 transition-colors">ë§í¬ë³µì‚¬</button>
                        <button onClick={downloadPng} className="flex-1 py-2 bg-slate-800 text-white text-[10px] font-bold rounded-lg hover:bg-slate-700 transition-colors">PNGë‹¤ìš´</button>
                    </div>
                </div>
            );
        };

        const ManageView = ({ users, handleUserUpload, handleScheduleUpload, badgeConfig, setBadgeConfig, db, schedules, logs, setIsPrintMode, setUsers, setSchedules, setLogs, setChangeLogs, changeLogs, appBgImage, setAppBgImage, handleAppBgUpload }) => {
            const handleBgImageUpload = (e) => {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image();
                        img.onload = () => {
                            setBadgeConfig(prev => ({
                                ...prev,
                                bgImage: evt.target.result,
                                imgWidth: img.naturalWidth,
                                imgHeight: img.naturalHeight
                            }));
                        };
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const [selectedId, setSelectedId] = useState(null);
            const [dragTarget, setDragTarget] = useState(null);
            const [guides, setGuides] = useState({ x: null, y: null });
            const [snapTargets, setSnapTargets] = useState([]);
            const [isZipping, setIsZipping] = useState(false);
            const [zipProgress, setZipProgress] = useState(0);
            const editorRef = useRef(null);

            const startDrag = (e, id) => {
                e.preventDefault();
                e.stopPropagation();
                setSelectedId(id);
                setDragTarget(id);

                const targets = [];
                targets.push({ x: 50, y: 50 }); // Canvas Center

                if (badgeConfig.layers) {
                    badgeConfig.layers.forEach(l => {
                        if (l.id !== id) {
                            targets.push({ x: l.x, y: l.y });
                        }
                    });
                }
                setSnapTargets(targets);
            };

            const onEditorMove = useCallback((e) => {
                if (!dragTarget || !editorRef.current) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = editorRef.current.getBoundingClientRect();
                
                let newX = ((clientX - rect.left) / rect.width) * 100;
                let newY = ((clientY - rect.top) / rect.height) * 100;
                
                newX = Math.max(0, Math.min(100, newX));
                newY = Math.max(0, Math.min(100, newY));
                
                let guideX = null;
                let guideY = null;
                
                const threshold = 1.5;
                for (const target of snapTargets) {
                    if (guideX === null && Math.abs(newX - target.x) < threshold) {
                        newX = target.x;
                        guideX = target.x;
                    }
                    if (guideY === null && Math.abs(newY - target.y) < threshold) {
                        newY = target.y;
                        guideY = target.y;
                    }
                }
                
                setGuides({ x: guideX, y: guideY });
                
                setBadgeConfig(prev => ({
                    ...prev,
                    layers: prev.layers.map(l => l.id === dragTarget ? { ...l, x: newX, y: newY } : l)
                }));
            }, [dragTarget, snapTargets]);

            const stopDrag = () => {
                setDragTarget(null);
                setGuides({ x: null, y: null });
                setSnapTargets([]);
            };

            useEffect(() => {
                if (dragTarget) {
                    window.addEventListener('mousemove', onEditorMove);
                    window.addEventListener('mouseup', stopDrag);
                    window.addEventListener('touchmove', onEditorMove, { passive: false });
                    window.addEventListener('touchmove', (e)=>{e.preventDefault()}, { passive: false });
                    window.addEventListener('touchend', stopDrag);
                }
                return () => {
                    window.removeEventListener('mousemove', onEditorMove);
                    window.removeEventListener('mouseup', stopDrag);
                    window.removeEventListener('touchmove', onEditorMove);
                    window.removeEventListener('touchend', stopDrag);
                };
            }, [dragTarget, onEditorMove]);

            const addLayer = (type, subType = null) => {
                const newId = `${type}_${Date.now()}`;
                let newLayer = { id: newId, type, x: 50, y: 50 };
                
                if (type === 'text') {
                    newLayer = { 
                        ...newLayer, 
                        content: subType ? (subType === 'name' ? 'ì„± ëª…' : subType === 'org' ? 'ì†Œ ì†' : 'ì§ ì±…') : 'New Text',
                        variable: subType, 
                        fontSize: 30, fontFamily: 'Noto Sans KR', color: '#000000', align: 'center', width: 'auto' 
                    };
                } else if (type === 'qr') {
                    newLayer = { ...newLayer, size: 100 };
                } else if (type === 'rect') {
                    newLayer = { ...newLayer, w: 200, h: 50, fill: '#e2e8f0', borderColor: '#000000', borderWidth: 0, opacity: 1, borderRadius: 0 };
                } else if (type === 'circle') {
                    newLayer = { ...newLayer, w: 100, h: 100, fill: '#e2e8f0', borderColor: '#000000', borderWidth: 0, opacity: 1 };
                }
                
                setBadgeConfig(prev => ({ ...prev, layers: [...(prev.layers || []), newLayer] }));
                setSelectedId(newId);
            };

            const updateLayer = (key, value) => {
                setBadgeConfig(prev => ({
                    ...prev,
                    layers: prev.layers.map(l => l.id === selectedId ? { ...l, [key]: value } : l)
                }));
            };

            const deleteLayer = () => {
                if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    setBadgeConfig(prev => ({ ...prev, layers: prev.layers.filter(l => l.id !== selectedId) }));
                    setSelectedId(null);
                }
            };

            const moveLayer = (direction) => {
                if (!selectedId) return;
                setBadgeConfig(prev => {
                    const idx = prev.layers.findIndex(l => l.id === selectedId);
                    if (idx < 0) return prev;
                    let newLayers = [...prev.layers];
                    const item = newLayers.splice(idx, 1)[0];

                    if (direction === 'top') {
                        newLayers.push(item);
                    } else if (direction === 'bottom') {
                        newLayers.unshift(item);
                    } else if (direction === 'up' && idx < prev.layers.length - 1) {
                        newLayers.splice(idx + 1, 0, item);
                    } else if (direction === 'down' && idx > 0) {
                        newLayers.splice(idx - 1, 0, item);
                    } else {
                        newLayers.splice(idx, 0, item);
                    }
                    return { ...prev, layers: newLayers };
                });
            };

            const selectedLayer = badgeConfig.layers ? badgeConfig.layers.find(l => l.id === selectedId) : null;

            const renderEditorLayer = (layer, index) => {
                const isSelected = layer.id === selectedId;
                const style = {
                    position: 'absolute', top: `${layer.y}%`, left: `${layer.x}%`,
                    transform: 'translate(-50%, -50%)',
                    cursor: 'grab',
                    border: isSelected ? '2px solid #3b82f6' : '1px dashed rgba(0,0,0,0.1)',
                    zIndex: index, 
                };

                const handlers = {
                    onMouseDown: (e) => startDrag(e, layer.id),
                    onTouchStart: (e) => startDrag(e, layer.id),
                    onClick: (e) => e.stopPropagation()
                };

                // âœ… ì—ë””í„° í™”ë©´ì˜ QR ê°€ì´ë“œì—ë„ ë¬¸êµ¬ ì¶”ê°€
                if (layer.type === 'qr') {
                    return <div key={layer.id} {...handlers} style={{ ...style, width: `${layer.size}px`, height: `${layer.size}px`, display: 'flex', flexWrap: 'wrap', alignContent: 'center', justifyContent: 'center', backgroundColor: 'rgba(255,255,255,0.5)' }}><span className="text-[10px] font-bold text-red-500 w-full text-center">QR</span><span className="text-[8px] text-red-400 w-full text-center">(ìë™ ìƒì„±)</span></div>;
                } else if (layer.type === 'text') {
                    return (
                        <div key={layer.id} {...handlers} className={layer.fontFamily} style={{
                            ...style,
                            fontSize: `${layer.fontSize}px`, color: layer.color, fontWeight: layer.fontWeight || 'bold',
                            backgroundColor: layer.bgColor || 'transparent', padding: `${layer.padding || 0}px`, borderRadius: `${layer.borderRadius || 0}px`,
                            width: layer.width === 'auto' ? 'auto' : `${layer.width}px`, textAlign: layer.align || 'center', whiteSpace: 'nowrap',
                            fontFamily: layer.fontFamily
                        }}>
                            {(!layer.variable ? layer.content : { name: 'ì„± ëª…', org: 'ì†Œ ì†', role: 'ì§ ì±…', id: 'ì‚¬ ë²ˆ' }[layer.variable] || layer.content)}
                        </div>
                    );
                } else if (layer.type === 'rect' || layer.type === 'circle') {
                    return (
                        <div key={layer.id} {...handlers} style={{
                            ...style, width: `${layer.w}px`, height: `${layer.h}px`, backgroundColor: layer.fill,
                            border: `${layer.borderWidth}px solid ${layer.borderColor}`, borderRadius: layer.type === 'circle' ? '50%' : `${layer.borderRadius}px`, opacity: layer.opacity
                        }}></div>
                    );
                }
            };

            const exportAllData = () => {
                if(logs.length === 0 && changeLogs.length === 0) return alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                
                const formatLogDate = (ts) => {
                    if (!ts) return '-';
                    const date = new Date(ts);
                    if (isNaN(date.getTime())) return ts; 
                    const pad = n => n < 10 ? '0'+n : n;
                    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
                };

                const combinedData = [];

                logs.forEach(l => {
                    combinedData.push({
                        rawTime: l.timestamp,
                        ì¼ì‹œ: formatLogDate(l.timestamp),
                        ì‚¬ë²ˆ: l.uid,
                        ì„±ëª…: l.name,
                        êµ¬ë¶„: l.action,
                        ì¼ì •ëª…: l.sessionTitle,
                        ê¸ˆì•¡: l.finalAmount || 0,
                        íŒ¨ë„í‹°: l.penaltyApplied || 0,
                        íƒ‘ìŠ¹ì°¨ëŸ‰: l.bus,
                        ë¹„ê³ : ''
                    });
                });

                changeLogs.forEach(c => {
                    combinedData.push({
                        rawTime: c.timestamp,
                        ì¼ì‹œ: formatLogDate(c.timestamp),
                        ì‚¬ë²ˆ: c.uid,
                        ì„±ëª…: c.name,
                        êµ¬ë¶„: 'ë³€ê²½',
                        ì¼ì •ëª…: c.targetOption, 
                        ê¸ˆì•¡: 0,
                        íŒ¨ë„í‹°: c.penalty || 0,
                        íƒ‘ìŠ¹ì°¨ëŸ‰: '', 
                        ë¹„ê³ : `${c.oldVal} -> ${c.newVal} | ${c.reason}`
                    });
                });

                combinedData.sort((a, b) => new Date(b.rawTime) - new Date(a.rawTime));

                const headers = ['ì¼ì‹œ', 'ì‚¬ë²ˆ', 'ì„±ëª…', 'êµ¬ë¶„', 'ì¼ì •ëª…', 'ê¸ˆì•¡', 'íŒ¨ë„í‹°', 'íƒ‘ìŠ¹ì°¨ëŸ‰', 'ë¹„ê³ '];
                let rows = '';
                combinedData.forEach(d => {
                    rows += `<tr>
                        <td>${d.ì¼ì‹œ}</td>
                        <td style="mso-number-format:'@'">${d.ì‚¬ë²ˆ}</td>
                        <td>${d.ì„±ëª…}</td>
                        <td>${d.êµ¬ë¶„}</td>
                        <td>${d.ì¼ì •ëª…}</td>
                        <td>${d.ê¸ˆì•¡}</td>
                        <td>${d.íŒ¨ë„í‹°}</td>
                        <td>${d.íƒ‘ìŠ¹ì°¨ëŸ‰}</td>
                        <td>${d.ë¹„ê³ }</td>
                    </tr>`;
                });

                const tableHTML = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                    <head>
                        <meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">
                        <style>
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #000; padding: 5px; text-align: center; white-space: nowrap; vertical-align: middle; }
                            th { background-color: #f0f0f0; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <h3>[INCARPASS í†µí•© ìš´ì˜ ë¡œê·¸]</h3>
                        <table>
                            <thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </body>
                </html>`;
                
                const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `INCARPASS_Unified_Log_${new Date().toISOString().slice(0,10)}.xls`;
                link.click();
            };

            const handleFullReset = async () => {
                if(!confirm("âš ï¸ ê²½ê³ : ì„œë²„ ë° ë¡œì»¬ì— ì €ì¥ëœ ëª¨ë“  ë°ì´í„°(ì°¸ê°€ì, ì¼ì •, ë¡œê·¸)ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                
                if (db) {
                    const collections = ['users', 'schedules', 'logs', 'changelogs'];
                    for (const col of collections) {
                        const snapshot = await db.collection('artifacts').doc(SYSTEM_APP_ID).collection(col).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    }
                }
                localStorage.clear();
                alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.reload();
            };

            const generateZip = async () => {
                if (users.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                setIsZipping(true);
                setZipProgress(0);

                await new Promise(resolve => setTimeout(resolve, 1000)); 

                const zip = new JSZip();
                const folder = zip.folder("badges");

                const sortedUsers = [...users].sort((a, b) => String(a.uid).localeCompare(String(b.uid), undefined, { numeric: true, sensitivity: 'base' }));

                for (let i = 0; i < sortedUsers.length; i++) {
                    const u = sortedUsers[i];
                    const element = document.getElementById(`badge-export-${u.uid}`);
                    if (element) {
                        try {
                            const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null });
                            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                            folder.file(`${u.name}_${u.uid}.png`, blob);
                        } catch (err) {
                            console.error("Error capturing badge:", u.name, err);
                        }
                    }
                    setZipProgress(Math.round(((i + 1) / sortedUsers.length) * 100));
                    await new Promise(resolve => setTimeout(resolve, 10)); 
                }

                zip.generateAsync({ type: "blob" }).then(content => {
                    saveAs(content, `ëª…ì°°_ì´ë¯¸ì§€_ì¼ê´„_${new Date().toISOString().slice(0,10)}.zip`);
                    setIsZipping(false);
                    alert("ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            };

            return (
                <div className="space-y-6 animate-slide-up no-print">
                    <div className="bg-white p-6 rounded-3xl shadow-card border border-slate-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="edit" className="text-incar"/> ëª…ì°° ë””ìì¸ ì—ë””í„°</h3>
                            <div className="flex gap-2">
                                <button onClick={()=>addLayer('text', 'name')} className="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-lg hover:bg-slate-200">+ ì´ë¦„</button>
                                <button onClick={()=>addLayer('text', 'org')} className="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-lg hover:bg-slate-200">+ ì†Œì†</button>
                                <button onClick={()=>addLayer('text')} className="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-lg hover:bg-slate-200">+ í…ìŠ¤íŠ¸</button>
                                <button onClick={()=>addLayer('rect')} className="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-lg hover:bg-slate-200">+ ë°•ìŠ¤</button>
                                <button onClick={()=>addLayer('circle')} className="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-lg hover:bg-slate-200">+ ì›</button>
                                <button onClick={()=>addLayer('qr')} className="px-3 py-1.5 bg-slate-100 text-xs font-bold rounded-lg hover:bg-slate-200">+ QR</button>
                            </div>
                        </div>
                        
                        <div className="flex flex-col lg:flex-row gap-8 items-start">
                            {/* Canvas Area */}
                            <div className="flex-none bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 p-4 flex justify-center relative" onClick={()=>setSelectedId(null)}>
                                <div ref={editorRef} className="relative overflow-hidden shadow-2xl bg-white select-none" style={{ width: '545px', height: '697px', borderRadius: '10px' }}>
                                    {guides.x !== null && <div className="smart-guide-x" style={{left: `${guides.x}%`}}></div>}
                                    {guides.y !== null && <div className="smart-guide-y" style={{top: `${guides.y}%`}}></div>}
                                    {badgeConfig.bgImage ? <img src={badgeConfig.bgImage} className="absolute inset-0 w-full h-full object-cover pointer-events-none" /> : <div className="absolute inset-0 flex items-center justify-center text-slate-300">ì´ë¯¸ì§€ ì—†ìŒ</div>}
                                    {badgeConfig.layers && badgeConfig.layers.map((layer, idx) => renderEditorLayer(layer, idx))}
                                </div>
                            </div>

                            {/* Property Panel */}
                            <div className="flex-1 space-y-4 w-full bg-white p-4 rounded-xl border border-slate-100 shadow-sm" onMouseDown={e => e.stopPropagation()}>
                                <div><label className="block text-xs font-bold text-slate-400 mb-2">ë°°ê²½ ì´ë¯¸ì§€</label><input type="file" accept="image/*" onChange={handleBgImageUpload} className="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-incar-light file:text-incar hover:file:bg-indigo-100"/></div>
                                
                                {selectedLayer ? (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex justify-between items-center border-b pb-2">
                                            <span className="font-bold text-sm text-incar">ì†ì„± í¸ì§‘ ({selectedLayer.type})</span>
                                            <div className="flex gap-2">
                                                <button onClick={()=>moveLayer('top')} className="p-1 hover:bg-slate-100 rounded text-incar" title="ë§¨ ì•ìœ¼ë¡œ"><Icon name="chevronsUp" size={16}/></button>
                                                <button onClick={()=>moveLayer('up')} className="p-1 hover:bg-slate-100 rounded" title="í•œ ì¹¸ ì•ìœ¼ë¡œ"><Icon name="up" size={16}/></button>
                                                <button onClick={()=>moveLayer('down')} className="p-1 hover:bg-slate-100 rounded" title="í•œ ì¹¸ ë’¤ë¡œ"><Icon name="down" size={16}/></button>
                                                <button onClick={()=>moveLayer('bottom')} className="p-1 hover:bg-slate-100 rounded text-incar" title="ë§¨ ë’¤ë¡œ"><Icon name="chevronsDown" size={16}/></button>
                                                <button onClick={deleteLayer} className="p-1 hover:bg-rose-100 text-rose-500 rounded ml-2" title="ì‚­ì œ"><Icon name="trash" size={16}/></button>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] font-bold text-slate-400">X (%)</label><input type="number" value={Math.round(selectedLayer.x)} onChange={e=>updateLayer('x', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                            <div><label className="text-[10px] font-bold text-slate-400">Y (%)</label><input type="number" value={Math.round(selectedLayer.y)} onChange={e=>updateLayer('y', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                        </div>

                                        {selectedLayer.type === 'text' && (
                                            <>
                                                <div><label className="text-[10px] font-bold text-slate-400">ë‚´ìš©</label><input type="text" value={selectedLayer.content} onChange={e=>updateLayer('content', e.target.value)} className="w-full p-2 border rounded text-xs"/></div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400">ë°ì´í„° ì—°ê²°</label>
                                                    <select value={selectedLayer.variable || ''} onChange={e=>updateLayer('variable', e.target.value)} className="w-full p-2 border rounded text-xs">
                                                        <option value="">(ì—°ê²° ì—†ìŒ - ê³ ì • í…ìŠ¤íŠ¸)</option>
                                                        <option value="name">ì´ë¦„ {`{name}`}</option>
                                                        <option value="org">ì†Œì† {`{org}`}</option>
                                                        <option value="role">ì§ì±… {`{role}`}</option>
                                                        <option value="id">ì‚¬ë²ˆ {`{id}`}</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400">í°íŠ¸</label>
                                                    <select value={selectedLayer.fontFamily || "'Noto Sans KR', sans-serif"} onChange={e=>updateLayer('fontFamily', e.target.value)} className="w-full p-2 border rounded text-xs" style={{ fontFamily: selectedLayer.fontFamily }}>
                                                        {AVAILABLE_FONTS.map((font, idx) => (
                                                            <option key={idx} value={font.value} style={{ fontFamily: font.value }}>{font.name}</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="text-[10px] font-bold text-slate-400">í°íŠ¸ í¬ê¸°</label><input type="number" value={selectedLayer.fontSize} onChange={e=>updateLayer('fontSize', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400">ìƒ‰ìƒ</label><div className="flex items-center gap-2"><input type="color" value={selectedLayer.color} onChange={e=>updateLayer('color', e.target.value)} className="w-8 h-8 rounded border"/><span className="text-xs">{selectedLayer.color}</span></div></div>
                                                </div>
                                            </>
                                        )}

                                        {(selectedLayer.type === 'rect' || selectedLayer.type === 'circle') && (
                                            <>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="text-[10px] font-bold text-slate-400">ë„ˆë¹„ (px)</label><input type="number" value={selectedLayer.w} onChange={e=>updateLayer('w', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400">ë†’ì´ (px)</label><input type="number" value={selectedLayer.h} onChange={e=>updateLayer('h', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="text-[10px] font-bold text-slate-400">ë°°ê²½ìƒ‰</label><div className="flex items-center gap-2"><input type="color" value={selectedLayer.fill} onChange={e=>updateLayer('fill', e.target.value)} className="w-8 h-8 rounded border"/></div></div>
                                                    <div><label className="text-[10px] font-bold text-slate-400">íˆ¬ëª…ë„ (0-1)</label><input type="number" step="0.1" min="0" max="1" value={selectedLayer.opacity} onChange={e=>updateLayer('opacity', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                                </div>
                                                {selectedLayer.type === 'rect' && (
                                                    <div><label className="text-[10px] font-bold text-slate-400">ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸° (px)</label><input type="number" value={selectedLayer.borderRadius} onChange={e=>updateLayer('borderRadius', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/></div>
                                                )}
                                            </>
                                        )}
                                        
                                        {selectedLayer.type === 'qr' && (
                                            <div>
                                                <label className="text-[10px] font-bold text-slate-400">í¬ê¸°</label>
                                                <input type="number" value={selectedLayer.size} onChange={e=>updateLayer('size', Number(e.target.value))} className="w-full p-2 border rounded text-xs"/>
                                                <p className="text-[10px] text-slate-400 mt-1">* QR ì½”ë“œëŠ” <br/><code className="bg-slate-100 p-1 rounded">ì•ˆë‚´ì‚¬ì´íŠ¸URL/?eid=ì‚¬ë²ˆ</code><br/>í˜•íƒœë¡œ ìë™ ì‚½ì…ë©ë‹ˆë‹¤.</p>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="text-center py-10 text-slate-400 text-sm border-2 border-dashed border-slate-100 rounded-xl bg-slate-50">
                                        ìš”ì†Œë¥¼ í´ë¦­í•˜ì—¬ í¸ì§‘í•˜ì„¸ìš”
                                    </div>
                                )}
                                
                                <div className="mt-4 pt-4 border-t">
                                    <label className="block text-xs font-bold text-slate-400 mb-2">ë ˆì´ì–´ ëª©ë¡ (ìœ„ìª½ì´ ì•ë©´)</label>
                                    <div className="max-h-40 overflow-y-auto border rounded-lg text-xs">
                                        {badgeConfig.layers && [...badgeConfig.layers].reverse().map((l, idx) => (
                                            <div key={l.id} onClick={()=>setSelectedId(l.id)} className={`p-2 border-b cursor-pointer flex justify-between items-center layer-item ${l.id===selectedId?'active':''}`}>
                                                <span>{l.type === 'text' ? (l.content || 'Text') : l.type.toUpperCase()}</span>
                                                <span className="text-[9px] text-slate-400">{l.id}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-incar text-white p-6 rounded-3xl shadow-xl relative overflow-hidden">
                        <div className="relative z-10">
                            <h3 className="font-black text-2xl">ì„œë²„ ë°ì´í„° ì„¸íŒ… (Firebase ë™ê¸°í™”)</h3>
                            <p className="text-xs text-blue-200 mt-2">ì´ ì‹œìŠ¤í…œì€ íŒŒì´ì–´ë² ì´ìŠ¤ ì‹¤ì‹œê°„ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ë©´ ëª¨ë“  ìŠ¤ë§ˆíŠ¸í°/ê¸°ê¸°ì— 100% ì‹¤ì‹œê°„ ê³µìœ ë©ë‹ˆë‹¤.</p>
                            <div className="space-y-4 mt-4">
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-3"><Icon name="users" className="text-blue-200"/><div><div className="font-bold text-sm">1. ì°¸ê°€ì ëª…ë‹¨ ì„œë²„ ì—…ë¡œë“œ (Users.csv)</div></div></div>
                                    <label className="flex items-center justify-center px-4 py-2 bg-white text-incar font-bold rounded-lg cursor-pointer hover:bg-slate-100 text-xs"><input type="file" accept=".csv" onChange={handleUserUpload} className="hidden" />ì—…ë¡œë“œ</label>
                                </div>
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-3"><Icon name="dashboard" className="text-blue-200"/><div><div className="font-bold text-sm">2. ì¼ì • ì •ë³´ ì„œë²„ ì—…ë¡œë“œ (Schedules.csv)</div></div></div>
                                    <label className="flex items-center justify-center px-4 py-2 bg-white text-incar font-bold rounded-lg cursor-pointer hover:bg-slate-100 text-xs"><input type="file" accept=".csv" onChange={handleScheduleUpload} className="hidden" />ì—…ë¡œë“œ</label>
                                </div>
                                
                                {/* ì•± ì „ì²´ ë°°ê²½í™”ë©´ ì¶”ê°€ */}
                                <div className="bg-white/10 rounded-2xl border border-white/20 p-4 flex justify-between items-center">
                                    <div className="flex items-center gap-3">
                                        <Icon name="image" className="text-blue-200"/>
                                        <div>
                                            <div className="font-bold text-sm">3. ì•± ì „ì²´ ë°°ê²½í™”ë©´ (ê¸°ê¸° ë¡œì»¬)</div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        {appBgImage && <button onClick={() => setAppBgImage(null)} className="px-3 py-2 bg-rose-500/80 text-white font-bold rounded-lg hover:bg-rose-500 text-xs transition-colors">ì´ˆê¸°í™”</button>}
                                        <label className="flex items-center justify-center px-4 py-2 bg-white text-incar font-bold rounded-lg cursor-pointer hover:bg-slate-100 text-xs">
                                            <input type="file" accept="image/*" onChange={handleAppBgUpload} className="hidden" />ì—…ë¡œë“œ
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* âœ… ëŒ€í‘œë‹˜ì´ ì›í•˜ì…¨ë˜ [ê°œë³„ QR ì½”ë“œ ì¼ê´„ ê´€ë¦¬] ë·° ì¶”ê°€ */}
                    <div className="bg-slate-100 border border-slate-200 p-6 rounded-3xl shadow-sm mt-6">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Icon name="qr" /> ê°œë³„ QR ì½”ë“œ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ</h4>
                                <p className="text-xs text-slate-500">ìƒì„±ëœ QRì€ <code className="bg-slate-200 px-1 rounded">{BASE_URL}ì‚¬ë²ˆ</code> í˜•ì‹ìœ¼ë¡œ, íœ´ëŒ€í° ê¸°ë³¸ ì¹´ë©”ë¼ë¡œ ì°ìœ¼ë©´ ìë™ìœ¼ë¡œ ì‚¬ì´íŠ¸ì— ì—°ê²°ë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 max-h-[500px] overflow-y-auto p-2">
                            {users.map(u => <UserQRCard key={u.uid} user={u} baseUrl={BASE_URL} />)}
                            {users.length === 0 && <div className="col-span-full py-8 text-center text-slate-400 text-sm">ë“±ë¡ëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì´ì–´ë² ì´ìŠ¤ì— ëª…ë‹¨ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</div>}
                        </div>
                    </div>

                    <div className="bg-slate-100 border border-slate-200 p-6 rounded-3xl shadow-sm flex justify-between items-center mt-6">
                        <div><h4 className="font-bold text-lg text-slate-800 mb-1 flex items-center gap-2"><Icon name="download" /> ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h4><p className="text-xs text-slate-500">ì„œë²„ì— ì €ì¥ëœ ë³€ê²½ ë° ìŠ¤ìº” ì´ë ¥ì„ ì—‘ì…€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.</p></div>
                        <div className="flex gap-2">
                             <button onClick={exportAllData} className="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition-colors shadow-lg">ì „ì²´ ë‚´ì—­ ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>

                    <div className="bg-slate-800 text-white p-6 rounded-3xl shadow-card flex justify-between items-center relative overflow-hidden group mt-6">
                        <div className="relative z-10"><h4 className="font-bold text-lg mb-1 flex items-center gap-2"><Icon name="download" /> ëª…ì°° ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</h4><p className="text-xs text-slate-400">ì—ë””í„°ë¡œ ë””ìì¸í•œ ëª…ì°°ì„ ZIP íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. (QRì— ê³ ê°ìš© URLì´ ìë™ ì‚½ì…ë©ë‹ˆë‹¤)</p></div>
                        <button onClick={generateZip} className="relative z-10 px-6 py-3 bg-white text-slate-900 rounded-xl font-bold text-sm hover:bg-slate-100 transition-colors shadow-lg">{isZipping ? `ìƒì„± ì¤‘... ${zipProgress}%` : 'ëª…ì°° ì´ë¯¸ì§€ ì¼ê´„ ë‹¤ìš´ë¡œë“œ (ZIP)'}</button>
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-card text-center border border-rose-100 mt-6">
                        <h4 className="font-bold text-slate-800 mb-2">ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”</h4>
                        <p className="text-xs text-slate-400 mb-4">í˜„ì¬ ë°ì´í„°: {users.length}ëª… / {schedules.length}ê°œ ì„¸ì…˜ / {logs.length}ê°œ ë¡œê·¸</p>
                        <button onClick={handleFullReset} className="w-full py-3 bg-rose-50 text-rose-600 font-bold rounded-xl hover:bg-rose-100 text-sm flex items-center justify-center gap-2">
                           <Icon name="trash" size={16} /> Firebaseì— ì €ì¥ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ (ì´ˆê¸°í™”)
                        </button>
                    </div>

                    {isZipping && (
                        <div style={{ position: 'fixed', top: '-10000px', left: 0, zIndex: -1000, visibility: 'visible', pointerEvents: 'none' }}>
                            {users.map(u => (
                                <div key={u.uid} id={`badge-export-${u.uid}`} style={{ width: `${badgeConfig.imgWidth}px`, height: `${badgeConfig.imgHeight}px`, position: 'relative', overflow: 'hidden', backgroundColor: 'white' }}>
                                    {badgeConfig.bgImage && <img src={badgeConfig.bgImage} className="absolute inset-0 w-full h-full object-cover" />}
                                    {badgeConfig.layers && badgeConfig.layers.map((layer, idx) => {
                                        const commonStyle = { position: 'absolute', top: `${layer.y}%`, left: `${layer.x}%`, transform: 'translate(-50%, -50%)', zIndex: idx, width: layer.width === 'auto' ? 'auto' : `${layer.width}px`, textAlign: layer.align || 'center' };
                                        if (layer.type === 'qr') return <div key={layer.id} style={{ ...commonStyle, width: `${layer.size}px`, height: `${layer.size}px`, display: 'flex', alignItems: 'center', justifyContent: 'center' }}><QRCodeCanvas text={BASE_URL + u.uid} size={layer.size} transparent={true} /></div>;
                                        else if (layer.type === 'text') {
                                            let content = layer.content;
                                            if (layer.variable) { if (layer.variable === 'name') content = u.name; else if (layer.variable === 'org') content = u.org; else if (layer.variable === 'role') content = u.options && (u.options['ì§ì±…'] || u.options['Role'] || '-'); else if (layer.variable === 'id') content = u.uid; }
                                            return <div key={layer.id} className={layer.fontFamily} style={{ ...commonStyle, fontSize: `${layer.fontSize}px`, color: layer.color, fontWeight: layer.fontWeight || 'bold', backgroundColor: layer.bgColor || 'transparent', padding: `${layer.padding || 0}px`, borderRadius: `${layer.borderRadius || 0}px`, textShadow: layer.shadow ? '2px 2px 4px rgba(0,0,0,0.5)' : 'none', whiteSpace: 'nowrap', fontFamily: layer.fontFamily }}>{content}</div>;
                                        } 
                                        return null;
                                    })}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [users, setUsers] = useState([]);
            const [schedules, setSchedules] = useState([]);
            const [logs, setLogs] = useState([]);
            const [changeLogs, setChangeLogs] = useState([]);
            
            // Firebase DB state
            const [db, setDb] = useState(null);

            // ì•± ì „ì²´ ë°°ê²½í™”ë©´ ìƒíƒœ (ê¸°ê¸°ë³„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìœ ì§€)
            const [appBgImage, setAppBgImage] = useState(() => localStorage.getItem('incar_pro_app_bg') || null);

            // ì°¨ëŸ‰ ëª©ë¡ ê´€ë¦¬ìš© ìƒíƒœ (ê¸°ê¸°ë³„ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìœ ì§€)
            const [busList, setBusList] = useState(() => {
                const saved = localStorage.getItem('incar_pro_bus_list');
                return saved ? JSON.parse(saved) : ['1í˜¸ì°¨', '2í˜¸ì°¨', '3í˜¸ì°¨'];
            });

            useEffect(() => { localStorage.setItem('incar_pro_bus_list', JSON.stringify(busList)); }, [busList]);
            useEffect(() => { if (appBgImage) localStorage.setItem('incar_pro_app_bg', appBgImage); else localStorage.removeItem('incar_pro_app_bg'); }, [appBgImage]);

            const scheduleStats = useMemo(() => {
                return schedules.map(s => {
                    let targetCount = 0;
                    if(s.targetKey === 'ALL') targetCount = users.length;
                    else targetCount = users.filter(u => u.options && u.options[s.targetKey] && u.options[s.targetKey].includes(s.targetVal)).length;
                    
                    const doneCount = logs.filter(l => {
                        if (l.sessionId !== s.id) return false;
                        const currentUser = users.find(u => String(u.uid) === String(l.uid));
                        if (!currentUser) return false; 
                        if (s.targetKey === 'ALL') return true;
                        const userOpt = currentUser.options?.[s.targetKey];
                        if (!userOpt) return false;
                        return s.targetVal === 'ALL' || userOpt.includes(s.targetVal);
                    }).length;

                    const percent = targetCount > 0 ? Math.round((doneCount / targetCount) * 100) : 0;
                    const expectedAmount = targetCount * (s.price || 0);
                    const actualAmount = logs.filter(l => {
                        if (l.sessionId !== s.id) return false;
                        const currentUser = users.find(u => String(u.uid) === String(l.uid));
                        if (!currentUser) return false;
                        if (s.targetKey === 'ALL') return true;
                        const userOpt = currentUser.options?.[s.targetKey];
                        if (!userOpt) return false;
                        return s.targetVal === 'ALL' || userOpt.includes(s.targetVal);
                    }).reduce((sum, l) => sum + (l.finalAmount || 0), 0);

                    const diffCount = doneCount - targetCount;
                    const diffAmount = actualAmount - expectedAmount;
                    return { ...s, targetCount, doneCount, percent, expectedAmount, actualAmount, diffCount, diffAmount };
                });
            }, [schedules, users, logs]);

            const groupedStats = useMemo(() => {
                const groups = {};
                scheduleStats.forEach(stat => {
                    const date = stat.displayDate || 'ê¸°íƒ€';
                    if(!groups[date]) groups[date] = [];
                    groups[date].push(stat);
                });
                return groups;
            }, [scheduleStats]);

            const [isPrintMode, setIsPrintMode] = useState(false);
            const [badgeConfig, setBadgeConfig] = useState({
                bgImage: null, imgWidth: 545, imgHeight: 697,
                layers: [
                    { id: 'qr', type: 'qr', x: 50, y: 20, size: 100 },
                    { id: 'org', type: 'text', content: 'ì†Œì† (Org)', variable: 'org', x: 50, y: 40, fontSize: 20, fontFamily: "'Noto Sans KR', sans-serif", color: '#475569', align: 'center', width: 'auto' },
                    { id: 'name', type: 'text', content: 'ì„± ëª… (Name)', variable: 'name', x: 50, y: 65, fontSize: 40, fontFamily: "'Noto Sans KR', sans-serif", color: '#000000', align: 'center', width: 'auto' },
                    { id: 'role', type: 'text', content: 'ì§ì±… (Role)', variable: 'role', x: 50, y: 50, fontSize: 18, fontFamily: "'Noto Sans KR', sans-serif", color: '#000000', align: 'center', width: 'auto' }
                ]
            });

            const [isLoading, setIsLoading] = useState(true);
            const [scanResult, setScanResult] = useState(null);
            const [selectedSession, setSelectedSession] = useState(null);
            const [isScanning, setIsScanning] = useState(false);
            const [targetSessionId, setTargetSessionId] = useState('');
            const [targetBus, setTargetBus] = useState('1í˜¸ì°¨');
            const [manualBus, setManualBus] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [selectedUser, setSelectedUser] = useState(null);
            const [editForm, setEditForm] = useState({ optKey: '', optVal: '', penalty: 0, reason: '' });
            const [refundRequest, setRefundRequest] = useState(null);
            const [forfeitRequest, setForfeitRequest] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                let unsubU, unsubS, unsubL, unsubC;

                const initFirebase = async () => {
                    try {
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        const _db = firebase.firestore();
                        await firebase.auth().signInAnonymously();
                        setDb(_db);

                        // ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                        unsubU = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').onSnapshot(snap => {
                            setUsers(snap.docs.map(d => d.data()));
                        });
                        unsubS = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').onSnapshot(snap => {
                            const list = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>a.date>b.date?1:-1);
                            setSchedules(list);
                            if (list.length > 0) setTargetSessionId(prev => prev || list[0].id);
                        });
                        unsubL = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').orderBy('timestamp','desc').onSnapshot(snap => {
                            setLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });
                        unsubC = _db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').orderBy('timestamp','desc').onSnapshot(snap => {
                            setChangeLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                        });

                        setIsLoading(false);
                    } catch (e) {
                        console.error("Firebase init fail:", e);
                        alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
                        setIsLoading(false);
                    }
                };

                initFirebase();

                const loadedBadgeConfig = JSON.parse(localStorage.getItem('incar_pro_badge_config_v2_9') || 'null');
                if(loadedBadgeConfig && loadedBadgeConfig.layers) setBadgeConfig(loadedBadgeConfig);

                return () => {
                    if (unsubU) unsubU(); if (unsubS) unsubS(); if (unsubL) unsubL(); if (unsubC) unsubC();
                };
            }, []);

            useEffect(() => { localStorage.setItem('incar_pro_badge_config_v2_9', JSON.stringify(badgeConfig)); }, [badgeConfig]);

            const cleanupOldLogs = async (uid, targetKey, oldVal) => {
                const relatedSessions = schedules.filter(s => s.targetKey === targetKey);
                const logsToDelete = logs.filter(l => l.uid === uid && relatedSessions.some(s => s.id === l.sessionId));
                const oldLogIds = logsToDelete.map(l => l.id);
                
                if (db && oldLogIds.length > 0) {
                    const batch = db.batch();
                    oldLogIds.forEach(id => {
                        const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').doc(id);
                        batch.delete(ref);
                    });
                    await batch.commit();
                }
                return oldLogIds;
            };

            const handleManualComplete = async (user, session) => {
                if(!confirm(`${user.name}ë‹˜ì„ ìˆ˜ë™ìœ¼ë¡œ [${session.type==='PAYMENT'?'ì§€ê¸‰ì™„ë£Œ':'íƒ‘ìŠ¹ì™„ë£Œ'}] ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const timeStr = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
                
                // GAS ì „ì†¡ (ì¤‘ì‹ë¹„ í…ìŠ¤íŠ¸ ì œê±°)
                const gasTourName = session.type === 'PAYMENT' ? session.title.replace(/\s*ì¤‘ì‹ë¹„/g, '').trim() : session.title;
                if (session.type === 'PAYMENT') {
                    sendToGAS({ type: 'meal', id: user.uid, name: user.name, tour: gasTourName, action: 'APPROVE', time: timeStr });
                } else {
                    sendToGAS({ type: 'departure', id: user.uid, name: user.name, category: 'ìˆ˜ë™ì²˜ë¦¬', course: session.title, time: timeStr });
                }

                if (db) {
                    const newLog = { timestamp: timeStr, uid: user.uid, name: user.name, org: user.org, action: session.type === 'PAYMENT' ? 'ì§€ê¸‰' : 'íƒ‘ìŠ¹', sessionId: session.id, sessionTitle: session.title, bus: 'ìˆ˜ë™ì²˜ë¦¬', amount: session.type === 'PAYMENT' ? session.price : 0, penaltyApplied: 0, finalAmount: session.type === 'PAYMENT' ? session.price : 0 };
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                }
                alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const executeUpdate = async (user, session, requiredChoice, penaltyAmount, reason, payoutOverride = null) => {
                const oldVal = user.options[session.targetKey];
                const logIdsToRemove = await cleanupOldLogs(user.uid, session.targetKey, oldVal);
                const newPenalty = penaltyAmount;
                const timeStr = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

                let finalAmount = 0; 
                let penaltyApplied = 0;

                if (session.type === 'PAYMENT') { 
                    if (payoutOverride !== null) { 
                        finalAmount = payoutOverride; 
                        penaltyApplied = 0; 
                    } else { 
                        const baseAmount = session.price; 
                        const deduction = (user.penaltyTotal || 0) + newPenalty; 
                        finalAmount = Math.max(0, baseAmount - deduction); 
                        penaltyApplied = (baseAmount - finalAmount); 
                    } 
                }

                // GAS ì „ì†¡ (ì¤‘ì‹ë¹„ í…ìŠ¤íŠ¸ ì œê±°)
                const gasTourName = session.type === 'PAYMENT' ? session.title.replace(/\s*ì¤‘ì‹ë¹„/g, '').trim() : session.title;
                if (session.type === 'PAYMENT') {
                    sendToGAS({ type: 'meal', id: user.uid, name: user.name, tour: gasTourName, action: 'APPROVE', time: timeStr });
                } else {
                    sendToGAS({ type: 'departure', id: user.uid, name: user.name, category: 'í˜„ì¥ë³€ê²½', course: session.title, time: timeStr });
                }

                if (db) {
                    const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(user.uid));
                    const updatedOptions = { ...user.options, [session.targetKey]: requiredChoice };
                    
                    const batch = db.batch();
                    batch.update(userRef, { options: updatedOptions, penaltyTotal: (user.penaltyTotal || 0) + newPenalty - penaltyApplied });
                    
                    const changeRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').doc();
                    batch.set(changeRef, { timestamp: timeStr, uid: user.uid, name: user.name, targetOption: session.targetKey, oldVal: oldVal || 'ë¯¸ì„ íƒ', newVal: requiredChoice, penalty: newPenalty, reason: reason });
                    
                    const logRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').doc();
                    batch.set(logRef, { timestamp: timeStr, uid: user.uid, name: user.name, org: user.org, action: session.type === 'PAYMENT' ? 'ì§€ê¸‰' : 'íƒ‘ìŠ¹', sessionId: session.id, sessionTitle: session.title, bus: targetBus, amount: session.type === 'PAYMENT' ? session.price : 0, penaltyApplied: penaltyApplied, finalAmount: finalAmount });
                    
                    await batch.commit();
                }

                setScanResult(null); setRefundRequest(null); setForfeitRequest(null);
                
                let alertMsg = `${user.name}ë‹˜ì˜ ì¼ì •ì´ [${requiredChoice}]ë¡œ ë³€ê²½ë˜ê³  ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`; 
                if(penaltyAmount > 0) alertMsg += `\n\nâš ï¸ ë¯¸ë°˜í™˜ ì²˜ë¦¬: ${CURRENCY}${penaltyAmount}ê°€ íŒ¨ë„í‹°ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`; 
                else if (reason.includes('ë°˜í™˜')) alertMsg += `\n\nâœ… ë°˜í™˜ í™•ì¸: ê¸°ì¡´ ì§€ê¸‰ì•¡ì´ ì •ìƒì ìœ¼ë¡œ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.`; 
                else if (payoutOverride === 0) alertMsg += `\n\nâ„¹ï¸ ì§€ê¸‰ ë³´ë¥˜: ê¸°ì¡´ ì¼ì • ë¹„ìš©ì„ ê³ ë ¤í•˜ì—¬ ì´ë²ˆ ì§€ê¸‰ì€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.`; 
                
                alert(alertMsg);
            };

            const handleForceUpdateAndProcess = async (user, session, requiredChoice) => {
                const oldVal = user.options[session.targetKey];
                const oldPaymentSchedules = schedules.filter(s => s.targetKey === session.targetKey && s.targetVal === oldVal && s.type === 'PAYMENT');
                const oldPaymentLogs = logs.filter(l => l.uid === user.uid && oldPaymentSchedules.some(s => s.id === l.sessionId));
                const recoupAmount = oldPaymentLogs.reduce((sum, l) => sum + (l.finalAmount || 0), 0);
                
                if (recoupAmount > 0) { 
                    setScanResult(null); setRefundRequest({ user, session, requiredChoice, amount: recoupAmount, oldVal }); 
                    return; 
                } 
                
                const oldBoardingSchedules = schedules.filter(s => s.targetKey === session.targetKey && s.targetVal === oldVal && s.type === 'BOARDING');
                const isFromTour = oldBoardingSchedules.length > 0;
                const isToPayment = session.type === 'PAYMENT' && session.price > 0;
                
                if (isFromTour && isToPayment) { 
                    setScanResult(null); setForfeitRequest({ user, session, requiredChoice, oldVal, price: session.price }); 
                    return; 
                }
                await executeUpdate(user, session, requiredChoice, 0, 'í˜„ì¥ ìŠ¤ìº” ì‹œ ì¦‰ì‹œ ë³€ê²½');
            };

            const resolveRefundRequest = async (isReturned) => { 
                if (!refundRequest) return; 
                const { user, session, requiredChoice, amount } = refundRequest; 
                if (isReturned) await executeUpdate(user, session, requiredChoice, 0, `í˜„ì¥ ë³€ê²½ (ê¸°ì¡´ ì§€ê¸‰ì•¡ ${CURRENCY}${amount} í˜„ì¥ ë°˜í™˜)`); 
                else await executeUpdate(user, session, requiredChoice, amount, `í˜„ì¥ ë³€ê²½ (ê¸°ì¡´ ì§€ê¸‰ì•¡ ${CURRENCY}${amount} ë¯¸ë°˜í™˜/íŒ¨ë„í‹°)`); 
            };

            const resolveForfeitRequest = async (shouldPay) => { 
                if (!forfeitRequest) return; 
                const { user, session, requiredChoice, oldVal } = forfeitRequest; 
                if (shouldPay) await executeUpdate(user, session, requiredChoice, 0, 'í˜„ì¥ ë³€ê²½ (ê´€ê´‘->ì§€ê¸‰, ìœ„ì•½ê¸ˆ ë©´ì œ ë° ì •ìƒì§€ê¸‰)'); 
                else await executeUpdate(user, session, requiredChoice, 0, `í˜„ì¥ ë³€ê²½ (ê´€ê´‘->ì§€ê¸‰, ì˜ˆì•½ë¶€ë„ ìœ„ì•½ê¸ˆ ì ìš©ìœ¼ë¡œ ì§€ê¸‰ìƒëµ)`, 0); 
            };

            const processScan = async (scannedText, strictMode = false) => { 
                const scannedUid = extractEid(scannedText); // URL í˜•íƒœì—ì„œë„ ì‚¬ë²ˆ íŒŒì‹±
                
                const user = users.find(u => String(u.uid).trim() === String(scannedUid).trim()); 
                if (!user) return setScanResult({ status: 'error', msg: 'ë¯¸ë“±ë¡ ì°¸ê°€ì', subMsg: `ID: ${scannedUid}` }); 
                
                const session = schedules.find(s => s.id === targetSessionId); 
                if (!session) return setScanResult({ status: 'error', msg: 'ì„¸ì…˜ ë¯¸ì„ íƒ', subMsg: 'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”' }); 

                if (strictMode && session.type === 'BOARDING') {
                    if (user.bus && user.bus.trim() !== targetBus.trim()) {
                         return setScanResult({ status: 'error', msg: 'íƒ‘ìŠ¹ ë¶ˆê°€ (ì°¨ëŸ‰ ë¶ˆì¼ì¹˜)', subMsg: `ë°°ì •: ${user.bus} / í˜„ì¬: ${targetBus}`, user });
                    }
                }
                
                const isDuplicate = logs.some(l => String(l.uid) === String(user.uid) && l.sessionId === session.id); 
                if (isDuplicate) return setScanResult({ status: 'duplicate', msg: 'ì´ë¯¸ ì²˜ë¦¬ë¨', subMsg: `${session.displayDate} - ${session.title}`, user }); 
                
                if (session.targetKey !== 'ALL') { 
                    const userChoice = user.options[session.targetKey]; 
                    const requiredChoice = session.targetVal; 
                    if (!userChoice || (requiredChoice !== 'ALL' && !userChoice.includes(requiredChoice))) { 
                        return setScanResult({ status: 'error', msg: 'ëŒ€ìƒì ì•„ë‹˜', subMsg: `í•„ìš”: ${requiredChoice} / ë³¸ì¸: ${userChoice || 'ì„ íƒì—†ìŒ'}`, user, requiredChoice, session }); 
                    } 
                } 
                
                let finalAmount = 0; let penaltyApplied = 0; 
                
                if (session.type === 'PAYMENT') { 
                    const baseAmount = session.price; 
                    const deduction = user.penaltyTotal || 0; 
                    finalAmount = Math.max(0, baseAmount - deduction); 
                    penaltyApplied = (baseAmount - finalAmount); 
                } 

                const timeStr = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
                
                // âœ… êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë°±ê·¸ë¼ìš´ë“œ ì „ì†¡ (ì¤‘ì‹ë¹„ í…ìŠ¤íŠ¸ ì œê±°)
                const gasTourName = session.type === 'PAYMENT' ? session.title.replace(/\s*ì¤‘ì‹ë¹„/g, '').trim() : session.title;
                if (session.type === 'PAYMENT') {
                    sendToGAS({ type: 'meal', id: user.uid, name: user.name, tour: gasTourName, action: 'APPROVE', time: timeStr });
                } else {
                    sendToGAS({ type: 'departure', id: user.uid, name: user.name, category: 'í˜„ì¥ìŠ¤ìº”', course: session.title, time: timeStr });
                }
                
                const newLog = { timestamp: timeStr, uid: user.uid, name: user.name, org: user.org, action: session.type === 'PAYMENT' ? 'ì§€ê¸‰' : 'íƒ‘ìŠ¹', sessionId: session.id, sessionTitle: session.title, bus: session.type === 'BOARDING' ? targetBus : '-', amount: session.type === 'PAYMENT' ? session.price : 0, penaltyApplied: penaltyApplied, finalAmount: finalAmount }; 
                
                if (db) {
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('logs').add(newLog);
                    if (penaltyApplied > 0) {
                        await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(user.uid)).update({
                            penaltyTotal: user.penaltyTotal - penaltyApplied
                        });
                    }
                }
                
                const todayLogs = logs.filter(l => l.uid === user.uid && l.timestamp.slice(0, 10) === timeStr.slice(0, 10) && l.action === 'ì§€ê¸‰'); 
                setScanResult({ status: 'success', msg: session.type==='PAYMENT'?'ì§€ê¸‰ ì™„ë£Œ':'íƒ‘ìŠ¹ í™•ì¸', subMsg: session.title, user, logs: newLog, relatedLogs: todayLogs }); 
            };

            const handleUserUpdate = async () => { 
                if (!selectedUser || !editForm.optKey) return; 
                const oldVal = selectedUser.options[editForm.optKey]; 
                await cleanupOldLogs(selectedUser.uid, editForm.optKey, oldVal); 
                const newPenalty = parseInt(editForm.penalty || 0); 
                const timeStr = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
                
                if (db) {
                    const userRef = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(selectedUser.uid)); 
                    const updatedOptions = { ...selectedUser.options, [editForm.optKey]: editForm.optVal }; 
                    await userRef.update({ options: updatedOptions, penaltyTotal: (selectedUser.penaltyTotal || 0) + newPenalty }); 
                    
                    await db.collection('artifacts').doc(SYSTEM_APP_ID).collection('changelogs').add({
                        timestamp: timeStr, uid: selectedUser.uid, name: selectedUser.name, targetOption: editForm.optKey, oldVal: oldVal, newVal: editForm.optVal, penalty: newPenalty, reason: editForm.reason
                    }); 
                }

                alert("ë³€ê²½ ë° íŒ¨ë„í‹° ì ìš©ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
                setEditForm({ optKey: '', optVal: '', penalty: 0, reason: '' }); 
                setSearchQuery(''); 
            };

            const handleUserUpload = async (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                Papa.parse(file, { 
                    header: true, skipEmptyLines: true, 
                    complete: async (results) => { 
                        const parsed = results.data.map(row => { 
                            const rawUid = row['ì‚¬ë²ˆ'] || row['ID'] || row['uid'] || Object.values(row)[0]; 
                            let cleanUid = String(rawUid).replace(/\s/g, ''); // âœ… ë„ì–´ì“°ê¸° ì™„ë²½ ì œê±°
                            if(cleanUid.endsWith('.0')) cleanUid = cleanUid.slice(0, -2); // âœ… ì—‘ì…€ ì†Œìˆ˜ì  ì˜¤ë¥˜(.0) ì™„ë²½ ì œê±°

                            const name = row['ì„±ëª…'] || row['ì´ë¦„'] || row['Name'] || Object.values(row)[1]; 
                            const org = row['ì†Œì†'] || row['ë¶€ì„œ'] || row['Org'] || '-'; 
                            const bus = row['ë²„ìŠ¤'] || row['íƒ‘ìŠ¹ë²„ìŠ¤'] || row['Bus'] || 'ë¯¸ì •'; 
                            const options = {}; 
                            Object.keys(row).forEach(key => { 
                                if(!['ì‚¬ë²ˆ','ID','uid','ì„±ëª…','ì´ë¦„','Name','ì†Œì†','ë¶€ì„œ','Org','ë²„ìŠ¤','íƒ‘ìŠ¹ë²„ìŠ¤','Bus'].includes(key)) { 
                                    if(row[key]) options[key] = row[key]; 
                                } 
                            }); 
                            return { uid: cleanUid, name, org, bus, options, penaltyTotal: 0 }; 
                        }).filter(u => u.uid); 
                        
                        if(confirm(`${parsed.length}ëª…ì˜ ëª…ë‹¨ì„ ì„œë²„ì— ì„¸íŒ…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
                            if (db) {
                                const batch = db.batch();
                                parsed.forEach(u => {
                                    const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('users').doc(String(u.uid));
                                    batch.set(ref, u);
                                });
                                await batch.commit();
                                alert("ì„œë²„ ì—…ë¡œë“œ ì™„ë£Œ! ëª¨ë“  ê¸°ê¸°ì— 100% ë™ê¸°í™”ë©ë‹ˆë‹¤.");
                            } else {
                                alert("ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                            }
                        } 
                    } 
                }); 
            };

            const handleScheduleUpload = async (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                Papa.parse(file, { 
                    header: true, skipEmptyLines: true, 
                    complete: async (results) => { 
                        const parsed = results.data.map((row, idx) => { 
                            const rawDate = row['ì¼ì •'] || row['Date'] || `Day ${idx+1}`; 
                            const today = new Date(); const dateObj = new Date(today); 
                            if(rawDate.includes('1ì¼')) dateObj.setDate(today.getDate()); 
                            else if(rawDate.includes('2ì¼')) dateObj.setDate(today.getDate()+1); 
                            else if(rawDate.includes('3ì¼')) dateObj.setDate(today.getDate()+2); 
                            else if(rawDate.includes('4ì¼')) dateObj.setDate(today.getDate()+3); 
                            const dateStr = dateObj.toISOString().split('T')[0]; 
                            let rawPrice = row['ì§€ê¸‰'] || row['Price'] || '0'; 
                            if (typeof rawPrice === 'string') rawPrice = rawPrice.replace(/[$,\s]/g, ''); 
                            const price = parseInt(rawPrice) || 0; 
                            let type = 'BOARDING'; 
                            if (price > 0) type = 'PAYMENT'; 
                            else if (row['íƒ€ì…'] && (row['íƒ€ì…'].includes('ì§€ê¸‰') || row['íƒ€ì…'].includes('Payment'))) type = 'PAYMENT'; 
                            return { 
                                id: `SCHED_${idx}`, date: dateStr, displayDate: rawDate, 
                                title: row['ì¥ì†Œ'] || row['Title'] || 'ì¼ì •', type: type, price: price, 
                                targetKey: row['íƒ€ê²Ÿì˜µì…˜'] || row['OptionKey'] || 'ALL', targetVal: row['íƒ€ê²Ÿê°’'] || row['OptionVal'] || 'ALL' 
                            }; 
                        }); 
                        
                        if(confirm(`${parsed.length}ê°œì˜ ìŠ¤ì¼€ì¤„ì„ ì„œë²„ì— ì„¸íŒ…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { 
                            if (db) {
                                const batch = db.batch();
                                parsed.forEach(s => {
                                    const ref = db.collection('artifacts').doc(SYSTEM_APP_ID).collection('schedules').doc(String(s.id));
                                    batch.set(ref, s);
                                });
                                await batch.commit();
                                alert("ìŠ¤ì¼€ì¤„ ì„œë²„ ì—…ë¡œë“œ ì™„ë£Œ! ëª¨ë“  ê¸°ê¸°ì— 100% ë™ê¸°í™”ë©ë‹ˆë‹¤.");
                            } else {
                                alert("ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                            }
                        } 
                    } 
                }); 
            };

            const handleAppBgUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            let width = img.width, height = img.height;
                            const MAX = 1920; 
                            if (width > height && width > MAX) { height *= MAX / width; width = MAX; } 
                            else if (height > MAX) { width *= MAX / height; height = MAX; }
                            canvas.width = width; canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                            setAppBgImage(dataUrl);
                        };
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            if (isLoading) return <div className="h-screen w-screen flex items-center justify-center font-bold text-incar">ì‹œìŠ¤í…œ ë¡œë”©ì¤‘...</div>;

            return (
                <div className={`h-full flex flex-row w-full relative ${appBgImage ? 'bg-cover bg-center bg-no-repeat bg-fixed' : 'bg-slate-50'}`} style={appBgImage ? {backgroundImage: `url(${appBgImage})`} : {}}>
                    {appBgImage && <div className="absolute inset-0 z-0 bg-slate-900/40 backdrop-blur-[2px] pointer-events-none"></div>}

                    <div className="z-10 h-full hidden md:block">
                        <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    </div>
                    
                    <main className="flex-1 flex flex-col h-full overflow-hidden relative w-full z-10">
                        { isMobile && (
                            <header className={`${appBgImage ? 'bg-white/90 backdrop-blur-md' : 'bg-white'} px-6 py-4 shadow-sm flex justify-between items-center z-20 no-print`}>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-incar rounded-lg flex items-center justify-center text-white font-black">P</div>
                                    <h1 className="font-black text-slate-800 tracking-tight">ISC ê´€ë¦¬ì</h1>
                                </div>
                                <div className="text-xs font-bold text-slate-400">{users.length}ëª…</div>
                            </header>
                        )}
                        
                        <div className="flex-1 overflow-y-auto p-4 pb-32 md:p-8 md:pb-8 w-full no-print-scroll relative z-10">
                            <div className="max-w-5xl mx-auto w-full">
                                {activeTab === 'dashboard' && <DashboardView users={users} logs={logs} scheduleStats={scheduleStats} groupedStats={groupedStats} changeLogs={changeLogs} onSessionClick={setSelectedSession} />}
                                {activeTab === 'boarding' && <ScanView mode="BOARDING" schedules={schedules} targetSessionId={targetSessionId} setTargetSessionId={setTargetSessionId} targetBus={targetBus} setTargetBus={setTargetBus} manualBus={manualBus} setManualBus={setManualBus} isScanning={isScanning} setIsScanning={setIsScanning} processScan={processScan} users={users} isMobile={isMobile} busList={busList} setBusList={setBusList} />}
                                {activeTab === 'payment' && <ScanView mode="PAYMENT" schedules={schedules} targetSessionId={targetSessionId} setTargetSessionId={setTargetSessionId} targetBus={targetBus} setTargetBus={setTargetBus} manualBus={manualBus} setManualBus={setManualBus} isScanning={isScanning} setIsScanning={setIsScanning} processScan={processScan} users={users} isMobile={isMobile} busList={busList} setBusList={setBusList} />}
                                {activeTab === 'change' && <ChangeView searchQuery={searchQuery} setSearchQuery={setSearchQuery} selectedUser={selectedUser} setSelectedUser={setSelectedUser} editForm={editForm} setEditForm={setEditForm} handleUserUpdate={handleUserUpdate} users={users} schedules={schedules} changeLogs={changeLogs} />}
                                {activeTab === 'manage' && <ManageView users={users} handleUserUpload={handleUserUpload} handleScheduleUpload={handleScheduleUpload} badgeConfig={badgeConfig} setBadgeConfig={setBadgeConfig} db={db} schedules={schedules} logs={logs} setIsPrintMode={setIsPrintMode} setUsers={setUsers} setSchedules={setSchedules} setLogs={setLogs} setChangeLogs={setChangeLogs} changeLogs={changeLogs} appBgImage={appBgImage} setAppBgImage={setAppBgImage} handleAppBgUpload={handleAppBgUpload} />} 
                            </div>
                        </div>

                        { isMobile && <MobileTab activeTab={activeTab} setActiveTab={setActiveTab} /> }
                        
                        {isPrintMode && <BadgePrintView users={users} config={badgeConfig} onClose={() => setIsPrintMode(false)} />}
                        {selectedSession && <SessionDetailModal session={selectedSession} users={users} logs={logs} onClose={() => setSelectedSession(null)} onManualComplete={handleManualComplete} />}
                        {refundRequest && (<div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm animate-fade-in no-print"><div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-slide-up"><div className="bg-rose-50 p-6 text-center border-b border-rose-100"><div className="w-16 h-16 bg-white text-rose-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-2xl font-bold">$</div><h3 className="text-xl font-black text-rose-600 mb-1">ì§€ê¸‰ê¸ˆ ë°˜í™˜ í•„ìš”</h3><p className="text-slate-600 font-bold text-sm">{refundRequest.user.name}ë‹˜ì€<br/>ì´ë¯¸ <span className="text-rose-600 underline">{CURRENCY}{refundRequest.amount}</span>ì„ ì§€ê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤.</p></div><div className="p-6 space-y-4"><div className="text-center text-xs text-slate-400 mb-2">ê¸°ì¡´ ì¼ì •: {refundRequest.oldVal} <br/>â–¼ <br/>ë³€ê²½ ì¼ì •: {refundRequest.session.title}</div><button onClick={() => resolveRefundRequest(true)} className="w-full py-4 bg-emerald-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1"><span>ë°˜í™˜ ë°›ì•˜ìŠµë‹ˆë‹¤</span><span className="text-[10px] opacity-80 font-normal">(íŒ¨ë„í‹° ì—†ìŒ)</span></button><button onClick={() => resolveRefundRequest(false)} className="w-full py-4 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1"><span>ë°˜í™˜ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</span><span className="text-[10px] opacity-80 font-normal">(ë¯¸ë°˜í™˜ê¸ˆ íŒ¨ë„í‹° ì²˜ë¦¬)</span></button><button onClick={() => setRefundRequest(null)} className="w-full py-3 text-slate-400 font-bold text-sm hover:bg-slate-50 rounded-xl">ì·¨ì†Œ</button></div></div></div>)}
                        {forfeitRequest && (<div className="fixed inset-0 z-[300] flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm animate-fade-in no-print"><div className="bg-white w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-slide-up"><div className="bg-indigo-50 p-6 text-center border-b border-indigo-100"><div className="w-16 h-16 bg-white text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm text-2xl font-bold">?</div><h3 className="text-xl font-black text-indigo-900 mb-1">ì¼ì • ë³€ê²½ í™•ì¸ (Case 2)</h3><p className="text-slate-600 font-bold text-sm">ì˜ˆì•½ëœ ê´€ê´‘ ì½”ìŠ¤ë¥¼ ì·¨ì†Œí•˜ê³ <br/>í˜„ê¸ˆ ì§€ê¸‰ ì¼ì •ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</p></div><div className="p-6 space-y-4"><div className="text-center text-xs text-slate-400 mb-2">ê¸°ì¡´: {forfeitRequest.oldVal} (ì˜ˆì•½ì·¨ì†Œ)<br/>â–¼ <br/>ë³€ê²½: {forfeitRequest.session.title} (ì§€ê¸‰ {CURRENCY}{forfeitRequest.price})</div><button onClick={() => resolveForfeitRequest(false)} className="w-full py-4 bg-rose-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1"><span>ë¶€ì§€ê¸‰ (ìœ„ì•½ê¸ˆ ì ìš©)</span><span className="text-[10px] opacity-80 font-normal">(ì˜ˆì•½ ë¹„ìš© íŒ¨ë„í‹°ë¡œ ìƒê³„ ì²˜ë¦¬)</span></button><button onClick={() => resolveForfeitRequest(true)} className="w-full py-4 bg-slate-800 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex flex-col items-center justify-center leading-none gap-1"><span>ì •ìƒ ì§€ê¸‰</span><span className="text-[10px] opacity-80 font-normal">({CURRENCY}{forfeitRequest.price} ì§€ê¸‰ ìŠ¹ì¸)</span></button><button onClick={() => setForfeitRequest(null)} className="w-full py-3 text-slate-400 font-bold text-sm hover:bg-slate-50 rounded-xl">ì·¨ì†Œ</button></div></div></div>)}
                    </main>
                    
                    <ResultModal result={scanResult} onClose={() => setScanResult(null)} onForceUpdate={handleForceUpdateAndProcess} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
