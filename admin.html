<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì</title>

  <!-- ê³ ê°ìš©ê³¼ ë™ì¼ CSS -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width:768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width:767px)">

  <style>
    /* =========================
       âœ… ê³µí†µ: QR ëª¨ë“œì—ì„œë§Œ ìŠ¤í¬ë¡¤ ì ê¸ˆ
       ========================= */
    body.qr-lock { overflow:hidden !important; overscroll-behavior:none; }

    /* =========================
       âœ… QR íŒ¨ë„
       ========================= */
    #qrReader{
      width:100%;
      max-width:420px;
      background:#000;
      border-radius:12px;
      overflow:hidden;
    }
    #qrReader video, #qrReader canvas{
      width:100% !important;
      height:100% !important;
      object-fit:cover;
    }

    .qr-panel{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }

    .manual-row{
      width:100%;
      max-width:420px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .manual-row input{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #d0d5dd;
      background:#fff;
    }

    .qr-result{
      width:100%;
      max-width:420px;
      padding:10px 12px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      text-align:center;
      font-weight:700;
      box-sizing:border-box;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .qr-result.success{ color:#16a34a; }
    .qr-result.fail{ color:#dc2626; }

    /* ê³ ê°ì •ë³´ ì¹´ë“œ */
    .info-card{
      width:100%;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      box-sizing:border-box;
    }
    .info-row{ font-size:14px; margin-bottom:8px; }
    .info-label{ color:#6b7280; font-size:12px; margin-bottom:2px; }

    /* ì—¬í–‰/ì¤‘ì‹ë¹„ ë¦¬ìŠ¤íŠ¸ ë²„íŠ¼ ë¬¶ìŒ */
    .admin-sub-buttons{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:12px;
    }
    .admin-clickable{ cursor:pointer; user-select:none; }

    /* âœ… ëª¨ë°”ì¼ì—ì„œë„ 1ì°¨ ì¹´í…Œê³ ë¦¬(ì‚¬ì´ë“œ ë©”ë‰´) ìˆ¨ê¸°ì§€ ì•ŠìŒ */
    /* (openPageì—ì„œ side-menu ìˆ¨ê¸°ëŠ” ë¡œì§ ì—†ìŒ) */
  </style>
</head>

<body>

<!-- ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= -->
<section id="adminLoginSection" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>ISC ê´€ë¦¬ì</h2>
      <p class="hero-desc">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</p>
      <input type="password" id="adminPw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
      <button class="primary-btn" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      <p id="loginError" class="error"></p>
    </div>
  </div>
</section>

<header class="header compact" id="topHeader" style="display:none;">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì</h1>
      <p class="sub">ê´€ë¦¬ì ëª¨ë“œ</p>
    </div>
  </div>
</header>

<main id="mainSection" class="main-bg" style="display:none;">
  <div class="layout">

    <aside class="side-menu">
      <button onclick="openPage('travelRoot')">ğŸ§­ ì—¬í–‰ì¼ì •ê´€ë¦¬</button>
      <button onclick="openPage('mealRoot')">ğŸ’³ ì¤‘ì‹ë¹„ì§€ê¸‰ê´€ë¦¬</button>
      <button onclick="openPage('customerRoot')">ğŸ‘¤ ê³ ê°ê´€ë¦¬</button>
    </aside>

    <section class="content-area">
      <div class="main-panel">

        <section id="detailPage" class="detail" style="display:none;">
          <h2 id="detailTitle"></h2>
          <div id="detailContent"></div>

          <div class="nav-buttons">
            <button class="ghost-btn" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
            <button class="ghost-btn" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
          </div>
        </section>

      </div>

      <aside class="fixed-poster">
        <img src="assets/images/iscposter.jpg" alt="ISC Poster">
      </aside>
    </section>
  </div>
</main>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ================= ì„¤ì • ================= */
/* âœ… ê³ ê°ìš© ì‚¬ì´íŠ¸ì—ì„œ ì“°ëŠ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ì™€ ë°˜ë“œì‹œ ë™ì¼ */
const ADMIN_PASSWORD = "0000";

/* âœ… GAS */
const GAS_URL = "https://script.google.com/macros/s/AKfycbywujbffRaXimjgXIjZkeyLv0kea2tDe17jtBmMvLjs6gFB0dz16Xkfj4mJLMN2mof83w/exec";

/* âœ… ì§ì› JSON */
const EMP_URL = "people/employees.json?ts=" + Date.now();

/* âœ… ê³ ê°ìš© ì‚¬ì´íŠ¸ ì£¼ì†Œ(ì¤‘ì‹ë¹„ ì§€ê¸‰ í‘œì‹œ ì—°ë™) */
const CUSTOMER_SITE_URL = "https://incarmkt.github.io/travel/";

/* ================= ìƒíƒœ ================= */
let employees = [];
let pageHistory = [];
let qrScanner = null;

let qrMode = "";            // departure | meal | customer
let currentCategory = "";   // ì „ì²´ì¼ì • | ì„ íƒì¼ì •
let currentCourse = "";     // ì¼ì •(ì½”ìŠ¤)ëª…
let currentMealTour = "";   // ì¤‘ì‹ë¹„ ì§€ê¸‰ í•­ëª©(íˆ¬ì–´ëª…)

/* ìŠ¤ìº” ì¤‘ë³µ ë°©ì§€ */
let lastScanAt = 0;
let lastScanId = "";

/* ================= ë°ì´í„° ë¡œë“œ ================= */
fetch(EMP_URL).then(r=>r.json()).then(d=>employees=d).catch(console.error);

/* ================= ë¡œê·¸ì¸ ================= */
function adminLogin(){
  const pw = (document.getElementById("adminPw").value || "").trim();
  if(pw !== ADMIN_PASSWORD){
    document.getElementById("loginError").textContent="ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
    return;
  }
  document.getElementById("adminLoginSection").style.display="none";
  document.getElementById("topHeader").style.display="flex";
  document.getElementById("mainSection").style.display="block";
  document.body.classList.add("logged-in");

  pageHistory = [];
  openPage("travelRoot");
}

/* ================= í˜ì´ì§€ ================= */
function openPage(type, fromHistory=false){
  stopQR(); // âœ… í˜ì´ì§€ ì´ë™ ì‹œ QR ì¢…ë£Œ + ì ê¸ˆ í•´ì œ

  if(!fromHistory) pageHistory.push(type);

  document.getElementById("detailPage").style.display="block";
  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  /* 1) ì—¬í–‰ì¼ì •ê´€ë¦¬ ë£¨íŠ¸ */
  if(type==="travelRoot"){
    t.textContent="ğŸ§­ ì—¬í–‰ì¼ì •ê´€ë¦¬";
    c.innerHTML = `
      <div class="card" style="text-align:center;">
        <p style="margin:0;font-weight:700;">ì¶œë°œ ì²´í¬ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        <div class="admin-sub-buttons">
          <button class="primary-btn" onclick="openTravelList('ì „ì²´ì¼ì •')">ì „ì²´ì¼ì •ê´€ë¦¬</button>
          <button class="primary-btn" onclick="openTravelList('ì„ íƒì¼ì •')">ì„ íƒì¼ì •ê´€ë¦¬</button>
        </div>
        <p style="margin:10px 0 0; color:#667085; font-size:12px;">
          â€» ì¼ì • ì„ íƒ â†’ QR í™”ë©´ì—ì„œ ë°”ì½”ë“œì²˜ëŸ¼ <b>ì—°ì† ìŠ¤ìº”</b>í•˜ë©´ ìë™ ê¸°ë¡ë©ë‹ˆë‹¤.
        </p>
      </div>
    `;
    return;
  }

  /* 2) ì¤‘ì‹ë¹„ì§€ê¸‰ê´€ë¦¬ ë£¨íŠ¸ */
  if(type==="mealRoot"){
    t.textContent="ğŸ’³ ì¤‘ì‹ë¹„ì§€ê¸‰ê´€ë¦¬";
    c.innerHTML = `
      <div class="card" style="text-align:center;">
        <p style="margin:0;font-weight:700;">ì§€ê¸‰ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div class="admin-sub-buttons" style="justify-content:center;">
          ${getMealItems().map(item => `
            <button class="primary-btn" onclick="openMealScan('${escapeQuotes(item)}')">${escapeHtml(item)}</button>
          `).join("")}
        </div>
        <p style="margin:10px 0 0; color:#667085; font-size:12px;">
          â€» QR/ì‚¬ë²ˆ ì…ë ¥ â†’ GASì— ì €ì¥ + ê³ ê°ìš© ì‚¬ì´íŠ¸ì— ì§€ê¸‰í‘œì‹œ(ê°€ëŠ¥í•œ ê²½ìš°)
        </p>
      </div>
    `;
    return;
  }

  /* 3) ê³ ê°ê´€ë¦¬ ë£¨íŠ¸ */
  if(type==="customerRoot"){
    t.textContent="ğŸ‘¤ ê³ ê°ê´€ë¦¬";
    openCustomerScan(); // ë°”ë¡œ QR + ì‚¬ë²ˆì…ë ¥
    return;
  }
}

/* ================= ì—¬í–‰ ì¼ì • ================= */
/* âœ… ë„¤ê°€ ì¤€ ì›ë³¸ travelSchedule ê·¸ëŒ€ë¡œ ìœ ì§€ */
const travelSchedule = [
  {
    day: "DAY 1",
    date: "2026.03.11 (ìˆ˜)",
    title: "ì¸ì²œ â†’ íƒ€ì´ë² ì´ / ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸",
    items: [
      { time:"08:00", icon:"âœˆï¸", title:"ì¸ì²œ êµ­ì œê³µí•­ ì¶œë°œ", desc:"OZ 711 / KE 2021" },
      { time:"12:30", icon:"ğŸœ", title:"ì¤‘ì‹ | ìš°ìœ¡ë©´", desc:"í˜„ì§€ ì¸ê¸° ì¤‘ì‹ë‹¹" },
      { time:"14:00", icon:"ğŸ›ï¸", title:"ì¤‘ì •ê¸°ë…ë‹¹", desc:"ì¥ê°œì„ ì´í†µ ê¸°ë…ê´€" },
      { time:"15:30", icon:"ğŸº", title:"êµ­ë¦½ê³ ê¶ë°•ë¬¼ê´€", desc:"ì„¸ê³„ 4ëŒ€ ë°•ë¬¼ê´€" },
      { time:"18:30", icon:"ğŸ½ï¸", title:"ì„ì‹ | íƒ€ì¹´ì˜¤ ìƒ¤ë¸Œìƒ¤ë¸Œ", desc:"í˜„ì§€ì‹" },
      { time:"20:00", icon:"ğŸŒƒ", title:"íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€", desc:"ì•¼ê²½ ê´€ëŒ" }
    ]
  },
  {
    day: "DAY 2",
    date: "2026.03.12 (ëª©)",
    title: "ì„ íƒ ê´€ê´‘ / ë§Œì°¬",
    items: [
      { time:"09:00", icon:"ğŸšŒ", title:"ì„ íƒ ê´€ê´‘", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"18:00", icon:"ğŸ‰", title:"ISC ë§Œì°¬", desc:"í•„ìˆ˜ ì°¸ì„" }
    ]
  },
  {
    day: "DAY 3",
    date: "2026.03.13 (ê¸ˆ)",
    title: "ê·¼êµ ê´€ê´‘",
    items: [
      { time:"10:00", icon:"ğŸŒŠ", title:"ì•¼ë¥˜ í•´ìƒê³µì›", desc:"ê¸°ì•”ê´´ì„ ê´€ê´‘" },
      { time:"14:00", icon:"ğŸ®", title:"ì§€ìš°í€", desc:"í™ë“± ë§ˆì„" }
    ]
  },
  {
    day: "DAY 4",
    date: "2026.03.14 (í† )",
    title: "ê·€êµ­",
    items: [
      { time:"07:00", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì•„ì›ƒ", desc:"" },
      { time:"11:40", icon:"âœˆï¸", title:"íƒ€ì´ë² ì´ ì¶œë°œ", desc:"OZ 712 / KE 2022" },
      { time:"15:25", icon:"ğŸ‡°ğŸ‡·", title:"ì¸ì²œ ë„ì°©", desc:"" }
    ]
  }
];

function openTravelList(cat){
  currentCategory = cat;

  pageHistory.push("travelList"); // ë³„ë„ í˜ì´ì§€ì²˜ëŸ¼
  stopQR();

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = (cat==="ì „ì²´ì¼ì •") ? "ğŸ—“ ì „ì²´ì¼ì •ê´€ë¦¬" : "ğŸ—“ ì„ íƒì¼ì •ê´€ë¦¬";

  const source = (cat==="ì „ì²´ì¼ì •")
    ? travelSchedule
    : travelSchedule.filter(d => (d.title || "").includes("ì„ íƒ"));

  c.innerHTML = source.map(day => `
    <div class="day-card">
      <h3>${escapeHtml(day.day)} <span>${escapeHtml(day.date)}</span></h3>
      <p class="day-title">${escapeHtml(day.title)}</p>

      <div class="timeline">
        ${day.items.map(item => `
          <div class="schedule-item">
            <div class="timeline-dot"></div>
            <div class="schedule-card admin-clickable"
                 onclick="openDepartureScan('${escapeQuotes(item.title)}')">
              <div class="schedule-time">${escapeHtml(item.time || "")}</div>
              <div class="schedule-title">${escapeHtml(item.icon || "")} ${escapeHtml(item.title || "")}</div>
              ${item.desc ? `<div class="schedule-desc">${escapeHtml(item.desc)}</div>` : ""}
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
}

function openDepartureScan(courseTitle){
  currentCourse = courseTitle;
  qrMode = "departure";

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ“· ì¶œë°œ ì²´í¬ - ${courseTitle}`;

  c.innerHTML = buildQRPanelHTML({
    placeholder: "ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥",
    buttonText: "ë“±ë¡",
    hint: "QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì—°ì† ìŠ¤ìº” ê°€ëŠ¥)",
    extraButtonsHtml: `
      <button class="ghost-btn" style="width:100%; max-width:420px;" onclick="resetResult()">ê²°ê³¼ ì´ˆê¸°í™”</button>
    `
  });

  startQR();
}

/* ================= ì¤‘ì‹ë¹„ ================= */
/* âœ… ì—¬ê¸´ ë„¤ ê³ ê°ìš© myTour(ë‹¨ìˆ˜ì´ ë“±) ê¸°ì¤€ìœ¼ë¡œ â€œì§€ê¸‰ ëŒ€ìƒâ€ë§Œ ë„£ì–´ì£¼ë©´ ë¨ */
function getMealItems(){
  // ì•„ë˜ ë°°ì—´ì€ ë„¤ê°€ ì‹¤ì œ ì§€ê¸‰ ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ë¡œ ì±„ìš°ë©´ ë¨
  // (ì˜ˆ: "ë‹¨ìˆ˜ì´", "í‹°ì—”ë¼ì´", "OOì‹ë‹¹" ë“±)
  return [
    "ë‹¨ìˆ˜ì´",  // ì˜ˆì‹œ
    "ê¸°íƒ€ ì¤‘ì‹ë¹„ í•­ëª© 1" // ì˜ˆì‹œ
  ];
}

function openMealScan(tourName){
  currentMealTour = tourName;
  qrMode = "meal";

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ“· ì¤‘ì‹ë¹„ ì§€ê¸‰ - ${tourName}`;

  c.innerHTML = buildQRPanelHTML({
    placeholder: "ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥",
    buttonText: "ì§€ê¸‰ ê¸°ë¡",
    hint: "QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì—°ì† ìŠ¤ìº” ê°€ëŠ¥)",
    extraButtonsHtml: `
      <div style="width:100%; max-width:420px; display:flex; gap:10px;">
        <button class="primary-btn" style="flex:1;" onclick="manualSubmitMeal('APPROVE')">ì§€ê¸‰(ìŠ¹ì¸)</button>
        <button class="ghost-btn" style="flex:1;" onclick="manualSubmitMeal('CANCEL')">ì·¨ì†Œ</button>
      </div>
    `
  });

  startQR();
}

/* ================= ê³ ê°ê´€ë¦¬ ================= */
function openCustomerScan(){
  qrMode = "customer";

  const c = document.getElementById("detailContent");

  c.innerHTML = buildQRPanelHTML({
    placeholder: "ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥",
    buttonText: "ì¡°íšŒ",
    hint: "QRì„ ìŠ¤ìº”í•˜ê±°ë‚˜ ì‚¬ë²ˆì„ ì…ë ¥í•˜ë©´ ê³ ê°ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.",
    extraButtonsHtml: `
      <button class="ghost-btn" style="width:100%; max-width:420px;" onclick="restartCustomerScan()">ë‹¤ì‹œ ìŠ¤ìº”</button>
    `
  });

  startQR();
}

/* ================= QR íŒ¨ë„ ê³µí†µ UI ================= */
function buildQRPanelHTML({placeholder, buttonText, hint, extraButtonsHtml=""}){
  return `
    <div class="qr-panel">
      <div id="qrReader"></div>

      <div class="manual-row">
        <input type="text" id="manualId" inputmode="numeric" placeholder="${escapeHtml(placeholder)}">
        <button class="ghost-btn" onclick="manualCheck()">${escapeHtml(buttonText)}</button>
      </div>

      <div id="qrResult" class="qr-result">QR ìŠ¤ìº” ëŒ€ê¸°ì¤‘</div>

      <div style="width:100%; max-width:420px; color:#667085; font-size:12px; text-align:center;">
        ${escapeHtml(hint)}
      </div>

      ${extraButtonsHtml ? `<div style="width:100%; max-width:420px;">${extraButtonsHtml}</div>` : ""}
    </div>
  `;
}

/* ================= QR ì‹œì‘/ì •ì§€ ================= */
async function startQR(){
  // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ
  if(qrScanner) return;

  document.body.classList.add("qr-lock");

  try{
    qrScanner = new Html5Qrcode("qrReader");
    const devices = await Html5Qrcode.getCameras();
    if(!devices || devices.length===0){
      setQR("ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", false);
      return;
    }

    const backCam =
      devices.find(d => /back|rear|í›„ë©´/i.test(d.label)) ||
      devices[devices.length - 1];

    await qrScanner.start(
      backCam.id,
      {
        fps: 10,
        qrbox: (vw, vh) => {
          const minEdge = Math.min(vw, vh);
          const size = Math.max(200, Math.min(260, Math.floor(minEdge * 0.7)));
          return { width: size, height: size };
        }
      },
      (text)=>handleQR(text),
      ()=>{}
    );
  }catch(e){
    console.error(e);
    setQR("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.", false);
  }
}

function stopQR(){
  document.body.classList.remove("qr-lock");
  lastScanAt = 0;
  lastScanId = "";

  if(!qrScanner) return;

  try{
    const tmp = qrScanner;
    qrScanner = null;

    tmp.stop()
      .then(()=>tmp.clear())
      .catch(()=>{
        try{ tmp.clear(); }catch{}
      });
  }catch(e){
    qrScanner = null;
  }
}

function resetResult(){
  const el = document.getElementById("qrResult");
  if(!el) return;
  el.textContent = "QR ìŠ¤ìº” ëŒ€ê¸°ì¤‘";
  el.className = "qr-result";
}

/* ================= QR ì²˜ë¦¬ ================= */
function handleQR(text){
  let id = "";
  try{
    id = new URL(text).searchParams.get("eid") || "";
  }catch{
    return;
  }
  if(!id) return;

  // âœ… ì¤‘ë³µ ìŠ¤ìº” ë°©ì§€(ê°™ì€ ì‚¬ë²ˆì´ ì—°ì†ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²ƒ ì–µì œ)
  const nowT = Date.now();
  if(id === lastScanId && (nowT - lastScanAt) < 1200) return;
  lastScanId = id;
  lastScanAt = nowT;

  processByMode(id);
}

function manualCheck(){
  const id = (document.getElementById("manualId")?.value || "").trim();
  if(!id) return;
  processByMode(id);
  const input = document.getElementById("manualId");
  if(input) input.value = "";
}

function processByMode(id){
  const emp = findEmp(id);
  if(!emp){
    setQR("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
    return;
  }

  const time = nowKST();

  if(qrMode==="departure"){
    // âœ… ìë™ ê¸°ë¡(ì—°ì† ìŠ¤ìº”)
    sendGAS({
      type: "departure",
      id: emp.id,
      name: emp.name,
      category: currentCategory,
      course: currentCourse,
      time
    });
    setQR(`âœ… ${emp.name} (${emp.id}) / ${currentCourse} / ${time}`, true);
    return;
  }

  if(qrMode==="meal"){
    // âœ… ê¸°ë³¸ì€ ìŠ¤ìº” ì¦‰ì‹œ APPROVE ê¸°ë¡
    sendGAS({
      type: "meal",
      id: emp.id,
      name: emp.name,
      action: "APPROVE",
      tour: currentMealTour,
      time
    });
    setQR(`âœ… ${emp.name} (${emp.id}) / ${currentMealTour} / APPROVE / ${time}`, true);

    // âœ… ê³ ê°ìš© ì§€ê¸‰í‘œì‹œ ì—°ë™(ê°€ëŠ¥í•œ ê²½ìš°)
    // - ê³ ê°ìš© ì‚¬ì´íŠ¸ì—ì„œ localStorage ê¸°ë°˜ìœ¼ë¡œ ì—°ë™í•  ê±°ë©´,
    //   ê³ ê° ê¸°ê¸°ì™€ ê´€ë¦¬ì ê¸°ê¸°ê°€ ë‹¤ë¥´ë¯€ë¡œ "ì„œë²„ ì¡°íšŒ ë°©ì‹(GAS GET)"ìœ¼ë¡œ ê°€ì•¼í•¨.
    // - ì—¬ê¸°ì„œëŠ” ì €ì¥ë§Œ ë³´ì¥(=GAS ê¸°ë¡)í•˜ê³ , ê³ ê°ìš©ì€ GAS ì¡°íšŒë¡œ í‘œì‹œí•˜ë„ë¡ ë§ì¶”ë©´ ë¨.
    return;
  }

  if(qrMode==="customer"){
    // âœ… ê³ ê°ê´€ë¦¬ëŠ” ìŠ¤ìº” í›„ ì •ë³´ í‘œì‹œ(ì—¬ê¸°ì„œë§Œ ë©ˆì¶¤)
    showCustomer(emp);
    return;
  }
}

/* ì¤‘ì‹ë¹„: ìˆ˜ë™ ë²„íŠ¼ìš©(ìŠ¹ì¸/ì·¨ì†Œ) */
function manualSubmitMeal(action){
  const id = (document.getElementById("manualId")?.value || "").trim();
  if(!id){
    setQR("ì‚¬ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.", false);
    return;
  }
  const emp = findEmp(id);
  if(!emp){
    setQR("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
    return;
  }
  const time = nowKST();
  sendGAS({
    type:"meal",
    id: emp.id,
    name: emp.name,
    action,
    tour: currentMealTour,
    time
  });
  setQR(`âœ… ${emp.name} (${emp.id}) / ${currentMealTour} / ${action} / ${time}`, true);

  const input = document.getElementById("manualId");
  if(input) input.value = "";
}

/* ================= GAS ì „ì†¡ ================= */
function sendGAS(payload){
  fetch(GAS_URL, {
    method:"POST",
    mode:"no-cors",
    body: JSON.stringify(payload)
  }).catch(console.error);
}

/* ================= ê³ ê°ì •ë³´ í‘œì‹œ ================= */
function showCustomer(emp){
  stopQR(); // âœ… ê³ ê°ê´€ë¦¬ì—ì„œë§Œ ìŠ¤ìº” ì¢…ë£Œ + ì ê¸ˆ í•´ì œ(PC ê³ ì • ë¬¸ì œ ë°©ì§€)

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  t.textContent = `ğŸ‘¤ ê³ ê°ê´€ë¦¬ - ${emp.name} (${emp.id})`;

  const rows = Object.keys(emp).map(k => {
    const v = (typeof emp[k] === "object") ? JSON.stringify(emp[k]) : String(emp[k]);
    return `
      <div class="info-row">
        <div class="info-label">${escapeHtml(k)}</div>
        <div>${escapeHtml(v)}</div>
      </div>
    `;
  }).join("");

  c.innerHTML = `
    <div class="info-card">
      ${rows}
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="primary-btn" onclick="restartCustomerScan()">ë‹¤ì‹œ ìŠ¤ìº”</button>
      <button class="ghost-btn" onclick="openCustomerLoginLink('${escapeQuotes(emp.id)}')">ê³ ê° ìë™ë¡œê·¸ì¸ ë§í¬ ì—´ê¸°</button>
    </div>
  `;
}

/* ê³ ê° ìë™ë¡œê·¸ì¸ ë§í¬(ê³ ê°ìš©: ?eid=ì‚¬ë²ˆ í˜•íƒœë¡œ ë¡œê·¸ì¸ ë¡œì§ì„ ë§Œë“¤ì–´ë‘” ê²½ìš°) */
function openCustomerLoginLink(empId){
  // ê³ ê°ìš© ì‚¬ì´íŠ¸ê°€ QRê³¼ ë™ì¼í•œ ê·œì¹™: ?eid=ì‚¬ë²ˆ
  const url = `${CUSTOMER_SITE_URL}?eid=${encodeURIComponent(empId)}`;
  window.open(url, "_blank");
}

function restartCustomerScan(){
  // ê³ ê°ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ ë‹¤ì‹œ QR
  const t = document.getElementById("detailTitle");
  t.textContent = "ğŸ‘¤ ê³ ê°ê´€ë¦¬";
  openCustomerScan();
}

/* ================= í™ˆ/ë’¤ë¡œê°€ê¸° ================= */
function goHome(){
  stopQR();
  pageHistory = [];
  openPage("travelRoot", true);
}
function goBack(){
  stopQR();
  pageHistory.pop();
  const prev = pageHistory.length ? pageHistory[pageHistory.length - 1] : "travelRoot";
  openPage(prev, true);
}

/* ================= ìœ í‹¸ ================= */
function setQR(msg, ok){
  const el = document.getElementById("qrResult");
  if(!el) return;
  el.textContent = msg;
  el.className = "qr-result " + (ok ? "success" : "fail");
}
function nowKST(){
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone:"Asia/Seoul",
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).format(new Date());
}
function findEmp(id){
  return employees.find(e => String(e.id).trim() === String(id).trim()) || null;
}
function escapeQuotes(str){
  return String(str).replace(/'/g,"\\'").replace(/"/g,'\\"');
}
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ================= ì—”í„°: ê´€ë¦¬ì ë¡œê·¸ì¸ ================= */
document.addEventListener("keydown", (e) => {
  if(e.key==="Enter" && document.getElementById("adminLoginSection").style.display !== "none"){
    adminLogin();
  }
});
</script>

</body>
</html>
