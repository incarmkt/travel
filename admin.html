<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì | ì¶œë°œ ì²´í¬</title>

  <!-- ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ ê³µìœ  -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">
</head>

<body class="logged-in">

<header class="header compact">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1 id="headerTitle">ê´€ë¦¬ì ì¶œë°œ ì²´í¬</h1>
      <p class="sub" id="headerSub">ì½”ìŠ¤ ì„ íƒ â†’ QR ë˜ëŠ” ì‚¬ë²ˆ ì…ë ¥</p>
    </div>
  </div>
  <div class="header-right">
    <p class="welcome-text"><strong>ê´€ë¦¬ì ëª¨ë“œ</strong></p>
  </div>
</header>

<main id="mainSection">
  <div class="layout">
    <section class="content-area">
      <div class="main-panel">

        <!-- ================= STEP 0 : ì¹´í…Œê³ ë¦¬ ì„ íƒ ================= -->
        <div id="categorySelect" class="card">
          <h3>ğŸ§­ ì¶œë°œ ìœ í˜• ì„ íƒ</h3>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="primary-btn" onclick="selectCategory('ì „ì²´ì¼ì •')">ì „ì²´ ê´€ê´‘</button>
            <button class="primary-btn" onclick="selectCategory('ì„ íƒê´€ê´‘')">ì„ íƒ ê´€ê´‘</button>
          </div>
        </div>

        <!-- ================= STEP 1 : ì½”ìŠ¤ ì„ íƒ ================= -->
        <div id="courseSelect" class="card" style="display:none;">
          <h3>ğŸ—“ ì¶œë°œ ì½”ìŠ¤ ì„ íƒ</h3>
          <div class="course-list">
            <button class="primary-btn" onclick="openScanner('ì¤‘ì •ê¸°ë…ë‹¹')">ì¤‘ì •ê¸°ë…ë‹¹</button>
            <button class="primary-btn" onclick="openScanner('êµ­ë¦½ê³ ê¶ë°•ë¬¼ê´€')">êµ­ë¦½ê³ ê¶ë°•ë¬¼ê´€</button>
            <button class="primary-btn" onclick="openScanner('íƒ€ì´ë² ì´ 101')">íƒ€ì´ë² ì´ 101</button>
            <button class="primary-btn" onclick="openScanner('ISC ë§Œì°¬')">ISC ë§Œì°¬</button>
          </div>
          <div style="margin-top:16px;">
            <button class="ghost-btn" onclick="goCategory()">â† ì´ì „</button>
          </div>
        </div>

        <!-- ================= STEP 2 : QR ìŠ¤ìº” ================= -->
        <div id="scanSection" class="card" style="display:none;">
          <h3 id="scanTitle">ğŸ“· ì¶œë°œ ì²´í¬</h3>

          <!-- QR ìŠ¤ìº” ì˜ì—­ -->
          <div id="qrReader"
               style="width:100%; height:260px; border-radius:12px; background:#000;">
          </div>

          <!-- ìˆ˜ë™ ì…ë ¥ -->
          <div class="manual-input" style="margin-top:12px;">
            <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥">
            <button class="ghost-btn" onclick="manualCheck()">ë“±ë¡</button>
          </div>

          <!-- ê²°ê³¼ -->
          <p id="scanResult" class="hint" style="margin-top:12px;"></p>

          <div class="nav-buttons">
            <button class="ghost-btn" onclick="closeScanner()">â† ë’¤ë¡œ</button>
          </div>
        </div>

      </div>
    </section>
  </div>
</main>

<!-- QR ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= CONFIG ================= */
const EMP_URL = "people/employees.json";
const GAS_URL = "https://script.google.com/macros/s/AKfycbywujbffRaXimjgXIjZkeyLv0kea2tDe17jtBmMvLjs6gFB0dz16Xkfj4mJLMN2mof83w/exec";

/* ================= STATE ================= */
let employees = [];
let currentCategory = "";
let currentCourse = "";
let qrScanner = null;

/* ================= LOAD EMP ================= */
fetch(EMP_URL + "?ts=" + Date.now())
  .then(r => r.json())
  .then(d => employees = d);

/* ================= CATEGORY ================= */
function selectCategory(cat) {
  currentCategory = cat;
  document.getElementById("categorySelect").style.display = "none";
  document.getElementById("courseSelect").style.display = "block";

  document.getElementById("headerTitle").textContent =
    cat === "ì „ì²´ì¼ì •" ? "ì „ì²´ ê´€ê´‘ ì¶œë°œ ì²´í¬" : "ì„ íƒ ê´€ê´‘ ì¶œë°œ ì²´í¬";
}

function goCategory() {
  document.getElementById("courseSelect").style.display = "none";
  document.getElementById("categorySelect").style.display = "block";
}

/* ================= COURSE ================= */
function openScanner(course) {
  currentCourse = course;

  document.getElementById("courseSelect").style.display = "none";
  document.getElementById("scanSection").style.display = "block";
  document.getElementById("scanTitle").textContent =
    `ğŸ“ ${course} ì¶œë°œ ì²´í¬`;

  startQR();
}

/* ================= QR INIT ================= */
function startQR() {
  if (qrScanner) return;

  qrScanner = new Html5Qrcode("qrReader");

  Html5Qrcode.getCameras().then(devices => {
    const backCam =
      devices.find(d => /back|rear/i.test(d.label)) ||
      devices[devices.length - 1];

    qrScanner.start(
      backCam.id,
      { fps: 10, qrbox: { width: 260, height: 160 } },
      text => handleQR(text),
      () => {}
    );
  });
}

/* ================= QR HANDLE ================= */
function handleQR(text) {
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (id) processDeparture(id);
  } catch {}
}

/* ================= MANUAL ================= */
function manualCheck() {
  const id = document.getElementById("manualId").value.trim();
  if (id) processDeparture(id);
}

/* ================= PROCESS ================= */
function processDeparture(id) {
  const emp = employees.find(e => e.id === id);
  if (!emp) {
    showResult("âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.", false);
    return;
  }

  const time = nowKST();

  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "departure",
      id: emp.id,
      name: emp.name,
      category: currentCategory,   // âœ… í•µì‹¬
      course: currentCourse,
      time
    })
  });

  showResult(`âœ… ${emp.name} (${emp.id}) ì¶œë°œ ë“±ë¡ ì™„ë£Œ`, true);
}

/* ================= UI ================= */
function showResult(msg, success) {
  const el = document.getElementById("scanResult");
  el.textContent = msg;
  el.style.color = success ? "#16a34a" : "#dc2626";
  document.getElementById("manualId").value = "";
}

/* ================= UTIL ================= */
function nowKST() {
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  }).format(new Date());
}

/* ================= CLOSE ================= */
function closeScanner() {
  if (qrScanner) {
    qrScanner.stop().then(() => {
      qrScanner.clear();
      qrScanner = null;
    });
  }

  document.getElementById("scanSection").style.display = "none";
  document.getElementById("courseSelect").style.display = "block";
  document.getElementById("scanResult").textContent = "";
}
</script>

</body>
</html>
