<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025 ISC ëŒ€ë§Œ ì—¬í–‰</title>

  <!-- <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)"> -->
  <link rel="stylesheet" href="css/theme-premium.css">
</head>

<body>
  
<!-- âœ… ì—¬ê¸°, body ì‹œì‘í•˜ìë§ˆì -->
<div id="mobileSplash" class="mobile-splash" style="display:none;">
  <img src="assets/images/iscposter.jpg" alt="ISC Poster">
</div>
  

<!-- ================= LOGIN (FINAL / DO NOT TOUCH) ================= -->
<section id="loginSection" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>2025 ISC Taiwan</h2>
      <p class="hero-desc">ì‚¬ë²ˆìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>

      <input type="text" id="employeeId" placeholder="ì‚¬ë²ˆ ì…ë ¥">
      <button class="primary-btn" onclick="login()">ë¡œê·¸ì¸</button>
      <p id="loginError" class="error"></p>
    </div>
  </div>
</section>

<!-- ================= MAIN (LOGIN AFTER) ================= -->
<main id="mainSection" class="main-bg" style="display:none;">

  <!-- ================= HOME VIEW ================= -->
<section id="homeView" class="home-view">
  
 <!-- 1ï¸âƒ£ INTRO (ê¸€ì”¨ í™”ë©´) -->
  <section class="home-intro">
<div class="intro-stage">

  <!-- ìƒë‹¨ -->
  <div class="intro-top">
    <img src="assets/images/logo.png" class="hero-logo">
    <p class="intro-brand">ISC Taiwan 2025 | ì¸ì¹´ê¸ˆìœµì„œë¹„ìŠ¤</p>
  </div>

  <!-- ì¤‘ì•™ -->
  <div class="intro-center">
    <p class="welcome-main">
      <strong id="employeeName"></strong> ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤
    </p>
    <p class="welcome-sub">ISC ë‹¬ì„±ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤</p>
    <p class="intro-date">2026.03.11 ~ 03.14 | ëŒ€ë§Œ</p>
  </div>

  <!-- í•˜ë‹¨ -->
  <div class="intro-bottom">
    <div class="ribbon">ISC Taiwan 2025</div>
    <p class="intro-copy">ì§€ê¸ˆë¶€í„° ì—¬ì •ì´ ì‹œì‘ë©ë‹ˆë‹¤</p>
    <div class="scroll-hint">â†“ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ í•˜ì„¸ìš”</div>
  </div>

</div>
  </section>

  <!-- 2ï¸âƒ£ MENU (ì¹´í…Œê³ ë¦¬ í™”ë©´) -->
  <section class="home-menu-section">
    <div class="home-menu-wrap">
      <nav class="home-menu">
      <button onclick="openPage('taiwan')">ğŸ‡¹ğŸ‡¼ ëŒ€ë§Œì˜ ëª¨ë“  ê²ƒ</button>
      <button onclick="openPage('exchange')">ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°</button>  <!-- âœ… ì¶”ê°€ -->
      <button onclick="openPage('schedule')">ğŸ—“ ì—¬í–‰ ì¼ì •</button>
      <button onclick="openPage('flight')">âœˆï¸ í•­ê³µí¸ ì •ë³´</button>
      <button onclick="openPage('myTour')">ğŸ’ ë‚˜ì˜ ì„ íƒ ê´€ê´‘</button>
      <button onclick="openPage('dinner')">ğŸ½ ë§Œì°¬ ì•ˆë‚´</button>
      <button onclick="openPage('request')">ğŸ“ ìš”ì²­ì‚¬í•­</button>
      <button onclick="openPage('contact')">ğŸ“ ê¸´ê¸‰ ì—°ë½ë§</button>
    </nav>
 </div>
 </section>

  </section>

<!-- ================= DETAIL OVERLAY ================= -->
<section id="detailPage" class="detail-sheet">

  <!-- ğŸ”¹ dim ì˜ì—­ (ì—¬ê¸°ë§Œ í™ˆìœ¼ë¡œ) -->
  <div class="detail-dim" onclick="goHome()"></div>

  <!-- ğŸ”¹ ì‹¤ì œ ì‹œíŠ¸ -->
  <div class="detail-sheet__inner" onclick="event.stopPropagation()">
    
       <!-- âœ… ìƒë‹¨ í—¤ë” -->
     <div class="detail-header">
   <div class="detail-title" id="detailTitle"></div>

  <div class="detail-actions">
  <button class="btn-home" onclick="goHome()">í™ˆìœ¼ë¡œ</button>
  <button class="btn-back" onclick="goBack()">ë’¤ë¡œê°€ê¸°</button>
</div>
</div>

        <!-- âœ… ì´ê²Œ ì—†ì–´ì„œ ì „ë¶€ ì•ˆ ë³´ì˜€ìŒ -->
    <div id="detailContent"></div>
  </div>
</section>


</main>
  <script>
/* ================= ê³µí†µ ================= */
    /* ================= í˜ì´ì§€ íˆìŠ¤í† ë¦¬ ================= */
let pageHistory = [];
let employees = [];
let currentUser = null;
const ADMIN_PASSWORD = "0000";
    
    /* ================= ì„ íƒê´€ê´‘ í…œí”Œë¦¿ ================= */
const myTourTemplates = [
  {
    keyword: "í‹°ì—”ë¼ì´",
    html: `
      <div class="tour-card green">
        <div class="tour-header">
          <span class="badge">ì„ íƒ 1ì•ˆ</span>
          <h3>í‹°ì—”ë¼ì´ ì˜¨ì²œ íë§</h3>
          <span class="icon">ğŸŒ¿</span>
        </div>

        <p class="tour-desc">
          í‹°ì—”ë¼ì´ ì˜¨ì²œìš• & ì–‘ëª…ì‚° êµ­ë¦½ê³µì› ìë½ì˜ ìµœê³ ê¸‰ ìœ í™© ì˜¨ì²œ
        </p>

        <div class="meal-box">
          <strong>ğŸ½ ì ì‹¬ ì‹ì‚¬</strong>
          <span>ë² ì´ì§•ë•</span>
          <em class="included">ì‹ì‚¬ í¬í•¨</em>
        </div>

        <div class="tour-footer">
          <span>ğŸ« ì…ì¥ê¶Œ</span>
          <span>ğŸšŒ ì „ìš©ì°¨ëŸ‰</span>
          <span>ğŸ´ ì¤‘ì‹</span>
        </div>
      </div>
    `
  },
  {
    keyword: "ê³ ê¶ë°•ë¬¼ê´€",
    html: `
      <div class="tour-card green">
        <div class="tour-header">
          <span class="badge">ì„ íƒ 2ì•ˆ</span>
          <h3>ê³ ê¶ë°•ë¬¼ê´€ ì—­ì‚¬ ê¸°í–‰</h3>
          <span class="icon">ğŸ›ï¸</span>
        </div>

        <p class="tour-desc">
          ì¤‘êµ­ ì—­ì‚¬ì˜ ì •ìˆ˜, ëŒ€ë§Œ ê³ ê¶ë°•ë¬¼ê´€
        </p>

        <div class="meal-box">
          <strong>ğŸ½ ì ì‹¬ ì‹ì‚¬</strong>
          <span>ë² ì´ì§•ë•</span>
          <em class="included">ì‹ì‚¬ í¬í•¨</em>
        </div>

        <div class="tour-footer">
          <span>ğŸ« ì…ì¥ê¶Œ</span>
          <span>ğŸšŒ ì „ìš©ì°¨ëŸ‰</span>
          <span>ğŸ´ ì¤‘ì‹</span>
        </div>
      </div>
    `
  },
  {
    keyword: "ììœ ì¼ì •",
    html: `
      <div class="tour-card red">
        <div class="tour-header">
          <span class="badge">ì„ íƒ 3ì•ˆ</span>
          <h3>ììœ ë¡œìš´ ëŒ€ë§Œ ì—¬í–‰</h3>
          <span class="icon">ğŸ‡¹ğŸ‡¼</span>
        </div>

        <p class="tour-desc">
          ììœ ì¼ì • ëŒ€ë§Œ
        </p>

        <div class="meal-box">
          <strong>ğŸ½ ì ì‹¬ ì‹ì‚¬</strong>
          <span>ììœ ì‹</span>
          <em class="cash">í˜„ê¸ˆ ì§€ê¸‰</em>
        </div>
        
<!-- ğŸ”½ ì—¬ê¸° ì¶”ê°€ -->
     <div class="meal-check" data-tour="ììœ ì¼ì •">
  <span class="status pending">ì¤‘ì‹ë¹„ ë¯¸ì§€ê¸‰</span>
  <button onclick="handleMealClick(this)">ì§€ê¸‰ í™•ì¸</button>
</div>
      
        <div class="tour-footer">
          <span>ğŸšŒ ììœ ì¼ì •</span>
          <span>ğŸœ ì¤‘ì‹ë¹„</span>
        </div>
      </div>
    `
  }
];

/* ================= ì„ íƒê´€ê´‘ ë Œë”ë§ í•¨ìˆ˜ ================= */
function renderMyTour() {
  const selected = currentUser.myTour || [];

  const matchedCards = myTourTemplates.filter(t =>
    selected.some(input => input.includes(t.keyword))
  );

  if (matchedCards.length === 0) {
    return `<div class="card">ì„ íƒëœ ê´€ê´‘ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  }

  return matchedCards.map(t => t.html).join("");
}

fetch("people/employees.json?ts=" + Date.now())
  .then(res => res.json())
  .then(data => {
    employees = data;
    tryAutoLogin(); // ğŸ”¥ ì´ í•œ ì¤„ì´ ì—†ì–´ì„œ ì•ˆ ëë˜ ê±°
  });

/* ================= ì¤‘ì‹ë¹„ ì§€ê¸‰ ë¡œì§ ================= */

// â‘  ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ë¶„ê¸° ì²˜ë¦¬
function handleMealClick(btn) {
  const wrap = btn.closest(".meal-check");
  const tour = wrap.dataset.tour;

  const isDone = wrap.classList.contains("done");

  if (isDone) {
    showMealDetail(wrap);
  } else {
    approveMeal(wrap, tour);
  }
}

// â‘¡ ë¯¸ì§€ê¸‰ â†’ ì§€ê¸‰ ì²˜ë¦¬
function approveMeal(wrap, tour) {
  const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  if (pw !== ADMIN_PASSWORD) {
    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  const time = nowKSTString();

 setMealUI(wrap, "DONE", time);
saveMealPaid(currentUser.id, tour, time);

logMealPaymentToSheet({
  action: "APPROVE",
  tour,
  time
});
}
    function setMealUI(wrap, mode, time = "") {
  const status = wrap.querySelector(".status");
  const btn = wrap.querySelector("button");

  if (mode === "DONE") {
    wrap.classList.add("done");
    status.textContent = "ì¤‘ì‹ë¹„ ì§€ê¸‰ ì™„ë£Œ";
    status.classList.remove("pending");
    status.classList.add("done");
    wrap.dataset.time = time;
    btn.textContent = "ì§€ê¸‰ í™•ì¸";
  } else {
    wrap.classList.remove("done");
    status.textContent = "ì¤‘ì‹ë¹„ ë¯¸ì§€ê¸‰";
    status.classList.add("pending");
    status.classList.remove("done");
    wrap.dataset.time = "";
    btn.textContent = "ì§€ê¸‰ í™•ì¸";
  }
}
    
function mealKey(userId, tour) {
  return `mealPaid_${userId}_${tour}`;
}
    function saveMealPaid(userId, tour, time) {
  localStorage.setItem(
    mealKey(userId, tour),
    JSON.stringify({ time })
  );
}

function loadMealPaid(userId, tour) {
  const raw = localStorage.getItem(mealKey(userId, tour));
  return raw ? JSON.parse(raw) : null;
}

function removeMealPaid(userId, tour) {
  localStorage.removeItem(mealKey(userId, tour));
}

// â‘¢ ì§€ê¸‰ ì™„ë£Œ ìƒíƒœì—ì„œ ëˆŒë €ì„ ë•Œ (í™•ì¸/ì·¨ì†Œ)
function showMealDetail(wrap) {
  const time = wrap.dataset.time;

  const pw = prompt(
    `ì§€ê¸‰ ì™„ë£Œ ì‹œê°\n${time}\n\nì·¨ì†Œí•˜ë ¤ë©´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥\n(í™•ì¸ë§Œ ë³´ë ¤ë©´ ì·¨ì†Œ)`
  );

  if (!pw) return;
  if (pw !== ADMIN_PASSWORD) {
    alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    return;
  }

  if (confirm("ì§€ê¸‰ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    const tour = wrap.dataset.tour;
    const cancelTime = nowKSTString();

  setMealUI(wrap, "PENDING");
removeMealPaid(currentUser.id, tour);

logMealPaymentToSheet({
  action: "CANCEL",
  tour,
  time: cancelTime
});
  }
}
function nowKSTString() {
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  }).format(new Date());
}
    const MEAL_SHEET_URL = "https://script.google.com/macros/s/AKfycbx2tVkT00Z8uXQWl6EeTIUUhZ3_NJHx3JDqSCHC5oJWkUCm0OtcTmaV6g20cNKoh0no9w/exec";

function logMealPaymentToSheet(payload) {
  if (!currentUser) return;

  fetch(MEAL_SHEET_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "meal",              // âœ… ì¤‘ì‹ë¹„ ë¡œê·¸ëŠ” ë¬´ì¡°ê±´ meal
      id: currentUser.id,
      name: currentUser.name,
      action: payload.action,    // APPROVE / CANCEL
      tour: payload.tour,
      time: payload.time
    })
  }).catch(console.error);
}
    
    
function login() {
  const id = document.getElementById("employeeId").value.trim();
  const user = employees.find(e => e.id === id);

  if (!user) {
    document.getElementById("loginError").textContent = "ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆì…ë‹ˆë‹¤.";
    return;
  }

  currentUser = user;

  // ë¡œê·¸ì¸ í™”ë©´ ì œê±°
  document.getElementById("loginSection").style.display = "none";

  // ğŸ“± ëª¨ë°”ì¼: ìŠ¤í”Œë˜ì‹œ 2ì´ˆ
  if (window.innerWidth <= 767) {
    const splash = document.getElementById("mobileSplash");
    splash.style.display = "flex";

    setTimeout(() => {
      splash.style.display = "none";
      document.getElementById("mainSection").style.display = "block";
    }, 2000);
  } 
  // ğŸ–¥ ë°ìŠ¤í¬íƒ‘: ì¦‰ì‹œ ì§„ì…
  else {
    document.getElementById("mainSection").style.display = "block";
  }

  document.getElementById("employeeName").textContent = user.name;
  document.body.classList.add("logged-in");
}
function tryAutoLogin() {
  const params = new URLSearchParams(window.location.search);
  const eid = params.get("eid");

  if (!eid) return;

  // inputì— ì‚¬ë²ˆ ì£¼ì…
  const input = document.getElementById("employeeId");
  if (input) input.value = eid;

  const user = employees.find(e => String(e.id) === String(eid));
  if (!user) {
    document.getElementById("loginError").textContent =
      "QR ì‚¬ë²ˆì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    return;
  }

  // ğŸ”¥ ì—¬ê¸°ì„œ ë
  login();
}

/* ================= ì—¬í–‰ ì¼ì • ================= */
const travelSchedule = [
  {
    day: "DAY 1",
    date: "2026.03.11 (ìˆ˜)",
    title: "ì¸ì²œ â†’ íƒ€ì´ë² ì´ / ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸",
    items: [
      { time:"08:00/9:00", icon:"âœˆï¸", title:"ì¸ì²œ êµ­ì œê³µí•­ ì¶œë°œ", desc:"OZ 711 / KE 2021" },
      { time:"12:30/13:30", icon:"ğŸœ", title:"ì¤‘ì‹ | ìš°ìœ¡ë©´", desc:"í˜„ì§€ ì¸ê¸° ì¤‘ì‹ë‹¹" },
      { time:"13:30/14:30", icon:"ğŸ›ï¸", title:"ë‹¨ìˆ˜ì´ ì˜›ê±°ë¦¬/í™ë§ˆì˜¤ì²­/ì§„ë¦¬ëŒ€í•™", desc:"í™ë§ˆì˜¤ì²­Â·ì˜›ê±°ë¦¬ ê´€ê´‘" },
      { time:"16:30/17:30", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì¸", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"18:00/18:30", icon:"ğŸ½ï¸", title:"ì„ì‹ | íƒ€ì¹´ì˜¤ ìƒ¤ë¸Œìƒ¤ë¸Œ", desc:"ë¬´ì œí•œ ìƒ¤ë¸Œìƒ¤ë¸Œ" },
      { time:"19:30/20:00", icon:"ğŸŒƒ", title:"íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€", desc:"ì•¼ê²½ ê´€ëŒ" },
      { time:"21:00/21:30", icon:"ğŸ¨", title:"í˜¸í…”ë³µê·€", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" }
    ]
  },
  {
    day: "DAY 2",
    date: "2026.03.12 (ëª©)",
    title: "ì„ íƒ ê´€ê´‘ / ë§Œì°¬",
    items: [
      { time:"08:30/9:00", icon:"ğŸšŒ", title:"ì„ íƒ ê´€ê´‘", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"08:30", icon:"ğŸšŒ", title:"í‹°ì—”ë¼ì´ ì˜¨ì²œ", desc:"ì„ íƒ 1ì•ˆ" },
      { time:"9:00", icon:"ğŸ›ï¸", title:"ê³ ê¶ë°•ë¬¼ê´€", desc:"ì„ íƒ 2ì•ˆ" },
      { time:"13:00", icon:"ğŸ½ï¸", title:"ì¤‘ì‹", desc:"ë² ì´ì§•ë•" },
      { time:"14:30", icon:"ğŸ›ï¸", title:"ì„œë¬¸ì •", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"08:30/9:00", icon:"ğŸ§­", title:"ììœ ì‹œê°„", desc:"ì¤‘ì‹ë¹„ ì§€ê¸‰" },
      { time:"18:00", icon:"ğŸ‰", title:"ISC ë§Œì°¬", desc:"í•„ìˆ˜ ì°¸ì„" }
    ]
  },
  {
    day: "DAY 3",
    date: "2026.03.13 (ê¸ˆ)",
    title: "ê·¼êµ ê´€ê´‘",
    items: [
      { time:"10:00", icon:"ğŸ¨ğŸ½ï¸", title:"í˜¸í…” ì¡°ì‹ í›„ ì¶œë°œ", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"11:00", icon:"ğŸŒŠ", title:"ì•¼ë¥˜ í•´ìƒê³µì›", desc:"ê¸°ì•”ê´´ì„ ê´€ê´‘" },
      { time:"12:30", icon:"ğŸ¦", title:"ì¤‘ì‹ : ì”¨í‘¸ë“œ", desc:"í˜„ì§€ í•´ì‚°ë¬¼ íŠ¹ì‹" },
      { time:"14:30", icon:"ğŸ®", title:"ìŠ¤í€ ì²œë“±ë‚ ë¦¬ê¸°", desc:"ì†Œì›ì²œë“± ë‚ ë¦¬ê¸°" },
      { time:"17:00", icon:"ğŸ®", title:"ì§€ìš°í€ ì•¼ê²½", desc:"í™ë“±ë§ˆì„" },
      { time:"20:00", icon:"ğŸŒŠ", title:"ì•¼ì‹œì¥ ë° ì„ì‹", desc:"ì•¼ì‹œì¥ ììœ ì‹ ë° ì‡¼í•‘" },
      { time:"21:30", icon:"ğŸ¨", title:"í˜¸í…”ë³µê·€", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"ì „ì¼", icon:"ğŸ§­", title:"ììœ ì¼ì • ì„ íƒì‹œ", desc:"ì „ì²´ ê°œì¸ë¶€ë‹´(ì¤‘ì‹ë¹„ ì§€ê¸‰ X)" }
    ]
  },
  {
    day: "DAY 4",
    date: "2026.03.14 (í† )",
    title: "ê·€êµ­",
    items: [
      { time:"08:00/9:00", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì•„ì›ƒ", desc:"íƒ€ì´ë² ì´ ë©”ë¦¬ì–´íŠ¸ í˜¸í…”[5ì„±ê¸‰]" },
      { time:"11:40/12:25", icon:"âœˆï¸", title:"íƒ€ì´ë² ì´ ì¶œë°œ", desc:"OZ 712 / KE 2022" },
      { time:"15:25/15:50", icon:"ğŸ‡°ğŸ‡·", title:"ì¸ì²œ ë„ì°©", desc:"ISC in Taiwan" }
    ]
  }
];
    
    function normalizeTime(t) {
  // "9:00" -> "09:00" ê°™ì€ í‘œì¤€í™”
  const s = String(t).trim();
  const m = s.match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return s;
  return `${String(m[1]).padStart(2, "0")}:${m[2]}`;
}

function pickTimeByAirline(timeStr, airline) {
  // timeStr: "08:00/9:00" or "11:40/12:25" or "21:30"
  const parts = String(timeStr).split("/").map(s => normalizeTime(s));

  // ìŠ¬ë˜ì‹œ ì—†ëŠ” ê°’ì´ë©´ ê·¸ëŒ€ë¡œ
  if (parts.length === 1) return parts[0];

  const isKoreanAir = String(airline || "").includes("ëŒ€í•œí•­ê³µ");
  // âœ… ë£°: ì•„ì‹œì•„ë‚˜ = ì•(ë¹ ë¥¸ ì‹œê°„), ëŒ€í•œí•­ê³µ = ë’¤(ëŠë¦° ì‹œê°„)
  return isKoreanAir ? parts[parts.length - 1] : parts[0];
}
function buildDay2ItemsForUser(user, userAirline) {
  const tours = user?.myTour || [];
  const hasTienlai = tours.some(v => String(v).includes("í‹°ì—”ë¼ì´"));
  const hasGugung  = tours.some(v => String(v).includes("ê³ ê¶ë°•ë¬¼ê´€"));
  const hasFree    = tours.some(v => String(v).includes("ììœ ì¼ì •"));

  // âœ… travelSchedule ì•ˆì—ì„œ DAY2 ê°ì²´ ì°¾ê¸°
  const day2 = travelSchedule.find(d => d.day === "DAY 2");
  const items = day2?.items || [];

  // âœ… DAY2 itemsì—ì„œ titleë¡œ ë¹ ë¥´ê²Œ ì°¾ê¸°
  const byTitle = (title) => items.find(x => x.title === title);

  const itemSelect = byTitle("ì„ íƒ ê´€ê´‘");
  const itemTienlai = byTitle("í‹°ì—”ë¼ì´ ì˜¨ì²œ");
  const itemGugung  = byTitle("ê³ ê¶ë°•ë¬¼ê´€");
  const itemLunch   = byTitle("ì¤‘ì‹");
  const itemXimen   = byTitle("ì„œë¬¸ì •");
  const itemFree    = byTitle("ììœ ì‹œê°„");
  const itemDinner  = byTitle("ISC ë§Œì°¬");

  // âœ… ì˜ˆì™¸: 3ê°œ ë‹¤ ë“¤ì–´ìˆìœ¼ë©´(ë°ì´í„°ê°€ ì• ë§¤í•œ ìƒíƒœ)
  // -> ì„ íƒê´€ê´‘ + ì¤‘ì‹ + ì„œë¬¸ì • + ë§Œì°¬ë§Œ ë³´ì—¬ì£¼ê¸°
  if (hasTienlai && hasGugung && hasFree) {
    return [
      ...(itemSelect ? [itemSelect] : []),
      ...(itemLunch ? [itemLunch] : []),
      ...(itemXimen ? [itemXimen] : []),
      ...(itemDinner ? [itemDinner] : [])
    ];
  }
  
  // âœ… 3ì•ˆ: ììœ ì¼ì •(ììœ ì‹œê°„)ë§Œ + ë§Œì°¬
  if (hasFree && !hasTienlai && !hasGugung) {
    return [
      ...(itemFree ? [itemFree] : []),
      ...(itemDinner ? [itemDinner] : [])
    ];
  }

  // âœ… 1ì•ˆ: í‹°ì—”ë¼ì´ + ì¤‘ì‹ + ì„œë¬¸ì • + ë§Œì°¬
  if (hasTienlai) {
    return [
      ...(itemTienlai ? [itemTienlai] : []),
      ...(itemLunch ? [itemLunch] : []),
      ...(itemXimen ? [itemXimen] : []),
      ...(itemDinner ? [itemDinner] : [])
    ];
  }

  // âœ… 2ì•ˆ: ê³ ê¶ + ì¤‘ì‹ + ì„œë¬¸ì • + ë§Œì°¬
  if (hasGugung) {
    return [
      ...(itemGugung ? [itemGugung] : []),
      ...(itemLunch ? [itemLunch] : []),
      ...(itemXimen ? [itemXimen] : []),
      ...(itemDinner ? [itemDinner] : [])
    ];
  }

  // âœ… ì•ˆì „ë§: ì„ íƒì •ë³´ê°€ ì´ìƒí•˜ë©´ "ì„ íƒ ê´€ê´‘" + ë§Œì°¬ë§Œ
  const itemSelect = byTitle("ì„ íƒ ê´€ê´‘");
  return [
    ...(itemSelect ? [itemSelect] : []),
    ...(itemDinner ? [itemDinner] : [])
  ];
}


function pickFlightDescByAirline(desc, airline) {
  const s = String(desc || "");
  if (!s.includes("/")) return s;

  const isKoreanAir = String(airline || "").includes("ëŒ€í•œí•­ê³µ");
  const parts = s.split("/").map(v => v.trim()); // ["OZ 711", "KE 2021"]
  return isKoreanAir ? (parts[1] || s) : (parts[0] || s);
}


/* ================= í˜ì´ì§€ ì—´ê¸° ================= */
function openPage(type, fromHistory = false) {
  const userAirline = currentUser?.flight?.departure?.airline || ""; // âœ… ì¶”ê°€
  
  if (!fromHistory) {
    pageHistory.push(type);
  }

  /* ================= í•µì‹¬ ìˆ˜ì • START ================= */

  const detail = document.getElementById("detailPage");

  // 1ï¸âƒ£ í•­ìƒ display ìƒíƒœ ë³´ì¥
  detail.style.display = "block";

  // 2ï¸âƒ£ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
  requestAnimationFrame(() => {
    document.body.classList.add("detail-open");
  });

  /* ================= í•µì‹¬ ìˆ˜ì • END ================= */

  const t = document.getElementById("detailTitle");
  const c = document.getElementById("detailContent");

  if (type === "schedule") {
  t.textContent = "ğŸ—“ ì—¬í–‰ ì¼ì •";

  c.innerHTML = `
    <div class="detail-content-wrap">
      ${travelSchedule.map(day => `
        <div class="day-card">
          <h3>${day.day} <span>${day.date}</span></h3>
          <p class="day-title">${day.title}</p>

          <div class="timeline">
            ${(() => {
              const items = (day.day === "DAY 2")
                ? buildDay2ItemsForUser(currentUser, userAirline)
                : day.items;

              return items.map(i => `
                <div class="schedule-item">
                  <div class="timeline-dot"></div>
                  <div class="schedule-card">
                    <div class="schedule-time">${pickTimeByAirline(i.time, userAirline)}</div>
                    <div class="schedule-body">
                      <div class="schedule-title">${i.icon} ${i.title}</div>
                      ${i.desc ? `<div class="schedule-desc">${pickFlightDescByAirline(i.desc, userAirline)}</div>` : ""}
                    </div>
                  </div>
                </div>
              `).join("");
            })()}
          </div>
        </div>
      `).join("")}
    </div>
  `;

  return; // âœ… schedule ì²˜ë¦¬ ë. ì•„ë˜ ë‹¤ë¥¸ type ë Œë”ë§ ë§‰ê¸°
}



if (type === "flight") {
  const dep = currentUser.flight.departure;
  const ret = currentUser.flight.return;

  t.textContent = "âœˆï¸ í•­ê³µí¸ ì •ë³´";
 c.innerHTML = `
  <div class="detail-content-wrap">
    <div class="day-card">
      <h3>ì¶œêµ­í¸</h3>
      <div class="schedule-item">
        <div class="schedule-card">
          <div class="schedule-time">${dep.time}</div>
          <div class="schedule-body">
            <div class="schedule-title">âœˆï¸ ${dep.from} â†’ ${dep.to}</div>
            <div class="schedule-desc">${dep.airline} ${dep.flightNo}</div>
            <div class="schedule-desc">${dep.date}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="day-card">
      <h3>ê·€êµ­í¸</h3>
      <div class="schedule-item">
        <div class="schedule-card">
          <div class="schedule-time">${ret.time}</div>
          <div class="schedule-body">
            <div class="schedule-title">ğŸ  ${ret.from} â†’ ${ret.to}</div>
            <div class="schedule-desc">${ret.airline} ${ret.flightNo}</div>
            <div class="schedule-desc">${ret.date}</div>
          </div>
        </div>
      </div>
    </div>
  `;
}
 

if (type === "myTour") {
  t.textContent = "ğŸ’ ë‚˜ì˜ ì„ íƒ ê´€ê´‘";
 c.innerHTML = `
  <div class="detail-content-wrap">
    <div class="mytour-wrap">
      ${renderMyTour()}
    </div>
  `;

  setTimeout(() => {
    const wrap = document.querySelector('.meal-check[data-tour="ììœ ì¼ì •"]');
    if (!wrap) return;

    syncMealStatusFromServer(currentUser.id, "ììœ ì¼ì •", wrap);

    const saved = loadMealPaid(currentUser.id, "ììœ ì¼ì •");
    if (!wrap.classList.contains("done") && saved?.time) {
      setMealUI(wrap, "DONE", saved.time);
    }
  }, 0);
}



if (type === "taiwan") {
  t.textContent = "ğŸ‡¹ğŸ‡¼ ëŒ€ë§Œì˜ ëª¨ë“  ê²ƒ";

 c.innerHTML = `
  <div class="detail-content-wrap">
    <div class="country-compare-grid">
      <!-- ëŒ€í•œë¯¼êµ­ -->
      <div class="country-card">
        <div class="country-header">
          <img src="assets/images/flag-kr.jpg" class="flag-img">
          <h3>ëŒ€í•œë¯¼êµ­</h3>
        </div>
        <div class="time-box">
          <span class="time-label">í˜„ì¬ ì‹œê°</span>
          <strong id="timeKR">--:--:--</strong>
        </div>
        <ul class="country-list">
          <li><span>ì‹œì°¨</span><strong>ê¸°ì¤€ êµ­ê°€</strong></li>
          <li><span>ì¸êµ¬</span><strong>ì•½ 5,100ë§Œ ëª…</strong></li>
          <li><span>ë©´ì </span><strong>ì•½ 100,210ã¢</strong></li>
          <li><span>GDP</span><strong>ì•½ 1.7ì¡° ë‹¬ëŸ¬</strong></li>
        </ul>
      </div>

      <!-- ëŒ€ë§Œ -->
      <div class="country-card">
        <div class="country-header">
          <img src="assets/images/flag-tw.jpg" class="flag-img">
          <h3>ëŒ€ë§Œ</h3>
        </div>
        <div class="time-box">
          <span class="time-label">í˜„ì¬ ì‹œê°</span>
          <strong id="timeTW">--:--:--</strong>
        </div>
        <ul class="country-list">
          <li><span>ì‹œì°¨</span><strong>í•œêµ­ë³´ë‹¤ 1ì‹œê°„ ëŠë¦¼</strong></li>
          <li><span>ì¸êµ¬</span><strong>ì•½ 2,300ë§Œ ëª…</strong></li>
          <li><span>ë©´ì </span><strong>ì•½ 36,197ã¢</strong></li>
          <li><span>GDP</span><strong>ì•½ 0.8ì¡° ë‹¬ëŸ¬</strong></li>
        </ul>
      </div>
    </div>

    <div class="exchange-row">
      í™˜ìœ¨: <strong>1 TWD â‰ˆ 42ì› ë‚´ì™¸</strong>
    </div>

    <p class="exchange-note">
      â€» í™˜ìœ¨ì€ ì‹¤ì‹œê°„ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    </p>

    <div class="day-card">
      <h3 class="section-title">ê¸°ë³¸ ì •ë³´</h3>
      <div class="info-card-grid">
        <div class="info-card">
          <h4>ğŸ‡¹ğŸ‡¼ êµ­ê¸°</h4>
          <p><strong>ì²­ì²œë°±ì¼ë§Œì§€í™ê¸°</strong><br>ê´‘ëª… Â· ììœ  Â· í¬ìƒ</p>
        </div>
        <div class="info-card">
          <h4>ğŸ—£ ì–¸ì–´</h4>
          <p>í‘œì¤€ ì¤‘êµ­ì–´ / ë²ˆì²´ í•œì</p>
        </div>
        <div class="info-card">
          <h4>â˜€ï¸ ê¸°í›„</h4>
          <p>3ì›” í‰ê·  18~25â„ƒ</p>
        </div>
      </div>
    </div>
  `;

  startWorldClock();
}
if (type === "exchange") {
  t.textContent = "ğŸ’± í™˜ìœ¨ ê³„ì‚°ê¸°";

  c.innerHTML = `
    <div class="detail-content-wrap">

      <!-- âœ… ë„ˆ CSSì— ì´ë¯¸ ìˆëŠ” exchange-row í™œìš© -->
      <div class="exchange-row">
        í™˜ìœ¨: <strong>1 TWD â‰ˆ <span id="fxRateText">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>ì›</strong><br>
        <span style="font-size:12px; color:#6b7280;">
          ì—…ë°ì´íŠ¸: <span id="fxUpdatedText">-</span>
        </span>
        <div style="margin-top:10px;">
          <button class="primary-btn" id="fxRefreshBtn" style="max-width:220px;">
            í™˜ìœ¨ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>

      <div class="day-card">
        <h3 class="section-title">TWD â†” KRW ê³„ì‚°</h3>

        <div class="fx-grid">
          <div class="fx-box">
            <label>ëŒ€ë§Œë‹¬ëŸ¬ (TWD)</label>
            <input id="inputTWD" type="text" inputmode="decimal" placeholder="ì˜ˆ: 1000">
          </div>

          <div class="fx-eq">â‡„</div>

          <div class="fx-box">
            <label>ì›í™” (KRW)</label>
            <input id="inputKRW" type="text" inputmode="decimal" placeholder="ì˜ˆ: 42000">
          </div>
        </div>

        <p class="fx-note">
          â€» ìˆ«ì ì…ë ¥ ì‹œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤. (ì½¤ë§ˆ ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)
        </p>
      </div>
    </div>
  `;

  initExchangeCalculatorAuto(); // âœ… ìƒˆ ë¡œì§
}


 

if (type === "dinner") {
  t.textContent = "ğŸ½ ë§Œì°¬ ì•ˆë‚´";
  c.innerHTML = `
    <div class="detail-content-wrap">
      <div class="card">ISC ê³µì‹ ë§Œì°¬</div>
    </div>
  `;
}

  
 if (type === "request") {
  t.textContent = "ğŸ“ ìš”ì²­ì‚¬í•­";
  c.innerHTML = `
    <div class="detail-content-wrap">
      <div class="card">
        <textarea id="requestInput" placeholder="ìš”ì²­ì‚¬í•­ ì…ë ¥"></textarea>
        <button class="primary-btn" onclick="submitRequest()">ì œì¶œ</button>
      </div>
    </div>
  `;
}
  /* ================= ë‹´ë‹¹ì 0000000ì €ë¶€ë¶„ ìˆ˜ì •ì§ì ‘í•˜ë©´ ë°”ë€œ ================= */
 if (type === "contact") {
  t.textContent = "ğŸ“ ê¸´ê¸‰ ì—°ë½ë§";

  c.innerHTML = `
  <div class="detail-content-wrap">
    <div class="day-card">
      <h3>ë¹„ìƒ ì—°ë½ë§</h3>

      <div class="timeline">
        <!-- ì¸ì¹´ë¸”ë£¨íˆ¬ì–´ -->
        <div class="schedule-item">
          <div class="timeline-dot"></div>
          <div class="schedule-card">
            <div class="schedule-body">
              <div class="schedule-title">ğŸ“ ì¸ì¹´ë¸”ë£¨íˆ¬ì–´</div>
              <div class="schedule-desc">
                ë‹´ë‹¹ì í™ê¸¸ë™ | 010-0000-0000
              </div>
            </div>
          </div>
        </div>

        <!-- ì¸ì¹´ ë§ˆì¼€íŒ…ë¶€ -->
        <div class="schedule-item">
          <div class="timeline-dot"></div>
          <div class="schedule-card">
            <div class="schedule-body">
              <div class="schedule-title">ğŸ“ ì¸ì¹´ ë§ˆì¼€íŒ…ë¶€</div>
              <div class="schedule-desc">
                ë‹´ë‹¹ì í˜„ë³´ë¼ê³¼ì¥ | 02-6214-0000
              </div>
            </div>
          </div>
        </div>

        <!-- í˜„ì§€ ê°€ì´ë“œ -->
        <div class="schedule-item">
          <div class="timeline-dot"></div>
          <div class="schedule-card">
            <div class="schedule-body">
              <div class="schedule-title">ğŸ“ í˜„ì§€ ê°€ì´ë“œ</div>
              <div class="schedule-desc">
                ë‹´ë‹¹ì Jason | +886-900-222-222
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  `;
}
}

 async function syncMealStatusFromServer(userId, tour, wrap) {
  const url = `${MEAL_SHEET_URL}?mode=customerAdmin&id=${userId}`;
  const res = await fetch(url);
  const data = await res.json();

  const status = data.mealMap?.[tour]; // "APPROVE" | "CANCEL" | undefined

  if (status === "APPROVE") {
    setMealUI(wrap, "DONE", "ì„œë²„ ê¸°ì¤€");
  } else {
    setMealUI(wrap, "PENDING");
  }
}

/* ================= í™ˆìœ¼ë¡œ ================= */
function goHome() {
  // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
  pageHistory = [];

  // ìƒì„¸ ë‹«ê¸°
  document.body.classList.remove("detail-open");
// ğŸ”¥ ì¶”ê°€ëœ ë¶€ë¶„: ì ê¸ˆì´ í’€ë¦¬ë©´ì„œ ìŠ¤í¬ë¡¤ì´ ìœ„ë¡œ íŠ•ê¸°ëŠ” ê²ƒì„ ë°©ì§€
  setTimeout(() => {
    const menuSection = document.querySelector('.home-menu-section');
    if (menuSection) {
      // ë©”ë‰´ ì˜ì—­ìœ¼ë¡œ ë¶€ë“œëŸ½ê³  ì°°ì¹µí•˜ê²Œ ìŠ¤í¬ë¡¤ ê³ ì •
      menuSection.scrollIntoView({ behavior: 'auto', block: 'start' });
    }
  }, 10); // 10msì˜ ë¯¸ì„¸í•œ ë”œë ˆì´ë¥¼ ì£¼ì–´ ë¸Œë¼ìš°ì € ë Œë”ë§ ì¶©ëŒì„ ë§‰ìŒ
}

    /* ================= ë’¤ë¡œê°€ê¸° ================= */
function goBack() {
  // í˜„ì¬ í˜ì´ì§€ ì œê±°
  pageHistory.pop();

  // ì´ì „ ê¸°ë¡ ì—†ìœ¼ë©´ í™ˆ
  if (pageHistory.length === 0) {
    goHome();
    return;
  }

  const prevType = pageHistory[pageHistory.length - 1];

  // historyì— ë‹¤ì‹œ ìŒ“ì§€ ì•Šê³  ë Œë”ë§Œ
  openPage(prevType, true);
}

  /* ================= ìš”ì²­ì‚¬í•­ ì „ì†¡ (ì—¬ê¸°ì— ì¶”ê°€) ================= */
function submitRequest() {
  const requestText = document.getElementById("requestInput").value.trim();

  if (!requestText) {
    alert("ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  if (!currentUser) {
    alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  fetch(MEAL_SHEET_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "request",     // âœ… ì‹œíŠ¸1
      id: currentUser.id,
      name: currentUser.name,
      request: requestText,
      time: nowKSTString()
    })
  })
  .then(() => {
    alert("ìš”ì²­ì‚¬í•­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    document.getElementById("requestInput").value = "";
  })
  .catch(err => {
    console.error(err);
    alert("ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  });
}

    function startWorldClock() {

  function updateTime() {
    const now = new Date();

    const kr = new Intl.DateTimeFormat("ko-KR", {
      timeZone: "Asia/Seoul",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    }).format(now);

    const tw = new Intl.DateTimeFormat("zh-TW", {
      timeZone: "Asia/Taipei",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    }).format(now);

    const krEl = document.getElementById("timeKR");
    const twEl = document.getElementById("timeTW");

    if (krEl && twEl) {
      krEl.textContent = kr;
      twEl.textContent = tw;
    }
  }

  updateTime();
  setInterval(updateTime, 1000);
}
    function initExchangeCalculator() {
  const rateEl = document.getElementById("rateKRW");
  const twdEl = document.getElementById("inputTWD");
  const krwEl = document.getElementById("inputKRW");

  if (!rateEl || !twdEl || !krwEl) return;

  // ë¬´í•œë£¨í”„ ë°©ì§€ í”Œë˜ê·¸
  let syncing = false;

  const parseNum = (v) => {
    if (v == null) return NaN;
    const x = String(v).replace(/,/g, "").trim();
    if (x === "") return NaN;
    return Number(x);
  };

  const fmt = (n) => {
    if (!isFinite(n)) return "";
    // ì†Œìˆ˜ëŠ” í•„ìš”í•  ë•Œë§Œ ë³´ì—¬ì£¼ê¸°
    const isInt = Math.abs(n - Math.round(n)) < 1e-10;
    return (isInt ? Math.round(n) : n).toLocaleString("ko-KR", {
      maximumFractionDigits: 2
    });
  };

  const getRate = () => {
    const r = Number(rateEl.value);
    return r > 0 ? r : 42; // ê¸°ë³¸ê°’
  };

  const updateFromTWD = () => {
    if (syncing) return;
    syncing = true;

    const twd = parseNum(twdEl.value);
    const rate = getRate();

    if (!isFinite(twd)) {
      krwEl.value = "";
      syncing = false;
      return;
    }

    const krw = twd * rate;
    krwEl.value = fmt(krw);
    syncing = false;
  };

  const updateFromKRW = () => {
    if (syncing) return;
    syncing = true;

    const krw = parseNum(krwEl.value);
    const rate = getRate();

    if (!isFinite(krw)) {
      twdEl.value = "";
      syncing = false;
      return;
    }

    const twd = krw / rate;
    twdEl.value = fmt(twd);
    syncing = false;
  };

  // ì…ë ¥ ì´ë²¤íŠ¸
  twdEl.addEventListener("input", updateFromTWD);
  krwEl.addEventListener("input", updateFromKRW);

  // í™˜ìœ¨ ë³€ê²½ ì‹œ: ë§ˆì§€ë§‰ìœ¼ë¡œ ì…ë ¥ëœ ê°’ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°
  rateEl.addEventListener("input", () => {
    // ë‘˜ ë‹¤ ê°’ì´ ìˆìœ¼ë©´ TWD ìš°ì„ , ì—†ìœ¼ë©´ KRW
    const hasT = String(twdEl.value).trim() !== "";
    const hasK = String(krwEl.value).trim() !== "";

    if (hasT) updateFromTWD();
    else if (hasK) updateFromKRW();
  });
}
const FX_CACHE_KEY = "fx_twd_krw_cache_v1";
const FX_CACHE_MS = 6 * 60 * 60 * 1000; // âœ… 6ì‹œê°„ ìºì‹œ (ì›í•˜ë©´ 24ì‹œê°„ìœ¼ë¡œ)

function fxParse(v) {
  if (v == null) return NaN;
  const x = String(v).replace(/,/g, "").trim();
  if (x === "") return NaN;
  return Number(x);
}

function fxFmt(n) {
  if (!isFinite(n)) return "";
  const isInt = Math.abs(n - Math.round(n)) < 1e-10;
  return (isInt ? Math.round(n) : n).toLocaleString("ko-KR", {
    maximumFractionDigits: 2
  });
}

/**
 * âœ… USD ê¸°ì¤€ ê³µê°œ í™˜ìœ¨í‘œë¥¼ ë°›ì•„ì„œ TWDâ†”KRW í™˜ìœ¨ ì‚°ì¶œ
 * 1 TWD = (KRW/USD) / (TWD/USD)
 */
async function fetchTwdToKrwRate() {
  const url = "https://open.er-api.com/v6/latest/USD"; // í‚¤ ì—†ìŒ
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("í™˜ìœ¨ API ì‹¤íŒ¨: " + res.status);

  const data = await res.json();
  const krwPerUsd = data?.rates?.KRW;
  const twdPerUsd = data?.rates?.TWD;

  if (!isFinite(krwPerUsd) || !isFinite(twdPerUsd)) {
    throw new Error("KRW/TWD í™˜ìœ¨ ë°ì´í„° ì—†ìŒ");
  }

  return {
    rate: krwPerUsd / twdPerUsd, // 1 TWD -> KRW
    updatedUtc: data.time_last_update_utc || ""
  };
}

function loadFxCache() {
  const raw = localStorage.getItem(FX_CACHE_KEY);
  if (!raw) return null;
  try {
    const v = JSON.parse(raw);
    if (!v.rate || !v.savedAt) return null;
    if (Date.now() - v.savedAt > FX_CACHE_MS) return null; // ë§Œë£Œ
    return v;
  } catch {
    return null;
  }
}

function saveFxCache(payload) {
  localStorage.setItem(FX_CACHE_KEY, JSON.stringify({
    rate: payload.rate,
    updatedUtc: payload.updatedUtc,
    savedAt: Date.now()
  }));
}

async function getFxRate({ force = false } = {}) {
  if (!force) {
    const cached = loadFxCache();
    if (cached) return cached;
  }
  const fresh = await fetchTwdToKrwRate();
  saveFxCache(fresh);
  return loadFxCache() || fresh;
}

function initExchangeCalculatorAuto() {
  const twdEl = document.getElementById("inputTWD");
  const krwEl = document.getElementById("inputKRW");

  const rateText = document.getElementById("fxRateText");
  const updatedText = document.getElementById("fxUpdatedText");
  const refreshBtn = document.getElementById("fxRefreshBtn");

  if (!twdEl || !krwEl || !rateText || !updatedText) return;

  let syncing = false;
  let rate = NaN; // 1 TWD -> KRW

  function updateFromTWD() {
    if (syncing) return;
    syncing = true;

    const twd = fxParse(twdEl.value);
    if (!isFinite(twd) || !isFinite(rate)) {
      krwEl.value = "";
      syncing = false;
      return;
    }
    krwEl.value = fxFmt(twd * rate);
    syncing = false;
  }

  function updateFromKRW() {
    if (syncing) return;
    syncing = true;

    const krw = fxParse(krwEl.value);
    if (!isFinite(krw) || !isFinite(rate) || rate === 0) {
      twdEl.value = "";
      syncing = false;
      return;
    }
    twdEl.value = fxFmt(krw / rate);
    syncing = false;
  }

  twdEl.addEventListener("input", updateFromTWD);
  krwEl.addEventListener("input", updateFromKRW);

  async function renderRate(force = false) {
    rateText.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
    try {
      const fx = await getFxRate({ force });
      rate = Number(fx.rate);

      rateText.textContent = fxFmt(rate);
      updatedText.textContent = fx.updatedUtc || "-";

      // ì´ë¯¸ ì…ë ¥ê°’ì´ ìˆìœ¼ë©´ ì¬ê³„ì‚°
      const hasT = String(twdEl.value).trim() !== "";
      const hasK = String(krwEl.value).trim() !== "";
      if (hasT) updateFromTWD();
      else if (hasK) updateFromKRW();

    } catch (e) {
      console.error(e);
      rateText.textContent = "ì‹¤íŒ¨";
      updatedText.textContent = "-";
      alert("í™˜ìœ¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
  }

  if (refreshBtn) {
    refreshBtn.addEventListener("click", () => renderRate(true));
  }

  // âœ… ìµœì´ˆ 1íšŒ ë¡œë”© (ìºì‹œ ìˆìœ¼ë©´ ìºì‹œ)
  renderRate(false);
}


</script>
<script>
(function () {
  let passed = false;

  function onScroll() {
    if (window.scrollY > 40 && !passed) {
      passed = true;
      document.body.classList.add("intro-passed");
    }
  }

  window.addEventListener("scroll", onScroll, { passive: true });
})();
</script>


</body>
</html>
