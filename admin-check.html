<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì ì¶œë°œ ì²´í¬</title>

  <!-- âœ… ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ ê³µìœ  -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">
</head>

<body class="logged-in">

<header class="header compact">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì ì¶œë°œ ì²´í¬</h1>
      <p class="sub">ì„ íƒê´€ê´‘ Â· ì¤‘ì‹ë¹„ Â· ì¶œë°œ í™•ì¸</p>
    </div>
  </div>
  <div class="header-right">
    <p class="welcome-text"><strong>ê´€ë¦¬ì ëª¨ë“œ</strong></p>
  </div>
</header>

<main id="mainSection">
  <div class="layout">

    <section class="content-area">
      <div class="main-panel">

        <!-- ================= QR SCAN ================= -->
        <div class="card">
          <h3>ğŸ“· QR ìŠ¤ìº”</h3>
          <video id="qrVideo" style="width:100%; border-radius:12px;" autoplay></video>
          <p class="hint">ì§ì› ê°œì¸ QRì„ ìŠ¤ìº”í•˜ì„¸ìš”</p>
        </div>

        <!-- ================= MANUAL INPUT ================= -->
        <div class="card">
          <h3>âŒ¨ï¸ ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥</h3>
          <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì…ë ¥">
          <button class="primary-btn" onclick="loadEmployeeById()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>

        <!-- ================= EMPLOYEE INFO ================= -->
        <div id="employeePanel" class="card" style="display:none;">
          <h3 id="empTitle">ì§ì› ì •ë³´</h3>

          <div class="info-row">
            <strong>ì‚¬ë²ˆ</strong>
            <span id="empId"></span>
          </div>
          <div class="info-row">
            <strong>ì´ë¦„</strong>
            <span id="empName"></span>
          </div>
          <div class="info-row">
            <strong>ì„ íƒê´€ê´‘</strong>
            <span id="empTour"></span>
          </div>

          <div class="action-box">
            <button class="primary-btn" onclick="markDeparture()">ğŸš ì¶œë°œ ì²´í¬</button>
            <button class="ghost-btn" onclick="payMeal()">ğŸœ ì¤‘ì‹ë¹„ ì§€ê¸‰</button>
          </div>

          <p id="actionResult" class="hint"></p>
        </div>

      </div>
    </section>

  </div>
</main>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= CONFIG ================= */
const EMP_URL = "people/employees.json";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxe8hQ9oGcL0z3N3y82dWaygu05sWI4CC6iLJYBb7vMm-9n8WURifONvPYb9ZUclr8M2A/exec";

let employees = [];
let currentEmployee = null;

/* ================= LOAD DATA ================= */
fetch(EMP_URL + "?ts=" + Date.now())
  .then(r => r.json())
  .then(d => employees = d);

/* ================= QR SCAN ================= */
const qrScanner = new Html5Qrcode("qrVideo");

Html5Qrcode.getCameras().then(devices => {
  if (devices.length) {
    qrScanner.start(
      devices[0].id,
      { fps: 10, qrbox: 250 },
      text => {
        handleScannedText(text);
      }
    );
  }
});

function handleScannedText(text) {
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (id) loadEmployee(id);
  } catch {
    // QRì´ URLì´ ì•„ë‹ ê²½ìš° ë¬´ì‹œ
  }
}

/* ================= MANUAL LOAD ================= */
function loadEmployeeById() {
  const id = document.getElementById("manualId").value.trim();
  loadEmployee(id);
}

/* ================= EMPLOYEE LOAD ================= */
function loadEmployee(id) {
  const emp = employees.find(e => e.id === id);
  if (!emp) {
    alert("í•´ë‹¹ ì‚¬ë²ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  currentEmployee = emp;

  document.getElementById("employeePanel").style.display = "block";
  document.getElementById("empTitle").textContent = `${emp.name}ë‹˜ ì •ë³´`;
  document.getElementById("empId").textContent = emp.id;
  document.getElementById("empName").textContent = emp.name;
  document.getElementById("empTour").textContent =
    emp.myTour?.length ? emp.myTour.join(", ") : "ì„ íƒê´€ê´‘ ì—†ìŒ";

  document.getElementById("actionResult").textContent = "";
}

/* ================= ACTIONS ================= */
function markDeparture() {
  if (!currentEmployee) return;

  sendToSheet({
    type: "departure",
    id: currentEmployee.id,
    name: currentEmployee.name,
    tour: currentEmployee.myTour?.join(", ") || "-"
  });

  showResult("ì¶œë°œ ì²´í¬ ì™„ë£Œ");
}

function payMeal() {
  if (!currentEmployee) return;

  sendToSheet({
    type: "meal",
    id: currentEmployee.id,
    name: currentEmployee.name,
    tour: "ë‹¨ìˆ˜ì´",
    action: "APPROVE",
    time: nowKST()
  });

  showResult("ì¤‘ì‹ë¹„ ì§€ê¸‰ ì²˜ë¦¬ ì™„ë£Œ");
}

/* ================= SHEET ================= */
function sendToSheet(payload) {
  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  });
}

function showResult(msg) {
  const el = document.getElementById("actionResult");
  el.textContent = msg;
  el.style.color = "#1f5fbf";
}

/* ================= UTIL ================= */
function nowKST() {
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    dateStyle: "short",
    timeStyle: "medium"
  }).format(new Date());
}
</script>

</body>
</html>
