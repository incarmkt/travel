<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì ì¶œë°œ ì²´í¬</title>

  <!-- ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ -->
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">
</head>

<body class="logged-in">

<header class="header compact">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì ì¶œë°œ ì²´í¬</h1>
      <p class="sub">ì¶œë°œ Â· ì„ íƒê´€ê´‘ Â· ì¤‘ì‹ë¹„</p>
    </div>
  </div>
  <div class="header-right">
    <p class="welcome-text"><strong>ê´€ë¦¬ì ëª¨ë“œ</strong></p>
  </div>
</header>

<main id="mainSection">
  <div class="layout">
    <section class="content-area">
      <div class="main-panel">

        <!-- ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= -->
        <div class="card" id="adminLogin">
          <h3>ğŸ” ê´€ë¦¬ì í™•ì¸</h3>
          <input type="password" id="adminCode" placeholder="ê´€ë¦¬ì ë²ˆí˜¸ ì…ë ¥">
          <button class="primary-btn" onclick="checkAdmin()">í™•ì¸</button>
          <p id="adminMsg" class="hint"></p>
        </div>

        <!-- ================= ê´€ë¦¬ì ë©”ì¸ ================= -->
        <div id="adminMain" style="display:none;">

          <!-- QR SCAN -->
          <div class="card">
            <h3>ğŸ“· QR ìŠ¤ìº”</h3>
            <div id="qrVideo"
                 style="width:100%; min-height:280px; background:#000; border-radius:12px;">
            </div>
            <p class="hint">ì§ì› ê°œì¸ QR ìŠ¤ìº”</p>
          </div>

          <!-- MANUAL INPUT -->
          <div class="card">
            <h3>âŒ¨ï¸ ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥</h3>
            <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì…ë ¥">
            <button class="primary-btn" onclick="loadEmployeeById()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>

          <!-- EMPLOYEE INFO -->
          <div id="employeePanel" class="card" style="display:none;">
            <h3 id="empTitle"></h3>

            <div class="info-row"><strong>ì‚¬ë²ˆ</strong><span id="empId"></span></div>
            <div class="info-row"><strong>ì´ë¦„</strong><span id="empName"></span></div>
            <div class="info-row"><strong>ì„ íƒê´€ê´‘</strong><span id="empTour"></span></div>

            <div class="action-box">
              <button class="primary-btn" onclick="markDeparture()">ğŸš ì¶œë°œ ì²´í¬</button>
              <button class="ghost-btn" onclick="payMeal()">ğŸœ ì¤‘ì‹ë¹„ ì§€ê¸‰</button>
            </div>

            <p id="actionResult" class="hint"></p>
          </div>

        </div>
      </div>
    </section>
  </div>
</main>

<!-- QR LIB -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= CONFIG ================= */
const ADMIN_CODE = "0000"; // ğŸ”¥ ê¸°ì¡´ ì¤‘ì‹ë¹„ ê´€ë¦¬ì ë²ˆí˜¸
const EMP_URL = "people/employees.json";
const GAS_URL = "https://script.google.com/macros/s/AKfycbxe8hQ9oGcL0z3N3y82dWaygu05sWI4CC6iLJYBb7vMm-9n8WURifONvPYb9ZUclr8M2A/exec";

let employees = [];
let currentEmployee = null;
let qrScanner = null;

/* ================= LOAD DATA ================= */
fetch(EMP_URL + "?ts=" + Date.now())
  .then(r => r.json())
  .then(d => employees = d);

/* ================= ADMIN LOGIN ================= */
function checkAdmin() {
  const input = document.getElementById("adminCode").value.trim();
  const msg = document.getElementById("adminMsg");

  if (input !== ADMIN_CODE) {
    msg.textContent = "ê´€ë¦¬ì ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    msg.style.color = "red";
    return;
  }

  msg.textContent = "ê´€ë¦¬ì í™•ì¸ ì™„ë£Œ";
  msg.style.color = "#1f5fbf";
  document.getElementById("adminMain").style.display = "block";
  startQR();
}

/* ================= QR SCAN ================= */
function startQR() {
  qrScanner = new Html5Qrcode("qrVideo");

  Html5Qrcode.getCameras().then(devices => {
    if (!devices.length) return;

    const backCam =
      devices.find(d => d.label.toLowerCase().includes("back")) ||
      devices[devices.length - 1];

    qrScanner.start(
      backCam.id,
      { fps: 10, qrbox: { width: 250, height: 250 } },
      text => handleScannedText(text),
      () => {}
    );
  });
}

function handleScannedText(text) {
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (id) loadEmployee(id);
  } catch {}
}

/* ================= MANUAL ================= */
function loadEmployeeById() {
  loadEmployee(document.getElementById("manualId").value.trim());
}

/* ================= EMPLOYEE ================= */
function loadEmployee(id) {
  const emp = employees.find(e => e.id === id);
  if (!emp) return alert("ì‚¬ë²ˆ ì—†ìŒ");

  currentEmployee = emp;
  document.getElementById("employeePanel").style.display = "block";
  document.getElementById("empTitle").textContent = `${emp.name}ë‹˜ ì •ë³´`;
  document.getElementById("empId").textContent = emp.id;
  document.getElementById("empName").textContent = emp.name;
  document.getElementById("empTour").textContent =
    emp.myTour?.length ? emp.myTour.join(", ") : "ì„ íƒê´€ê´‘ ì—†ìŒ";
}

/* ================= ACTION ================= */
function markDeparture() {
  sendToSheet({
    type: "departure",
    id: currentEmployee.id,
    name: currentEmployee.name,
    tour: currentEmployee.myTour?.join(", ") || "-"
  });
  showResult("ì¶œë°œ ì²´í¬ ì™„ë£Œ");
}

function payMeal() {
  sendToSheet({
    type: "meal",
    id: currentEmployee.id,
    name: currentEmployee.name,
    tour: "ë‹¨ìˆ˜ì´",
    action: "APPROVE",
    time: nowKST()
  });
  showResult("ì¤‘ì‹ë¹„ ì§€ê¸‰ ì™„ë£Œ");
}

/* ================= SHEET ================= */
function sendToSheet(payload) {
  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  });
}

/* ================= UI ================= */
function showResult(msg) {
  const el = document.getElementById("actionResult");
  el.textContent = msg;
  el.style.color = "#1f5fbf";
}

function nowKST() {
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    dateStyle: "short",
    timeStyle: "medium"
  }).format(new Date());
}
</script>

</body>
</html>
