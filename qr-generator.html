<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ISC ì§ì› QR ë° ëª…ì°° ìƒì„±ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- QR ìƒì„± -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <!-- ZIP ë‹¤ìš´ë¡œë“œ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body{
      font-family: system-ui, -apple-system, sans-serif;
      background:#f6f7fb;
      padding:20px;
      margin:0;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    h1{margin:0;}
    .muted{color:#667085;font-size:13px;margin:6px 0 0;}
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
      background:#111827;
      color:#fff;
      transition: all 0.2s ease;
    }
    .btn:hover { background: #1f2937; }
    
    .btn.secondary{
      background:#fff;
      color:#111827;
      border:1px solid #e5e7eb;
    }
    .btn.secondary:hover { background: #f9fafb; }
    
    .btn.primary {
      background: #3b82f6;
      color: #fff;
    }
    .btn.primary:hover { background: #2563eb; }

    .grid{
      display:grid;
      /* ë²„íŠ¼ì´ 3ê°œë¡œ ëŠ˜ì–´ë‚˜ ì¹´ë“œê°€ ì¢ì•„ì§€ì§€ ì•Šë„ë¡ ìµœì†Œ ë„ˆë¹„ë¥¼ 220pxë¡œ ì¡°ì • */
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap:14px;
    }
    .card{
      background:#fff;
      border-radius:14px;
      padding:16px 12px;
      text-align:center;
      box-shadow:0 4px 10px rgba(0,0,0,.05);
      border:1px solid #eef2f7;
    }
    .name{font-weight:800;margin-top:12px; font-size: 16px;}
    .id{font-size:12px;color:#6b7280;margin-top:4px;}
    .mini-actions{
      margin-top:14px;
      display:flex;
      gap:6px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .mini-actions button{
      font-size:11px;
      padding:8px;
      border-radius:8px;
      flex: 1; /* ë²„íŠ¼ë“¤ì„ ê· ë“±í•œ ë„ˆë¹„ë¡œ */
    }
    .status{
      margin-top:10px;
      font-size:13px;
      color:#111827;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:10px 12px;
    }
    .status.good{border-color:#bbf7d0; background:#f0fdf4; color:#166534;}
    .status.bad{border-color:#fecaca; background:#fef2f2; color:#991b1b;}
    .hidden{display:none;}
  </style>
</head>
<body>

  <div class="topbar">
    <div style="flex:1; min-width:220px;">
      <h1>ISC ì§ì› QR & ëª…ì°° ìƒì„±ê¸°</h1>
      <div class="muted">
        QR ë‚´ìš©ì€ <b>https://incarmkt.github.io/travel/?eid=ì‚¬ë²ˆ</b> í˜•ì‹ì…ë‹ˆë‹¤.
      </div>
    </div>

    <button id="btnReload" class="btn secondary">ìƒˆë¡œê³ ì¹¨(ëª©ë¡ ì¬ë¡œë“œ)</button>
    <button id="btnZip" class="btn">QRë§Œ ì „ì²´ ZIP</button>
    <!-- ğŸ”¥ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ì „ì²´ ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
    <button id="btnNameTagZip" class="btn primary">ì „ì²´ ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <div id="statusBox" class="status hidden"></div>

  <div id="qrGrid" class="grid"></div>

<script>
/* ==============================
   ì„¤ì •
============================== */
const EMP_URL  = "people/employees.json?ts=" + Date.now();
const BASE_URL = "https://incarmkt.github.io/travel/?eid=";

/* ==============================
   ìƒíƒœ
============================== */
let employees = [];

/* ==============================
   ìœ í‹¸
============================== */
function setStatus(msg, kind=""){
  const box = document.getElementById("statusBox");
  box.classList.remove("hidden","good","bad");
  if(kind==="good") box.classList.add("good");
  if(kind==="bad") box.classList.add("bad");
  box.textContent = msg;
}

function clearStatus(){
  const box = document.getElementById("statusBox");
  box.classList.add("hidden");
  box.textContent = "";
}

function safeName(str){
  return String(str || "").replace(/[\\/:*?"<>|]/g, "_").trim();
}

function dataURLtoBase64(dataUrl){
  return dataUrl.split(",")[1];
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

/* ==============================
   ğŸ”¥ ëª…ì°° ì´ë¯¸ì§€(Canvas) ìƒì„± ë¡œì§
============================== */
async function createNameTagCanvas(emp, qrDataUrl) {
  const canvas = document.createElement('canvas');
  // ëª…ì°° ì‹¤ë¬¼ ë¹„ìœ¨ (ì•½ 2:3, ì˜ˆ: 54x86mm ë¹„ìœ¨) 
  canvas.width = 600;
  canvas.height = 900;
  const ctx = canvas.getContext('2d');

  // 1. ì „ì²´ ë°°ê²½ (ì—°í•œ íšŒìƒ‰í†¤)
  ctx.fillStyle = "#f8fafc";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // 2. ìƒë‹¨ í—¤ë” ì˜ì—­ (ISC ë‹¤í¬ ë„¤ì´ë¹„)
  ctx.fillStyle = "#111827"; 
  ctx.fillRect(0, 0, canvas.width, 180);
  
  // í—¤ë” í•˜ë‹¨ í¬ì¸íŠ¸ ë¼ì¸ (ë¸”ë£¨)
  ctx.fillStyle = "#3b82f6";
  ctx.fillRect(0, 180, canvas.width, 10);

  // 3. ìƒë‹¨ í…ìŠ¤íŠ¸ (í–‰ì‚¬ëª…)
  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 34px system-ui, -apple-system, sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("ISC OVERSEAS WORKSHOP", 300, 80);
  
  ctx.fillStyle = "#9ca3af";
  ctx.font = "24px system-ui, -apple-system, sans-serif";
  ctx.fillText("TAIWAN 2026", 300, 130);

  // 4. ì‚¬ì› ì •ë³´
  // JSONì— ë¶€ì„œ(department) ì •ë³´ê°€ ìˆë‹¤ë©´ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì ìš©
  const dept = emp.department || emp.team || "ISC ì„ì§ì›";
  
  ctx.fillStyle = "#3b82f6"; // íŒŒë€ìƒ‰ ì†Œì† í…ìŠ¤íŠ¸
  ctx.font = "bold 28px system-ui, -apple-system, sans-serif";
  ctx.fillText(dept, 300, 310);

  ctx.fillStyle = "#111827"; // ì´ë¦„
  ctx.font = "bold 76px system-ui, -apple-system, sans-serif";
  ctx.fillText(emp.name, 300, 400);

  ctx.fillStyle = "#6b7280"; // ì‚¬ë²ˆ
  ctx.font = "26px system-ui, -apple-system, sans-serif";
  ctx.fillText(`ID : ${emp.id}`, 300, 450);

  // 5. í•˜ë‹¨ QR ì˜ì—­ ë°°ê²½ (ê·¸ë¦¼ì íš¨ê³¼)
  ctx.fillStyle = "#ffffff";
  ctx.shadowColor = "rgba(0,0,0,0.1)";
  ctx.shadowBlur = 15;
  ctx.shadowOffsetY = 5;
  ctx.fillRect(140, 500, 320, 320); // í°ìƒ‰ ë°•ìŠ¤
  ctx.shadowColor = "transparent"; // ê·¸ë¦¼ì ë¦¬ì…‹

  // 6. QR ì½”ë“œ í•©ì„±
  const qrImg = new Image();
  qrImg.src = qrDataUrl;
  await new Promise(r => qrImg.onload = r);

  // QR ì´ë¯¸ì§€ë¥¼ ë°•ìŠ¤ ì•ˆì— ë°°ì¹˜ (ì—¬ë°± í¬í•¨)
  ctx.drawImage(qrImg, 150, 510, 300, 300);

  // 7. í…Œë‘ë¦¬ (ì¸ì‡„ìš© ì»·íŒ… ê°€ì´ë“œë¼ì¸ ëŠë‚Œ)
  ctx.strokeStyle = "#e2e8f0";
  ctx.lineWidth = 2;
  ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);

  return canvas;
}

/* ==============================
   ë Œë”
============================== */
function renderGrid(list){
  const grid = document.getElementById("qrGrid");
  grid.innerHTML = "";

  list.forEach(emp => {
    const card = document.createElement("div");
    card.className = "card";

    const qrBox = document.createElement("div");
    qrBox.style.display = "inline-block";
    qrBox.style.padding = "6px";
    qrBox.style.background = "#fff";
    qrBox.style.borderRadius = "12px";
    qrBox.style.border = "1px solid #eef2f7";

    card.appendChild(qrBox);

    // âœ… ê¸°ì¡´ QR ìƒì„± ìœ ì§€
    const qrText = BASE_URL + String(emp.id).trim();

    new QRCode(qrBox, {
      text: qrText,
      width: 140,
      height: 140
    });

    const nameEl = document.createElement("div");
    nameEl.className = "name";
    nameEl.textContent = emp.name;

    const idEl = document.createElement("div");
    idEl.className = "id";
    idEl.textContent = emp.id;

    const actions = document.createElement("div");
    actions.className = "mini-actions";

    // --- ê¸°ì¡´ ë²„íŠ¼ë“¤ ---
    const btnCopy = document.createElement("button");
    btnCopy.className = "btn secondary";
    btnCopy.textContent = "ë§í¬ë³µì‚¬";
    btnCopy.onclick = async () => {
      try{
        await navigator.clipboard.writeText(qrText);
        setStatus(`${emp.name} (${emp.id}) ë§í¬ ë³µì‚¬ ì™„ë£Œ`, "good");
      }catch{
        setStatus("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)", "bad");
      }
    };

    const btnPng = document.createElement("button");
    btnPng.className = "btn secondary";
    btnPng.textContent = "QRë‹¤ìš´";
    btnPng.onclick = async () => {
      try{
        await sleep(30);
        const img = qrBox.querySelector("img");
        const canvas = qrBox.querySelector("canvas");
        let dataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");

        if(!dataUrl) throw new Error("QR ë Œë” ìš”ì†Œ ì—†ìŒ");

        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = `${safeName(emp.id)}_${safeName(emp.name)}_QR.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setStatus(`${emp.name} (${emp.id}) QR ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, "good");
      }catch(e){
        console.error(e);
        setStatus("PNG ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨", "bad");
      }
    };

    // ğŸ”¥ ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ëª…ì°° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
    const btnNameTag = document.createElement("button");
    btnNameTag.className = "btn primary";
    btnNameTag.textContent = "ëª…ì°°ë‹¤ìš´";
    btnNameTag.onclick = async () => {
      try{
        await sleep(30);
        const img = qrBox.querySelector("img");
        const canvas = qrBox.querySelector("canvas");
        let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
        
        if(!qrDataUrl) throw new Error("QR ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨");

        // ëª…ì°° ìº”ë²„ìŠ¤ í•©ì„±
        const nameTagCanvas = await createNameTagCanvas(emp, qrDataUrl);
        
        const a = document.createElement("a");
        a.href = nameTagCanvas.toDataURL("image/png");
        a.download = `${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        setStatus(`${emp.name} (${emp.id}) ëª…ì°° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`, "good");
      }catch(e){
        console.error(e);
        setStatus("ëª…ì°° ìƒì„± ì‹¤íŒ¨", "bad");
      }
    };

    actions.appendChild(btnCopy);
    actions.appendChild(btnPng);
    actions.appendChild(btnNameTag); // ë²„íŠ¼ ì¶”ê°€

    card.appendChild(nameEl);
    card.appendChild(idEl);
    card.appendChild(actions);

    grid.appendChild(card);
  });

  clearStatus();
}

/* ==============================
   ì§ì› ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ ë™ì¼)
============================== */
async function loadEmployees(){
  setStatus("ì§ì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", "");
  try{
    const res = await fetch(EMP_URL, { cache:"no-store" });
    employees = await res.json();

    employees.sort((a,b) => String(a.id).localeCompare(String(b.id), "ko"));

    renderGrid(employees);
    setStatus(`ì§ì› ${employees.length}ëª… ë¡œë“œ ì™„ë£Œ`, "good");
  }catch(e){
    console.error(e);
    setStatus("employees.json ë¡œë“œ ì‹¤íŒ¨ (ê²½ë¡œ/ë°°í¬ í™•ì¸)", "bad");
  }
}

/* ==============================
   ì „ì²´ QR ZIP ë‹¤ìš´ë¡œë“œ (ê¸°ì¡´ ìœ ì§€)
============================== */
async function downloadZipAll(){
  if(!employees.length) return setStatus("ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", "bad");
  setStatus("QR ZIP ìƒì„± ì¤‘...", "");
  try{
    const zip = new JSZip();
    const folder = zip.folder("ISC_QR");

    for(let i=0; i<employees.length; i++){
      const emp = employees[i];
      setStatus(`QR ZIP ìƒì„± ì¤‘... ${i+1}/${employees.length} (${emp.name})`, "");

      const temp = document.createElement("div");
      temp.style.position = "fixed"; temp.style.left = "-9999px";
      document.body.appendChild(temp);

      new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 320, height: 320 });
      await sleep(60);

      const img = temp.querySelector("img");
      const canvas = temp.querySelector("canvas");
      let dataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");

      const base64 = dataURLtoBase64(dataUrl);
      folder.file(`${safeName(emp.id)}_${safeName(emp.name)}.png`, base64, { base64:true });
      temp.remove();
    }
    const blob = await zip.generateAsync({ type:"blob" });
    saveAs(blob, "ISC_ì§ì›_QRì „ì²´.zip");
    setStatus("QR ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ…", "good");
  }catch(e){
    console.error(e);
    setStatus("ZIP ìƒì„± ì‹¤íŒ¨", "bad");
  }
}

/* ==============================
   ğŸ”¥ ì „ì²´ ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ (ì‹ ê·œ)
============================== */
async function downloadNameTagZipAll(){
  if(!employees.length) return setStatus("ì§ì› ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.", "bad");
  setStatus("ëª…ì°° ZIP ìƒì„± ì¤‘... (ë””ìì¸ í•©ì„± ì¤‘ì´ë¯€ë¡œ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "");
  
  try{
    const zip = new JSZip();
    const folder = zip.folder("ISC_ëª…ì°°_ì¶œë ¥ìš©");

    for(let i=0; i<employees.length; i++){
      const emp = employees[i];
      setStatus(`ëª…ì°° ZIP ìƒì„± ì¤‘... ${i+1}/${employees.length} (${emp.name})`, "");

      // 1. ì„ì‹œ ê³ í•´ìƒë„ QR ìƒì„±
      const temp = document.createElement("div");
      temp.style.position = "fixed"; temp.style.left = "-9999px";
      document.body.appendChild(temp);

      new QRCode(temp, { text: BASE_URL + String(emp.id).trim(), width: 400, height: 400 });
      await sleep(60); // ë Œë”ë§ ëŒ€ê¸°

      const img = temp.querySelector("img");
      const canvas = temp.querySelector("canvas");
      let qrDataUrl = img && img.src ? img.src : (canvas ? canvas.toDataURL("image/png") : "");
      temp.remove();

      // 2. ëª…ì°° ë””ìì¸ í•©ì„±
      const nameTagCanvas = await createNameTagCanvas(emp, qrDataUrl);
      const base64 = dataURLtoBase64(nameTagCanvas.toDataURL("image/png"));
      
      // 3. ZIPì— ì¶”ê°€
      folder.file(`${safeName(emp.id)}_${safeName(emp.name)}_ëª…ì°°.png`, base64, { base64:true });
    }

    const blob = await zip.generateAsync({ type:"blob" });
    saveAs(blob, "ISC_ëª…ì°°_ì¶œë ¥ìš©_ì „ì²´.zip");
    setStatus("ëª…ì°° ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ âœ… (ë°”ë¡œ ì¸ì‡„ì†Œì— ë„˜ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤)", "good");
  }catch(e){
    console.error(e);
    setStatus("ëª…ì°° ZIP ìƒì„± ì‹¤íŒ¨", "bad");
  }
}

/* ==============================
   ì´ë²¤íŠ¸ ë°”ì¸ë”©
============================== */
document.getElementById("btnReload").addEventListener("click", loadEmployees);
document.getElementById("btnZip").addEventListener("click", downloadZipAll);
document.getElementById("btnNameTagZip").addEventListener("click", downloadNameTagZipAll);

/* ìµœì´ˆ ë¡œë“œ */
loadEmployees();
</script>

</body>
</html>
