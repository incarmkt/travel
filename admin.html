<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISC ê´€ë¦¬ì | ì¶œë°œ ì²´í¬</title>

  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/desktop.css" media="(min-width: 768px)">
  <link rel="stylesheet" href="css/mobile.css" media="(max-width: 767px)">

  <style>
    /* ===== ê´€ë¦¬ì QR í™”ë©´ ì•ˆì •í™” ì „ìš© ===== */
    #qrReader {
      width: 100%;
      max-width: 360px;
      aspect-ratio: 1 / 1;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }

    .scan-wrap {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .manual-input {
      width: 100%;
      max-width: 360px;
      display: flex;
      gap: 8px;
    }

    .manual-input input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d0d5dd;
    }

    .scan-result {
      font-weight: 700;
      text-align: center;
      min-height: 20px;
    }
  </style>
</head>

<body class="logged-in">

<header class="header compact">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1 id="headerTitle">ê´€ë¦¬ì ì¶œë°œ ì²´í¬</h1>
      <p class="sub">ì¼ì • ì„ íƒ â†’ QR ë˜ëŠ” ì‚¬ë²ˆ ì…ë ¥</p>
    </div>
  </div>
  <div class="header-right">
    <p class="welcome-text"><strong>ê´€ë¦¬ì ëª¨ë“œ</strong></p>
  </div>
</header>

<main id="mainSection">
  <div class="layout">
    <section class="content-area">
      <div class="main-panel">

        <!-- STEP 1 : ì¼ì • ì„ íƒ -->
        <div id="scheduleArea"></div>

        <!-- STEP 2 : QR -->
        <div id="scanSection" class="card" style="display:none;">
          <h3 id="scanTitle"></h3>

          <div class="scan-wrap">
            <div id="qrReader"></div>

            <div class="manual-input">
              <input type="text" id="manualId" placeholder="ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥">
              <button class="ghost-btn" onclick="manualCheck()">ë“±ë¡</button>
            </div>

            <div id="scanResult" class="scan-result"></div>

            <button class="ghost-btn" onclick="closeScanner()">â† ì¼ì •ìœ¼ë¡œ</button>
          </div>
        </div>

      </div>
    </section>
  </div>
</main>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= CONFIG ================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbywujbffRaXimjgXIjZkeyLv0kea2tDe17jtBmMvLjs6gFB0dz16Xkfj4mJLMN2mof83w/exec";
const EMP_URL = "people/employees.json";

/* ================= STATE ================= */
let employees = [];
let currentCourse = "";
let qrScanner = null;

/* ================= ê³ ê°ìš© ì¼ì • ê·¸ëŒ€ë¡œ ë³µì‚¬ ================= */
const travelSchedule = [
  {
    day: "DAY 1",
    date: "2026.03.11 (ìˆ˜)",
    title: "ì¸ì²œ â†’ íƒ€ì´ë² ì´ / ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸",
    items: [
      { time:"08:00", title:"ì¸ì²œ êµ­ì œê³µí•­ ì¶œë°œ" },
      { time:"14:00", title:"ì¤‘ì •ê¸°ë…ë‹¹" },
      { time:"15:30", title:"êµ­ë¦½ê³ ê¶ë°•ë¬¼ê´€" },
      { time:"20:00", title:"íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€" }
    ]
  },
  {
    day: "DAY 2",
    date: "2026.03.12 (ëª©)",
    title: "ì„ íƒ ê´€ê´‘ / ë§Œì°¬",
    items: [
      { time:"09:00", title:"ì„ íƒ ê´€ê´‘" },
      { time:"18:00", title:"ISC ë§Œì°¬" }
    ]
  },
  {
    day: "DAY 3",
    date: "2026.03.13 (ê¸ˆ)",
    title: "ê·¼êµ ê´€ê´‘",
    items: [
      { time:"10:00", title:"ì•¼ë¥˜ í•´ìƒê³µì›" },
      { time:"14:00", title:"ì§€ìš°í€" }
    ]
  }
];

/* ================= LOAD ================= */
fetch(EMP_URL + "?ts=" + Date.now())
  .then(r => r.json())
  .then(d => employees = d);

renderSchedule();

/* ================= RENDER ================= */
function renderSchedule() {
  const area = document.getElementById("scheduleArea");
  area.innerHTML = travelSchedule.map(day => `
    <div class="day-card">
      <h3>${day.day} <span>${day.date}</span></h3>
      <p class="day-title">${day.title}</p>

      ${day.items.map(i => `
        <button class="primary-btn"
          style="width:100%; margin-bottom:8px;"
          onclick="openScanner('${i.title}')">
          â° ${i.time} | ${i.title}
        </button>
      `).join("")}
    </div>
  `).join("");
}

/* ================= QR ================= */
function openScanner(course) {
  currentCourse = course;
  document.getElementById("scheduleArea").style.display = "none";
  document.getElementById("scanSection").style.display = "block";
  document.getElementById("scanTitle").textContent = `ğŸ“ ${course} ì¶œë°œ ì²´í¬`;
  startQR();
}

function startQR() {
  if (qrScanner) return;

  qrScanner = new Html5Qrcode("qrReader");
  Html5Qrcode.getCameras().then(devices => {
    const cam = devices.find(d => /back|rear/i.test(d.label)) || devices[0];
    qrScanner.start(cam.id, { fps: 10 }, handleQR);
  });
}

function handleQR(text) {
  try {
    const url = new URL(text);
    const id = url.searchParams.get("eid");
    if (id) processDeparture(id);
  } catch {}
}

function manualCheck() {
  const id = document.getElementById("manualId").value.trim();
  if (id) processDeparture(id);
}

function processDeparture(id) {
  const emp = employees.find(e => e.id === id);
  const result = document.getElementById("scanResult");

  if (!emp) {
    result.textContent = "âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆ";
    result.style.color = "#dc2626";
    return;
  }

  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "departure",
      id: emp.id,
      name: emp.name,
      category: "ì „ì²´ì¼ì •",
      course: currentCourse,
      time: nowKST()
    })
  });

  result.textContent = `âœ… ${emp.name} ì¶œë°œ ë“±ë¡ ì™„ë£Œ`;
  result.style.color = "#16a34a";
  document.getElementById("manualId").value = "";
}

function closeScanner() {
  qrScanner?.stop().then(() => {
    qrScanner.clear();
    qrScanner = null;
  });
  document.getElementById("scanSection").style.display = "none";
  document.getElementById("scheduleArea").style.display = "block";
  document.getElementById("scanResult").textContent = "";
}

function nowKST() {
  return new Intl.DateTimeFormat("ko-KR", {
    timeZone: "Asia/Seoul",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  }).format(new Date());
}
</script>

</body>
</html>
