<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ISC ê´€ë¦¬ì</title>

<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/desktop.css" media="(min-width:768px)">
<link rel="stylesheet" href="css/mobile.css" media="(max-width:767px)">

<style>
.admin-hidden { display:none !important; }

/* QR í™”ë©´ì—ì„œë§Œ ìŠ¤í¬ë¡¤ ì ê¸ˆ */
body.qr-mode {
  overflow: hidden !important;
}

#qrReader {
  width: 100%;
  max-width: 360px;
  aspect-ratio: 1 / 1;
  background: #000;
  border-radius: 12px;
  margin: 0 auto;
}

.qr-wrap {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}
</style>
</head>

<body>

<!-- ================= ê´€ë¦¬ì ë¡œê·¸ì¸ ================= -->
<section id="adminLogin" class="login-hero">
  <div class="hero-overlay">
    <div class="login-box">
      <img src="assets/images/logo.png" class="hero-logo">
      <h2>ISC ê´€ë¦¬ì</h2>
      <p class="hero-desc">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</p>
      <input type="password" id="adminPw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
      <button type="button" class="primary-btn" onclick="adminLogin()">ë¡œê·¸ì¸</button>
      <p id="adminLoginError" class="error"></p>
    </div>
  </div>
</section>

<!-- ================= ê´€ë¦¬ì í—¤ë” ================= -->
<header id="adminHeader" class="header compact admin-hidden">
  <div class="header-left">
    <img src="assets/images/logo.png" class="logo">
    <div>
      <h1>ISC ê´€ë¦¬ì</h1>
      <p class="sub" id="adminSub"></p>
    </div>
  </div>
</header>

<!-- ================= ë©”ì¸ ================= -->
<main id="adminMain" class="admin-hidden">

  <!-- ê´€ë¦¬ì ë©”ì¸ -->
  <section id="pageMain" class="content-area">
    <div class="main-panel">
      <button class="primary-btn" onclick="openPage('Travel')">ì—¬í–‰ ì¼ì • ê´€ë¦¬</button>
      <button class="primary-btn">ì¤‘ì‹ë¹„ ê´€ë¦¬</button>
      <button class="primary-btn">ê³ ê° ì •ë³´</button>
    </div>
  </section>

  <!-- ì—¬í–‰ ê´€ë¦¬ -->
  <section id="pageTravel" class="content-area admin-hidden">
    <div class="main-panel">
      <button class="primary-btn" onclick="openSchedule('ì „ì²´ì¼ì •')">ì „ì²´ ê´€ê´‘ ì¶œë°œ ì²´í¬</button>
      <button class="primary-btn" onclick="openSchedule('ì„ íƒê´€ê´‘')">ì„ íƒ ê´€ê´‘ ì¶œë°œ ì²´í¬</button>
      <button class="ghost-btn" onclick="goBack()">â† ë’¤ë¡œ</button>
    </div>
  </section>

  <!-- ì¼ì • ë¦¬ìŠ¤íŠ¸ -->
  <section id="pageSchedule" class="content-area admin-hidden"></section>

  <!-- QR -->
  <section id="pageQR" class="content-area admin-hidden">
    <div class="card">
      <h3 id="qrTitle"></h3>
      <div class="qr-wrap">
        <div id="qrReader"></div>
        <input id="manualId" placeholder="ì‚¬ë²ˆ ì§ì ‘ ì…ë ¥">
        <button class="ghost-btn" onclick="manualCheck()">ë“±ë¡</button>
        <div id="qrResult"></div>
        <button class="ghost-btn" onclick="goBack()">â† ë’¤ë¡œ</button>
      </div>
    </div>
  </section>

</main>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ================= ì„¤ì • ================= */
const ADMIN_PASSWORD = "0000";
const GAS_URL = "https://script.google.com/macros/s/AKfycbywujbffRaXimjgXIjZkeyLv0kea2tDe17jtBmMvLjs6gFB0dz16Xkfj4mJLMN2mof83w/exec";
const EMP_URL = "people/employees.json";

let employees = [];
let pageStack = [];
let currentCategory = "";
let currentCourse = "";
let qrScanner = null;

/* ================= ë¡œê·¸ì¸ ================= */
function adminLogin() {
  const pw = document.getElementById("adminPw").value.trim();
  if (pw !== ADMIN_PASSWORD) {
    document.getElementById("adminLoginError").textContent = "ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜";
    return;
  }
  document.getElementById("adminLogin").style.display = "none";
  document.getElementById("adminHeader").classList.remove("admin-hidden");
  document.getElementById("adminMain").classList.remove("admin-hidden");
  document.body.classList.add("logged-in");
}

/* ================= ë„¤ë¹„ ================= */
function hideAll() {
  document.querySelectorAll("main > section").forEach(s => s.classList.add("admin-hidden"));
}

function openPage(page) {
  hideAll();
  pageStack.push(page);
  document.getElementById("page" + page).classList.remove("admin-hidden");
}

function goBack() {
  pageStack.pop();
  hideAll();
  const prev = pageStack[pageStack.length - 1] || "Main";
  document.getElementById("page" + prev).classList.remove("admin-hidden");
  document.body.classList.remove("qr-mode");

  if (qrScanner) {
    qrScanner.stop().then(() => {
      qrScanner.clear();
      qrScanner = null;
    });
  }
}

/* ================= ì¼ì • ================= */
function openSchedule(cat) {
  currentCategory = cat;
  hideAll();
  pageStack.push("Schedule");
  renderScheduleForAdmin();
  document.getElementById("pageSchedule").classList.remove("admin-hidden");
}

/* ================= QR ================= */
function openQR(course) {
  currentCourse = course;
  hideAll();
  pageStack.push("QR");
  document.getElementById("pageQR").classList.remove("admin-hidden");
  document.body.classList.add("qr-mode");
  document.getElementById("qrTitle").textContent = `${course} ì¶œë°œ ì²´í¬`;
  startQR();
}

function startQR() {
  qrScanner = new Html5Qrcode("qrReader");
  Html5Qrcode.getCameras().then(cams => {
    const cam = cams.find(c => /back/i.test(c.label)) || cams[0];
    qrScanner.start(cam.id, { fps: 10, qrbox: 250 }, handleQR);
  });
}

function handleQR(text) {
  try {
    const id = new URL(text).searchParams.get("eid");
    if (id) processDeparture(id);
  } catch {}
}

function manualCheck() {
  processDeparture(document.getElementById("manualId").value.trim());
}

function processDeparture(id) {
  const emp = employees.find(e => e.id === id);
  if (!emp) {
    document.getElementById("qrResult").textContent = "âŒ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ë²ˆ";
    return;
  }

  fetch(GAS_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      type: "departure",
      id: emp.id,
      name: emp.name,
      category: currentCategory,
      course: currentCourse,
      time: new Date().toLocaleString("ko-KR",{timeZone:"Asia/Seoul"})
    })
  });

  document.getElementById("qrResult").textContent =
    `âœ… ${emp.name} / ${currentCourse} ì¶œë°œ ì™„ë£Œ`;
}

/* ================= ì§ì› ================= */
fetch(EMP_URL).then(r=>r.json()).then(d=>employees=d);

/* ================= ì—¬í–‰ ì¼ì • (ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€) ================= */
const travelSchedule = [
  {
    day: "DAY 1",
    date: "2026.03.11 (ìˆ˜)",
    title: "ì¸ì²œ â†’ íƒ€ì´ë² ì´ / ì‹œë‚´ í•˜ì´ë¼ì´íŠ¸",
    items: [
      { time:"08:00", icon:"âœˆï¸", title:"ì¸ì²œ êµ­ì œê³µí•­ ì¶œë°œ", desc:"OZ 711 / KE 2021" },
      { time:"12:30", icon:"ğŸœ", title:"ì¤‘ì‹ | ìš°ìœ¡ë©´", desc:"í˜„ì§€ ì¸ê¸° ì¤‘ì‹ë‹¹" },
      { time:"14:00", icon:"ğŸ›ï¸", title:"ì¤‘ì •ê¸°ë…ë‹¹", desc:"ì¥ê°œì„ ì´í†µ ê¸°ë…ê´€" },
      { time:"15:30", icon:"ğŸº", title:"êµ­ë¦½ê³ ê¶ë°•ë¬¼ê´€", desc:"ì„¸ê³„ 4ëŒ€ ë°•ë¬¼ê´€" },
      { time:"18:30", icon:"ğŸ½ï¸", title:"ì„ì‹ | íƒ€ì¹´ì˜¤ ìƒ¤ë¸Œìƒ¤ë¸Œ", desc:"í˜„ì§€ì‹" },
      { time:"20:00", icon:"ğŸŒƒ", title:"íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€", desc:"ì•¼ê²½ ê´€ëŒ" }
    ]
  },
  {
    day: "DAY 2",
    date: "2026.03.12 (ëª©)",
    title: "ì„ íƒ ê´€ê´‘ / ë§Œì°¬",
    items: [
      { time:"09:00", icon:"ğŸšŒ", title:"ì„ íƒ ê´€ê´‘", desc:"ê°œì¸ ì„ íƒ ì¼ì •" },
      { time:"18:00", icon:"ğŸ‰", title:"ISC ë§Œì°¬", desc:"í•„ìˆ˜ ì°¸ì„" }
    ]
  },
  {
    day: "DAY 3",
    date: "2026.03.13 (ê¸ˆ)",
    title: "ê·¼êµ ê´€ê´‘",
    items: [
      { time:"10:00", icon:"ğŸŒŠ", title:"ì•¼ë¥˜ í•´ìƒê³µì›", desc:"ê¸°ì•”ê´´ì„ ê´€ê´‘" },
      { time:"14:00", icon:"ğŸ®", title:"ì§€ìš°í€", desc:"í™ë“± ë§ˆì„" }
    ]
  },
  {
    day: "DAY 4",
    date: "2026.03.14 (í† )",
    title: "ê·€êµ­",
    items: [
      { time:"07:00", icon:"ğŸ¨", title:"í˜¸í…” ì²´í¬ì•„ì›ƒ", desc:"" },
      { time:"11:40", icon:"âœˆï¸", title:"íƒ€ì´ë² ì´ ì¶œë°œ", desc:"OZ 712 / KE 2022" },
      { time:"15:25", icon:"ğŸ‡°ğŸ‡·", title:"ì¸ì²œ ë„ì°©", desc:"" }
    ]
  }
];

/* ================= ì¼ì • ë Œë” ================= */
function renderScheduleForAdmin() {
  const wrap = document.getElementById("pageSchedule");
  wrap.innerHTML = travelSchedule.map(day => `
    <div class="day-card">
      <h3>${day.day} <span>${day.date}</span></h3>
      <p class="day-title">${day.title}</p>
      <div class="timeline">
        ${day.items.map(item => `
          <div class="schedule-item">
            <div class="timeline-dot"></div>
            <div class="schedule-card"
                 onclick="openQR('${item.title}')"
                 style="cursor:pointer">
              <div class="schedule-time">${item.time}</div>
              <div class="schedule-title">${item.icon} ${item.title}</div>
              ${item.desc ? `<div class="schedule-desc">${item.desc}</div>` : ""}
            </div>
          </div>
        `).join("")}
      </div>
    </div>
  `).join("");
}
</script>

</body>
</html>
